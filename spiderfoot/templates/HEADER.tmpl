<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>ASM-NG v${version}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ASM-NG - Attack Surface Management">
    <meta name="author" content="NGS">
    <link rel="icon" type="image/png" href="${docroot}/static/img/spiderfoot-icon.png">

    <script type='text/javascript' src='${docroot}/static/js/spiderfoot.js'></script>
    <script type='text/javascript' src='${docroot}/static/js/viz.js'></script>

    <link href="${docroot}/static/node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="${docroot}/static/node_modules/tablesorter/dist/css/jquery.tablesorter.pager.min.css" rel="stylesheet">
    <link href="${docroot}/static/node_modules/alertifyjs/build/css/alertify.min.css" rel="stylesheet">

    <!-- Theme CSS - only load the one we need based on localStorage -->
    <script>
        // Synchronously write the correct theme stylesheet
        var isDark = localStorage.getItem("theme") === "dark-theme";
        var cssFile = isDark ? "dark.css" : "spiderfoot.css";
        var cacheBust = "?v=" + Date.now();
        document.write('<link id="theme-css" href="${docroot}/static/css/' + cssFile + cacheBust + '" rel="stylesheet">');
    </script>
    <noscript>
        <link href="${docroot}/static/css/spiderfoot.css" rel="stylesheet">
    </noscript>
  </head>

  <body>

<!-- ASM-NG Logo Banner (Video) -->
<div class="asm-ng-logo-container">
  <div class="asm-ng-logo-wrapper">
    <a href="${docroot}/">
      <video class="asm-ng-logo-video" autoplay loop muted playsinline>
        <source src="${docroot}/static/img/asm-ng-logo.mp4" type="video/mp4">
        <!-- Fallback to image if video not supported -->
        <img src="${docroot}/static/img/asm-ng-logo.png" alt="ASM-NG" class="asm-ng-logo" />
      </video>
    </a>
  </div>
</div>

<!-- ASM-NG Navigation Menu -->
<nav class="asm-ng-sidebar">
  <ul class="sidebar-nav">
    <li
% if pageid == "NEWSCAN":
    class="active"
% endif
    >
      <a id="nav-link-newscan" href="${docroot}/newscan">
        <i class="glyphicon glyphicon-screenshot nav-icon"></i>
        <span class="nav-text">New Scan</span>
      </a>
    </li>
    <li
% if pageid == "SCANLIST":
    class="active"
% endif
    >
      <a id="nav-link-scans" href="${docroot}/">
        <i class="glyphicon glyphicon-list nav-icon"></i>
        <span class="nav-text">Scans</span>
      </a>
    </li>
    <li
% if pageid == "WORKSPACES":
    class="active"
% endif
    >
      <a id="nav-link-workspaces" href="${docroot}/workspaces">
        <i class="glyphicon glyphicon-folder-open nav-icon"></i>
        <span class="nav-text">Workspaces</span>
      </a>
    </li>
    <li
% if pageid == "IMPORT":
    class="active"
% endif
    >
      <a id="nav-link-import" href="${docroot}/importscans">
        <i class="glyphicon glyphicon-import nav-icon"></i>
        <span class="nav-text">Import</span>
      </a>
    </li>
    <li
% if pageid == "SETTINGS":
    class="active"
% endif
    >
      <a id="nav-link-settings" href="${docroot}/opts">
        <i class="glyphicon glyphicon-wrench nav-icon"></i>
        <span class="nav-text">Settings</span>
      </a>
    </li>
  </ul>

  <!-- Theme Toggle -->
  <div class="sidebar-toggle-container">
    <label id="switcher4" class="switch">
      <input id="theme-toggler" class="theme-toggler" type="checkbox">
      <span class="slider round"></span>
    </label>
    <span id="toggler-text">INVERT</span>
  </div>
</nav>

    <!-- Placed at the end of the document so the pages load faster -->
    <script>var docroot = '${docroot}';</script>
    <script src="${docroot}/static/node_modules/jquery/dist/jquery.min.js"></script>
    <script src="${docroot}/static/node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="${docroot}/static/node_modules/alertifyjs/build/alertify.min.js"></script>
    <script src="${docroot}/static/node_modules/tablesorter/dist/js/jquery.tablesorter.min.js"></script>
    <script src='${docroot}/static/node_modules/tablesorter/dist/js/extras/jquery.tablesorter.pager.min.js'></script>
    <script src='${docroot}/static/node_modules/tablesorter/dist/js/jquery.tablesorter.widgets.min.js'></script>
    <script src="${docroot}/static/node_modules/d3/d3.min.js"></script>
    <script type='text/javascript' hash="sha256-0kTZzWMEh3cdgCMVytlY1E8rg7oO13eyLa+kvyAhRmo=">sf.updateTooltips();</script>

    <!-- Auto-logout on browser close (not tab navigation) -->
    <script>
    (function() {
        // Use sessionStorage to track if this is an active browser session
        // sessionStorage persists across page navigations but clears when browser closes
        var SESSION_KEY = 'sf_active_session';
        var NAV_KEY = 'sf_navigating';

        // Mark this session as active
        sessionStorage.setItem(SESSION_KEY, '1');

        // Clear navigation flag on page load (we successfully navigated)
        sessionStorage.removeItem(NAV_KEY);

        // Track all forms of internal navigation
        function markNavigation() {
            sessionStorage.setItem(NAV_KEY, '1');
        }

        // Mark clicks on internal links
        document.addEventListener('click', function(e) {
            var link = e.target.closest('a');
            if (link && link.href) {
                // Mark any link click as navigation (internal or external)
                markNavigation();
            }
        }, true);

        // Mark form submissions
        document.addEventListener('submit', markNavigation, true);

        // Intercept window.location changes by wrapping common patterns
        // This catches programmatic navigation like window.location.href = '...'
        var originalAssign = window.location.assign;
        var originalReplace = window.location.replace;

        if (originalAssign) {
            window.location.assign = function(url) {
                markNavigation();
                return originalAssign.call(window.location, url);
            };
        }

        if (originalReplace) {
            window.location.replace = function(url) {
                markNavigation();
                return originalReplace.call(window.location, url);
            };
        }

        // For direct href assignment, use a MutationObserver isn't practical,
        // but we can use beforeunload to check if navigation is happening
        // by detecting if sessionStorage flag indicates active navigation

        function fireLogout() {
            // Only logout if we're NOT navigating to another page
            // The NAV_KEY will be set for intentional navigation
            if (sessionStorage.getItem(NAV_KEY)) {
                // This is intentional navigation, don't logout
                return;
            }

            // This is a true close (tab or browser close)
            // Send logout beacon
            try {
                navigator.sendBeacon(docroot + '/logout', '');
            } catch (e) {
                // Fallback: synchronous request (not recommended but better than nothing)
                var xhr = new XMLHttpRequest();
                xhr.open('GET', docroot + '/logout', false);
                xhr.send();
            }
        }

        // Use pagehide instead of beforeunload for more reliable detection
        // pagehide fires when the page is being hidden/unloaded
        window.addEventListener('pagehide', function(e) {
            // If page is being cached (bfcache), don't logout
            if (e.persisted) return;

            // Small delay to allow navigation flag to be set
            // For programmatic navigation (window.location.href = ...)
            // we need to set the flag before this fires
            fireLogout();
        });

        // Also set nav flag just before any unload to catch programmatic navigation
        window.addEventListener('beforeunload', function() {
            // Give a tiny window for other scripts to have set location
            // If we're here and no nav flag, it's likely a close
        });

        // Expose a global function to mark navigation for custom JS
        window.sfMarkNavigation = markNavigation;
    })();
    </script>

    <div class="container" id="mainbody" style='padding-bottom: 50px; overflow: visible !important;'>

