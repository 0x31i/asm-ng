## -*- coding: utf-8 -*-
<%include file="HEADER.tmpl"/>
<%
  if status == "FINISHED":
    statusy = "alert-success"
  elif status.startswith("ABORT"):
    statusy = "alert-warning"
  elif status == "CREATED" or status == "RUNNING" or status == "STARTED" or status == "STARTING" or status == "INITIALIZING":
    statusy = "alert-info"
  elif status == "ERROR-FAILED":
    statusy = "alert-danger"
  else:
    statusy = "alert-info"
  end
%>
<h2>${name}&nbsp;<span id='scanstatusbadge' class='badge ${statusy}'>${status}</span><span id='latestbadge' class='badge' style='display: none; background-color: #3b82f6; color: white; margin-left: 5px;'>LATEST</span><span id='syncbadge' class='badge' style='display: none; background-color: #10b981; color: white; margin-left: 5px; cursor: pointer;' onclick='resyncScanEntries()' title='Click to sync entries from previous scans'>SYNC</span><span id='importedbadge' class='badge' style='display: none; background-color: #8b5cf6; color: white; margin-left: 5px;'></span>&nbsp;<img id="loader" src="${docroot}/static/img/loader.gif"></h2>
  <div id="scan-progress-container" style="display: none; margin-bottom: 10px;">
    <div style="display: flex; align-items: center; gap: 10px;">
      <div class="progress" style="flex: 1; height: 18px; margin-bottom: 0;">
        <div id="scan-progress-bar" class="progress-bar progress-bar-striped active" role="progressbar"
             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%; min-width: 2em; text-align: center; line-height: 18px; font-size: 11px;">
          0%
        </div>
      </div>
      <small id="scan-progress-pct" style="white-space: nowrap; font-weight: bold; min-width: 30px;"></small>
    </div>
    <div id="scan-progress-details" style="margin-top: 4px; font-size: 11px; color: #888; display: flex; gap: 15px; flex-wrap: wrap;">
      <span id="sp-modules" title="Modules that have reported results / total modules"></span>
      <span id="sp-running" title="Modules actively processing events"></span>
      <span id="sp-queued" title="Events waiting to be processed by modules"></span>
      <span id="sp-events" title="Total events produced so far"></span>
      <span id="sp-rate" title="Events produced per second (recent)"></span>
    </div>
  </div>
  <div class="btn-toolbar" role="toolbar" style='padding-bottom: 10px'>
   <div class="btn-group">
      <a id='btn-status' class="btn btn-default" onClick='scanSummaryView("${id}")'><i class='glyphicon glyphicon-eye-open'></i>&nbsp;Summary</a>
      <a id='btn-findings' class="btn btn-default" onClick='viewFindings("${id}")'><i class='glyphicon glyphicon-exclamation-sign'></i>&nbsp;Findings</a>
      <a id='btn-graph' class="btn btn-default" onClick='viewVulnerabilities("${id}")'><i class='glyphicon glyphicon-asterisk'></i>&nbsp;Vulnerabilities</a>
      <a id='btn-data' class="btn btn-default" onClick='dataEventList("${id}")'><i class='glyphicon glyphicon-th-list'></i>&nbsp;Data</a>
      <a id='btn-assets' class="btn btn-default" onClick='viewAssets("${id}")'><i class='glyphicon glyphicon-hdd'></i>&nbsp;Assets</a>
% if current_user == 'admin':
      <a id='btn-info' class="btn btn-default" onClick='viewScanConfig("${id}")'><i class='glyphicon glyphicon-cog'></i>&nbsp;Manage</a>
% endif
    </div>
        <div id='modifyactions' role="group" class="btn-group">
            <a id='btn-setfp' rel="tooltip" data-title="Set validation status" class="btn-warning btn btn-default dropdown-toggle" data-toggle="dropdown"><i class='glyphicon glyphicon-ok-circle glyphicon glyphicon-white'></i></a>
            <ul class="dropdown-menu">
                <li class="dropdown-header">Validation Status</li>
                <li><a href='#' class='link' onClick='setFp(2); return false;'><i class='glyphicon glyphicon-ok-circle' style='color: #3b82f6;'></i> Mark as Validated</a></li>
                <li><a href='#' class='link' onClick='setFp(1); return false;'><i class='glyphicon glyphicon-ban-circle' style='color: #ea580c;'></i> Mark as False Positive</a></li>
                <li><a href='#' class='link' onClick='setFp(0); return false;'><i class='glyphicon glyphicon-minus' style='color: #6b7280;'></i> Mark as Unvalidated</a></li>
                <li class="divider"></li>
                <li><a href='#' class='link' onClick='setFp(0, 1); return false;'>Force Unset (ignore parent)</a></li>
                <li class="divider"></li>
                <li class="dropdown-header">Bulk Actions</li>
                <li><a href='#' class='link' onClick='selectMatchingFps(); return false;'>Select All Matching Saved FPs</a></li>
                <li><a href='#' class='link' onClick='markAllMatchingFps(); return false;'>Mark All Matching as FP</a></li>
                <li><a href='#' class='link' onClick='selectAllVisible(); return false;'>Select All Visible</a></li>
            </ul>
        </div>
        <div id='customtabview' role="group" class="btn-group">
         <a id='btn-fullview' rel="tooltip" data-title="Full Data View" class="btn btn-default active" onClick='dataUpdate("full")'><i class='glyphicon glyphicon-th glyphicon glyphicon-white'></i></a>
         <a id='btn-discoverypathview' rel="tooltip" data-title="Discovery Path View" class="btn btn-default" onClick='dataUpdate("discovery-path")'><i class='glyphicon glyphicon-random glyphicon glyphicon-white'></i></a>
         <a id='btn-vizview' rel="tooltip" data-title="Visualize" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><i class='glyphicon glyphicon-picture glyphicon glyphicon-white'></i></a>
         <ul class="dropdown-menu">
            <li><a class='link' onClick='dataUpdate("viz-bubble-data")'>Bubble (Data Element)</a></li>
            <li><a class='link' onClick='dataUpdate("viz-bubble-source")'>Bubble (Source Data Element)</a></li>
            <li><a class='link' onClick='dataUpdate("viz-dendro")'>Discovery Path (Visual)</a></li>
         </ul>
        </div>
        <div id='customvizview' class="btn-group">
         <a id='btn-random' rel="tooltip" data-title="Random Layout" class="btn btn-default active" onClick='vizUpdate("random")'><b>R</b></a>
         <a id='btn-forceatlas' rel="tooltip" data-title="Force Layout" class="btn btn-default" onClick='vizUpdate("force")'><b>F</b></a>
         <a id='btn-saveimage' rel="tooltip" data-title="Save Image" class="btn btn-default dropdown-toggle" onClick='vizUpdate("download")'><i class='glyphicon glyphicon-picture glyphicon glyphicon-white'></i></a>
        </div>
        <div class="btn-group" role="group">
            <button id='btn-refresh' rel="tooltip" title="Refresh" class="btn btn-success btn-default" onClick='refresh()'><i class='glyphicon glyphicon-refresh glyphicon glyphicon-white'></i></button>
            <a id='btn-export' rel="tooltip" data-title="Export Data" class="btn btn-default dropdown-toggle download-button" data-toggle="dropdown"><i class='glyphicon glyphicon-download-alt glyphicon glyphicon-white'></i></a>
            <ul id="export-dropdown-menu" class="dropdown-menu">
              <li class="dropdown-header">Full Data (All Results)</li>
              <li><a class='link' onClick='exportEventData("${id}", currentType, "csv", "full")'>CSV</a></li>
              <li><a class='link' onClick='exportEventData("${id}", currentType, "excel", "full")'>Excel</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Analysis (No False Positives)</li>
              <li><a class='link' onClick='exportEventData("${id}", currentType, "csv", "analysis")'>CSV</a></li>
              <li><a class='link' onClick='exportEventData("${id}", currentType, "excel", "analysis")'>Excel</a></li>
              <li><a class='link' onClick='exportEventData("${id}", currentType, "excel", "analysis_correlations")'>Excel + Findings & Correlations</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Legacy Export (v4.0 Types)</li>
              <li><a class='link' onClick='exportEventData("${id}", currentType, "csv", "full", true)'>CSV</a></li>
              <li><a class='link' onClick='exportEventData("${id}", currentType, "excel", "full", true)'>Excel</a></li>
              <li><a class='link' onClick='exportEventData("${id}", currentType, "csv", "analysis", true)'>CSV Analysis</a></li>
              <li><a class='link' onClick='exportEventData("${id}", currentType, "excel", "analysis", true)'>Excel Analysis</a></li>
              <li><a class='link' onClick='exportEventData("${id}", currentType, "excel", "analysis_correlations", true)'>Excel Analysis + Findings & Correlations</a></li>
            </ul>
        </div>
    <div class='btn-group search-group'>
        <div id='btn-search' class='input-group'>
          <input class='form-control' id='searchvalue' type='text' placeholder='Search...' data-toggle='popover' data-html='true' data-animation='true' data-title='Usage' data-content="Supply a regular expression encapsulated in '/', e.g. <i>/searchregex/</i> or a simple wildcard search, e.g. <i>*string*</i> or an exact value, e.g. <i>string</i>.<br /><br /><b>Note</b> that the current scope is what's searched.">
            <div class='input-group-btn' style='width: 0px'> <!-- Chrome fix -->
              <button class='btn btn-primary' id='searchbutton' type='button' onClick="$('#btn-search').popover('toggle');searchDirector('${id}')">
                <i class='glyphicon glyphicon-search glyphicon glyphicon-white'></i>
              </button>
            </div>
        </div>
    </div>
  </div>

  <!-- Page Title -->
  <div id="page-title" class="page-title">
    <span id="page-title-text" class="page-title-text">SUMMARY</span>
    <div id="page-title-actions" class="page-title-actions">
      <button class="btn-module-info" id="btn-module-info" onclick="showModuleInfo()"><i class="glyphicon glyphicon-info-sign"></i>&nbsp;&nbsp;MODULE INFO</button>
      <button class="btn-instructions" id="btn-instructions" onclick="showInstructions()"><i class="glyphicon glyphicon-education"></i>&nbsp;&nbsp;INSTRUCTIONS</button>
    </div>
  </div>

  <!-- Expandable Info Panel for Module Info / Instructions -->
  <div id="info-panel-wrapper" class="info-panel-wrapper" style="display:none;">
    <div id="info-panel" class="info-panel">
      <div class="info-panel-header">
        <div class="info-panel-title">
          <i id="info-panel-icon" class="glyphicon glyphicon-info-sign"></i>
          <span id="info-panel-title-text">MODULE INFO</span>
        </div>
        <button class="info-panel-close" onclick="closeInfoPanel()" title="Close">
          <i class="glyphicon glyphicon-remove"></i>
        </button>
      </div>
      <div id="info-panel-content" class="info-panel-content"></div>
    </div>
  </div>

  <!-- Floating Selection Toolbar - Modern horizontal design -->
  <div id="selection-toolbar" class="toolbar-bottom toolbar-hidden">
    <!-- Left snap button (horizontal mode only) -->
    <div class="toolbar-snap-btn toolbar-snap-left" onclick="snapToolbar('left')" title="Snap to left">
      <i class="glyphicon glyphicon-chevron-left"></i>
    </div>

    <div class="toolbar-content">
      <!-- Header row with count and close button -->
      <div class="toolbar-header">
        <div class="selection-count-display">
          <span class="count-number" id="selection-count">0</span>
          <span>SELECTED</span>
        </div>
        <button type="button" class="close-btn" onclick="clearSelection()">&times;</button>
      </div>

      <!-- Match buttons section -->
      <div class="match-section">
        <label>Select matching:</label>
        <div class="match-buttons">
          <div id="match-data-element" class="match-btn-wrapper" style="display: none;">
            <button class="btn btn-data-match" onclick="selectAllMatchingDataElements()">
              <i class="glyphicon glyphicon-plus"></i>
              Data Element
              <span id="data-match-count" class="match-count-badge">0</span>
            </button>
          </div>
          <div id="match-source-element" class="match-btn-wrapper" style="display: none;">
            <button class="btn btn-source-match" onclick="selectAllMatchingSourceElements()">
              <i class="glyphicon glyphicon-plus"></i>
              Source Element
              <span id="source-match-count" class="match-count-badge">0</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Action buttons -->
      <div class="toolbar-actions">
        <button class="btn btn-validated-action" onclick="setFp(2)" title="Mark as Validated (confirmed belongs to organization)">
          <i class="glyphicon glyphicon-ok-circle"></i>
          Validated
        </button>
        <button class="btn btn-fp-action" onclick="setFp(1)" title="Mark as False Positive (confirmed doesn't belong)">
          <i class="glyphicon glyphicon-ban-circle"></i>
          False Positive
        </button>
        <button class="btn btn-unvalidated-action" onclick="setFp(0)" title="Mark as Unvalidated (reset status)">
          <i class="glyphicon glyphicon-minus"></i>
          Unvalidated
        </button>
        <button class="btn btn-clear" onclick="clearSelection()">
          Clear
        </button>
      </div>

      <!-- Undo snap button (vertical mode only) -->
      <div class="toolbar-undo-snap" onclick="snapToolbar('bottom')" title="Return to bottom">
        <i class="glyphicon glyphicon-chevron-down"></i>
      </div>
    </div>

    <!-- Right snap button (horizontal mode only) -->
    <div class="toolbar-snap-btn toolbar-snap-right" onclick="snapToolbar('right')" title="Snap to right">
      <i class="glyphicon glyphicon-chevron-right"></i>
    </div>
  </div>
    <script src="${docroot}/static/node_modules/sigma/build/sigma.min.js"></script>
    <script src="${docroot}/static/node_modules/sigma/build/plugins/sigma.parsers.json.min.js"></script>
    <script src="${docroot}/static/node_modules/sigma/build/plugins/sigma.plugins.dragNodes.min.js"></script>
    <script src="${docroot}/static/node_modules/sigma/build/plugins/sigma.layout.forceAtlas2.min.js"></script>
    <script src="${docroot}/static/node_modules/sigma/build/plugins/sigma.renderers.snapshot.min.js"></script>
    <script type='text/javascript'>
        // HTML escape utility
        if (typeof sf !== 'undefined' && !sf.escapeHtml) {
            sf.escapeHtml = function(str) {
                if (!str) return '';
                var div = document.createElement('div');
                div.appendChild(document.createTextNode(str));
                return div.innerHTML;
            };
        }

        var currentType = "ALL";
        var currentTypeName = "All";
        var currentSection = "btn-data";
        var currentDataFormat = "full";
        var lastSearchType = "ALL";
        var lastSearchQuery = "";
        var dataloaders = [];
        var sharedSigma = "";
        var loadersrunning = false;
        var defaultExportDropdownHtml = '';
        var refresh = function() { dataEventList("${id}"); }
        var _skipHistoryPush = false; // Flag to prevent pushState during popstate handling
        var _instanceId = "${id}";

        // ---- BROWSER HISTORY MANAGEMENT ----
        // Builds a state object representing the current view for history.pushState
        function buildHistoryState() {
            return {
                view: currentSection,
                dataType: currentType,
                dataTypeName: currentTypeName,
                dataFormat: currentDataFormat,
                vulnTab: (typeof vulnActiveTab !== 'undefined') ? vulnActiveTab : 'nessus',
                findingsTab: (typeof findingsActiveTab !== 'undefined') ? findingsActiveTab : 'findings',
                assetsView: (typeof currentAssetsView !== 'undefined') ? currentAssetsView : 'overview',
                searchQuery: lastSearchQuery,
                searchType: lastSearchType,
                scrollY: window.scrollY
            };
        }

        // Push a new history entry for the current view state
        function pushViewState(viewName, extra) {
            if (_skipHistoryPush) return;
            var state = buildHistoryState();
            if (viewName) state.view = viewName;
            if (extra) {
                for (var k in extra) {
                    if (extra.hasOwnProperty(k)) state[k] = extra[k];
                }
            }
            state.scrollY = 0; // New view starts at top
            history.pushState(state, '', window.location.href);
        }

        // Restore a view from a history state object (called on popstate)
        function restoreViewFromState(state) {
            if (!state || !state.view) return;
            _skipHistoryPush = true;
            switch (state.view) {
                case 'btn-status':
                    scanSummaryView(_instanceId);
                    break;
                case 'btn-findings':
                    viewFindings(_instanceId);
                    if (state.findingsTab && state.findingsTab !== 'findings') {
                        setTimeout(function() {
                            _skipHistoryPush = true;
                            switchFindingsTab(state.findingsTab, _instanceId);
                            _skipHistoryPush = false;
                        }, 100);
                    }
                    break;
                case 'btn-graph':
                    viewVulnerabilities(_instanceId);
                    if (state.vulnTab && state.vulnTab !== 'nessus') {
                        setTimeout(function() {
                            _skipHistoryPush = true;
                            switchVulnTab(state.vulnTab, _instanceId);
                            _skipHistoryPush = false;
                        }, 100);
                    }
                    break;
                case 'btn-data':
                    if (state.dataType && state.dataType !== 'ALL') {
                        dataEventData(_instanceId, state.dataTypeName, state.dataType, state.dataFormat || 'full');
                    } else {
                        dataEventList(_instanceId);
                    }
                    break;
                case 'btn-assets':
                    viewAssets(_instanceId);
                    if (state.assetsView && state.assetsView !== 'overview') {
                        setTimeout(function() {
                            _skipHistoryPush = true;
                            if (state.assetsView === 'known') assetsShowKnown(_instanceId);
                            else if (state.assetsView === 'potential') assetsShowPotential(_instanceId);
                            _skipHistoryPush = false;
                        }, 100);
                    }
                    break;
                case 'btn-info':
                    viewScanConfig(_instanceId);
                    break;
                case 'btn-search':
                    if (state.searchQuery) {
                        searchResults(_instanceId, state.searchQuery, state.searchType !== 'ALL' ? state.searchType : null);
                    } else {
                        scanSummaryView(_instanceId);
                    }
                    break;
                default:
                    scanSummaryView(_instanceId);
                    break;
            }
            _skipHistoryPush = false;
            // Restore scroll position after content loads
            if (state.scrollY) {
                setTimeout(function() { window.scrollTo(0, state.scrollY); }, 300);
            }
        }

        // Listen for browser back/forward button
        window.addEventListener('popstate', function(event) {
            if (event.state) {
                restoreViewFromState(event.state);
            }
        });

        $('#searchvalue').popover({ 'trigger': 'focus', 'placement': 'bottom'});
        $('#searchvalue').keyup(function(event) {
            if (event.keyCode == 13) {
                $('#searchbutton').click();
            }
        });

        function switchSelectAll() {
            if (!$("#checkall")[0].checked) {
                $("input[id*=cb_]").prop('checked', false);
            } else {
                $("input[id*=cb_]").prop('checked', true);
            }
        }

        // Store data for bulk FP operations
        var currentViewData = [];

        // Client-side filter state - persists while on the page
        var clientFilterState = {
            fp: false,
            validated: false,
            imported: false
        };

        // Toggle client-side filter
        function toggleClientFilter(type) {
            clientFilterState[type] = !clientFilterState[type];
            applyClientSideFilters();
            updateFilterButtonStates();
        }

        // Apply client-side filters by showing/hiding rows
        function applyClientSideFilters() {
            var visibleCount = 0;
            var hiddenCount = 0;

            $("#scansummary-content tbody tr").each(function() {
                var row = $(this);
                var statusSpan = row.find(".validation-status span");
                var isImported = row.hasClass("imported-row");

                var shouldHide = false;

                // Check FP filter
                if (clientFilterState.fp && statusSpan.hasClass('status-fp')) {
                    shouldHide = true;
                }

                // Check Validated filter
                if (clientFilterState.validated && statusSpan.hasClass('status-validated')) {
                    shouldHide = true;
                }

                // Check Imported filter
                if (clientFilterState.imported && isImported) {
                    shouldHide = true;
                }

                if (shouldHide) {
                    row.hide();
                    hiddenCount++;
                } else {
                    row.show();
                    visibleCount++;
                }
            });

            // Update visible count in stats
            $(".stats-bar-left .stats-item:first-child .stats-value").text(visibleCount);

            return visibleCount;
        }

        // Update filter button visual states
        function updateFilterButtonStates() {
            // Update FP button
            var fpBtn = $(".filter-btn-fp");
            if (clientFilterState.fp) {
                fpBtn.addClass('filter-btn-active');
                fpBtn.text(fpBtn.data('hiding-text') || 'HIDING FP');
            } else {
                fpBtn.removeClass('filter-btn-active');
                fpBtn.text(fpBtn.data('show-text') || 'HIDE FP');
            }

            // Update Validated button
            var valBtn = $(".filter-btn-validated");
            if (clientFilterState.validated) {
                valBtn.addClass('filter-btn-active');
                valBtn.text(valBtn.data('hiding-text') || 'HIDING VALIDATED');
            } else {
                valBtn.removeClass('filter-btn-active');
                valBtn.text(valBtn.data('show-text') || 'HIDE VALIDATED');
            }

            // Update Imported button
            var impBtn = $(".filter-btn-imported");
            if (clientFilterState.imported) {
                impBtn.addClass('filter-btn-active');
                impBtn.text(impBtn.data('hiding-text') || 'HIDING IMPORTED');
            } else {
                impBtn.removeClass('filter-btn-active');
                impBtn.text(impBtn.data('show-text') || 'HIDE IMPORTED');
            }
        }

        // Select all visible checkboxes
        function selectAllVisible() {
            $("input[id*=cb_]").prop('checked', true);
            $("#checkall").prop('checked', true);
            var count = $("input[id*=cb_]:checked").length;
            alertify.success("Selected " + count + " items");
        }

        // Select all known asset rows
        function selectKnownAssets() {
            $("input[id*=cb_]").prop('checked', false);
            $("#checkall").prop('checked', false);
            var count = 0;
            $("tr.known-asset-row").each(function() {
                var row = $(this);
                if (row.is(':visible')) {
                    row.find("input[id*=cb_]").prop('checked', true);
                    count++;
                }
            });
            if (count > 0) {
                alertify.success("Selected " + count + " known asset items");
            } else {
                alertify.warning("No known asset items in current view");
            }
        }

        // Select only items that match saved target-level FPs
        function selectMatchingFps() {
            $("input[id*=cb_]").prop('checked', false);
            $("#checkall").prop('checked', false);
            var count = 0;
            // Find rows with the warning icon (matching saved FPs)
            $("tr").each(function() {
                var row = $(this);
                if (row.find(".glyphicon-repeat.text-warning").length > 0) {
                    row.find("input[id*=cb_]").prop('checked', true);
                    count++;
                }
            });
            if (count > 0) {
                alertify.success("Selected " + count + " items matching saved FPs");
            } else {
                alertify.warning("No items match saved FPs in current view");
            }
        }

        // One-click: select all matching FPs and mark them
        function markAllMatchingFps() {
            selectMatchingFps();
            var sel = getSelected();
            if (sel.length == 0) {
                alertify.warning("No items match saved FPs to mark");
                return;
            }
            // Confirm before bulk marking
            alertify.confirm("Mark " + sel.length + " items as False Positive?<br/><small>These will be saved for all future scans of this target.</small>",
                function() {
                    setFp(1);
                },
                function() {
                    alertify.warning("Cancelled");
                }
            ).setHeader("Confirm Bulk FP");
        }

        // Variables for selection toolbar - now storing arrays for multiple selection support
        var selectedDataElements = [];
        var selectedSourceElements = [];

        // Clear all selections
        function clearSelection() {
            $("input[id*=cb_]").prop('checked', false);
            $("#checkall").prop('checked', false);
            updateSelectionToolbar();
        }

        // Update the selection toolbar based on current selections
        function updateSelectionToolbar() {
            // Only operate if we're on a page with FP checkboxes
            var hasCheckboxes = $("input[id*=cb_]").length > 0;
            if (!hasCheckboxes) {
                hideSelectionToolbar();
                return;
            }

            var selectedCount = $("input[id*=cb_]:checked").length;
            $("#selection-count").text(selectedCount);

            if (selectedCount > 0) {
                // Show toolbar - use class toggle for consistent behavior
                showSelectionToolbar();

                // Highlight table headers to match toolbar buttons
                highlightTableHeaders(true);

                // Collect ALL unique Data Elements and Source Elements from ALL selected rows
                selectedDataElements = [];
                selectedSourceElements = [];
                var dataElementSet = {};
                var sourceElementSet = {};

                $("input[id*=cb_]:checked").each(function() {
                    var row = $(this).closest("tr");
                    var cells = row.find("td");

                    if (cells.length >= 4) {
                        var dataEl = cells.eq(2).text().trim();
                        var sourceEl = cells.eq(3).text().trim();

                        // Add to unique sets
                        if (dataEl && !dataElementSet[dataEl]) {
                            dataElementSet[dataEl] = true;
                            selectedDataElements.push(dataEl);
                        }
                        if (sourceEl && !sourceElementSet[sourceEl]) {
                            sourceElementSet[sourceEl] = true;
                            selectedSourceElements.push(sourceEl);
                        }
                    }
                });

                // Show data element match option with count
                if (selectedDataElements.length > 0) {
                    var preview = "";
                    if (selectedDataElements.length === 1) {
                        preview = '"' + selectedDataElements[0].substring(0, 40) + '"';
                        if (selectedDataElements[0].length > 40) preview = preview.slice(0, -1) + '..."';
                    } else {
                        preview = selectedDataElements.length + " unique values";
                    }
                    $("#match-source-preview").text(preview);
                    $("#source-match-count").text(selectedDataElements.length);
                    $("#match-source-element").show();
                } else {
                    $("#match-source-element").hide();
                }

                // Show source element match option with count
                if (selectedSourceElements.length > 0) {
                    var preview = "";
                    if (selectedSourceElements.length === 1) {
                        preview = '"' + selectedSourceElements[0].substring(0, 40) + '"';
                        if (selectedSourceElements[0].length > 40) preview = preview.slice(0, -1) + '..."';
                    } else {
                        preview = selectedSourceElements.length + " unique values";
                    }
                    $("#match-data-preview").text(preview);
                    $("#data-match-count").text(selectedSourceElements.length);
                    $("#match-data-element").show();
                } else {
                    $("#match-data-element").hide();
                }
            } else {
                hideSelectionToolbar();
                // Remove table header highlights
                highlightTableHeaders(false);
            }
        }

        // Helper functions for consistent toolbar show/hide
        function showSelectionToolbar() {
            var toolbar = document.getElementById('selection-toolbar');
            if (toolbar) {
                toolbar.classList.remove('toolbar-hidden');
                toolbar.style.display = 'flex';
            }
        }

        function hideSelectionToolbar() {
            var toolbar = document.getElementById('selection-toolbar');
            if (toolbar) {
                toolbar.classList.add('toolbar-hidden');
                toolbar.style.display = 'none';
            }
        }

        // Highlight or unhighlight table headers when toolbar is shown/hidden
        function highlightTableHeaders(highlight) {
            var isDarkMode = localStorage.getItem("theme") === "dark-theme";
            var defaultBg = isDarkMode ? "rgba(0, 0, 0, 0.85)" : "rgba(255, 255, 255, 0.85)";
            var defaultColor = isDarkMode ? "#ffffff" : "#1f2937";
            var defaultBorder = isDarkMode ? "1px solid rgba(255, 255, 255, 0.2)" : "1px solid rgba(0, 0, 0, 0.2)";

            // Find headers by text content
            $("#scansummary-content thead th").each(function() {
                var headerText = $(this).text().trim();
                if (headerText === "Data Element") {
                    if (highlight) {
                        $(this).addClass('th-data-highlight');
                        // Override inline styles with green button style
                        $(this).css({
                            'background': 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)',
                            'background-color': '#22c55e',
                            'color': '#ffffff',
                            'border': '1px solid #16a34a',
                            'text-shadow': '0 1px 2px rgba(0, 0, 0, 0.3)'
                        });
                    } else {
                        $(this).removeClass('th-data-highlight');
                        // Restore default styles
                        $(this).css({
                            'background': defaultBg,
                            'background-color': '',
                            'color': defaultColor,
                            'border': defaultBorder,
                            'text-shadow': ''
                        });
                    }
                } else if (headerText === "Source Data Element") {
                    if (highlight) {
                        $(this).addClass('th-source-highlight');
                        // Override inline styles with purple button style
                        $(this).css({
                            'background': 'linear-gradient(135deg, #a855f7 0%, #7c3aed 100%)',
                            'background-color': '#a855f7',
                            'color': '#ffffff',
                            'border': '1px solid #7c3aed',
                            'text-shadow': '0 1px 2px rgba(0, 0, 0, 0.3)'
                        });
                    } else {
                        $(this).removeClass('th-source-highlight');
                        // Restore default styles
                        $(this).css({
                            'background': defaultBg,
                            'background-color': '',
                            'color': defaultColor,
                            'border': defaultBorder,
                            'text-shadow': ''
                        });
                    }
                }
            });
        }

        // Select all rows matching ANY of the selected Data Elements
        function selectAllMatchingDataElements() {
            if (selectedDataElements.length === 0) return;

            // Create a lookup set for fast matching
            var matchSet = {};
            for (var i = 0; i < selectedDataElements.length; i++) {
                matchSet[selectedDataElements[i]] = true;
            }

            var newSelections = 0;
            $("#scansummary-content tbody tr").each(function() {
                var cells = $(this).find("td");
                if (cells.length >= 3) {
                    var dataElement = cells.eq(2).text().trim();
                    if (matchSet[dataElement]) {
                        var cb = $(this).find("input[id*=cb_]");
                        if (!cb.prop('checked')) {
                            cb.prop('checked', true);
                            newSelections++;
                        }
                    }
                }
            });

            if (newSelections > 0) {
                alertify.success("Selected " + newSelections + " additional rows matching " + selectedDataElements.length + " Data Element(s)");
            } else {
                alertify.info("All matching rows are already selected");
            }
            updateSelectionToolbar();
        }

        // Select all rows matching ANY of the selected Source Data Elements
        function selectAllMatchingSourceElements() {
            if (selectedSourceElements.length === 0) return;

            // Create a lookup set for fast matching
            var matchSet = {};
            for (var i = 0; i < selectedSourceElements.length; i++) {
                matchSet[selectedSourceElements[i]] = true;
            }

            var newSelections = 0;
            $("#scansummary-content tbody tr").each(function() {
                var cells = $(this).find("td");
                if (cells.length >= 4) {
                    var sourceElement = cells.eq(3).text().trim();
                    if (matchSet[sourceElement]) {
                        var cb = $(this).find("input[id*=cb_]");
                        if (!cb.prop('checked')) {
                            cb.prop('checked', true);
                            newSelections++;
                        }
                    }
                }
            });

            if (newSelections > 0) {
                alertify.success("Selected " + newSelections + " additional rows matching " + selectedSourceElements.length + " Source Element(s)");
            } else {
                alertify.info("All matching rows are already selected");
            }
            updateSelectionToolbar();
        }

        // ============================================
        // Snap-to Toolbar Functionality
        // ============================================
        var toolbarPosition = 'bottom'; // 'bottom', 'left', or 'right'

        function snapToolbar(position) {
            var toolbar = document.getElementById('selection-toolbar');

            // Remove all position classes
            toolbar.classList.remove('toolbar-bottom', 'toolbar-left', 'toolbar-right');

            // Add new position class
            toolbar.classList.add('toolbar-' + position);
            toolbarPosition = position;

            // Store preference in localStorage
            try {
                localStorage.setItem('toolbarPosition', position);
            } catch(e) {}

            // Update toolbar display
            updateToolbarStyle();
        }

        function updateToolbarStyle() {
            var selectedCount = $("input[id*=cb_]:checked").length;

            if (selectedCount > 0) {
                showSelectionToolbar();
            }
        }

        function loadToolbarPosition() {
            try {
                var saved = localStorage.getItem('toolbarPosition');
                if (saved && ['bottom', 'left', 'right'].indexOf(saved) !== -1) {
                    toolbarPosition = saved;
                    var toolbar = document.getElementById('selection-toolbar');
                    toolbar.classList.remove('toolbar-bottom', 'toolbar-left', 'toolbar-right');
                    toolbar.classList.add('toolbar-' + saved);
                }
            } catch(e) {}
        }

        // Initialize on page load
        $(document).ready(function() {
            loadToolbarPosition();
            sf.updateTooltips();
        });

        function getSelected() {
            ids = [];
            $("input[id*=cb_]").each(function(i, obj) {
                if (obj.checked) {
                    ids[ids.length] = obj.id.replace("cb_", "");
                }
            });

            return ids;
        }

        function setFp(flag, force) {
            sel = getSelected();
            if (sel.length == 0) {
                alertify.error("You need to select at least one record.");
                return false;
            }
            data = JSON.stringify(sel);
            $("#loader").show();
            // Always use persist endpoint - all status changes are saved for future scans
            var endpoint = '${docroot}/resultsetfppersist';
            var params = {'id': '${id}', 'fp': flag, 'resultids': data, 'persist': 1 };
            if (force) {
                params['force'] = force;
            }
            sf.fetchData(endpoint, params, function(ret) {
                $("#loader").hide();
                if (ret[0] == "SUCCESS") {
                    if (flag == 1) {
                        alertify.success("Marked as False Positive successfully.");
                    } else if (flag == 2) {
                        alertify.success("Marked as Validated successfully.");
                    } else {
                        alertify.success("Status cleared successfully.");
                    }
                    // Update rows in-place instead of full refresh
                    updateRowsStatus(sel, flag);
                    // Clear selection and update toolbar
                    clearSelection();
                    // Update stats bar counts
                    updateStatsBarCounts();
                    return;
                }
                if (ret[0] == "WARNING") {
                    alertify.error(ret[1]);
                    return;
                }
                if (ret[0] == "ERROR") {
                    alertify.error("There was an error updating status because: " + ret[1] + "<br/>If you believe this to be an error, please log out and log back in, and if the problem repeats, report this as a bug.");
                }
            });
        }

        // Update rows in place without full refresh
        function updateRowsStatus(ids, flag) {
            ids.forEach(function(id) {
                var checkbox = $("input#cb_" + id);
                var row = checkbox.closest("tr");
                var statusCell = row.find("td.validation-status");

                var isImported = row.hasClass("imported-row");
                var isKnownAsset = row.hasClass("known-asset-row");
                var importedClass = isImported ? " status-imported-glow" : "";
                var statusHtml = "";

                if (flag == 1) {
                    statusHtml = "<span class='status-fp" + importedClass + "' title='False Positive - confirmed does not belong to organization'>FALSE POSITIVE</span>";
                    row.attr('data-status', 'fp');
                } else if (flag == 2) {
                    statusHtml = "<span class='status-validated" + importedClass + "' title='Validated - confirmed belongs to organization'>VALIDATED</span>";
                    row.attr('data-status', 'validated');
                } else {
                    statusHtml = "<span class='status-unvalidated" + importedClass + "' title='Not yet reviewed'>UNVALIDATED</span>";
                    row.attr('data-status', 'unvalidated');
                }
                // Preserve known asset badge
                if (isKnownAsset) {
                    statusHtml += "<br><span class='status-known-asset' title='Matches a known asset'>KNOWN ASSET</span>";
                }

                statusCell.html(statusHtml);
            });
        }

        // Update stats bar counts without full refresh
        function updateStatsBarCounts() {
            var stats = {
                total: 0,
                fp: 0,
                validated: 0,
                unvalidated: 0,
                imported: 0
            };

            // Count ALL rows (not just visible) for accurate stats
            $("#scansummary-content tbody tr").each(function() {
                var row = $(this);
                stats.total++;

                if (row.hasClass('imported-row')) {
                    stats.imported++;
                }

                var statusSpan = row.find(".validation-status span");
                if (statusSpan.hasClass('status-fp')) {
                    stats.fp++;
                } else if (statusSpan.hasClass('status-validated')) {
                    stats.validated++;
                } else {
                    stats.unvalidated++;
                }
            });

            // Update stats bar display
            $(".stats-bar-left .stats-fp .stats-value").text(stats.fp);
            $(".stats-bar-left .stats-validated .stats-value").text(stats.validated);
            $(".stats-bar-left .stats-unvalidated .stats-value").text(stats.unvalidated);

            // Dynamically inject HIDE FP button if it doesn't exist and there are FPs
            var fpBtn = $(".stats-bar-right .filter-btn-fp");
            if (stats.fp > 0 && fpBtn.length === 0) {
                var fpBtnClass = clientFilterState.fp ? 'filter-btn filter-btn-active filter-btn-fp' : 'filter-btn filter-btn-fp';
                var fpBtnText = clientFilterState.fp ? 'HIDING ' + stats.fp + ' FP' : 'HIDE ' + stats.fp + ' FP';
                var fpHtml = "<button class='" + fpBtnClass + "' data-show-text='HIDE " + stats.fp + " FP' data-hiding-text='HIDING " + stats.fp + " FP' onclick=\"toggleClientFilter('fp')\">" + fpBtnText + "</button>";
                $(".stats-bar-right").prepend(fpHtml);
            } else if (stats.fp > 0 && fpBtn.length > 0) {
                // Update existing button text and data attributes
                fpBtn.data('show-text', 'HIDE ' + stats.fp + ' FP');
                fpBtn.data('hiding-text', 'HIDING ' + stats.fp + ' FP');
                if (clientFilterState.fp) {
                    fpBtn.text('HIDING ' + stats.fp + ' FP');
                } else {
                    fpBtn.text('HIDE ' + stats.fp + ' FP');
                }
            }

            // Dynamically inject HIDE VALIDATED button if it doesn't exist and there are validated items
            var valBtn = $(".stats-bar-right .filter-btn-validated");
            if (stats.validated > 0 && valBtn.length === 0) {
                var valBtnClass = clientFilterState.validated ? 'filter-btn filter-btn-active filter-btn-validated' : 'filter-btn filter-btn-validated';
                var valBtnText = clientFilterState.validated ? 'HIDING ' + stats.validated + ' VALIDATED' : 'HIDE ' + stats.validated + ' VALIDATED';
                var valHtml = "<button class='" + valBtnClass + "' data-show-text='HIDE " + stats.validated + " VALIDATED' data-hiding-text='HIDING " + stats.validated + " VALIDATED' onclick=\"toggleClientFilter('validated')\">" + valBtnText + "</button>";
                // Insert after FP button if it exists, otherwise prepend
                var existingFpBtn = $(".stats-bar-right .filter-btn-fp");
                if (existingFpBtn.length > 0) {
                    existingFpBtn.after(valHtml);
                } else {
                    $(".stats-bar-right").prepend(valHtml);
                }
            } else if (stats.validated > 0 && valBtn.length > 0) {
                // Update existing button text and data attributes
                valBtn.data('show-text', 'HIDE ' + stats.validated + ' VALIDATED');
                valBtn.data('hiding-text', 'HIDING ' + stats.validated + ' VALIDATED');
                if (clientFilterState.validated) {
                    valBtn.text('HIDING ' + stats.validated + ' VALIDATED');
                } else {
                    valBtn.text('HIDE ' + stats.validated + ' VALIDATED');
                }
            }

            // Update visible count (accounting for active filters)
            var visibleCount = $("#scansummary-content tbody tr:visible").length;
            $(".stats-bar-left .stats-item:first-child .stats-value").text(visibleCount);
        }

        // Page title mappings
        var pageTitles = {
            "btn-status": "SUMMARY",
            "btn-findings": "FINDINGS",
            "btn-graph": "VULNERABILITIES",
            "btn-assets": "ASSETS",
            "btn-data": "DATA",
            "btn-info": "MANAGE",
            "btn-search": "SEARCH RESULTS"
        };

        // Update page title with optional subdirectory
        function updatePageTitle(subDirectory) {
            var baseTitle = pageTitles[currentSection] || currentSection.replace("btn-", "").toUpperCase();
            if (subDirectory && subDirectory !== "All" && subDirectory !== "ALL") {
                var decodedSubDir = decodeURIComponent(subDirectory);
                $("#page-title-text").text(baseTitle + " / " + decodedSubDir.toUpperCase());
                // Show action buttons on DATA type detail pages
                if (currentSection === 'btn-data') {
                    $("#page-title-actions").addClass('visible');
                    updateInfoButtonStates();
                }
            } else {
                $("#page-title-text").text(baseTitle);
                $("#page-title-actions").removeClass('visible');
                if (_infoPanelOpen) closeInfoPanel();
            }
        }

        // ---- INFO PANEL: MODULE INFO & INSTRUCTIONS ----
        var _infoPanelOpen = false;
        var _infoPanelMode = null; // 'module-info' or 'instructions'
        var _modulesCache = null;  // cached /modules API response

        // Instructions mapping: eventType -> { title, intro, items[] }
        // Source: documentation/instructions-POSITIVE.md
        var _defaultIntro = "For each item, there are specific target areas to review. Overall, a review of any internal processes that impact the target area needs to be done. Are there changes that can prevent issues or unintentional exposure of data?";

        var _instructionsMap = {
            // --- External Vulnerabilities ---
            "VULNERABILITY_CVE_CRITICAL": {
                title: "External Vulnerabilities",
                intro: _defaultIntro,
                items: [
                    "Confirm all targeted assets are valid and in scope.",
                    "Review past vulnerability tickets for recurring themes (ex: unpatched third-party libraries).",
                    "Ensure patching and remediation processes are timely and consistently applied.",
                    "Track metrics to identify systemic issues requiring process changes."
                ]
            },
            "VULNERABILITY_CVE_HIGH": {
                title: "External Vulnerabilities",
                intro: _defaultIntro,
                items: [
                    "Confirm all targeted assets are valid and in scope.",
                    "Review past vulnerability tickets for recurring themes (ex: unpatched third-party libraries).",
                    "Ensure patching and remediation processes are timely and consistently applied.",
                    "Track metrics to identify systemic issues requiring process changes."
                ]
            },
            "VULNERABILITY_CVE_MEDIUM": {
                title: "External Vulnerabilities",
                intro: _defaultIntro,
                items: [
                    "Confirm all targeted assets are valid and in scope.",
                    "Review past vulnerability tickets for recurring themes (ex: unpatched third-party libraries).",
                    "Ensure patching and remediation processes are timely and consistently applied.",
                    "Track metrics to identify systemic issues requiring process changes."
                ]
            },
            "VULNERABILITY_CVE_LOW": {
                title: "External Vulnerabilities",
                intro: _defaultIntro,
                items: [
                    "Confirm all targeted assets are valid and in scope.",
                    "Review past vulnerability tickets for recurring themes (ex: unpatched third-party libraries).",
                    "Ensure patching and remediation processes are timely and consistently applied.",
                    "Track metrics to identify systemic issues requiring process changes."
                ]
            },
            "VULNERABILITY_GENERAL": {
                title: "External Vulnerabilities",
                intro: _defaultIntro,
                items: [
                    "Confirm all targeted assets are valid and in scope.",
                    "Review past vulnerability tickets for recurring themes (ex: unpatched third-party libraries).",
                    "Ensure patching and remediation processes are timely and consistently applied.",
                    "Track metrics to identify systemic issues requiring process changes."
                ]
            },
            "VULNERABILITY_DISCLOSURE": {
                title: "Vulnerability Disclosure",
                intro: _defaultIntro,
                items: [
                    "Confirm all applicable vulnerability disclosures have been accounted for, and the vulnerabilities disclosed are remediated.",
                    "Review whether new or updated assets could be affected by these disclosures.",
                    "Ensure patching and remediation processes are timely and consistently applied.",
                    "Track metrics to identify systemic issues requiring process changes."
                ]
            },

            // --- IP Addresses ---
            "INTERNAL_IP_ADDRESS": {
                title: "Internal IP Address",
                intro: _defaultIntro,
                items: [
                    "Validate that internal IP addresses listed are accurate and currently in use.",
                    "Remove or update obsolete or invalid addresses.",
                    "Investigate any exposures of internal IPs to the public and close unnecessary paths.",
                    "Implement controls to reduce accidental external exposure of internal networks."
                ]
            },
            "IP_ADDRESS": {
                title: "IP Address",
                intro: _defaultIntro,
                items: [
                    "Confirm listed IP addresses are valid and required for business operations.",
                    "Remove or decommission unused or invalid IP addresses.",
                    "Review whether all public IPs are necessary, consolidating where possible.",
                    "Document ownership and purpose for each exposed IP to support ongoing management."
                ]
            },
            "IPV6_ADDRESS": {
                title: "IPv6 Address",
                intro: _defaultIntro,
                items: [
                    "Confirm listed IPv6 addresses are valid and assigned to correct assets.",
                    "Remove or update unused or invalid IPv6 addresses.",
                    "Review exposure of IPv6 services to ensure they are intentional.",
                    "Apply consistent firewall and monitoring policies across IPv4 and IPv6."
                ]
            },

            // --- Ports ---
            "TCP_PORT_OPEN": {
                title: "TCP Port Open",
                intro: _defaultIntro,
                items: [
                    "Validate that the listed open ports are accurate and required.",
                    "Close or block unused or unauthorized ports.",
                    "Confirm that exposed services are hardened and updated.",
                    "Monitor regularly for unexpected changes in open ports."
                ]
            },
            "TCP_PORT_OPEN_BANNER": {
                title: "TCP Port Open Banner",
                intro: _defaultIntro,
                items: [
                    "Validate that the listed open ports are accurate and required.",
                    "Close or block unused or unauthorized ports.",
                    "Confirm that exposed services are hardened and updated.",
                    "Monitor regularly for unexpected changes in open ports."
                ]
            },

            // --- Internet Names & Domains ---
            "INTERNET_NAME": {
                title: "Internet Name",
                intro: _defaultIntro,
                items: [
                    "Validate listed internet names are correct and active.",
                    "Remove or update unused or incorrect entries.",
                    "Verify that naming conventions follow company policy.",
                    "Document ownership for accountability and lifecycle management."
                ]
            },
            "DOMAIN_NAME": {
                title: "Domain Name",
                intro: _defaultIntro,
                items: [
                    "Ensure domains are registered under the correct registrar and ownership is current.",
                    "Renew domains before expiration to prevent hijacking.",
                    "Apply registrar lock where possible and limit WHOIS exposure of sensitive contact info."
                ]
            },
            "DOMAIN_REGISTRAR": {
                title: "Domain Registrar",
                intro: _defaultIntro,
                items: [
                    "Ensure domains are registered under the correct registrar and ownership is current.",
                    "Renew domains before expiration to prevent hijacking.",
                    "Apply registrar lock where possible and limit WHOIS exposure of sensitive contact info."
                ]
            },
            "DOMAIN_NAME_PARENT": {
                title: "Domain Name Parent",
                intro: _defaultIntro,
                items: [
                    "Ensure domains are registered under the correct registrar and ownership is current.",
                    "Renew domains before expiration to prevent hijacking.",
                    "Apply registrar lock where possible and limit WHOIS exposure of sensitive contact info."
                ]
            },
            "DOMAIN_WHOIS": {
                title: "Domain WHOIS",
                intro: _defaultIntro,
                items: [
                    "Ensure domains are registered under the correct registrar and ownership is current.",
                    "Renew domains before expiration to prevent hijacking.",
                    "Apply registrar lock where possible and limit WHOIS exposure of sensitive contact info."
                ]
            },

            // --- DNS ---
            "DNS_SPF": {
                title: "DNS SPF",
                intro: _defaultIntro,
                items: [
                    "Confirm SPF and other DNS TXT records are correctly configured for the organization's mail domain(s).",
                    "Remove obsolete records and ensure policies align with DMARC/DKIM requirements.",
                    "Monitor DNS for unauthorized or malicious record changes."
                ]
            },
            "DNS_TEXT": {
                title: "DNS Text",
                intro: _defaultIntro,
                items: [
                    "Confirm SPF and other DNS TXT records are correctly configured for the organization's mail domain(s).",
                    "Remove obsolete records and ensure policies align with DMARC/DKIM requirements.",
                    "Monitor DNS for unauthorized or malicious record changes."
                ]
            },

            // --- Web Server & Technology ---
            "WEBSERVER_TECHNOLOGY": {
                title: "Webserver Technology",
                intro: _defaultIntro,
                items: [
                    "Confirm that the listed web server technologies are accurate.",
                    "Remove or update outdated or incorrect entries.",
                    "Verify that web server versions are supported and patched.",
                    "Standardize server technologies to simplify management."
                ]
            },
            "WEBSERVER_STRANGEHEADER": {
                title: "Webserver Strange Header",
                intro: _defaultIntro,
                items: [
                    "Validate whether the unusual or unexpected HTTP headers are intentional.",
                    "Remove or sanitize headers that disclose unnecessary system details (ex: internal software versions, debug info).",
                    "If required by application logic, document the purpose of the header and ensure it is safe to expose externally."
                ]
            },
            "HTTP_CODE": {
                title: "HTTP Code",
                intro: _defaultIntro,
                items: [
                    "Validate that listed sources and return codes are correct.",
                    "Identify and remove incorrect or unnecessary codes.",
                    "Investigate unexpected error codes for misconfiguration.",
                    "Monitor for changes that could indicate unauthorized behavior."
                ]
            },
            "SOFTWARE_USED": {
                title: "Software Used",
                intro: _defaultIntro,
                items: [
                    "Verify all detected software packages are valid and currently supported.",
                    "Remove unused or outdated software from public systems.",
                    "Track versions to ensure timely patching and upgrades."
                ]
            },

            // --- URLs ---
            "URL_PASSWORD": {
                title: "URL Password",
                intro: _defaultIntro,
                items: [
                    "Validate listed URLs are correct and necessary.",
                    "Confirm that password utilities are still required for function.",
                    "Remove outdated or unused password-related endpoints.",
                    "Ensure strong authentication and access control are enforced."
                ]
            },
            "URL_PASSWORD_HISTORIC": {
                title: "URL Password Historic",
                intro: _defaultIntro,
                items: [
                    "Validate that listed URLs are correct and relevant.",
                    "Remove obsolete or unnecessary entries.",
                    "Confirm no legacy password utilities are exposed.",
                    "Enforce secure handling of password-related functionality."
                ]
            },
            "URL_UPLOAD": {
                title: "URL Upload",
                intro: _defaultIntro,
                items: [
                    "Validate listed URLs are correct and in use.",
                    "Confirm file upload utilities are still required for functionality.",
                    "Remove or disable unused upload functions.",
                    "Apply security controls (file type restrictions, malware scanning, access validation)."
                ]
            },
            "URL_FORM": {
                title: "URL Form",
                intro: _defaultIntro,
                items: [
                    "Validate listed URLs are correct and active.",
                    "Identify and remove unnecessary or outdated forms.",
                    "Confirm forms use secure transmission (HTTPS, CSRF protections).",
                    "Monitor forms for misuse or injection attempts."
                ]
            },
            "URL_STATIC": {
                title: "URL Static",
                intro: _defaultIntro,
                items: [
                    "Validate listed URLs are correct and relevant.",
                    "Remove outdated or unnecessary static content.",
                    "Ensure static content does not expose sensitive data.",
                    "Apply caching and integrity controls where appropriate."
                ]
            },
            "URL_JAVASCRIPT": {
                title: "URL JavaScript",
                intro: _defaultIntro,
                items: [
                    "Validate listed URLs are correct and required.",
                    "Remove outdated or unused JavaScript files.",
                    "Ensure scripts are loaded securely (HTTPS, integrity checks).",
                    "Monitor for injection or unauthorized modifications."
                ]
            },
            "URL_WEB_FRAMEWORK": {
                title: "URL Web Framework",
                intro: _defaultIntro,
                items: [
                    "Confirm the detected web framework is correct and in active use.",
                    "Review versioning \u2014 if outdated, plan to upgrade or patch to supported releases.",
                    "Ensure the framework's admin/debug utilities are not exposed externally."
                ]
            },

            // --- Web Content ---
            "TARGET_WEB_CONTENT": {
                title: "Target Web Content",
                intro: _defaultIntro,
                items: [
                    "Confirm that sources and return content are correct.",
                    "Remove or correct any invalid or outdated content.",
                    "Ensure sensitive information is not unintentionally exposed.",
                    "Monitor content changes for anomalies or defacement attempts."
                ]
            },
            "TARGET_WEB_CONTENT_TYPE": {
                title: "Target Web Content Type",
                intro: _defaultIntro,
                items: [
                    "Validate that content types match expected application use.",
                    "Remove or correct unnecessary or incorrect entries.",
                    "Ensure content types do not expose vulnerabilities (ex: MIME misconfigurations).",
                    "Standardize content type usage across applications."
                ]
            },

            // --- Email ---
            "EMAILADDR": {
                title: "Email Address",
                intro: _defaultIntro,
                items: [
                    "Validate that email addresses are accurate and active.",
                    "Remove or update incorrect or inactive addresses.",
                    "Confirm addresses follow organizational naming conventions.",
                    "Review for unnecessary public exposure."
                ]
            },
            "EMAILADDR_COMPROMISED": {
                title: "Email Address Compromised",
                intro: _defaultIntro,
                items: [
                    "Validate compromised email addresses are correct.",
                    "Investigate affected accounts for unauthorized activity.",
                    "Reset passwords and enforce MFA.",
                    "Provide targeted training for compromised users."
                ]
            },
            "MALICIOUS_EMAILADDR": {
                title: "Malicious Email Address",
                intro: _defaultIntro,
                items: [
                    "Verify whether the email addresses listed have been targeted in phishing, spam, or malicious campaigns.",
                    "Block or flag malicious sender addresses at the email gateway.",
                    "Educate employees to recognize and report emails originating from flagged addresses."
                ]
            },

            // --- Credentials & Accounts ---
            "PASSWORD_COMPROMISED": {
                title: "Breached Credentials",
                intro: _defaultIntro,
                items: [
                    "Monitor for new breached credentials regularly.",
                    "Investigate if affected accounts are still active.",
                    "Reset passwords and enforce MFA where necessary.",
                    "Provide employee security awareness training."
                ]
            },
            "ACCOUNT_EXTERNAL_OWNED_COMPROMISED": {
                title: "Breached Credentials",
                intro: _defaultIntro,
                items: [
                    "Monitor for new breached credentials regularly.",
                    "Investigate if affected accounts are still active.",
                    "Reset passwords and enforce MFA where necessary.",
                    "Provide employee security awareness training."
                ]
            },
            "USERNAME": {
                title: "Username",
                intro: _defaultIntro,
                items: [
                    "Confirm whether exposed usernames are active.",
                    "Remove or disable unnecessary accounts.",
                    "Ensure multi-factor authentication (MFA) is required for all valid organization-related accounts and monitor for brute-force attempts against exposed accounts."
                ]
            },
            "ACCOUNT_EXTERNAL_OWNED": {
                title: "Account External Owned",
                intro: _defaultIntro,
                items: [
                    "Confirm external accounts (ex: SaaS, cloud, social logins) are authorized and managed.",
                    "Decommission unused accounts.",
                    "Enforce MFA and strong password policies on all accounts."
                ]
            },

            // --- Identity / Personal Info ---
            "HUMAN_NAME": {
                title: "Human Name",
                intro: _defaultIntro,
                items: [
                    "Validate whether exposure of personal names is appropriate (ex: public employees vs. sensitive staff).",
                    "Redact or limit unnecessary personal identifiers in public assets.",
                    "Review data leakage sources (documents, code commits, metadata)."
                ]
            },
            "PHONE_NUMBER": {
                title: "Phone Number",
                intro: _defaultIntro,
                items: [
                    "Confirm listed phone numbers are still valid and intended to be public-facing.",
                    "Remove or obfuscate any internal, private, or employee personal numbers that should not be published.",
                    "Route all public-facing phone numbers through approved contact centers."
                ]
            },
            "PHYSICAL_ADDRESS": {
                title: "Physical Address",
                intro: _defaultIntro,
                items: [
                    "Validate whether physical addresses are legitimate company assets.",
                    "Ensure sensitive or non-public office/employee addresses are not disclosed externally.",
                    "For public addresses, confirm accuracy and remove duplicates."
                ]
            },
            "PHYSICAL_COORDINATES": {
                title: "Physical Coordinates",
                intro: _defaultIntro,
                items: [
                    "Confirm listed coordinates are valid and relevant.",
                    "Remove or update obsolete entries.",
                    "Ensure no sensitive site locations are exposed.",
                    "Monitor for unauthorized use of location data."
                ]
            },
            "GEOINFO": {
                title: "Geographic Information",
                intro: _defaultIntro,
                items: [
                    "Validate geographic information accuracy.",
                    "Remove or correct outdated or irrelevant entries.",
                    "Confirm no unnecessary location data is exposed.",
                    "Monitor for misuse of geolocation information."
                ]
            },

            // --- Cryptographic ---
            "PGP_KEY": {
                title: "PGP Key",
                intro: _defaultIntro,
                items: [
                    "Confirm the PGP key is valid and intended for public use.",
                    "Retire any old or unused keys, and ensure all active keys are properly managed.",
                    "Document ownership and rotation practices for cryptographic keys."
                ]
            },
            "HASH": {
                title: "Hash",
                intro: _defaultIntro,
                items: [
                    "Determine whether the hash corresponds to a leaked password, file, or artifact.",
                    "If sensitive, rotate the underlying credential and investigate possible compromise.",
                    "Avoid exposing cryptographic hashes in public sources unless necessary (ex: software integrity checks)."
                ]
            },

            // --- Files ---
            "INTERESTING_FILE": {
                title: "Interesting File",
                intro: _defaultIntro,
                items: [
                    "Review files flagged as interesting for sensitive data.",
                    "Remove or secure files not intended for public access.",
                    "Confirm file permissions are correctly applied.",
                    "Monitor for recurrence of exposed sensitive files."
                ]
            },
            "INTERESTING_FILE_HISTORIC": {
                title: "Interesting File Historic",
                intro: _defaultIntro,
                items: [
                    "Review previously exposed files for sensitive information that may still be cached or archived externally.",
                    "Request takedowns where possible and ensure the files are no longer accessible.",
                    "Monitor for reappearance in future scans."
                ]
            },

            // --- SSL Certificates ---
            "SSL_CERTIFICATE_EXPIRING": {
                title: "SSL Certificate Expiring",
                intro: _defaultIntro,
                items: [
                    "Validate all certificate expiration dates.",
                    "Ensure timely renewal of certificates before expiry.",
                    "Review certificate renewal processes for improvements.",
                    "Automate monitoring to prevent lapses."
                ]
            },
            "SSL_CERTIFICATE_MISMATCH": {
                title: "SSL Certificate Mismatch",
                intro: _defaultIntro,
                items: [
                    "Confirm certificates match the domains they protect.",
                    "Replace or reissue mismatched certificates.",
                    "Review certificate creation and deployment process.",
                    "Automate certificate management to reduce errors."
                ]
            },
            "SSL_CERTIFICATE_ISSUED": {
                title: "SSL Certificate Issued",
                intro: _defaultIntro,
                items: [
                    "Confirm that certificates are issued by a trusted CA and properly bound to the intended hostname(s).",
                    "Replace any certificates issued by untrusted or test CAs.",
                    "Standardize issuance from a central certificate authority to prevent inconsistencies."
                ]
            },
            "SSL_CERTIFICATE_ISSUER": {
                title: "SSL Certificate Issuer",
                intro: _defaultIntro,
                items: [
                    "Confirm that certificates are issued by a trusted CA and properly bound to the intended hostname(s).",
                    "Replace any certificates issued by untrusted or test CAs.",
                    "Standardize issuance from a central certificate authority to prevent inconsistencies."
                ]
            },

            // --- Blacklisted / Malicious ---
            "BLACKLISTED_IPADDR": {
                title: "Blacklisted IP Address",
                intro: _defaultIntro,
                items: [
                    "Investigate why company IPs or subnets are blacklisted.",
                    "Remediate any underlying compromise (ex: spam relay, malware infection).",
                    "Submit delisting requests once issues are resolved.",
                    "Monitor continuously for reappearance."
                ]
            },
            "MALICIOUS_IPADDR": {
                title: "Malicious IP Address",
                intro: _defaultIntro,
                items: [
                    "Investigate why company IPs or subnets are blacklisted.",
                    "Remediate any underlying compromise (ex: spam relay, malware infection).",
                    "Submit delisting requests once issues are resolved.",
                    "Monitor continuously for reappearance."
                ]
            },
            "BLACKLISTED_SUBNET": {
                title: "Blacklisted Subnet",
                intro: _defaultIntro,
                items: [
                    "Investigate why company IPs or subnets are blacklisted.",
                    "Remediate any underlying compromise (ex: spam relay, malware infection).",
                    "Submit delisting requests once issues are resolved.",
                    "Monitor continuously for reappearance."
                ]
            },
            "MALICIOUS_SUBNET": {
                title: "Malicious Subnet",
                intro: _defaultIntro,
                items: [
                    "Investigate why company IPs or subnets are blacklisted.",
                    "Remediate any underlying compromise (ex: spam relay, malware infection).",
                    "Submit delisting requests once issues are resolved.",
                    "Monitor continuously for reappearance."
                ]
            },

            // --- Social & Apps ---
            "SOCIAL_MEDIA": {
                title: "Social Media",
                intro: _defaultIntro,
                items: [
                    "Validate that identified social media accounts are official and managed by the company.",
                    "Report and remove fake or impersonating accounts.",
                    "Ensure corporate accounts have secure logins and account recovery processes."
                ]
            },
            "APPSTORE_ENTRY": {
                title: "App Store Entry",
                intro: _defaultIntro,
                items: [
                    "Confirm all app store entries are official and accurate.",
                    "Remove or report fraudulent or outdated entries.",
                    "Ensure apps are signed and are up to date.",
                    "Monitor for impersonation or malicious clones."
                ]
            },

            // --- Code Repos ---
            "PUBLIC_CODE_REPO": {
                title: "Public Code Repository",
                intro: _defaultIntro,
                items: [
                    "Review repositories for exposed credentials, API keys, or sensitive configurations.",
                    "Remove sensitive data and rotate any leaked secrets.",
                    "Apply .gitignore and secret-scanning tools (ex: GitGuardian, Trufflehog) to prevent recurrence."
                ]
            }
        };

        function closeInfoPanel() {
            _infoPanelOpen = false;
            _infoPanelMode = null;
            $("#btn-module-info").removeClass('active');
            $("#btn-instructions").removeClass('active');
            var el = document.getElementById("info-panel-wrapper");
            if (el) {
                el.style.display = "none";
                el.className = "info-panel-wrapper";
            }
        }

        function openInfoPanel(mode, contentHtml, titleText, iconClass) {
            var wrapper = document.getElementById("info-panel-wrapper");
            var content = document.getElementById("info-panel-content");
            var titleEl = document.getElementById("info-panel-title-text");
            var iconEl = document.getElementById("info-panel-icon");

            if (!wrapper) {
                alertify.error("BUG: info-panel-wrapper not found in DOM");
                return;
            }

            // If same mode is open, close it (toggle)
            if (_infoPanelOpen && _infoPanelMode === mode) {
                closeInfoPanel();
                return;
            }

            // Set content, title, and icon
            if (titleEl) titleEl.textContent = titleText;
            if (iconEl) iconEl.className = 'glyphicon ' + iconClass;
            if (content) content.innerHTML = contentHtml;

            // Set mode class for styling
            wrapper.className = "info-panel-wrapper mode-" + mode;

            // Show the panel  simple display toggle, no animation
            wrapper.style.display = "block";
            _infoPanelOpen = true;
            _infoPanelMode = mode;
            updatePanelButtonStates(mode);
        }

        function updatePanelButtonStates(mode) {
            if (mode === 'module-info') {
                $("#btn-module-info").addClass('active');
                $("#btn-instructions").removeClass('active');
            } else {
                $("#btn-instructions").addClass('active');
                $("#btn-module-info").removeClass('active');
            }
        }

        function buildModuleInfoHtml(modules) {
            if (!modules || modules.length === 0) {
                return '<div class="info-panel-empty"><i class="glyphicon glyphicon-exclamation-sign"></i> No module information available for this data type.</div>';
            }
            var html = '<div class="module-info-grid">';
            for (var i = 0; i < modules.length; i++) {
                var mod = modules[i];
                var catBadges = '';
                if (mod.cats && mod.cats.length) {
                    for (var j = 0; j < mod.cats.length; j++) {
                        catBadges += '<span class="module-cat-badge">' + sf.escapeHtml(mod.cats[j]) + '</span>';
                    }
                }
                html += '<div class="module-info-card">';
                html += '<div class="module-info-card-header">';
                html += '<span class="module-info-name">' + sf.escapeHtml(mod.name) + '</span>';
                html += '<span class="module-info-id">' + sf.escapeHtml(mod.module) + '</span>';
                html += '</div>';
                if (mod.summary) {
                    html += '<div class="module-info-summary">' + sf.escapeHtml(mod.summary) + '</div>';
                }
                if (catBadges) {
                    html += '<div class="module-info-cats">' + catBadges + '</div>';
                }
                html += '</div>';
            }
            html += '</div>';
            return html;
        }

        function buildInstructionsHtml(data) {
            var html = '<div class="instructions-content">';
            html += '<h3 class="instructions-heading">' + sf.escapeHtml(data.title) + '</h3>';
            html += '<p class="instructions-intro">' + sf.escapeHtml(data.intro) + '</p>';
            html += '<ul class="instructions-list">';
            for (var i = 0; i < data.items.length; i++) {
                html += '<li class="instructions-item">';
                html += '<span class="instructions-bullet">' + (i + 1) + '</span>';
                html += '<span class="instructions-text">' + sf.escapeHtml(data.items[i]) + '</span>';
                html += '</li>';
            }
            html += '</ul>';
            html += '</div>';
            return html;
        }

        function showModuleInfo() {
            sf.log("showModuleInfo() called, currentType=" + currentType);
            if (!currentType || currentType === "ALL") {
                alertify.error("Cannot show module info: no data type selected.");
                return;
            }

            // If cache exists, render immediately
            if (_modulesCache) {
                renderModuleInfo(_modulesCache);
                return;
            }

            // Fetch modules from API via GET
            $.ajax({
                type: "GET",
                url: docroot + "/modules",
                cache: false,
                dataType: "json"
            }).done(function(data) {
                if (data && typeof data.length !== 'undefined') {
                    _modulesCache = data;
                    renderModuleInfo(data);
                } else {
                    alertify.error("Module info: unexpected response format");
                }
            }).fail(function(xhr, status, err) {
                alertify.error("Module info request failed: " + status + " " + err);
                sf.log("showModuleInfo AJAX failed: " + status + " " + err);
            });
        }

        function renderModuleInfo(allModules) {
            // Filter modules that produce the current type
            var relevant = [];
            for (var i = 0; i < allModules.length; i++) {
                var mod = allModules[i];
                if (mod.provides && mod.provides.indexOf(currentType) !== -1) {
                    relevant.push({
                        module: mod.name,
                        name: mod.label || mod.name,
                        summary: mod.summary || mod.descr || '',
                        cats: mod.cats || mod.group || []
                    });
                }
            }
            // Sort by name
            relevant.sort(function(a, b) { return a.name.localeCompare(b.name); });
            var html = buildModuleInfoHtml(relevant);
            var count = relevant.length;
            openInfoPanel('module-info', html, 'MODULE INFO  ' + count + ' MODULE' + (count !== 1 ? 'S' : '') + ' PRODUCE ' + currentType, 'glyphicon-info-sign');
        }

        function showInstructions() {
            sf.log("showInstructions() called, currentType=" + currentType);
            if (!currentType || currentType === "ALL") {
                alertify.error("Cannot show instructions: no data type selected.");
                return;
            }
            var data = _instructionsMap[currentType];
            if (!data) {
                alertify.error("No review instructions mapped for: " + currentType);
                return;
            }
            var html = buildInstructionsHtml(data);
            openInfoPanel('instructions', html, 'REVIEW INSTRUCTIONS \u2014 ' + currentType, 'glyphicon-education');
        }

        // Update button disabled states based on current type
        function updateInfoButtonStates() {
            // Close panel when switching types
            if (_infoPanelOpen) {
                closeInfoPanel();
            }
            var btnMod = document.getElementById("btn-module-info");
            var btnInst = document.getElementById("btn-instructions");
            if (!currentType || currentType === "ALL") {
                if (btnMod) { btnMod.disabled = true; btnMod.classList.add('disabled'); }
                if (btnInst) { btnInst.disabled = true; btnInst.classList.add('disabled'); }
                return;
            }
            // Module info is always available (every type has producing modules)
            if (btnMod) { btnMod.disabled = false; btnMod.classList.remove('disabled'); }

            // Instructions: only enable if mapping exists
            if (_instructionsMap[currentType]) {
                if (btnInst) { btnInst.disabled = false; btnInst.classList.remove('disabled'); }
            } else {
                if (btnInst) { btnInst.disabled = true; btnInst.classList.add('disabled'); }
            }
        }

        function navTo(target) {
            // Save scroll position in current history state before navigating away
            if (!_skipHistoryPush && history.state) {
                var s = history.state;
                s.scrollY = window.scrollY;
                history.replaceState(s, '', window.location.href);
            }
            var targets = [ "btn-data", "btn-info",
                "btn-export", "btn-download-logs", "btn-viz",
                "btn-status", "btn-graph", "btn-findings", "btn-assets" ]
            for (var i = 0; i < targets.length; i++) {
                if (targets[i] == target) {
                    $("#" + targets[i]).addClass("active");
                } else {
                    $("#" + targets[i]).removeClass("active");
                }
            }

            currentSection = target;
            updatePageTitle();

            // Restore default export dropdown when navigating away from vulns/findings
            if (target !== 'btn-graph' && target !== 'btn-findings' && defaultExportDropdownHtml) {
                $('#export-dropdown-menu').html(defaultExportDropdownHtml);
            }

            $("#breadcrumbs").remove();
            $("#stats-bar").remove();
            $("#dedup-bar").remove();
            $(".data-list-legend").remove();
            $("#customtabview").hide();
            $("#customvizview").hide();
            $("#modifyactions").hide();
            // Hide selection toolbar and remove header highlights when navigating away
            hideSelectionToolbar();
            highlightTableHeaders(false);
            dataloaders = []
        }

        function searchDirector(instanceId) {
            qry = $("#searchvalue").val();
            if (currentType == "ALL") {
                searchResults(instanceId, qry);
            } else {
                searchResults(instanceId, qry, currentType);
            }
        }

        function searchResults(instanceId, query, typeName) {
            // Remove pre-existing tables if they exist
            $("#scansummary-content").remove();
            $("#ai-correlation-section").remove();
            $("#ai-correlation-table-single").remove();
            $("#ai-correlation-table-cross").remove();
            $("#scanlogs-content").remove();
            $("#stats-bar").remove();
            $("#dedup-bar").remove();
            navTo("btn-search");
            pushViewState('btn-search', {searchQuery: query, searchType: typeName || 'ALL'});
            $("#modifyactions").hide();
            $("#loader").show();
            $("#btn-export").show();
            $("#btn-download-logs").hide();
            $("#btn-refresh").show();
            $("#btn-search").show();
            $("#scanreminder").hide();
            refresh = function() { searchResults(instanceId, query, typeName); }
            sf.search(instanceId, query, typeName, function(data) {
                            lastSearchType = typeName;
                            lastSearchQuery = query;

                            if (data.length == 0) {
                                var table = "<div id='scansummary-content'>&nbsp;&nbsp;No results found. Try broadening your search criteria.</div>";
                            } else {
                                // Search results info bar
                                var infoBar = "<div class='search-results-info'>Search results: " + data.length + " records</div>";

                                var table = "<table id='scansummary-content' class='table table-bordered table-striped small tablesorter'><thead><tr>";
                                if (typeName == null) {
                                    table += "<th class='sorter-false'>Data Element Type</th>";
                                }
                                table += "<th>Data Element</th><th>Source Data Element</th><th>Source Module</th><th>Identified</th></tr></thead><tbody>";
                                for (var i = 0; i < data.length; i++) {
                                    table += "<tr>";
                                    if (typeName == null) {
                                        table += "<td><pre class='table-border-bg-inherit'>" + data[i][8] + "</pre></td>";
                                    }
                                    table += "<td><pre class='table-border-bg-inherit'>";
                                    table += sf.replace_sfurltag(data[i][1]);
                                    // for debug
                                    table += "</pre></td><td><pre class='table-border-bg-inherit'>";
                                    table += sf.replace_sfurltag(data[i][2]);
                                    table += "</pre></td><td><pre class='table-border-bg-inherit'>" + data[i][3];
                                    table += "</pre></td><td><pre class='table-border-bg-inherit'>" + data[i][0];
                                    table += "</pre></td>";
                                    table += "</tr>";
                                }
                                table += "</tbody></table>"
                                table = infoBar + table;
                            }
                            $("#loader").fadeOut(500);
                            $("#mainbody").append(table);
                            $("#scansummary-content").tablesorter();
            });
        }

        // Vulnerabilities page - NESSUS and BURP imports with data tables
        var vulnActiveTab = 'nessus';
        var vulnInstanceId = null;

        function viewVulnerabilities(instanceId) {
            $("#scansummary-content").remove();
            $("#ai-correlation-section").remove();
            $("#ai-correlation-table-single").remove();
            $("#ai-correlation-table-cross").remove();
            $("#scanlogs-content").remove();
            $("#stats-bar").remove();
            $("#dedup-bar").remove();
            $("#btn-export").show();
            $("#btn-download-logs").hide();
            $("#btn-refresh").show();
            $("#btn-search").hide();
            $("#scanreminder").hide();
            navTo("btn-graph");
            pushViewState('btn-graph');
            vulnInstanceId = instanceId;
            currentSection = 'btn-graph';
            refresh = function() { viewVulnerabilities(instanceId); }

            // Save default export dropdown and replace with vuln-specific options
            if (!defaultExportDropdownHtml) {
                defaultExportDropdownHtml = $('#export-dropdown-menu').html();
            }
            var vulnExportHtml = '';
            vulnExportHtml += "<li class='dropdown-header'>Vulnerability Export</li>";
            vulnExportHtml += "<li><a class='link' onClick='exportEventData(\"" + instanceId + "\", \"\", \"csv\", \"full\")'>CSV (EXT-VULNS.csv + WEBAPP-VULNS.csv)</a></li>";
            vulnExportHtml += "<li><a class='link' onClick='exportEventData(\"" + instanceId + "\", \"\", \"excel\", \"full\")'>Excel (VULNS.xlsx - two tabs)</a></li>";
            $('#export-dropdown-menu').html(vulnExportHtml);

            var grid = "<div id='scansummary-content'>";
            grid += "<div class='vuln-container'>";
            grid += "<div class='vuln-tab-bar'>";
            grid += "<button id='vuln-btn-nessus' class='vuln-tab-btn active' onclick='switchVulnTab(\"nessus\", \"" + instanceId + "\")'>";
            grid += "<span class='vuln-btn-icon'><i class='glyphicon glyphicon-shield'></i></span>";
            grid += "<span class='vuln-btn-label'>EXTERNAL VULNERABILITIES</span>";
            grid += "<span class='vuln-btn-sub'>NESSUS PRO</span>";
            grid += "</button>";
            grid += "<button id='vuln-btn-burp' class='vuln-tab-btn' onclick='switchVulnTab(\"burp\", \"" + instanceId + "\")'>";
            grid += "<span class='vuln-btn-icon'><i class='glyphicon glyphicon-globe'></i></span>";
            grid += "<span class='vuln-btn-label'>WEB APP VULNERABILITIES</span>";
            grid += "<span class='vuln-btn-sub'>BURP SUITE PRO</span>";
            grid += "</button>";
            grid += "</div>";
            grid += "<div class='vuln-content'>";
            grid += "<div id='vuln-nessus-content' class='vuln-panel'></div>";
            grid += "<div id='vuln-burp-content' class='vuln-panel' style='display:none'></div>";
            grid += "</div></div></div>";

            $("#mainbody").append(grid);
            $("#loader").hide();

            // Load Nessus data for default tab
            loadNessusData(instanceId);
        }

        // =====================================================================
        // ASSETS PAGE
        // =====================================================================
        var currentAssetsView = 'overview';
        var assetsTarget = '${seedtarget}';
        var assetsInstanceId = null;

        function viewAssets(instanceId) {
            $("#scansummary-content").remove();
            $("#ai-correlation-section").remove();
            $("#ai-correlation-table-single").remove();
            $("#ai-correlation-table-cross").remove();
            $("#scanlogs-content").remove();
            $("#stats-bar").remove();
            $("#dedup-bar").remove();
            $("#btn-export").hide();
            $("#btn-download-logs").hide();
            $("#btn-refresh").show();
            $("#btn-search").hide();
            $("#customtabview").hide();
            $("#modifyactions").hide();
            $("#scanreminder").hide();
            navTo("btn-assets");
            pushViewState('btn-assets', {assetsView: 'overview'});
            currentSection = 'btn-assets';
            refresh = function() { viewAssets(instanceId); }

            var grid = "<div id='scansummary-content'>";

            // Top button bar for view switching
            grid += "<div class='assets-view-bar'>";
            grid += "<div class='assets-view-buttons'>";
            grid += "<button id='assets-btn-overview' class='assets-view-btn assets-view-btn-active' onclick='assetsShowOverview(\"" + instanceId + "\")'>";
            grid += "<i class='glyphicon glyphicon-dashboard'></i>&nbsp;&nbsp;OVERVIEW</button>";
            grid += "<button id='assets-btn-known' class='assets-view-btn' onclick='assetsShowKnown(\"" + instanceId + "\")'>";
            grid += "<i class='glyphicon glyphicon-list'></i>&nbsp;&nbsp;KNOWN ASSETS</button>";
            grid += "<button id='assets-btn-potential' class='assets-view-btn' onclick='assetsShowPotential(\"" + instanceId + "\")'>";
            grid += "<i class='glyphicon glyphicon-search'></i>&nbsp;&nbsp;POTENTIAL MATCHES</button>";
            grid += "</div>";
            // Action buttons
            grid += "<div class='assets-action-buttons'>";
            grid += "<button class='btn btn-sm assets-sync-btn' onclick='assetsSyncVerified(\"" + instanceId + "\")'>";
            grid += "<i class='glyphicon glyphicon-refresh'></i>&nbsp;&nbsp;SYNC VERIFIED</button>";
            grid += "<button class='btn btn-sm assets-import-btn' onclick='assetsShowImportModal()'>";
            grid += "<i class='glyphicon glyphicon-upload'></i>&nbsp;&nbsp;IMPORT LIST</button>";
            grid += "<button class='btn btn-sm assets-add-btn' onclick='assetsShowAddModal()'>";
            grid += "<i class='glyphicon glyphicon-plus'></i>&nbsp;&nbsp;ADD ASSET</button>";
            grid += "<a class='btn btn-sm assets-export-btn' href='${docroot}/knownassetexport?target=" + encodeURIComponent(assetsTarget) + "&format=excel'>";
            grid += "<i class='glyphicon glyphicon-download-alt'></i>&nbsp;&nbsp;EXPORT</a>";
            grid += "</div>";
            grid += "</div>";

            // Content container
            grid += "<div id='assets-content'></div>";
            grid += "</div>";

            // Import Modal
            grid += "<div id='assets-import-modal' class='assets-modal-overlay' style='display:none;'>";
            grid += "<div class='assets-modal'>";
            grid += "<div class='assets-modal-header'>";
            grid += "<span class='assets-modal-title'>IMPORT KNOWN ASSETS</span>";
            grid += "<button class='close-btn' onclick='assetsCloseModals()'>&times;</button>";
            grid += "</div>";
            grid += "<div class='assets-modal-body'>";
            grid += "<div class='form-group'><label class='assets-label'>ASSET TYPE</label>";
            grid += "<select id='import-asset-type' class='form-control assets-input'>";
            grid += "<option value='ip'>IP ADDRESSES</option>";
            grid += "<option value='domain'>DOMAINS / SUBDOMAINS</option>";
            grid += "<option value='employee'>EMPLOYEE NAMES</option>";
            grid += "</select></div>";
            grid += "<div class='form-group'><label class='assets-label'>FILE (.TXT, .CSV, .XLSX)</label>";
            grid += "<input type='file' id='import-asset-file' class='form-control assets-input' accept='.txt,.csv,.xlsx,.xls'></div>";
            grid += "<p class='assets-hint'>TXT: ONE VALUE PER LINE. CSV/XLSX: FIRST COLUMN USED. HEADER ROWS AUTO-DETECTED.</p>";
            grid += "</div>";
            grid += "<div class='assets-modal-footer'>";
            grid += "<button class='btn assets-btn-cancel' onclick='assetsCloseModals()'>CANCEL</button>";
            grid += "<button class='btn assets-btn-confirm' onclick='assetsDoImport(\"" + instanceId + "\")'>IMPORT</button>";
            grid += "</div></div></div>";

            // Add Single Asset Modal
            grid += "<div id='assets-add-modal' class='assets-modal-overlay' style='display:none;'>";
            grid += "<div class='assets-modal'>";
            grid += "<div class='assets-modal-header'>";
            grid += "<span class='assets-modal-title'>ADD KNOWN ASSET</span>";
            grid += "<button class='close-btn' onclick='assetsCloseModals()'>&times;</button>";
            grid += "</div>";
            grid += "<div class='assets-modal-body'>";
            grid += "<div class='form-group'><label class='assets-label'>ASSET TYPE</label>";
            grid += "<select id='add-asset-type' class='form-control assets-input'>";
            grid += "<option value='ip'>IP ADDRESS</option>";
            grid += "<option value='domain'>DOMAIN / SUBDOMAIN</option>";
            grid += "<option value='employee'>EMPLOYEE NAME</option>";
            grid += "</select></div>";
            grid += "<div class='form-group'><label class='assets-label'>VALUE</label>";
            grid += "<input type='text' id='add-asset-value' class='form-control assets-input' placeholder='e.g. 192.168.1.1 or corp.example.com'></div>";
            grid += "<div class='form-group'><label class='assets-label'>SOURCE</label>";
            grid += "<select id='add-asset-source' class='form-control assets-input'>";
            grid += "<option value='CLIENT_PROVIDED'>CLIENT PROVIDED</option>";
            grid += "<option value='ANALYST_CONFIRMED'>ANALYST CONFIRMED</option>";
            grid += "</select></div>";
            grid += "<div class='form-group'><label class='assets-label'>NOTES (OPTIONAL)</label>";
            grid += "<input type='text' id='add-asset-notes' class='form-control assets-input' placeholder='Optional notes'></div>";
            grid += "</div>";
            grid += "<div class='assets-modal-footer'>";
            grid += "<button class='btn assets-btn-cancel' onclick='assetsCloseModals()'>CANCEL</button>";
            grid += "<button class='btn assets-btn-confirm' onclick='assetsDoAdd(\"" + instanceId + "\")'>ADD ASSET</button>";
            grid += "</div></div></div>";

            $("#mainbody").append(grid);

            // Load the default view
            assetsShowOverview(instanceId);
        }

        function assetsSetActiveBtn(viewName) {
            $(".assets-view-btn").removeClass("assets-view-btn-active");
            $("#assets-btn-" + viewName).addClass("assets-view-btn-active");
            currentAssetsView = viewName;
        }

        function assetsShowImportModal() { $("#assets-import-modal").show(); }
        function assetsShowAddModal() { $("#assets-add-modal").show(); }
        function assetsCloseModals() { $(".assets-modal-overlay").hide(); }

        // ---- SYNC VERIFIED  KNOWN ASSETS ----
        function assetsSyncVerified(instanceId) {
            alertify.success("SYNCING VERIFIED ENTRIES...");
            sf.fetchData('${docroot}/knownassetsyncverified', {id: instanceId}, function(ret) {
                if (ret[0] === "SUCCESS") {
                    alertify.success(ret[1]);
                    if (currentAssetsView === 'overview') assetsShowOverview(instanceId);
                    else if (currentAssetsView === 'known') assetsShowKnown(instanceId);
                    else if (currentAssetsView === 'potential') assetsShowPotential(instanceId);
                } else {
                    alertify.error("SYNC FAILED: " + ret[1]);
                }
            });
        }

        // ---- OVERVIEW VIEW ----
        function assetsShowOverview(instanceId) {
            assetsSetActiveBtn('overview');
            pushViewState('btn-assets', {assetsView: 'overview'});
            $("#assets-content").html("<div class='assets-loader'><img src='${docroot}/static/img/loader.gif'></div>");

            // Fetch counts and matches in parallel
            var countsLoaded = false, matchesLoaded = false;
            var counts = {total:0, client_provided:0, analyst_confirmed:0, by_type:{ip:0, domain:0, employee:0}};
            var matchData = [];

            sf.fetchData('${docroot}/knownassetcount', {target: assetsTarget}, function(data) {
                counts = data;
                countsLoaded = true;
                if (matchesLoaded) renderOverview(instanceId, counts, matchData);
            });

            sf.fetchData('${docroot}/knownassetmatches', {id: instanceId}, function(data) {
                matchData = data;
                matchesLoaded = true;
                if (countsLoaded) renderOverview(instanceId, counts, matchData);
            });
        }

        function renderOverview(instanceId, counts, matches) {
            var pendingMatches = 0;
            for (var i = 0; i < matches.length; i++) {
                if (matches[i].false_positive == 0 && !matches[i].isTargetFp && !matches[i].isTargetValidated) {
                    pendingMatches++;
                }
            }

            var html = "<div class='assets-overview-grid'>";

            // Summary Cards Row
            html += "<div class='assets-cards-row'>";
            html += "<div class='assets-card assets-card-total'>";
            html += "<div class='assets-card-icon'><i class='glyphicon glyphicon-hdd'></i></div>";
            html += "<div class='assets-card-info'><span class='assets-card-number'>" + counts.total + "</span>";
            html += "<span class='assets-card-label'>TOTAL KNOWN ASSETS</span></div></div>";

            html += "<div class='assets-card assets-card-client'>";
            html += "<div class='assets-card-icon'><i class='glyphicon glyphicon-briefcase'></i></div>";
            html += "<div class='assets-card-info'><span class='assets-card-number'>" + counts.client_provided + "</span>";
            html += "<span class='assets-card-label'>CLIENT PROVIDED</span></div></div>";

            html += "<div class='assets-card assets-card-analyst'>";
            html += "<div class='assets-card-icon'><i class='glyphicon glyphicon-ok-sign'></i></div>";
            html += "<div class='assets-card-info'><span class='assets-card-number'>" + counts.analyst_confirmed + "</span>";
            html += "<span class='assets-card-label'>ANALYST CONFIRMED</span></div></div>";

            html += "<div class='assets-card assets-card-pending'>";
            html += "<div class='assets-card-icon'><i class='glyphicon glyphicon-search'></i></div>";
            html += "<div class='assets-card-info'><span class='assets-card-number'>" + pendingMatches + "</span>";
            html += "<span class='assets-card-label'>PENDING MATCHES</span></div></div>";
            html += "</div>";

            // Type Breakdown Row
            html += "<div class='assets-breakdown-row'>";
            html += "<div class='assets-breakdown-card'>";
            html += "<i class='glyphicon glyphicon-map-marker'></i>";
            html += "<span class='assets-breakdown-count'>" + (counts.by_type.ip || 0) + "</span>";
            html += "<span class='assets-breakdown-label'>IP ADDRESSES</span></div>";

            html += "<div class='assets-breakdown-card'>";
            html += "<i class='glyphicon glyphicon-globe'></i>";
            html += "<span class='assets-breakdown-count'>" + (counts.by_type.domain || 0) + "</span>";
            html += "<span class='assets-breakdown-label'>DOMAINS</span></div>";

            html += "<div class='assets-breakdown-card'>";
            html += "<i class='glyphicon glyphicon-user'></i>";
            html += "<span class='assets-breakdown-count'>" + (counts.by_type.employee || 0) + "</span>";
            html += "<span class='assets-breakdown-label'>EMPLOYEES</span></div>";

            html += "<div class='assets-breakdown-card'>";
            html += "<i class='glyphicon glyphicon-warning-sign'></i>";
            html += "<span class='assets-breakdown-count'>" + matches.length + "</span>";
            html += "<span class='assets-breakdown-label'>SCAN MATCHES</span></div>";
            html += "</div>";

            // Quick action callout
            if (pendingMatches > 0) {
                html += "<div class='assets-callout'>";
                html += "<i class='glyphicon glyphicon-bell'></i>&nbsp;&nbsp;";
                html += "<strong>" + pendingMatches + " POTENTIAL MATCHES</strong> NEED REVIEW.&nbsp;&nbsp;";
                html += "<a class='link assets-callout-link' onclick='assetsShowPotential(\"" + instanceId + "\")'>REVIEW NOW</a>";
                html += "</div>";
            } else if (counts.total === 0) {
                html += "<div class='assets-callout assets-callout-info'>";
                html += "<i class='glyphicon glyphicon-info-sign'></i>&nbsp;&nbsp;";
                html += "NO KNOWN ASSETS YET. USE <strong>IMPORT LIST</strong> TO UPLOAD CLIENT ASSETS, ";
                html += "OR <strong>SYNC VERIFIED</strong> TO PULL IN EXISTING VALIDATED ENTRIES.";
                html += "</div>";
            }

            // Import History
            html += "<div class='assets-section-header'><i class='glyphicon glyphicon-time'></i>&nbsp;&nbsp;IMPORT HISTORY</div>";
            html += "<div id='assets-import-history'><span class='assets-loader-text'>LOADING...</span></div>";

            html += "</div>";
            $("#assets-content").html(html);
            $("#loader").hide();

            // Load import history
            sf.fetchData('${docroot}/knownassetimporthistory', {target: assetsTarget}, function(history) {
                if (history.length === 0) {
                    $("#assets-import-history").html("<p class='assets-empty-text'>NO IMPORTS YET. USE THE IMPORT LIST BUTTON TO GET STARTED.</p>");
                    return;
                }
                var tbl = "<table class='table table-bordered table-striped assets-table'>";
                tbl += "<thead><tr><th>DATE</th><th>TYPE</th><th>FILE</th><th>ITEMS</th><th>BY</th></tr></thead><tbody>";
                for (var i = 0; i < history.length; i++) {
                    var h = history[i];
                    var d = new Date(h.date_imported * 1000);
                    tbl += "<tr><td>" + d.toLocaleString() + "</td>";
                    tbl += "<td><span class='assets-type-badge assets-type-" + h.asset_type + "'>" + h.asset_type.toUpperCase() + "</span></td>";
                    tbl += "<td>" + (h.file_name || '-') + "</td>";
                    tbl += "<td>" + h.item_count + "</td>";
                    tbl += "<td>" + (h.imported_by || '-') + "</td></tr>";
                }
                tbl += "</tbody></table>";
                $("#assets-import-history").html(tbl);
            });
        }

        // ---- KNOWN ASSETS VIEW ----
        // Known assets active filters (multi-select)
        var knownActiveFilters = { type: 'all', source: 'all' };

        function assetsShowKnown(instanceId) {
            assetsSetActiveBtn('known');
            pushViewState('btn-assets', {assetsView: 'known'});
            $("#assets-content").html("<div class='assets-loader'><img src='${docroot}/static/img/loader.gif'></div>");

            sf.fetchData('${docroot}/knownassetlist', {target: assetsTarget}, function(data) {
                var html = "";

                // Count by type and source
                var ipCount = 0, domainCount = 0, empCount = 0, clientCount = 0, analystCount = 0;
                for (var i = 0; i < data.length; i++) {
                    if (data[i].asset_type === 'ip') ipCount++;
                    if (data[i].asset_type === 'domain') domainCount++;
                    if (data[i].asset_type === 'employee') empCount++;
                    if (data[i].source === 'CLIENT_PROVIDED') clientCount++;
                    if (data[i].source === 'ANALYST_CONFIRMED') analystCount++;
                }

                // Filter bar - larger buttons, type filters and source filters
                html += "<div class='assets-known-filter-bar assets-known-sticky-bar' id='assets-known-sticky-bar'>";
                html += "<div class='assets-known-filter-group'>";
                html += "<span class='assets-known-filter-label'>TYPE</span>";
                html += "<button class='assets-known-filter-btn" + (knownActiveFilters.type === 'all' ? " assets-known-filter-active" : "") + "' onclick='knownFilterType(\"all\", this)'>";
                html += "<i class='glyphicon glyphicon-th-list'></i>&nbsp;&nbsp;ALL (" + data.length + ")</button>";
                html += "<button class='assets-known-filter-btn" + (knownActiveFilters.type === 'ip' ? " assets-known-filter-active" : "") + "' onclick='knownFilterType(\"ip\", this)'>";
                html += "<i class='glyphicon glyphicon-globe'></i>&nbsp;&nbsp;IPS (" + ipCount + ")</button>";
                html += "<button class='assets-known-filter-btn" + (knownActiveFilters.type === 'domain' ? " assets-known-filter-active" : "") + "' onclick='knownFilterType(\"domain\", this)'>";
                html += "<i class='glyphicon glyphicon-link'></i>&nbsp;&nbsp;DOMAINS (" + domainCount + ")</button>";
                html += "<button class='assets-known-filter-btn" + (knownActiveFilters.type === 'employee' ? " assets-known-filter-active" : "") + "' onclick='knownFilterType(\"employee\", this)'>";
                html += "<i class='glyphicon glyphicon-user'></i>&nbsp;&nbsp;EMPLOYEES (" + empCount + ")</button>";
                html += "</div>";
                html += "<div class='assets-known-filter-group'>";
                html += "<span class='assets-known-filter-label'>SOURCE</span>";
                html += "<button class='assets-known-filter-btn assets-known-filter-src" + (knownActiveFilters.source === 'all' ? " assets-known-filter-active" : "") + "' onclick='knownFilterSource(\"all\", this)'>";
                html += "<i class='glyphicon glyphicon-th-list'></i>&nbsp;&nbsp;ALL</button>";
                html += "<button class='assets-known-filter-btn assets-known-filter-src" + (knownActiveFilters.source === 'CLIENT_PROVIDED' ? " assets-known-filter-active" : "") + "' onclick='knownFilterSource(\"CLIENT_PROVIDED\", this)'>";
                html += "<i class='glyphicon glyphicon-briefcase'></i>&nbsp;&nbsp;CLIENT (" + clientCount + ")</button>";
                html += "<button class='assets-known-filter-btn assets-known-filter-src" + (knownActiveFilters.source === 'ANALYST_CONFIRMED' ? " assets-known-filter-active" : "") + "' onclick='knownFilterSource(\"ANALYST_CONFIRMED\", this)'>";
                html += "<i class='glyphicon glyphicon-check'></i>&nbsp;&nbsp;ANALYST (" + analystCount + ")</button>";
                html += "</div>";
                html += "<div style='flex:1;'></div>";
                html += "<button class='btn assets-known-remove-sel-btn' onclick='assetsRemoveSelected(\"" + instanceId + "\")' style='display:none;' id='assets-remove-sel-btn'>";
                html += "<i class='glyphicon glyphicon-trash'></i>&nbsp;&nbsp;REMOVE SELECTED</button>";
                html += "<button class='btn assets-known-bulk-fp-btn' onclick='knownBulkAction(\"" + instanceId + "\", \"fp\")' style='display:none;' id='assets-bulk-fp-btn'>";
                html += "<i class='glyphicon glyphicon-ban-circle'></i>&nbsp;&nbsp;FALSE POSITIVE</button>";
                html += "<button class='btn assets-known-bulk-pending-btn' onclick='knownBulkAction(\"" + instanceId + "\", \"reset\")' style='display:none;' id='assets-bulk-pending-btn'>";
                html += "<i class='glyphicon glyphicon-repeat'></i>&nbsp;&nbsp;PENDING</button>";
                html += "</div>";

                if (data.length === 0) {
                    html += "<div class='assets-empty'>";
                    html += "<i class='glyphicon glyphicon-inbox'></i>";
                    html += "<p>NO KNOWN ASSETS YET. IMPORT A LIST OR ADD ASSETS INDIVIDUALLY.</p></div>";
                } else {
                    html += "<table class='table table-bordered assets-table assets-known-compact' id='known-assets-table'>";
                    html += "<thead><tr>";
                    html += "<th class='assets-known-col-select'><input type='checkbox' id='assets-select-all' onchange='assetsToggleSelectAll()'></th>";
                    html += "<th class='assets-known-col-type'>TYPE</th>";
                    html += "<th>VALUE</th>";
                    html += "<th class='assets-known-col-source'>SOURCE</th>";
                    html += "<th class='assets-known-col-actions'>ACTIONS</th>";
                    html += "</tr></thead><tbody>";

                    for (var i = 0; i < data.length; i++) {
                        var a = data[i];
                        var d = new Date(a.date_added * 1000);
                        var sourceClass = a.source === 'CLIENT_PROVIDED' ? 'assets-source-client' : 'assets-source-analyst';
                        var sourceLabel = a.source === 'CLIENT_PROVIDED' ? 'CLIENT' : 'ANALYST';
                        var safeValue = $('<span>').text(a.asset_value).html();
                        var valueWrapped = assetsRenderWrappable(a.asset_value);

                        // Check filters
                        var typeMatch = (knownActiveFilters.type === 'all' || knownActiveFilters.type === a.asset_type);
                        var sourceMatch = (knownActiveFilters.source === 'all' || knownActiveFilters.source === a.source);
                        var hideStyle = (!typeMatch || !sourceMatch) ? " style='display:none;'" : "";

                        // Main compact row
                        html += "<tr class='assets-known-row' data-asset-id='" + a.id + "' data-asset-type='" + a.asset_type + "' data-asset-source='" + a.source + "'" + hideStyle + ">";
                        html += "<td class='assets-cell-select' onclick='knownToggleCb(this, event)'><input type='checkbox' class='asset-cb' value='" + a.id + "' onchange='assetsUpdateSelection()'></td>";
                        html += "<td class='assets-known-type-cell assets-expandable' onclick='knownToggleDetail(this)'><span class='assets-type-badge assets-type-" + a.asset_type + "'>" + a.asset_type.toUpperCase() + "</span></td>";
                        html += "<td class='assets-known-value-cell assets-expandable' onclick='knownToggleDetail(this)'>" + valueWrapped + "</td>";
                        html += "<td class='assets-known-source-cell assets-expandable' onclick='knownToggleDetail(this)'><span class='assets-source-badge " + sourceClass + "'>" + sourceLabel + "</span></td>";
                        html += "<td class='assets-known-action-cell'>";
                        html += "<button class='btn btn-xs assets-icon-btn assets-fp-action' onclick='event.stopPropagation();knownAssetAction(" + a.id + ", \"fp\")' title='FALSE POSITIVE'>";
                        html += "<i class='glyphicon glyphicon-ban-circle'></i></button>";
                        html += "<button class='btn btn-xs assets-icon-btn assets-reset-action' onclick='event.stopPropagation();knownAssetAction(" + a.id + ", \"reset\")' title='PENDING'>";
                        html += "<i class='glyphicon glyphicon-repeat'></i></button>";
                        html += "</td></tr>";

                        // Expandable detail row
                        html += "<tr class='assets-detail-row assets-known-detail' data-parent-asset='" + a.id + "' style='display:none;'>";
                        html += "<td colspan='5'>";
                        html += "<div class='assets-detail-grid'>";
                        html += "<div class='assets-detail-card'><div class='assets-detail-card-label'>SOURCE</div><div class='assets-detail-card-value'><span class='assets-source-badge " + sourceClass + "'>" + sourceLabel + "</span></div></div>";
                        html += "<div class='assets-detail-card'><div class='assets-detail-card-label'>DATE ADDED</div><div class='assets-detail-card-value'>" + d.toLocaleDateString() + "</div></div>";
                        html += "<div class='assets-detail-card'><div class='assets-detail-card-label'>ADDED BY</div><div class='assets-detail-card-value'>" + (a.added_by || '-') + "</div></div>";
                        html += "<div class='assets-detail-card'><div class='assets-detail-card-label'>NOTES</div><div class='assets-detail-card-value'>" + (a.notes ? $('<span>').text(a.notes).html() : '-') + "</div></div>";
                        html += "<div class='assets-detail-card'><div class='assets-detail-card-label'>FULL VALUE</div><div class='assets-detail-card-value' style='word-break:break-all;'>" + safeValue + "</div></div>";
                        html += "</div></td></tr>";
                    }
                    html += "</tbody></table>";
                }

                $("#assets-content").html(html);
                $("#loader").hide();
                knownInitSelectionTracking();

                // Make filter bar sticky with inline styles (ensures it works even if CSS fails)
                var knownStickyBar = document.getElementById('assets-known-sticky-bar');
                if (knownStickyBar) {
                    var isDarkMode = localStorage.getItem("theme") === "dark-theme";
                    knownStickyBar.style.setProperty('position', 'sticky', 'important');
                    knownStickyBar.style.setProperty('top', '0', 'important');
                    knownStickyBar.style.setProperty('z-index', '200', 'important');
                    knownStickyBar.style.setProperty('background', isDarkMode ? '#0a0f1a' : '#ffffff', 'important');
                    // Set thead sticky offset to bar height using inline !important to override global CSS
                    var barHeight = knownStickyBar.offsetHeight;
                    var thBg = isDarkMode ? "rgba(0, 0, 0, 0.85)" : "#f1f5f9";
                    $('#known-assets-table thead th').each(function() {
                        this.style.setProperty('position', 'sticky', 'important');
                        this.style.setProperty('top', barHeight + 'px', 'important');
                        this.style.setProperty('z-index', '100', 'important');
                        this.style.setProperty('background', thBg, 'important');
                    });
                }
            });
        }

        // Click-to-expand detail for known asset rows
        function knownToggleDetail(td) {
            var $row = $(td).closest('tr');
            var $detail = $row.next('.assets-known-detail');
            if ($detail.is(':visible')) {
                $detail.hide();
                $row.removeClass('assets-row-expanded');
            } else {
                $detail.show();
                $row.addClass('assets-row-expanded');
            }
        }

        // Click anywhere in checkbox cell to toggle
        function knownToggleCb(td, event) {
            if (event.target.type === 'checkbox') return;
            var cb = $(td).find('input[type=checkbox]');
            cb.prop('checked', !cb.prop('checked'));
            assetsUpdateSelection();
        }

        // Track checkbox changes
        function knownInitSelectionTracking() {
            $(document).off('change.knownassetscb').on('change.knownassetscb', '.asset-cb, #assets-select-all', function() {
                assetsUpdateSelection();
            });
        }

        // Type filter - independent of source filter
        function knownFilterType(filter, btn) {
            knownActiveFilters.type = filter;
            $(".assets-known-filter-group:eq(0) .assets-known-filter-btn").removeClass("assets-known-filter-active");
            $(btn).addClass("assets-known-filter-active");
            knownApplyFilters();
        }

        // Source filter - independent of type filter
        function knownFilterSource(filter, btn) {
            knownActiveFilters.source = filter;
            $(".assets-known-filter-group:eq(1) .assets-known-filter-btn").removeClass("assets-known-filter-active");
            $(btn).addClass("assets-known-filter-active");
            knownApplyFilters();
        }

        // Apply both filters together
        function knownApplyFilters() {
            $("#known-assets-table tbody tr.assets-known-row").each(function() {
                var $row = $(this);
                var typeMatch = (knownActiveFilters.type === 'all' || knownActiveFilters.type === $row.data('asset-type'));
                var sourceMatch = (knownActiveFilters.source === 'all' || knownActiveFilters.source === $row.data('asset-source'));
                var show = typeMatch && sourceMatch;
                $row.toggle(show);
                // Also hide detail row if main row is hidden
                $row.next('.assets-known-detail').toggle(show && $row.hasClass('assets-row-expanded'));
            });
            // Uncheck select-all when filters change
            $("#assets-select-all").prop("checked", false);
            assetsUpdateSelection();
        }

        function assetsToggleSelectAll() {
            var checked = $("#assets-select-all").is(":checked");
            $(".asset-cb:visible").prop("checked", checked);
            assetsUpdateSelection();
        }

        function assetsUpdateSelection() {
            var count = $(".asset-cb:checked").length;
            if (count > 0) {
                $("#assets-remove-sel-btn").show().html("<i class='glyphicon glyphicon-trash'></i>&nbsp;&nbsp;REMOVE SELECTED (" + count + ")");
                $("#assets-bulk-fp-btn").show().html("<i class='glyphicon glyphicon-ban-circle'></i>&nbsp;&nbsp;FALSE POSITIVE (" + count + ")");
                $("#assets-bulk-pending-btn").show().html("<i class='glyphicon glyphicon-repeat'></i>&nbsp;&nbsp;PENDING (" + count + ")");
            } else {
                $("#assets-remove-sel-btn").hide();
                $("#assets-bulk-fp-btn").hide();
                $("#assets-bulk-pending-btn").hide();
            }
        }

        // In-place action for known asset row: mark as FP or reset to pending
        function knownAssetAction(assetId, action) {
            var $row = $("tr.assets-known-row[data-asset-id='" + assetId + "']");
            if (!$row.length) return;
            var $actionCell = $row.find('.assets-known-action-cell');

            if (action === 'fp') {
                // Mark as false positive - remove from known assets
                sf.fetchData('${docroot}/knownassetremove', {id: assetId}, function(ret) {
                    if (ret[0] === "SUCCESS") {
                        $row.addClass('assets-known-row-fp');
                        $actionCell.html(
                            "<button class='btn btn-xs assets-icon-btn assets-reset-action' onclick='event.stopPropagation();knownAssetAction(" + assetId + ", \"undo_fp\")' title='UNDO - RESTORE ASSET'>" +
                            "<i class='glyphicon glyphicon-repeat'></i></button>"
                        );
                        alertify.success("MARKED AS FALSE POSITIVE");
                    } else {
                        alertify.error("ERROR: " + ret[1]);
                    }
                });
            } else if (action === 'undo_fp') {
                // Restore the asset - re-add it
                var assetType = $row.data('asset-type');
                var assetValue = $row.find('.assets-known-value-cell').text();
                var assetSource = $row.data('asset-source');
                sf.fetchData('${docroot}/knownassetadd', {
                    target: assetsTarget,
                    asset_type: assetType,
                    asset_value: assetValue,
                    source: assetSource === 'CLIENT_PROVIDED' ? 'CLIENT_PROVIDED' : 'ANALYST_CONFIRMED'
                }, function(ret) {
                    if (ret[0] === "SUCCESS") {
                        $row.removeClass('assets-known-row-fp');
                        $actionCell.html(
                            "<button class='btn btn-xs assets-icon-btn assets-fp-action' onclick='event.stopPropagation();knownAssetAction(" + assetId + ", \"fp\")' title='FALSE POSITIVE'>" +
                            "<i class='glyphicon glyphicon-ban-circle'></i></button>" +
                            "<button class='btn btn-xs assets-icon-btn assets-reset-action' onclick='event.stopPropagation();knownAssetAction(" + assetId + ", \"reset\")' title='PENDING'>" +
                            "<i class='glyphicon glyphicon-repeat'></i></button>"
                        );
                        alertify.success("ASSET RESTORED");
                    } else {
                        alertify.error("ERROR: " + ret[1]);
                    }
                });
            } else if (action === 'reset') {
                // Reset to pending - visual indication
                $row.addClass('assets-known-row-pending');
                $actionCell.html(
                    "<button class='btn btn-xs assets-icon-btn assets-fp-action' onclick='event.stopPropagation();knownAssetAction(" + assetId + ", \"fp\")' title='FALSE POSITIVE'>" +
                    "<i class='glyphicon glyphicon-ban-circle'></i></button>" +
                    "<button class='btn btn-xs assets-icon-btn assets-reset-action' onclick='event.stopPropagation();knownAssetAction(" + assetId + ", \"reset\")' title='PENDING'>" +
                    "<i class='glyphicon glyphicon-repeat'></i></button>"
                );
                setTimeout(function() { $row.removeClass('assets-known-row-pending'); }, 600);
                alertify.success("ASSET STATUS: PENDING");
            }
        }

        // Bulk action for known assets: mark selected as FP or reset
        function knownBulkAction(instanceId, action) {
            var ids = [];
            $(".asset-cb:checked").each(function() { ids.push($(this).val()); });
            if (ids.length === 0) return;
            for (var i = 0; i < ids.length; i++) {
                knownAssetAction(parseInt(ids[i]), action);
            }
            $("#assets-select-all").prop("checked", false);
            $(".asset-cb").prop("checked", false);
            assetsUpdateSelection();
        }

        function assetsRemoveSelected(instanceId) {
            var ids = [];
            $(".asset-cb:checked").each(function() { ids.push($(this).val()); });
            if (ids.length === 0) return;
            if (!confirm("Remove " + ids.length + " selected assets?")) return;
            sf.fetchData('${docroot}/knownassetremove', {ids: JSON.stringify(ids)}, function(ret) {
                if (ret[0] === "SUCCESS") {
                    alertify.success(ret[1]);
                    // Remove rows in-place
                    for (var i = 0; i < ids.length; i++) {
                        var $row = $("tr.assets-known-row[data-asset-id='" + ids[i] + "']");
                        $row.next('.assets-known-detail').remove();
                        $row.remove();
                    }
                    $("#assets-select-all").prop("checked", false);
                    assetsUpdateSelection();
                } else {
                    alertify.error("ERROR: " + ret[1]);
                }
            });
        }

        // ---- POTENTIAL MATCHES VIEW ----
        var assetsHideResolved = true; // default: resolved rows hidden
        var assetsHideFps = true; // default: false positive rows hidden

        // Break text into segments at . - @ : / delimiters for wrapping and highlight
        function assetsRenderWrappable(text) {
            var html = '';
            var seg = '';
            var idx = 0;
            for (var i = 0; i < text.length; i++) {
                var c = text[i];
                if (c === '.' || c === '-' || c === '@' || c === ':' || c === '/') {
                    if (seg) {
                        var escaped = $('<span>').text(seg).html();
                        html += '<span class="assets-seg" data-seg="' + idx + '">' + escaped + '</span>';
                        idx++;
                    }
                    html += $('<span>').text(c).html() + '<wbr>';
                    seg = '';
                } else {
                    seg += c;
                }
            }
            if (seg) {
                var escaped = $('<span>').text(seg).html();
                html += '<span class="assets-seg" data-seg="' + idx + '">' + escaped + '</span>';
            }
            return html;
        }

        function assetsShowPotential(instanceId) {
            assetsInstanceId = instanceId;
            assetsSetActiveBtn('potential');
            pushViewState('btn-assets', {assetsView: 'potential'});
            $("#assets-content").html("<div class='assets-loader'><img src='${docroot}/static/img/loader.gif'></div>");

            sf.fetchData('${docroot}/knownassetmatches', {id: instanceId}, function(matches) {
                var html = "";

                // Stats bar - sticky
                var pending = 0, verified = 0, fps = 0;
                for (var i = 0; i < matches.length; i++) {
                    var m = matches[i];
                    if (m.false_positive == 2 || m.isTargetValidated == 1) verified++;
                    else if (m.false_positive == 1 || m.isTargetFp == 1) fps++;
                    else pending++;
                }

                html += "<div class='assets-match-stats assets-sticky-bar' id='assets-sticky-bar'>";
                html += "<div class='assets-match-stat'><span class='assets-match-stat-num'>" + matches.length + "</span><span class='assets-match-stat-label'>TOTAL MATCHES</span></div>";
                html += "<div class='assets-match-stat assets-match-stat-pending'><span class='assets-match-stat-num'>" + pending + "</span><span class='assets-match-stat-label'>PENDING</span></div>";
                html += "<div class='assets-match-stat assets-match-stat-verified'><span class='assets-match-stat-num'>" + verified + "</span><span class='assets-match-stat-label'>VERIFIED</span></div>";
                html += "<div class='assets-match-stat assets-match-stat-fp'><span class='assets-match-stat-num'>" + fps + "</span><span class='assets-match-stat-label'>FALSE POSITIVE</span></div>";
                html += "<div style='flex:1;'></div>";

                // Toggle verified
                html += "<button class='btn assets-toggle-resolved-btn" + (assetsHideResolved ? "" : " active") + "' onclick='assetsToggleResolved(\"" + instanceId + "\")'>";
                html += "<i class='glyphicon glyphicon-eye-" + (assetsHideResolved ? "close" : "open") + "'></i>&nbsp;&nbsp;";
                html += (assetsHideResolved ? "SHOW" : "HIDE") + " VERIFIED (" + verified + ")</button>";

                // Toggle false positives
                html += "<button class='btn assets-toggle-fps-btn" + (assetsHideFps ? "" : " active") + "' onclick='assetsToggleFps(\"" + instanceId + "\")'>";
                html += "<i class='glyphicon glyphicon-eye-" + (assetsHideFps ? "close" : "open") + "'></i>&nbsp;&nbsp;";
                html += (assetsHideFps ? "SHOW" : "HIDE") + " FPS (" + fps + ")</button>";

                // Bulk actions - inactive by default, activated via assetsUpdateBulkButtons()
                html += "<div class='assets-bulk-group'>";
                html += "<button class='btn assets-bulk-verify-btn assets-bulk-inactive' id='assets-bulk-verify' onclick='assetsBulkAction(\"" + instanceId + "\", \"verify\")' disabled>";
                html += "<i class='glyphicon glyphicon-ok-circle'></i>&nbsp;&nbsp;VERIFIED</button>";
                html += "<button class='btn assets-bulk-fp-btn assets-bulk-inactive' id='assets-bulk-fp' onclick='assetsBulkAction(\"" + instanceId + "\", \"fp\")' disabled>";
                html += "<i class='glyphicon glyphicon-ban-circle'></i>&nbsp;&nbsp;FALSE POSITIVE</button>";
                html += "<button class='btn assets-bulk-reset-btn assets-bulk-inactive' id='assets-bulk-reset' onclick='assetsBulkAction(\"" + instanceId + "\", \"reset\")' disabled>";
                html += "<i class='glyphicon glyphicon-repeat'></i>&nbsp;&nbsp;PENDING</button>";
                html += "</div>";
                html += "</div>";

                if (matches.length === 0) {
                    html += "<div class='assets-empty'>";
                    html += "<i class='glyphicon glyphicon-ok-sign'></i>";
                    html += "<p>NO MATCHES FOUND. IMPORT KNOWN ASSETS OR USE SYNC VERIFIED TO START MATCHING AGAINST SCAN DATA.</p></div>";
                } else {
                    html += "<table class='table table-bordered assets-table assets-matches-compact' id='potential-matches-table'>";
                    html += "<thead><tr>";
                    html += "<th class='assets-col-select'><input type='checkbox' id='matches-select-all' onchange='matchesToggleSelectAll()'></th>";
                    html += "<th class='assets-col-status'>STATUS</th>";
                    html += "<th>DATA ELEMENT</th>";
                    html += "<th>KNOWN ASSET</th>";
                    html += "<th class='assets-col-actions'></th>";
                    html += "</tr></thead><tbody>";

                    for (var i = 0; i < matches.length; i++) {
                        var m = matches[i];
                        var isResolved = false;
                        var statusBadge = "";
                        var rowClass = "";
                        if (m.false_positive == 2 || m.isTargetValidated == 1) {
                            statusBadge = "<span class='status-validated'>VERIFIED</span>";
                            rowClass = "assets-row-verified assets-row-resolved";
                            isResolved = true;
                        } else if (m.false_positive == 1 || m.isTargetFp == 1) {
                            statusBadge = "<span class='status-fp'>FALSE POSITIVE</span>";
                            rowClass = "assets-row-fp assets-row-resolved";
                            isResolved = true;
                        } else {
                            statusBadge = "<span class='status-unvalidated'>PENDING</span>";
                            rowClass = "assets-row-pending";
                        }

                        var matchLabel = m.match_type.replace(/_/g, ' ').toUpperCase();
                        var isVerified = (m.false_positive == 2 || m.isTargetValidated == 1);
                        var isFp = (m.false_positive == 1 || m.isTargetFp == 1);
                        var hideStyle = ((isVerified && assetsHideResolved) || (isFp && assetsHideFps)) ? " style='display:none;'" : "";
                        var knownWrapped = assetsRenderWrappable(m.matched_asset);
                        var dataWrapped = assetsRenderWrappable(m.data);

                        // Main row - clicking status/known/data cells toggles detail
                        html += "<tr class='assets-match-row " + rowClass + "' data-hash='" + m.hash + "'" + hideStyle + ">";
                        html += "<td class='assets-cell-select' onclick='assetsToggleCb(this, event)'><input type='checkbox' class='match-cb' value='" + m.hash + "'></td>";
                        html += "<td class='assets-col-status-cell text-center assets-expandable' onclick='assetsToggleDetailByRow(this)'>" + statusBadge + "</td>";
                        html += "<td class='assets-value-cell assets-hl-cell assets-expandable' onclick='assetsToggleDetailByRow(this)'>" + dataWrapped + "</td>";
                        html += "<td class='assets-matched-asset assets-hl-cell assets-expandable' onclick='assetsToggleDetailByRow(this)'>" + knownWrapped + "</td>";
                        html += "<td class='assets-action-cell'>";
                        if (!isResolved) {
                            html += "<button class='btn btn-xs assets-icon-btn assets-verify-action' onclick='event.stopPropagation();assetsSingleAction(\"" + instanceId + "\", \"" + m.hash + "\", \"verify\")' title='VERIFY'>";
                            html += "<i class='glyphicon glyphicon-ok'></i></button>";
                            html += "<button class='btn btn-xs assets-icon-btn assets-fp-action' onclick='event.stopPropagation();assetsSingleAction(\"" + instanceId + "\", \"" + m.hash + "\", \"fp\")' title='FALSE POSITIVE'>";
                            html += "<i class='glyphicon glyphicon-remove'></i></button>";
                        } else {
                            html += "<button class='btn btn-xs assets-icon-btn assets-reset-action' onclick='event.stopPropagation();assetsSingleAction(\"" + instanceId + "\", \"" + m.hash + "\", \"reset\")' title='RESET TO PENDING'>";
                            html += "<i class='glyphicon glyphicon-repeat'></i></button>";
                        }
                        html += "</td></tr>";

                        // Expandable detail row - styled as distinct cards
                        var detailResClass = (isResolved ? " assets-row-resolved" : "");
                        html += "<tr class='assets-detail-row" + detailResClass + "' data-parent='" + m.hash + "' style='display:none;'>";
                        html += "<td colspan='5'>";
                        html += "<div class='assets-detail-grid'>";
                        html += "<div class='assets-detail-card'><div class='assets-detail-card-label'>MATCH TYPE</div><div class='assets-detail-card-value'><span class='assets-match-type-badge'>" + matchLabel + "</span></div></div>";
                        html += "<div class='assets-detail-card'><div class='assets-detail-card-label'>EVENT TYPE</div><div class='assets-detail-card-value'>" + m.type + "</div></div>";
                        html += "<div class='assets-detail-card'><div class='assets-detail-card-label'>SOURCE MODULE</div><div class='assets-detail-card-value'>" + m.module + "</div></div>";
                        if (m.confidence) {
                            html += "<div class='assets-detail-card'><div class='assets-detail-card-label'>CONFIDENCE</div><div class='assets-detail-card-value assets-confidence-val'>" + m.confidence + "</div></div>";
                        }
                        html += "</div></td></tr>";
                    }
                    html += "</tbody></table>";
                }

                $("#assets-content").html(html);
                $("#loader").hide();
                assetsInitSegmentHighlight();
                assetsInitSelectionTracking();

                // Make stats bar sticky with inline styles (ensures it works even if CSS fails)
                var stickyBar = document.getElementById('assets-sticky-bar');
                if (stickyBar) {
                    var isDarkMode = localStorage.getItem("theme") === "dark-theme";
                    stickyBar.style.setProperty('position', 'sticky', 'important');
                    stickyBar.style.setProperty('top', '0', 'important');
                    stickyBar.style.setProperty('z-index', '200', 'important');
                    stickyBar.style.setProperty('background', isDarkMode ? '#0a0f1a' : '#f8fafc', 'important');
                    // Set thead sticky offset to bar height using inline !important to override global CSS
                    var barHeight = stickyBar.offsetHeight;
                    var thBg = isDarkMode ? "rgba(0, 0, 0, 0.85)" : "#f1f5f9";
                    $('#potential-matches-table thead th').each(function() {
                        this.style.setProperty('position', 'sticky', 'important');
                        this.style.setProperty('top', barHeight + 'px', 'important');
                        this.style.setProperty('z-index', '100', 'important');
                        this.style.setProperty('background', thBg, 'important');
                    });
                }
            });
        }

        // Toggle verified rows
        function assetsToggleResolved(instanceId) {
            assetsHideResolved = !assetsHideResolved;
            assetsShowPotential(instanceId);
        }

        // Toggle false positive rows
        function assetsToggleFps(instanceId) {
            assetsHideFps = !assetsHideFps;
            assetsShowPotential(instanceId);
        }

        // Click on status/known/data cell toggles detail row
        function assetsToggleDetailByRow(td) {
            var $row = $(td).closest('tr');
            var $detail = $row.next('.assets-detail-row');
            if ($detail.is(':visible')) {
                $detail.hide();
                $row.removeClass('assets-row-expanded');
            } else {
                $detail.show();
                $row.addClass('assets-row-expanded');
            }
        }

        // Click anywhere in checkbox cell to toggle
        function assetsToggleCb(td, event) {
            if (event.target.type === 'checkbox') return;
            var cb = $(td).find('input[type=checkbox]');
            cb.prop('checked', !cb.prop('checked'));
            assetsUpdateBulkButtons();
        }

        // Track checkbox changes to enable/disable bulk buttons
        function assetsInitSelectionTracking() {
            $(document).off('change.assetscb').on('change.assetscb', '.match-cb, #matches-select-all', function() {
                assetsUpdateBulkButtons();
            });
        }

        function assetsUpdateBulkButtons() {
            var count = $(".match-cb:checked").length;
            var $verify = $("#assets-bulk-verify");
            var $fp = $("#assets-bulk-fp");
            var $reset = $("#assets-bulk-reset");
            if (count > 0) {
                $verify.removeClass('assets-bulk-inactive').prop('disabled', false);
                $fp.removeClass('assets-bulk-inactive').prop('disabled', false);
                $reset.removeClass('assets-bulk-inactive').prop('disabled', false);
            } else {
                $verify.addClass('assets-bulk-inactive').prop('disabled', true);
                $fp.addClass('assets-bulk-inactive').prop('disabled', true);
                $reset.addClass('assets-bulk-inactive').prop('disabled', true);
            }
        }

        // Segment-based hover highlight
        function assetsInitSegmentHighlight() {
            var $table = $('#potential-matches-table');
            if (!$table.length) return;

            $table.on('mouseenter', '.assets-seg', function() {
                var $seg = $(this);
                var segText = $seg.text().toLowerCase();
                if (!segText) return;
                var $cell = $seg.closest('.assets-hl-cell');
                var $row = $cell.closest('tr');

                $seg.addClass('assets-hl-active');

                var $paired = $cell.hasClass('assets-matched-asset')
                    ? $row.find('.assets-value-cell')
                    : $row.find('.assets-matched-asset');
                if ($paired.length) {
                    $paired.find('.assets-seg').each(function() {
                        if ($(this).text().toLowerCase() === segText) {
                            $(this).addClass('assets-hl-active');
                        }
                    });
                }
            });

            $table.on('mouseleave', '.assets-seg', function() {
                var $row = $(this).closest('tr');
                $row.find('.assets-hl-active').removeClass('assets-hl-active');
            });
        }

        function matchesToggleSelectAll() {
            var checked = $("#matches-select-all").is(":checked");
            $(".assets-match-row:visible .match-cb").prop("checked", checked);
            assetsUpdateBulkButtons();
        }

        // Update a single row in-place after an action
        function assetsUpdateRowInPlace(hash, action) {
            var $row = $("tr.assets-match-row[data-hash='" + hash + "']");
            if (!$row.length) return;
            var $statusCell = $row.find('.assets-col-status-cell');
            var $actionCell = $row.find('.assets-action-cell');
            var iid = assetsInstanceId;

            if (action === 'verify') {
                $statusCell.html("<span class='status-validated'>VERIFIED</span>");
                $row.removeClass('assets-row-pending assets-row-fp').addClass('assets-row-verified assets-row-resolved');
                $actionCell.html("<button class='btn btn-xs assets-icon-btn assets-reset-action' onclick='event.stopPropagation();assetsSingleAction(\"" + iid + "\", \"" + hash + "\", \"reset\")' title='RESET TO PENDING'><i class='glyphicon glyphicon-repeat'></i></button>");
                if (assetsHideResolved) { $row.hide(); $row.next('.assets-detail-row').hide(); }
            } else if (action === 'fp') {
                $statusCell.html("<span class='status-fp'>FALSE POSITIVE</span>");
                $row.removeClass('assets-row-pending assets-row-verified').addClass('assets-row-fp assets-row-resolved');
                $actionCell.html("<button class='btn btn-xs assets-icon-btn assets-reset-action' onclick='event.stopPropagation();assetsSingleAction(\"" + iid + "\", \"" + hash + "\", \"reset\")' title='RESET TO PENDING'><i class='glyphicon glyphicon-repeat'></i></button>");
                if (assetsHideFps) { $row.hide(); $row.next('.assets-detail-row').hide(); }
            } else if (action === 'reset') {
                $statusCell.html("<span class='status-unvalidated'>PENDING</span>");
                $row.removeClass('assets-row-verified assets-row-fp assets-row-resolved').addClass('assets-row-pending');
                $actionCell.html(
                    "<button class='btn btn-xs assets-icon-btn assets-verify-action' onclick='event.stopPropagation();assetsSingleAction(\"" + iid + "\", \"" + hash + "\", \"verify\")' title='VERIFY'><i class='glyphicon glyphicon-ok'></i></button>" +
                    "<button class='btn btn-xs assets-icon-btn assets-fp-action' onclick='event.stopPropagation();assetsSingleAction(\"" + iid + "\", \"" + hash + "\", \"fp\")' title='FALSE POSITIVE'><i class='glyphicon glyphicon-remove'></i></button>"
                );
                $row.show();
            }
            // Uncheck the row
            $row.find('.match-cb').prop('checked', false);
        }

        // Recalculate stats from DOM and update the sticky bar counters
        function assetsRecalcStats() {
            var total = $("tr.assets-match-row").length;
            var verified = $("tr.assets-row-verified").length;
            var fps = $("tr.assets-row-fp").length;
            var pending = total - verified - fps;
            $(".assets-match-stats .assets-match-stat:eq(0) .assets-match-stat-num").text(total);
            $(".assets-match-stat-pending .assets-match-stat-num").text(pending);
            $(".assets-match-stat-verified .assets-match-stat-num").text(verified);
            $(".assets-match-stat-fp .assets-match-stat-num").text(fps);
            // Update toggle button counts
            $(".assets-toggle-resolved-btn").html(
                "<i class='glyphicon glyphicon-eye-" + (assetsHideResolved ? "close" : "open") + "'></i>&nbsp;&nbsp;" +
                (assetsHideResolved ? "SHOW" : "HIDE") + " VERIFIED (" + verified + ")"
            );
            $(".assets-toggle-fps-btn").html(
                "<i class='glyphicon glyphicon-eye-" + (assetsHideFps ? "close" : "open") + "'></i>&nbsp;&nbsp;" +
                (assetsHideFps ? "SHOW" : "HIDE") + " FPS (" + fps + ")"
            );
        }

        function assetsSingleAction(instanceId, hash, action) {
            sf.fetchData('${docroot}/knownassetverifymatch', {
                id: instanceId, result_hash: hash, action: action
            }, function(ret) {
                if (ret[0] === "SUCCESS") {
                    alertify.success(ret[1]);
                    assetsUpdateRowInPlace(hash, action);
                    assetsRecalcStats();
                    assetsUpdateBulkButtons();
                } else {
                    alertify.error("ERROR: " + ret[1]);
                }
            });
        }

        function assetsBulkAction(instanceId, action) {
            var hashes = [];
            $(".match-cb:checked").each(function() { hashes.push($(this).val()); });
            if (hashes.length === 0) {
                alertify.error("SELECT AT LEAST ONE MATCH.");
                return;
            }
            sf.fetchData('${docroot}/knownassetverifymatch', {
                id: instanceId, result_hashes: JSON.stringify(hashes), action: action
            }, function(ret) {
                if (ret[0] === "SUCCESS") {
                    alertify.success(ret[1]);
                    for (var i = 0; i < hashes.length; i++) {
                        assetsUpdateRowInPlace(hashes[i], action);
                    }
                    assetsRecalcStats();
                    $("#matches-select-all").prop("checked", false);
                    assetsUpdateBulkButtons();
                } else {
                    alertify.error("ERROR: " + ret[1]);
                }
            });
        }

        // ---- IMPORT / ADD HANDLERS ----
        function assetsDoImport(instanceId) {
            var fileInput = document.getElementById('import-asset-file');
            var assetType = document.getElementById('import-asset-type').value;
            if (!fileInput.files || fileInput.files.length === 0) {
                alertify.error("PLEASE SELECT A FILE.");
                return;
            }
            var formData = new FormData();
            formData.append('target', assetsTarget);
            formData.append('asset_type', assetType);
            formData.append('importfile', fileInput.files[0]);

            $.ajax({
                url: '${docroot}/knownassetimport',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    var ret = typeof response === 'string' ? JSON.parse(response) : response;
                    if (ret[0] === "SUCCESS") {
                        alertify.success(ret[1]);
                        assetsCloseModals();
                        if (currentAssetsView === 'known') assetsShowKnown(instanceId);
                        else if (currentAssetsView === 'potential') assetsShowPotential(instanceId);
                        else assetsShowOverview(instanceId);
                    } else {
                        alertify.error("IMPORT FAILED: " + ret[1]);
                    }
                },
                error: function() { alertify.error("IMPORT REQUEST FAILED."); }
            });
        }

        function assetsDoAdd(instanceId) {
            var assetType = document.getElementById('add-asset-type').value;
            var assetValue = document.getElementById('add-asset-value').value.trim();
            var source = document.getElementById('add-asset-source').value;
            var notes = document.getElementById('add-asset-notes').value.trim();
            if (!assetValue) {
                alertify.error("PLEASE ENTER A VALUE.");
                return;
            }
            sf.fetchData('${docroot}/knownassetadd', {
                target: assetsTarget, asset_type: assetType,
                asset_value: assetValue, source: source, notes: notes || ''
            }, function(ret) {
                if (ret[0] === "SUCCESS") {
                    alertify.success("ASSET ADDED");
                    assetsCloseModals();
                    document.getElementById('add-asset-value').value = '';
                    document.getElementById('add-asset-notes').value = '';
                    if (currentAssetsView === 'known') assetsShowKnown(instanceId);
                    else assetsShowOverview(instanceId);
                } else {
                    alertify.error("ERROR: " + ret[1]);
                }
            });
        }

        // Switch between NESSUS and BURP vulnerability tabs
        function switchVulnTab(tab, instanceId) {
            $('.vuln-tab-btn').removeClass('active');
            $('#vuln-btn-' + tab).addClass('active');
            $('.vuln-panel').hide();
            $('#vuln-' + tab + '-content').show();
            vulnActiveTab = tab;
            pushViewState('btn-graph', {vulnTab: tab});

            // Load data on first switch
            if (tab === 'nessus' && $('#vuln-nessus-content').html() === '') {
                loadNessusData(instanceId);
            }
            if (tab === 'burp' && $('#vuln-burp-content').html() === '') {
                loadBurpData(instanceId);
            }
        }

        // ---- NESSUS DATA ----
        function loadNessusData(instanceId) {
            var panel = $('#vuln-nessus-content');
            panel.html("<div class='vuln-placeholder'><i class='glyphicon glyphicon-refresh spinning' style='font-size: 24px;'></i><p>Loading...</p></div>");

            sf.fetchData('${docroot}/scannessuscount', {'id': instanceId},
                function(data) {
                    if (data.success && data.count > 0) {
                        loadNessusTable(instanceId);
                    } else {
                        showNessusUploadPlaceholder(instanceId);
                    }
                },
                function() {
                    showNessusUploadPlaceholder(instanceId);
                }
            );
        }

        function showNessusUploadPlaceholder(instanceId) {
            var panel = $('#vuln-nessus-content');
            var html = "<div class='vuln-placeholder'>";
            html += "<i class='glyphicon glyphicon-import' style='font-size: 32px; opacity: 0.4;'></i>";
            html += "<p>Import Nessus Pro scan results (.nessus)</p>";
            html += "<p class='text-muted' style='font-size: 12px;'>No vulnerability scans imported yet</p>";
            html += "<div style='margin-top: 20px;'>";
            html += "<button class='btn btn-danger' onclick='triggerNessusUpload(\"" + instanceId + "\")'>";
            html += "<i class='glyphicon glyphicon-upload'></i>&nbsp;&nbsp;IMPORT";
            html += "</button>";
            html += "<input type='file' id='nessus-file-input' accept='.nessus,.xml' style='display:none' onchange='handleNessusUpload(\"" + instanceId + "\", this)'>";
            html += "</div></div>";
            panel.html(html);
        }

        function triggerNessusUpload(instanceId) {
            $('#nessus-file-input').click();
        }

        function handleNessusUpload(instanceId, input) {
            if (!input.files || !input.files[0]) return;

            var file = input.files[0];
            var formData = new FormData();
            formData.append('importfile', file);
            formData.append('id', instanceId);

            var panel = $('#vuln-nessus-content');
            panel.html("<div class='vuln-placeholder'><i class='glyphicon glyphicon-refresh spinning' style='font-size: 32px;'></i><p>Importing Nessus scan...</p></div>");

            $.ajax({
                url: '${docroot}/importnessus',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                dataType: 'json',
                success: function(data) {
                    if (data.success) {
                        loadNessusTable(instanceId);
                    } else {
                        panel.html("<div class='alert alert-danger' style='margin: 20px;'><i class='glyphicon glyphicon-exclamation-sign'></i>&nbsp;" + data.message + "</div>");
                        setTimeout(function() { showNessusUploadPlaceholder(instanceId); }, 3000);
                    }
                },
                error: function(xhr, status, error) {
                    panel.html("<div class='alert alert-danger' style='margin: 20px;'><i class='glyphicon glyphicon-exclamation-sign'></i>&nbsp;Upload failed: " + status + "</div>");
                    setTimeout(function() { showNessusUploadPlaceholder(instanceId); }, 3000);
                }
            });
        }

        // -- Shared vulnerability table state --
        var nessusFilterState = { closed: false, ticketed: false };
        var burpFilterState = { closed: false, ticketed: false };
        var findingsFilterState = { critical: false, high: false, medium: false, low: false, info: false };
        var correlationsFilterState = { critical: false, high: false, medium: false, low: false, info: false };
        var nessusMerged = true;
        var burpMerged = true;
        window.nessusRawResults = [];
        window.burpRawResults = [];
        window.nessusInstanceId = '';
        window.burpInstanceId = '';

        function buildNessusDetailHtml(r) {
            var html = '';
            var svcPort = r.service_name || '';
            if (r.port && r.port > 0) svcPort += (svcPort ? ' ' : '') + r.port;

            if (r.synopsis) {
                html += "<div class='finding-detail-section detail-synopsis'>";
                html += "<div class='finding-detail-label'>Synopsis</div>";
                html += "<div class='finding-detail-text'>" + r.synopsis + "</div></div>";
            }
            if (r.description) {
                html += "<div class='finding-detail-section detail-description'>";
                html += "<div class='finding-detail-label'>Description</div>";
                html += "<div class='finding-detail-text'>" + r.description + "</div></div>";
            }
            if (r.solution) {
                html += "<div class='finding-detail-section detail-remediation'>";
                html += "<div class='finding-detail-label'>Solution</div>";
                html += "<div class='finding-detail-text'>" + r.solution + "</div></div>";
            }
            if (r.operating_system) {
                html += "<div class='finding-detail-section detail-os'>";
                html += "<div class='finding-detail-label'>Operating System</div>";
                html += "<div class='finding-detail-text'>" + r.operating_system + "</div></div>";
            }
            if (svcPort) {
                html += "<div class='finding-detail-section detail-service'>";
                html += "<div class='finding-detail-label'>Service / Port</div>";
                html += "<div class='finding-detail-text'>" + svcPort + (r.protocol ? ' (' + r.protocol + ')' : '') + "</div></div>";
            }
            if (r.cvss3_base_score) {
                html += "<div class='finding-detail-section detail-cvss'>";
                html += "<div class='finding-detail-label'>CVSS3 Base Score</div>";
                html += "<div class='finding-detail-text'>" + r.cvss3_base_score + "</div></div>";
            }
            if (r.see_also) {
                html += "<div class='finding-detail-section detail-see-also'>";
                html += "<div class='finding-detail-label'>See Also</div>";
                html += "<div class='finding-detail-text'>" + r.see_also.replace(/\n/g, '<br>') + "</div></div>";
            }
            if (r.plugin_output) {
                html += "<div class='finding-detail-section detail-plugin-output'>";
                html += "<div class='finding-detail-label'>Plugin Output</div>";
                html += "<div class='finding-detail-text'>" + r.plugin_output.replace(/</g, '&lt;').replace(/>/g, '&gt;') + "</div></div>";
            }
            if (r.request) {
                html += "<div class='finding-detail-section detail-request'>";
                html += "<div class='finding-detail-label'>Request</div>";
                html += "<div class='finding-detail-text'>" + r.request.replace(/</g, '&lt;').replace(/>/g, '&gt;') + "</div></div>";
            }
            return html;
        }

        function getTrackingBadge(tracking, resultId, table, mergedIds) {
            var labels = {0: 'OPEN', 1: 'CLOSED', 2: 'TICKETED'};
            var classes = {0: 'tracking-open', 1: 'tracking-closed', 2: 'tracking-ticketed'};
            var val = parseInt(tracking) || 0;

            if (mergedIds && mergedIds.length > 1) {
                // Merged row - check if all tracking values match
                var rawResults = table === 'nessus' ? window.nessusRawResults : window.burpRawResults;
                var trackingVals = {};
                for (var mi = 0; mi < mergedIds.length; mi++) {
                    for (var ri = 0; ri < rawResults.length; ri++) {
                        if (rawResults[ri].id === mergedIds[mi]) {
                            trackingVals[rawResults[ri].tracking || 0] = true;
                            break;
                        }
                    }
                }
                var uniqueVals = Object.keys(trackingVals);
                var idsJson = JSON.stringify(mergedIds);
                if (uniqueVals.length > 1) {
                    // MIXED state
                    return "<span class='tracking-badge tracking-mixed' data-merged-ids='" + idsJson + "' data-tracking='mixed' onclick='cycleMergedTracking(event, \"" + table + "\", " + idsJson + ", \"mixed\")'>MIXED</span>";
                } else {
                    var mergedVal = parseInt(uniqueVals[0]) || 0;
                    return "<span class='tracking-badge " + classes[mergedVal] + "' data-merged-ids='" + idsJson + "' data-tracking='" + mergedVal + "' onclick='cycleMergedTracking(event, \"" + table + "\", " + idsJson + ", " + mergedVal + ")'>" + labels[mergedVal] + "</span>";
                }
            }

            return "<span class='tracking-badge " + classes[val] + "' data-result-id='" + resultId + "' data-tracking='" + val + "' onclick='cycleTracking(event, \"" + table + "\", " + resultId + ", " + val + ")'>" + labels[val] + "</span>";
        }

        function mergeResults(results) {
            var groups = {};
            var order = [];
            for (var i = 0; i < results.length; i++) {
                var r = results[i];
                var key = (r.plugin_name || '').toLowerCase() + '|' + (r.host_ip || '').toLowerCase() + '|' + (r.host_name || '').toLowerCase();
                if (!groups[key]) {
                    groups[key] = [];
                    order.push(key);
                }
                groups[key].push(r);
            }
            return {groups: groups, order: order};
        }

        function cycleTracking(evt, table, resultId, currentVal) {
            evt.stopPropagation();
            // Cycle: OPEN(0) -> TICKETED(2) -> CLOSED(1) -> OPEN(0)
            var next = currentVal === 0 ? 2 : (currentVal === 2 ? 1 : 0);
            var endpoint = table === 'nessus' ? '${docroot}/scannessussettracking' : '${docroot}/scanburpsettracking';
            var instanceId = table === 'nessus' ? window.nessusInstanceId : window.burpInstanceId;

            sf.fetchData(endpoint, {'id': instanceId, 'resultId': resultId, 'tracking': next},
                function(data) {
                    if (data.success) {
                        // Update raw data
                        var rawResults = table === 'nessus' ? window.nessusRawResults : window.burpRawResults;
                        for (var i = 0; i < rawResults.length; i++) {
                            if (rawResults[i].id === resultId) {
                                rawResults[i].tracking = next;
                                break;
                            }
                        }
                        // Update badge in place
                        var labels = {0: 'OPEN', 1: 'CLOSED', 2: 'TICKETED'};
                        var classes = {0: 'tracking-open', 1: 'tracking-closed', 2: 'tracking-ticketed'};
                        var badge = $(evt.target);
                        badge.removeClass('tracking-open tracking-closed tracking-ticketed tracking-mixed');
                        badge.addClass(classes[next]);
                        badge.text(labels[next]);
                        badge.attr('data-tracking', next);
                        badge.attr('onclick', "cycleTracking(event, '" + table + "', " + resultId + ", " + next + ")");
                        // Update filter counts
                        updateVulnFilterCounts(table);
                    }
                }
            );
        }

        // Bulk tracking update for merged rows
        function cycleMergedTracking(evt, table, mergedIds, currentVal) {
            evt.stopPropagation();
            var badge = $(evt.target);

            // If MIXED, show override warning flow
            if (currentVal === 'mixed') {
                var step = badge.attr('data-override-step') || '0';
                if (step === '0') {
                    // First click on MIXED: show orange OVERRIDE ALL?
                    badge.attr('data-override-step', '1');
                    badge.removeClass('tracking-mixed');
                    badge.addClass('tracking-override-warn');
                    badge.text('OVERRIDE ALL?');
                    return;
                } else if (step === '1') {
                    // Second click: show red CONFIRM OVERRIDE
                    badge.attr('data-override-step', '2');
                    badge.removeClass('tracking-override-warn');
                    badge.addClass('tracking-override-confirm');
                    badge.text('CONFIRM OVERRIDE');
                    return;
                } else {
                    // Third click: proceed with bulk override to OPEN(0)
                    badge.removeAttr('data-override-step');
                    bulkSetMergedTracking(evt, table, mergedIds, 0);
                    return;
                }
            }

            // Normal cycle: OPEN(0) -> TICKETED(2) -> CLOSED(1) -> OPEN(0)
            var next = currentVal === 0 ? 2 : (currentVal === 2 ? 1 : 0);
            bulkSetMergedTracking(evt, table, mergedIds, next);
        }

        function bulkSetMergedTracking(evt, table, mergedIds, nextVal) {
            var endpoint = table === 'nessus' ? '${docroot}/scannessussettracking' : '${docroot}/scanburpsettracking';
            var instanceId = table === 'nessus' ? window.nessusInstanceId : window.burpInstanceId;
            var rawResults = table === 'nessus' ? window.nessusRawResults : window.burpRawResults;
            var completed = 0;
            var total = mergedIds.length;

            for (var mi = 0; mi < mergedIds.length; mi++) {
                (function(rid) {
                    sf.fetchData(endpoint, {'id': instanceId, 'resultId': rid, 'tracking': nextVal},
                        function(data) {
                            if (data.success) {
                                for (var i = 0; i < rawResults.length; i++) {
                                    if (rawResults[i].id === rid) {
                                        rawResults[i].tracking = nextVal;
                                        break;
                                    }
                                }
                            }
                            completed++;
                            if (completed >= total) {
                                // All done - update badge in place
                                var labels = {0: 'OPEN', 1: 'CLOSED', 2: 'TICKETED'};
                                var classes = {0: 'tracking-open', 1: 'tracking-closed', 2: 'tracking-ticketed'};
                                var badge = $(evt.target);
                                badge.removeClass('tracking-open tracking-closed tracking-ticketed tracking-mixed tracking-override-warn tracking-override-confirm');
                                badge.addClass(classes[nextVal]);
                                badge.text(labels[nextVal]);
                                badge.attr('data-tracking', nextVal);
                                var idsJson = JSON.stringify(mergedIds);
                                badge.attr('onclick', "cycleMergedTracking(event, '" + table + "', " + idsJson + ", " + nextVal + ")");
                                updateVulnFilterCounts(table);
                            }
                        }
                    );
                })(mergedIds[mi]);
            }
        }

        function toggleVulnFilter(table, type) {
            var state = table === 'nessus' ? nessusFilterState : burpFilterState;
            state[type] = !state[type];
            applyVulnFilters(table);
        }

        function applyVulnFilters(table) {
            var state = table === 'nessus' ? nessusFilterState : burpFilterState;
            var tableEl = table === 'nessus' ? '#nessus-table' : '#burp-table';
            $(tableEl + ' tbody tr.finding-row').each(function() {
                var row = $(this);
                var trackingBadge = row.find('.tracking-badge');
                if (!trackingBadge.length) { row.show(); return; }
                var trackVal = parseInt(trackingBadge.attr('data-tracking')) || 0;
                var shouldHide = false;
                if (state.closed && trackVal === 1) shouldHide = true;
                if (state.ticketed && trackVal === 2) shouldHide = true;
                if (shouldHide) {
                    row.hide();
                    row.next('.finding-detail-row').hide();
                } else {
                    row.show();
                }
            });
            updateVulnFilterCounts(table);
        }

        function updateVulnFilterCounts(table) {
            var rawResults = table === 'nessus' ? window.nessusRawResults : window.burpRawResults;
            var state = table === 'nessus' ? nessusFilterState : burpFilterState;
            var closedCount = 0, ticketedCount = 0, openCount = 0;
            for (var i = 0; i < rawResults.length; i++) {
                var t = parseInt(rawResults[i].tracking) || 0;
                if (t === 1) closedCount++;
                else if (t === 2) ticketedCount++;
                else openCount++;
            }
            var prefix = table === 'nessus' ? 'nessus' : 'burp';
            if (closedCount > 0) {
                $('#' + prefix + '-hide-closed').show();
                $('#' + prefix + '-hide-closed').text(state.closed ? 'HIDING ' + closedCount + ' CLOSED' : 'HIDE ' + closedCount + ' CLOSED');
                if (state.closed) $('#' + prefix + '-hide-closed').addClass('filter-btn-active'); else $('#' + prefix + '-hide-closed').removeClass('filter-btn-active');
            } else { $('#' + prefix + '-hide-closed').hide(); }
            if (ticketedCount > 0) {
                $('#' + prefix + '-hide-ticketed').show();
                $('#' + prefix + '-hide-ticketed').text(state.ticketed ? 'HIDING ' + ticketedCount + ' TICKETED' : 'HIDE ' + ticketedCount + ' TICKETED');
                if (state.ticketed) $('#' + prefix + '-hide-ticketed').addClass('filter-btn-active'); else $('#' + prefix + '-hide-ticketed').removeClass('filter-btn-active');
            } else { $('#' + prefix + '-hide-ticketed').hide(); }
            // Update main count
            var visibleCount = rawResults.length - (state.closed ? closedCount : 0) - (state.ticketed ? ticketedCount : 0);
            var label = table === 'nessus' ? 'NESSUS FINDINGS' : 'BURP ISSUES';
            var icon = table === 'nessus' ? 'glyphicon-shield' : 'glyphicon-globe';
            $('#' + prefix + '-findings-count').html("<i class='glyphicon " + icon + "'></i>&nbsp;" + visibleCount + " " + label);
        }

        function loadNessusTable(instanceId) {
            var panel = $('#vuln-nessus-content');
            panel.html("<div class='vuln-placeholder'><i class='glyphicon glyphicon-refresh spinning' style='font-size: 24px;'></i><p>Loading Nessus results...</p></div>");

            sf.fetchData('${docroot}/scannessuslist', {'id': instanceId},
                function(data) {
                    if (!data.success || !data.results || data.results.length === 0) {
                        showNessusUploadPlaceholder(instanceId);
                        return;
                    }

                    // Filter out NONE severity findings
                    var results = data.results.filter(function(r) {
                        return (r.severity || '').toLowerCase() !== 'none';
                    });

                    window.nessusRawResults = results;
                    window.nessusInstanceId = instanceId;
                    renderNessusTable(instanceId, results, nessusMerged);
                },
                function() {
                    showNessusUploadPlaceholder(instanceId);
                }
            );
        }

        function renderNessusTable(instanceId, results, merged) {
            var panel = $('#vuln-nessus-content');

            // Toolbar - left: action buttons + count
            var html = "<div class='findings-toolbar'>";
            html += "<div class='findings-toolbar-left'>";
            html += "<button class='btn btn-sm btn-cyan' onclick='reimportNessus(\"" + instanceId + "\")'>";
            html += "<i class='glyphicon glyphicon-upload'></i>&nbsp;REIMPORT</button>&nbsp;";
            html += "<span class='findings-count' id='nessus-findings-count'><i class='glyphicon glyphicon-shield'></i>&nbsp;" + results.length + " NESSUS FINDINGS</span>";
            html += "</div>";
            // Toolbar - right: merge toggle + hide filters
            html += "<div class='findings-toolbar-right'>";
            html += "<button class='btn btn-sm btn-default vuln-merge-btn' id='nessus-merge-btn' onclick='toggleNessusMerge(\"" + instanceId + "\")'>";
            html += merged ? "<i class='glyphicon glyphicon-compressed'></i>&nbsp;SHOW ALL" : "<i class='glyphicon glyphicon-compressed'></i>&nbsp;MERGE SIMILAR";
            html += "</button>&nbsp;";
            html += "<button class='filter-btn filter-btn-closed' id='nessus-hide-closed' style='display:none' onclick='toggleVulnFilter(\"nessus\",\"closed\")'></button>&nbsp;";
            html += "<button class='filter-btn filter-btn-ticketed' id='nessus-hide-ticketed' style='display:none' onclick='toggleVulnFilter(\"nessus\",\"ticketed\")'></button>";
            html += "</div></div>";

            // Table
            html += "<div class='findings-table-wrapper'>";
            html += "<table id='nessus-table' class='table findings-table tablesorter small'>";
            html += "<thead><tr>";
            html += "<th>Severity</th>";
            html += "<th>Plugin Name</th>";
            html += "<th>Host IP</th>";
            html += "<th>Host Name</th>";
            html += "<th>Tracking</th>";
            html += "</tr></thead><tbody>";

            if (merged) {
                var mg = mergeResults(results);
                var idx = 0;
                for (var oi = 0; oi < mg.order.length; oi++) {
                    var key = mg.order[oi];
                    var group = mg.groups[key];
                    var r = group[0];
                    var count = group.length;
                    var groupIds = [];
                    for (var gi = 0; gi < group.length; gi++) { groupIds.push(group[gi].id); }
                    html += renderNessusRow(r, idx, count > 1 ? count : 0, count > 1 ? groupIds : null);
                    idx++;
                }
            } else {
                for (var i = 0; i < results.length; i++) {
                    html += renderNessusRow(results[i], i, 0, null);
                }
            }

            html += "</tbody></table></div>";
            html += "<input type='file' id='nessus-file-input' accept='.nessus,.xml' style='display:none' onchange='handleNessusUpload(\"" + instanceId + "\", this)'>";

            panel.html(html);

            $.tablesorter.addParser({
                id: 'nessusSeverity',
                is: function(s) { return false; },
                format: function(s) {
                    return s.toLowerCase().replace(/critical/,0).replace(/high/,1).replace(/medium/,2).replace(/low/,3).replace(/none/,4);
                },
                type: 'numeric'
            });

            $("#nessus-table").tablesorter({
                headers: { 0: { sorter: 'nessusSeverity' }, 4: { sorter: false } },
                cssChildRow: 'finding-detail-row',
                sortList: [[0, 0]]
            });

            updateVulnFilterCounts('nessus');
            applyVulnFilters('nessus');
        }

        function renderNessusRow(r, idx, mergeCount, mergedIds) {
            var sevLower = (r.severity || '').toLowerCase();
            var badgeClass = '';
            if (sevLower === 'critical') badgeClass = 'alert-critical';
            else if (sevLower === 'high') badgeClass = 'alert-danger';
            else if (sevLower === 'medium') badgeClass = 'alert-warning';
            else if (sevLower === 'low') badgeClass = 'alert-info';
            else badgeClass = 'alert-success';

            var hasDetail = r.description || r.synopsis || r.solution || r.see_also || r.request || r.plugin_output || r.operating_system || r.cvss3_base_score;

            var html = "<tr class='finding-row finding-" + sevLower + "' data-nessus-id='" + idx + "'" + (hasDetail ? " onclick='toggleNessusDetail(" + idx + ")'" : "") + ">";
            html += "<td><span class='badge " + badgeClass + "'>" + (r.severity || 'None') + "</span>";
            if (hasDetail) html += " <i class='glyphicon glyphicon-chevron-right finding-expand-icon' id='nessus-icon-" + idx + "'></i>";
            html += "</td>";
            html += "<td><div class='cell-clamp'>" + (r.plugin_name || '');
            if (mergeCount > 0) html += " <span class='merge-count-badge'>&times;" + mergeCount + "</span>";
            html += "</div></td>";
            html += "<td>" + (r.host_ip || '') + "</td>";
            html += "<td><div class='cell-clamp'>" + (r.host_name || '') + "</div></td>";
            html += "<td>" + getTrackingBadge(r.tracking, r.id, 'nessus', mergedIds) + "</td>";
            html += "</tr>";

            if (hasDetail) {
                html += "<tr class='finding-detail-row finding-" + sevLower + "' id='nessus-detail-" + idx + "'>";
                html += "<td colspan='5'><div class='finding-detail' id='nessus-detail-content-" + idx + "'>";
                html += "<div class='nessus-detail-grid'>";
                html += buildNessusDetailHtml(r);
                html += "</div></div></td></tr>";
            }
            return html;
        }

        function toggleNessusMerge(instanceId) {
            nessusMerged = !nessusMerged;
            renderNessusTable(instanceId, window.nessusRawResults, nessusMerged);
        }

        function reimportNessus(instanceId) {
            if (confirm('NESSUS DATA HAS ALREADY BEEN IMPORTED - WOULD YOU LIKE TO REPLACE THE CURRENT DATA?')) {
                $('#nessus-file-input').click();
            }
        }

        function toggleNessusDetail(idx) {
            var row = $('tr[data-nessus-id="' + idx + '"]');
            var detail = $('#nessus-detail-content-' + idx);
            if (row.hasClass('finding-expanded')) {
                row.removeClass('finding-expanded');
                detail.slideUp(150);
            } else {
                row.addClass('finding-expanded');
                detail.slideDown(150);
            }
        }

        // ---- BURP DATA ----
        function loadBurpData(instanceId) {
            var panel = $('#vuln-burp-content');
            panel.html("<div class='vuln-placeholder'><i class='glyphicon glyphicon-refresh spinning' style='font-size: 24px;'></i><p>Loading...</p></div>");

            sf.fetchData('${docroot}/scanburpcount', {'id': instanceId},
                function(data) {
                    if (data.success && data.count > 0) {
                        loadBurpTable(instanceId);
                    } else {
                        showBurpUploadPlaceholder(instanceId);
                    }
                },
                function() {
                    showBurpUploadPlaceholder(instanceId);
                }
            );
        }

        function showBurpUploadPlaceholder(instanceId) {
            var panel = $('#vuln-burp-content');
            var html = "<div class='vuln-placeholder'>";
            html += "<i class='glyphicon glyphicon-import' style='font-size: 32px; opacity: 0.4;'></i>";
            html += "<p>Import Burp Pro scan results</p>";
            html += "<p class='text-muted' style='font-size: 12px;'>No vulnerability scans imported yet</p>";
            html += "<div style='margin-top: 20px; display: flex; gap: 10px; justify-content: center;'>";
            html += "<button class='btn btn-danger' onclick='triggerBurpUpload(\"" + instanceId + "\", \"xml\")'>";
            html += "<i class='glyphicon glyphicon-upload'></i>&nbsp;&nbsp;IMPORT XML";
            html += "</button>";
            html += "<input type='file' id='burp-file-input' accept='.xml' style='display:none' onchange='handleBurpUpload(\"" + instanceId + "\", this, \"xml\")'>";
            html += "<input type='file' id='burp-html-file-input' accept='.html,.htm' style='display:none' onchange='handleBurpUpload(\"" + instanceId + "\", this, \"html\")'>";
            html += "</div></div>";
            panel.html(html);
        }

        function triggerBurpUpload(instanceId, format) {
            if (format === 'html') {
                $('#burp-html-file-input').click();
            } else {
                $('#burp-file-input').click();
            }
        }

        function handleBurpUpload(instanceId, input, format) {
            if (!input.files || !input.files[0]) return;

            var file = input.files[0];
            var formData = new FormData();
            formData.append('importfile', file);
            formData.append('id', instanceId);

            var endpoint = format === 'html' ? '${docroot}/importburphtml' : '${docroot}/importburp';

            var panel = $('#vuln-burp-content');
            var loadMsg = format === 'html' ? 'Enhancing Burp data with HTML report...' : 'Importing Burp scan...';
            panel.html("<div class='vuln-placeholder'><i class='glyphicon glyphicon-refresh spinning' style='font-size: 32px;'></i><p>" + loadMsg + "</p></div>");

            $.ajax({
                url: endpoint,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                dataType: 'json',
                success: function(data) {
                    if (data.success) {
                        loadBurpTable(instanceId);
                    } else {
                        panel.html("<div class='alert alert-danger' style='margin: 20px;'><i class='glyphicon glyphicon-exclamation-sign'></i>&nbsp;" + data.message + "</div>");
                        setTimeout(function() { showBurpUploadPlaceholder(instanceId); }, 3000);
                    }
                },
                error: function(xhr, status, error) {
                    panel.html("<div class='alert alert-danger' style='margin: 20px;'><i class='glyphicon glyphicon-exclamation-sign'></i>&nbsp;Upload failed: " + status + "</div>");
                    setTimeout(function() { showBurpUploadPlaceholder(instanceId); }, 3000);
                }
            });
        }

        function buildBurpDetailHtml(r) {
            var html = '';
            if (r.issue_detail) {
                html += "<div class='finding-detail-section detail-issue-detail'>";
                html += "<div class='finding-detail-label'>Issue Detail</div>";
                html += "<div class='finding-detail-text'>" + r.issue_detail + "</div></div>";
            }
            if (r.solutions) {
                html += "<div class='finding-detail-section detail-remediation'>";
                html += "<div class='finding-detail-label'>Remediation</div>";
                html += "<div class='finding-detail-text'>" + r.solutions + "</div></div>";
            }
            if (r.issue_background) {
                html += "<div class='finding-detail-section detail-background'>";
                html += "<div class='finding-detail-label'>Issue Background</div>";
                html += "<div class='finding-detail-text'>" + r.issue_background + "</div></div>";
            }
            if (r.references) {
                html += "<div class='finding-detail-section detail-references'>";
                html += "<div class='finding-detail-label'>References</div>";
                html += "<div class='finding-detail-text'>" + r.references.replace(/\n/g, '<br>') + "</div></div>";
            }
            if (r.vulnerability_classifications) {
                html += "<div class='finding-detail-section detail-classifications'>";
                html += "<div class='finding-detail-label'>Vulnerability Classifications</div>";
                html += "<div class='finding-detail-text'>" + r.vulnerability_classifications.replace(/\n/g, '<br>') + "</div></div>";
            }
            if (r.see_also) {
                html += "<div class='finding-detail-section detail-see-also'>";
                html += "<div class='finding-detail-label'>See Also</div>";
                html += "<div class='finding-detail-text'>" + r.see_also.replace(/\n/g, '<br>') + "</div></div>";
            }
            if (r.request) {
                html += "<div class='finding-detail-section detail-request'>";
                html += "<div class='finding-detail-label'>Request</div>";
                html += "<div class='finding-detail-text'>" + r.request.replace(/</g, '&lt;').replace(/>/g, '&gt;') + "</div></div>";
            }
            if (r.response) {
                html += "<div class='finding-detail-section detail-response'>";
                html += "<div class='finding-detail-label'>Response</div>";
                html += "<div class='finding-detail-text'>" + r.response.replace(/</g, '&lt;').replace(/>/g, '&gt;') + "</div></div>";
            }
            return html;
        }

        function loadBurpTable(instanceId) {
            var panel = $('#vuln-burp-content');
            panel.html("<div class='vuln-placeholder'><i class='glyphicon glyphicon-refresh spinning' style='font-size: 24px;'></i><p>Loading Burp results...</p></div>");

            sf.fetchData('${docroot}/scanburplist', {'id': instanceId},
                function(data) {
                    if (!data.success || !data.results || data.results.length === 0) {
                        showBurpUploadPlaceholder(instanceId);
                        return;
                    }

                    // Filter out INFO/Information severity findings
                    var results = data.results.filter(function(r) {
                        var sev = (r.severity || '').toLowerCase();
                        return sev !== 'information' && sev !== 'info';
                    });

                    window.burpRawResults = results;
                    window.burpInstanceId = instanceId;

                    // Check if HTML enhancement has been applied
                    sf.fetchData('${docroot}/scanburpenhanced', {'id': instanceId},
                        function(enhData) {
                            var isEnhanced = enhData.success && enhData.enhanced;
                            renderBurpTable(instanceId, results, burpMerged, isEnhanced);
                        },
                        function() {
                            renderBurpTable(instanceId, results, burpMerged, false);
                        }
                    );
                },
                function() {
                    showBurpUploadPlaceholder(instanceId);
                }
            );
        }

        function renderBurpTable(instanceId, results, merged, isEnhanced) {
            window.burpIsEnhanced = !!isEnhanced;
            var panel = $('#vuln-burp-content');

            // Toolbar - left: action buttons + count
            var html = "<div class='findings-toolbar'>";
            html += "<div class='findings-toolbar-left'>";
            html += "<button class='btn btn-sm btn-cyan' onclick='reimportBurp(\"" + instanceId + "\", \"xml\")'>";
            html += "<i class='glyphicon glyphicon-upload'></i>&nbsp;REIMPORT XML</button>&nbsp;";
            if (isEnhanced) {
                html += "<button class='btn btn-sm btn-cyan' onclick='enhanceBurpHtml(\"" + instanceId + "\")'>";
                html += "<i class='glyphicon glyphicon-ok'></i>&nbsp;ENHANCED</button>&nbsp;";
            } else {
                html += "<button class='btn btn-sm btn-danger' onclick='enhanceBurpHtml(\"" + instanceId + "\")'>";
                html += "<i class='glyphicon glyphicon-exclamation-sign'></i>&nbsp;ENHANCE</button>&nbsp;";
            }
            html += "<span class='findings-count' id='burp-findings-count'><i class='glyphicon glyphicon-globe'></i>&nbsp;" + results.length + " BURP ISSUES</span>";
            html += "</div>";
            // Toolbar - right: merge toggle + hide filters
            html += "<div class='findings-toolbar-right'>";
            html += "<button class='btn btn-sm btn-default vuln-merge-btn' id='burp-merge-btn' onclick='toggleBurpMerge(\"" + instanceId + "\")'>";
            html += merged ? "<i class='glyphicon glyphicon-compressed'></i>&nbsp;SHOW ALL" : "<i class='glyphicon glyphicon-compressed'></i>&nbsp;MERGE SIMILAR";
            html += "</button>&nbsp;";
            html += "<button class='filter-btn filter-btn-closed' id='burp-hide-closed' style='display:none' onclick='toggleVulnFilter(\"burp\",\"closed\")'></button>&nbsp;";
            html += "<button class='filter-btn filter-btn-ticketed' id='burp-hide-ticketed' style='display:none' onclick='toggleVulnFilter(\"burp\",\"ticketed\")'></button>";
            html += "</div></div>";

            // Table
            html += "<div class='findings-table-wrapper'>";
            html += "<table id='burp-table' class='table findings-table tablesorter small'>";
            html += "<thead><tr>";
            html += "<th>Severity</th>";
            html += "<th>Plugin Name</th>";
            html += "<th>Host IP</th>";
            html += "<th>Host Name</th>";
            html += "<th>Tracking</th>";
            html += "</tr></thead><tbody>";

            if (merged) {
                var mg = mergeResults(results);
                var idx = 0;
                for (var oi = 0; oi < mg.order.length; oi++) {
                    var key = mg.order[oi];
                    var group = mg.groups[key];
                    var r = group[0];
                    var count = group.length;
                    var groupIds = [];
                    for (var gi = 0; gi < group.length; gi++) { groupIds.push(group[gi].id); }
                    html += renderBurpRow(r, idx, count > 1 ? count : 0, count > 1 ? groupIds : null);
                    idx++;
                }
            } else {
                for (var i = 0; i < results.length; i++) {
                    html += renderBurpRow(results[i], i, 0, null);
                }
            }

            html += "</tbody></table></div>";
            html += "<input type='file' id='burp-file-input' accept='.xml' style='display:none' onchange='handleBurpUpload(\"" + instanceId + "\", this, \"xml\")'>";
            html += "<input type='file' id='burp-html-file-input' accept='.html,.htm' style='display:none' onchange='handleBurpUpload(\"" + instanceId + "\", this, \"html\")'>";

            panel.html(html);

            $.tablesorter.addParser({
                id: 'burpSeverity',
                is: function(s) { return false; },
                format: function(s) {
                    return s.toLowerCase().replace(/high/,0).replace(/medium/,1).replace(/low/,2).replace(/information/,3).replace(/info/,3);
                },
                type: 'numeric'
            });

            $("#burp-table").tablesorter({
                headers: { 0: { sorter: 'burpSeverity' }, 4: { sorter: false } },
                cssChildRow: 'finding-detail-row',
                sortList: [[0, 0]]
            });

            updateVulnFilterCounts('burp');
            applyVulnFilters('burp');
        }

        function renderBurpRow(r, idx, mergeCount, mergedIds) {
            var sevLower = (r.severity || '').toLowerCase();
            var badgeClass = '';
            if (sevLower === 'high') badgeClass = 'alert-danger';
            else if (sevLower === 'medium') badgeClass = 'alert-warning';
            else if (sevLower === 'low') badgeClass = 'alert-info';
            else badgeClass = 'alert-success';

            var hasDetail = r.solutions || r.see_also || r.request || r.response || r.issue_detail || r.issue_background || r.references || r.vulnerability_classifications;

            var html = "<tr class='finding-row finding-" + sevLower + "' data-burp-id='" + idx + "'" + (hasDetail ? " onclick='toggleBurpDetail(" + idx + ")'" : "") + ">";
            html += "<td><span class='badge " + badgeClass + "'>" + (r.severity || 'Information') + "</span>";
            if (hasDetail) html += " <i class='glyphicon glyphicon-chevron-right finding-expand-icon' id='burp-icon-" + idx + "'></i>";
            html += "</td>";
            html += "<td><div class='cell-clamp'>" + (r.plugin_name || '');
            if (mergeCount > 0) html += " <span class='merge-count-badge'>&times;" + mergeCount + "</span>";
            html += "</div></td>";
            html += "<td>" + (r.host_ip || '') + "</td>";
            html += "<td><div class='cell-clamp'>" + (r.host_name || '') + "</div></td>";
            html += "<td>" + getTrackingBadge(r.tracking, r.id, 'burp', mergedIds) + "</td>";
            html += "</tr>";

            if (hasDetail) {
                html += "<tr class='finding-detail-row finding-" + sevLower + "' id='burp-detail-" + idx + "'>";
                html += "<td colspan='5'><div class='finding-detail' id='burp-detail-content-" + idx + "'>";
                html += "<div class='burp-detail-grid'>";
                html += buildBurpDetailHtml(r);
                html += "</div></div></td></tr>";
            }
            return html;
        }

        function toggleBurpMerge(instanceId) {
            burpMerged = !burpMerged;
            renderBurpTable(instanceId, window.burpRawResults, burpMerged, window.burpIsEnhanced);
        }

        function toggleBurpDetail(idx) {
            var row = $('tr[data-burp-id="' + idx + '"]');
            var detail = $('#burp-detail-content-' + idx);
            if (row.hasClass('finding-expanded')) {
                row.removeClass('finding-expanded');
                detail.slideUp(150);
            } else {
                row.addClass('finding-expanded');
                detail.slideDown(150);
            }
        }

        function reimportBurp(instanceId, format) {
            if (confirm('BURP DATA HAS ALREADY BEEN IMPORTED - WOULD YOU LIKE TO REPLACE THE CURRENT DATA?')) {
                $('#burp-file-input').click();
            }
        }

        function enhanceBurpHtml(instanceId) {
            $('#burp-html-file-input').click();
        }

        // Legacy graphEvents - redirects to vulnerabilities
        function graphEvents(instanceId) {
            viewVulnerabilities(instanceId);
        }

        // ============================================================
        // FINDINGS PAGE - Two tabs: FINDINGS (Excel import) + CORRELATIONS
        // ============================================================
        var findingsActiveTab = 'findings';

        function viewFindings(instanceId) {
            $("#scansummary-content").remove();
            $("#ai-correlation-section").remove();
            $("#ai-correlation-table-single").remove();
            $("#ai-correlation-table-cross").remove();
            $("#scanlogs-content").remove();
            $("#stats-bar").remove();
            $("#dedup-bar").remove();
            $("#btn-export").show();
            $("#btn-download-logs").hide();
            $("#btn-refresh").show();
            $("#btn-search").hide();
            $("#scanreminder").hide();
            navTo("btn-findings");
            pushViewState('btn-findings');
            refresh = function() { viewFindings(instanceId); }

            // Save default export dropdown and replace with findings-specific options
            if (!defaultExportDropdownHtml) {
                defaultExportDropdownHtml = $('#export-dropdown-menu').html();
            }
            var findingsExportHtml = '';
            findingsExportHtml += "<li class='dropdown-header'>Findings & Correlations Export</li>";
            findingsExportHtml += "<li><a class='link' onClick='exportEventData(\"" + instanceId + "\", \"\", \"csv\", \"full\")'>CSV (FINDINGS.csv + CORRELATIONS.csv)</a></li>";
            findingsExportHtml += "<li><a class='link' onClick='exportEventData(\"" + instanceId + "\", \"\", \"excel\", \"full\")'>Excel (FINDINGS.xlsx - two tabs)</a></li>";
            $('#export-dropdown-menu').html(findingsExportHtml);

            var grid = "<div id='scansummary-content'>";
            grid += "<div class='vuln-container'>";
            grid += "<div class='vuln-tab-bar'>";
            grid += "<button id='findings-btn-findings' class='vuln-tab-btn active' onclick='switchFindingsTab(\"findings\", \"" + instanceId + "\")'>";
            grid += "<span class='vuln-btn-icon'><i class='glyphicon glyphicon-list-alt'></i></span>";
            grid += "<span class='vuln-btn-label'>FINDINGS</span>";
            grid += "<span class='vuln-btn-sub'>All Finding Analysis</span>";
            grid += "</button>";
            grid += "<button id='findings-btn-correlations' class='vuln-tab-btn' onclick='switchFindingsTab(\"correlations\", \"" + instanceId + "\")'>";
            grid += "<span class='vuln-btn-icon'><i class='glyphicon glyphicon-exclamation-sign'></i></span>";
            grid += "<span class='vuln-btn-label'>CORRELATIONS</span>";
            grid += "<span class='vuln-btn-sub'>Rule-Based Analysis</span>";
            grid += "</button>";
            grid += "</div>";
            grid += "<div class='vuln-content'>";
            grid += "<div id='findings-findings-content' class='vuln-panel'></div>";
            grid += "<div id='findings-correlations-content' class='vuln-panel' style='display:none'></div>";
            grid += "</div></div></div>";

            $("#mainbody").append(grid);
            $("#loader").hide();

            // Load findings data into the findings tab
            loadFindingsData(instanceId);
        }

        function switchFindingsTab(tab, instanceId) {
            // Update tab buttons
            $('#findings-btn-findings').removeClass('active');
            $('#findings-btn-correlations').removeClass('active');
            $('#findings-btn-' + tab).addClass('active');

            // Show/hide panels
            $('#findings-findings-content').hide();
            $('#findings-correlations-content').hide();
            $('#findings-' + tab + '-content').show();

            findingsActiveTab = tab;
            pushViewState('btn-findings', {findingsTab: tab});

            // Load correlations data on first switch
            if (tab === 'correlations' && $('#findings-correlations-content').html() === '') {
                loadCorrelationsIntoPanel(instanceId);
            }
        }

        function loadFindingsData(instanceId) {
            var panel = $('#findings-findings-content');

            // First check if findings already exist
            sf.fetchData('${docroot}/scanfindingscount', {'id': instanceId},
                function(data) {
                    if (data.success && data.count > 0) {
                        // Findings exist - load and display them
                        loadFindingsTable(instanceId);
                    } else {
                        // No findings - show upload placeholder
                        showFindingsUploadPlaceholder(instanceId);
                    }
                },
                function() {
                    showFindingsUploadPlaceholder(instanceId);
                }
            );
        }

        function showFindingsUploadPlaceholder(instanceId) {
            var panel = $('#findings-findings-content');
            var html = "<div class='vuln-placeholder'>";
            html += "<i class='glyphicon glyphicon-import' style='font-size: 32px; opacity: 0.4;'></i>";
            html += "<p>Import Finding Analysis results (.xlsx)</p>";
            html += "<p class='text-muted' style='font-size: 12px;'>Upload an Excel file with Priority, Category, Tab, Item, Description, Recommendation columns</p>";
            html += "<div style='margin-top: 20px;'>";
            html += "<button class='btn btn-danger' onclick='triggerFindingsUpload(\"" + instanceId + "\")'>";
            html += "<i class='glyphicon glyphicon-upload'></i>&nbsp;&nbsp;IMPORT";
            html += "</button>";
            html += "<input type='file' id='findings-file-input' accept='.xlsx,.xls' style='display:none' onchange='handleFindingsUpload(\"" + instanceId + "\", this)'>";
            html += "</div></div>";
            panel.html(html);
        }

        function triggerFindingsUpload(instanceId) {
            $('#findings-file-input').click();
        }

        function handleFindingsUpload(instanceId, input) {
            if (!input.files || !input.files[0]) return;

            var file = input.files[0];
            var fname = file.name.toLowerCase();
            if (!fname.endsWith('.xlsx') && !fname.endsWith('.xls')) {
                alert('Please select an Excel file (.xlsx)');
                return;
            }

            var formData = new FormData();
            formData.append('importfile', file);
            formData.append('id', instanceId);

            var panel = $('#findings-findings-content');
            panel.html("<div class='vuln-placeholder'><i class='glyphicon glyphicon-refresh spinning' style='font-size: 32px;'></i><p>Importing findings...</p></div>");

            $.ajax({
                url: '${docroot}/importfindings',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                dataType: 'json',
                success: function(data) {
                    if (data.success) {
                        loadFindingsTable(instanceId);
                    } else {
                        panel.html("<div class='alert alert-danger' style='margin: 20px;'><i class='glyphicon glyphicon-exclamation-sign'></i>&nbsp;" + data.message + "</div>");
                        setTimeout(function() { showFindingsUploadPlaceholder(instanceId); }, 3000);
                    }
                },
                error: function(xhr, status, error) {
                    panel.html("<div class='alert alert-danger' style='margin: 20px;'><i class='glyphicon glyphicon-exclamation-sign'></i>&nbsp;Upload failed: " + status + "</div>");
                    setTimeout(function() { showFindingsUploadPlaceholder(instanceId); }, 3000);
                }
            });
        }

        function loadFindingsTable(instanceId) {
            var panel = $('#findings-findings-content');
            panel.html("<div class='vuln-placeholder'><i class='glyphicon glyphicon-refresh spinning' style='font-size: 24px;'></i><p>Loading findings...</p></div>");

            sf.fetchData('${docroot}/scanfindings', {'id': instanceId},
                function(data) {
                    if (!data || data.length === 0) {
                        showFindingsUploadPlaceholder(instanceId);
                        return;
                    }

                    // Store raw data for filtering
                    window.findingsRawData = data;

                    // Count severities
                    var sevCounts = { critical: 0, high: 0, medium: 0, low: 0, info: 0 };
                    for (var s = 0; s < data.length; s++) {
                        var p = (data[s][1] || '').toUpperCase();
                        if (p === 'CRITICAL') sevCounts.critical++;
                        else if (p === 'HIGH') sevCounts.high++;
                        else if (p === 'MEDIUM') sevCounts.medium++;
                        else if (p === 'LOW') sevCounts.low++;
                        else if (p === 'INFO') sevCounts.info++;
                    }

                    // Toolbar - left: action buttons + count (mirroring VULNERABILITIES layout)
                    var html = "<div class='findings-toolbar'>";
                    html += "<div class='findings-toolbar-left'>";
                    html += "<button class='btn btn-sm btn-cyan' onclick='reimportFindings(\"" + instanceId + "\")'>";
                    html += "<i class='glyphicon glyphicon-upload'></i>&nbsp;REIMPORT</button>&nbsp;";
                    html += "<span class='findings-count' id='findings-findings-count'><i class='glyphicon glyphicon-list-alt'></i>&nbsp;" + data.length + " FINDINGS</span>";
                    html += "</div>";
                    // Toolbar - right: severity hide filters
                    html += "<div class='findings-toolbar-right'>";
                    if (sevCounts.critical > 0) html += "<button class='filter-btn" + (findingsFilterState.critical ? " filter-btn-active" : "") + "' id='findings-hide-critical' onclick='toggleFindingsFilter(\"critical\")'>" + (findingsFilterState.critical ? "HIDING " : "HIDE ") + sevCounts.critical + " CRITICALS</button>&nbsp;";
                    if (sevCounts.high > 0) html += "<button class='filter-btn" + (findingsFilterState.high ? " filter-btn-active" : "") + "' id='findings-hide-high' onclick='toggleFindingsFilter(\"high\")'>" + (findingsFilterState.high ? "HIDING " : "HIDE ") + sevCounts.high + " HIGHS</button>&nbsp;";
                    if (sevCounts.medium > 0) html += "<button class='filter-btn" + (findingsFilterState.medium ? " filter-btn-active" : "") + "' id='findings-hide-medium' onclick='toggleFindingsFilter(\"medium\")'>" + (findingsFilterState.medium ? "HIDING " : "HIDE ") + sevCounts.medium + " MEDIUMS</button>&nbsp;";
                    if (sevCounts.low > 0) html += "<button class='filter-btn" + (findingsFilterState.low ? " filter-btn-active" : "") + "' id='findings-hide-low' onclick='toggleFindingsFilter(\"low\")'>" + (findingsFilterState.low ? "HIDING " : "HIDE ") + sevCounts.low + " LOWS</button>&nbsp;";
                    if (sevCounts.info > 0) html += "<button class='filter-btn" + (findingsFilterState.info ? " filter-btn-active" : "") + "' id='findings-hide-info' onclick='toggleFindingsFilter(\"info\")'>" + (findingsFilterState.info ? "HIDING " : "HIDE ") + sevCounts.info + " INFOS</button>";
                    html += "</div></div>";

                    // Compact 4-column table with expandable detail rows
                    html += "<div class='findings-table-wrapper'>";
                    html += "<table id='findings-table' class='table findings-table tablesorter small'>";
                    html += "<colgroup>";
                    html += "<col class='col-priority'>";
                    html += "<col class='col-category'>";
                    html += "<col class='col-type'>";
                    html += "<col class='col-item'>";
                    html += "</colgroup>";
                    html += "<thead><tr>";
                    html += "<th>Priority</th>";
                    html += "<th>Category</th>";
                    html += "<th>Type</th>";
                    html += "<th>Item</th>";
                    html += "</tr></thead><tbody>";

                    for (var i = 0; i < data.length; i++) {
                        var priority = data[i][1];
                        var prioLower = priority.toLowerCase();
                        var badgeClass = '';
                        if (priority === 'CRITICAL') badgeClass = 'alert-critical';
                        else if (priority === 'HIGH') badgeClass = 'alert-danger';
                        else if (priority === 'MEDIUM') badgeClass = 'alert-warning';
                        else if (priority === 'LOW') badgeClass = 'alert-info';
                        else if (priority === 'INFO') badgeClass = 'alert-success';

                        var typeVal = data[i][3] || '';
                        var desc = data[i][5] || '';
                        var rec = data[i][6] || '';
                        var hasDetail = desc || rec;

                        // Main row (clickable to expand)
                        html += "<tr class='finding-row finding-" + prioLower + "' data-finding-id='" + i + "'" + (hasDetail ? " onclick='toggleFinding(" + i + ")'" : "") + ">";
                        html += "<td><span class='badge " + badgeClass + "'>" + priority + "</span>";
                        if (hasDetail) html += " <i class='glyphicon glyphicon-chevron-right finding-expand-icon' id='finding-icon-" + i + "'></i>";
                        html += "</td>";
                        html += "<td><div class='cell-clamp'>" + (data[i][2] || '') + "</div></td>";
                        // Type column as clickable link
                        if (typeVal === 'EXTERNAL_VULNERABILITIES') {
                            html += "<td><div class='cell-clamp'><a class='finding-type-link' onclick='event.stopPropagation(); viewVulnerabilities(\"" + instanceId + "\"); window.scrollTo(0,0);' title='View External Vulnerabilities (Nessus)'>" + typeVal + "</a></div></td>";
                        } else if (typeVal === 'WEBAPP_VULNERABILITIES') {
                            html += "<td><div class='cell-clamp'><a class='finding-type-link' onclick='event.stopPropagation(); viewVulnerabilities(\"" + instanceId + "\"); switchVulnTab(\"burp\", \"" + instanceId + "\"); window.scrollTo(0,0);' title='View Web App Vulnerabilities (Burp)'>" + typeVal + "</a></div></td>";
                        } else if (typeVal) {
                            html += "<td><div class='cell-clamp'><a class='finding-type-link' onclick='event.stopPropagation(); dataEventData(\"" + instanceId + "\", \"" + typeVal.replace(/"/g, '&quot;') + "\", \"" + typeVal.replace(/"/g, '&quot;') + "\", \"full\");' title='View " + typeVal + " data'>" + typeVal + "</a></div></td>";
                        } else {
                            html += "<td></td>";
                        }
                        html += "<td><div class='cell-clamp'>" + (data[i][4] || '') + "</div></td>";
                        html += "</tr>";

                        // Expandable detail row
                        if (hasDetail) {
                            html += "<tr class='finding-detail-row finding-" + prioLower + "' id='finding-detail-" + i + "'>";
                            html += "<td colspan='4'><div class='finding-detail' id='finding-detail-content-" + i + "'>";
                            html += "<div class='finding-detail-grid'>";
                            if (desc) {
                                html += "<div class='finding-detail-section detail-description'>";
                                html += "<div class='finding-detail-label'>Description</div>";
                                html += "<div class='finding-detail-text'>" + desc + "</div>";
                                html += "</div>";
                            }
                            if (rec) {
                                html += "<div class='finding-detail-section detail-recommendation'>";
                                html += "<div class='finding-detail-label'>Recommendation</div>";
                                html += "<div class='finding-detail-text'>" + rec + "</div>";
                                html += "</div>";
                            }
                            html += "</div></div></td></tr>";
                        }
                    }

                    html += "</tbody></table></div>";
                    html += "<input type='file' id='findings-file-input' accept='.xlsx,.xls' style='display:none' onchange='handleFindingsUpload(\"" + instanceId + "\", this)'>";

                    panel.html(html);

                    // Enable table sorting (skip detail rows)
                    $.tablesorter.addParser({
                        id: 'findingsPriority',
                        is: function(s) { return false; },
                        format: function(s) {
                            return s.toLowerCase().replace(/critical/,0).replace(/high/,1).replace(/medium/,2).replace(/low/,3).replace(/info/,4);
                        },
                        type: 'numeric'
                    });

                    $("#findings-table").tablesorter({
                        headers: { 0: { sorter: 'findingsPriority' } },
                        cssChildRow: 'finding-detail-row',
                        sortList: [[0, 0]]
                    });
                },
                function() {
                    showFindingsUploadPlaceholder(instanceId);
                }
            );
        }

        function toggleFinding(idx) {
            var row = $('tr[data-finding-id="' + idx + '"]');
            var detail = $('#finding-detail-content-' + idx);
            if (row.hasClass('finding-expanded')) {
                row.removeClass('finding-expanded');
                detail.slideUp(150);
            } else {
                row.addClass('finding-expanded');
                detail.slideDown(150);
            }
        }

        function reimportFindings(instanceId) {
            if (confirm('FINDINGS ANALYSIS HAS ALREADY BEEN PERFORMED - WOULD YOU LIKE TO REPLACE THE CURRENT FINDINGS?')) {
                $('#findings-file-input').click();
            }
        }

        function toggleFindingsFilter(severity) {
            findingsFilterState[severity] = !findingsFilterState[severity];
            applyFindingsFilters();
        }

        function applyFindingsFilters() {
            $('#findings-table tbody tr.finding-row').each(function() {
                var row = $(this);
                var badge = row.find('.badge').text().toLowerCase();
                var shouldHide = false;
                if (findingsFilterState.critical && badge === 'critical') shouldHide = true;
                if (findingsFilterState.high && badge === 'high') shouldHide = true;
                if (findingsFilterState.medium && badge === 'medium') shouldHide = true;
                if (findingsFilterState.low && badge === 'low') shouldHide = true;
                if (findingsFilterState.info && badge === 'info') shouldHide = true;
                if (shouldHide) {
                    row.hide();
                    row.next('.finding-detail-row').hide();
                } else {
                    row.show();
                }
            });
            updateFindingsFilterCounts();
        }

        function updateFindingsFilterCounts() {
            var data = window.findingsRawData || [];
            var sevCounts = { critical: 0, high: 0, medium: 0, low: 0, info: 0 };
            for (var i = 0; i < data.length; i++) {
                var p = (data[i][1] || '').toUpperCase();
                if (p === 'CRITICAL') sevCounts.critical++;
                else if (p === 'HIGH') sevCounts.high++;
                else if (p === 'MEDIUM') sevCounts.medium++;
                else if (p === 'LOW') sevCounts.low++;
                else if (p === 'INFO') sevCounts.info++;
            }
            var severities = ['critical', 'high', 'medium', 'low', 'info'];
            var labels = { critical: 'CRITICALS', high: 'HIGHS', medium: 'MEDIUMS', low: 'LOWS', info: 'INFOS' };
            for (var s = 0; s < severities.length; s++) {
                var sev = severities[s];
                var btn = $('#findings-hide-' + sev);
                if (sevCounts[sev] > 0) {
                    btn.show();
                    btn.text(findingsFilterState[sev] ? 'HIDING ' + sevCounts[sev] + ' ' + labels[sev] : 'HIDE ' + sevCounts[sev] + ' ' + labels[sev]);
                    if (findingsFilterState[sev]) btn.addClass('filter-btn-active'); else btn.removeClass('filter-btn-active');
                } else {
                    btn.hide();
                }
            }
            // Update visible count
            var hiddenCount = 0;
            for (var s = 0; s < severities.length; s++) {
                if (findingsFilterState[severities[s]]) hiddenCount += sevCounts[severities[s]];
            }
            var visibleCount = data.length - hiddenCount;
            $('#findings-findings-count').html("<i class='glyphicon glyphicon-list-alt'></i>&nbsp;" + visibleCount + " FINDINGS");
        }

        function toggleCorrelationsFilter(severity) {
            correlationsFilterState[severity] = !correlationsFilterState[severity];
            applyCorrelationsFilters();
        }

        function applyCorrelationsFilters() {
            $('#correlations-panel-table tbody tr.corr-row').each(function() {
                var row = $(this);
                var badge = row.find('.badge').text().toLowerCase();
                var shouldHide = false;
                if (correlationsFilterState.critical && badge === 'critical') shouldHide = true;
                if (correlationsFilterState.high && badge === 'high') shouldHide = true;
                if (correlationsFilterState.medium && badge === 'medium') shouldHide = true;
                if (correlationsFilterState.low && badge === 'low') shouldHide = true;
                if (correlationsFilterState.info && badge === 'info') shouldHide = true;
                if (shouldHide) {
                    row.hide();
                    row.next('.corr-detail-row').hide();
                } else {
                    row.show();
                }
            });
            updateCorrelationsFilterCounts();
        }

        function updateCorrelationsFilterCounts() {
            var data = window.correlationsRawData || [];
            var sevCounts = { critical: 0, high: 0, medium: 0, low: 0, info: 0 };
            for (var i = 0; i < data.length; i++) {
                var r = (data[i][3] || '').toUpperCase();
                if (r === 'CRITICAL') sevCounts.critical++;
                else if (r === 'HIGH') sevCounts.high++;
                else if (r === 'MEDIUM') sevCounts.medium++;
                else if (r === 'LOW') sevCounts.low++;
                else if (r === 'INFO') sevCounts.info++;
            }
            var severities = ['critical', 'high', 'medium', 'low', 'info'];
            var labels = { critical: 'CRITICALS', high: 'HIGHS', medium: 'MEDIUMS', low: 'LOWS', info: 'INFOS' };
            for (var s = 0; s < severities.length; s++) {
                var sev = severities[s];
                var btn = $('#corr-hide-' + sev);
                if (sevCounts[sev] > 0) {
                    btn.show();
                    btn.text(correlationsFilterState[sev] ? 'HIDING ' + sevCounts[sev] + ' ' + labels[sev] : 'HIDE ' + sevCounts[sev] + ' ' + labels[sev]);
                    if (correlationsFilterState[sev]) btn.addClass('filter-btn-active'); else btn.removeClass('filter-btn-active');
                } else {
                    btn.hide();
                }
            }
            var hiddenCount = 0;
            for (var s = 0; s < severities.length; s++) {
                if (correlationsFilterState[severities[s]]) hiddenCount += sevCounts[severities[s]];
            }
            var visibleCount = data.length - hiddenCount;
            $('#correlations-count').text(visibleCount + " CORRELATIONS");
        }

        // Load correlations data into the correlations tab panel
        function loadCorrelationsIntoPanel(instanceId) {
            var panel = $('#findings-correlations-content');
            panel.html("<div class='vuln-placeholder'><i class='glyphicon glyphicon-refresh spinning' style='font-size: 24px;'></i><p>Loading correlations...</p></div>");

            sf.fetchData('${docroot}/scanstatus', {'id': instanceId},
                function(statusData) {
                    if (statusData && statusData[6] && (
                        (statusData[6]['CRITICAL'] || 0) > 0 ||
                        statusData[6]['HIGH'] > 0 ||
                        statusData[6]['MEDIUM'] > 0 ||
                        statusData[6]['LOW'] > 0 ||
                        statusData[6]['INFO'] > 0
                    )) {
                        sf.fetchData('${docroot}/scancorrelations', {'id': instanceId},
                            function(data) {
                                renderCorrelationsPanel(instanceId, data, statusData[6]);
                            },
                            function() {
                                renderCorrelationsPanelEmpty(instanceId);
                            }
                        );
                    } else {
                        renderCorrelationsPanelEmpty(instanceId);
                    }
                },
                function() {
                    sf.fetchData('${docroot}/scancorrelations', {'id': instanceId},
                        function(data) {
                            renderCorrelationsPanel(instanceId, data);
                        },
                        function() {
                            renderCorrelationsPanelEmpty(instanceId);
                        }
                    );
                }
            );
        }

        function buildAiCorrelationBar(instanceId) {
            // No longer rendered as a separate bar - AI rescan is now in the toolbar
            return "";
        }

        function initAiCorrelationButtons(instanceId) {
            sf.fetchData('${docroot}/checkAiCorrelationModes', {'id': instanceId},
                function(data) {
                    if (data.success) {
                        if (!data.single_scan_available) {
                            $("#btn-panel-rescan").prop('disabled', true).addClass('disabled')
                                .attr('title', 'No scan data available for AI analysis.');
                        }
                    }
                },
                function() { }
            );
        }

        function renderCorrelationsPanel(instanceId, data, counts) {
            var panel = $('#findings-correlations-content');

            if (!data || data.length == 0) {
                renderCorrelationsPanelEmpty(instanceId);
                return;
            }

            // Store raw data for filtering
            window.correlationsRawData = data;

            // Count risk levels
            var corrSevCounts = { critical: 0, high: 0, medium: 0, low: 0, info: 0 };
            for (var s = 0; s < data.length; s++) {
                var r = (data[s][3] || '').toUpperCase();
                if (r === 'CRITICAL') corrSevCounts.critical++;
                else if (r === 'HIGH') corrSevCounts.high++;
                else if (r === 'MEDIUM') corrSevCounts.medium++;
                else if (r === 'LOW') corrSevCounts.low++;
                else if (r === 'INFO') corrSevCounts.info++;
            }

            // Toolbar matching findings style - action buttons on left
            var html = "<div class='findings-toolbar'>";
            html += "<div class='findings-toolbar-left'>";
            html += "<button id='btn-panel-rescan' class='btn btn-sm btn-cyan' onclick='runAiCorrelation(\"" + instanceId + "\", \"single\")'>";
            html += "<i class='glyphicon glyphicon-flash'></i>&nbsp;AI RESCAN</button>&nbsp;";
            html += "<span class='findings-count' id='correlations-count'>" + data.length + " CORRELATIONS</span>";
            html += "</div>";
            html += "<div class='findings-toolbar-right'>";
            html += "<span class='ai-correlation-compact-results' id='ai-correlation-results'></span>";
            if (corrSevCounts.critical > 0) html += "<button class='filter-btn" + (correlationsFilterState.critical ? " filter-btn-active" : "") + "' id='corr-hide-critical' onclick='toggleCorrelationsFilter(\"critical\")'>" + (correlationsFilterState.critical ? "HIDING " : "HIDE ") + corrSevCounts.critical + " CRITICALS</button>&nbsp;";
            if (corrSevCounts.high > 0) html += "<button class='filter-btn" + (correlationsFilterState.high ? " filter-btn-active" : "") + "' id='corr-hide-high' onclick='toggleCorrelationsFilter(\"high\")'>" + (correlationsFilterState.high ? "HIDING " : "HIDE ") + corrSevCounts.high + " HIGHS</button>&nbsp;";
            if (corrSevCounts.medium > 0) html += "<button class='filter-btn" + (correlationsFilterState.medium ? " filter-btn-active" : "") + "' id='corr-hide-medium' onclick='toggleCorrelationsFilter(\"medium\")'>" + (correlationsFilterState.medium ? "HIDING " : "HIDE ") + corrSevCounts.medium + " MEDIUMS</button>&nbsp;";
            if (corrSevCounts.low > 0) html += "<button class='filter-btn" + (correlationsFilterState.low ? " filter-btn-active" : "") + "' id='corr-hide-low' onclick='toggleCorrelationsFilter(\"low\")'>" + (correlationsFilterState.low ? "HIDING " : "HIDE ") + corrSevCounts.low + " LOWS</button>&nbsp;";
            if (corrSevCounts.info > 0) html += "<button class='filter-btn" + (correlationsFilterState.info ? " filter-btn-active" : "") + "' id='corr-hide-info' onclick='toggleCorrelationsFilter(\"info\")'>" + (correlationsFilterState.info ? "HIDING " : "HIDE ") + corrSevCounts.info + " INFOS</button>";
            html += "</div></div>";

            // Table matching findings style: Risk | Correlation | Type | Data Elements
            html += "<div class='findings-table-wrapper'>";
            html += "<table id='correlations-panel-table' class='table findings-table tablesorter small'>";
            html += "<colgroup>";
            html += "<col class='col-priority'>";
            html += "<col class='col-corr-name'>";
            html += "<col class='col-corr-type'>";
            html += "<col class='col-corr-elements'>";
            html += "</colgroup>";
            html += "<thead><tr>";
            html += "<th>Risk</th>";
            html += "<th>Correlation</th>";
            html += "<th>Type</th>";
            html += "<th>Data Elements</th>";
            html += "</tr></thead><tbody>";

            for (var i = 0; i < data.length; i++) {
                var risk = data[i][3];
                var riskLower = risk.toLowerCase();
                var badgeClass = '';
                if (risk === 'CRITICAL') badgeClass = 'alert-critical';
                else if (risk === 'HIGH') badgeClass = 'alert-danger';
                else if (risk === 'MEDIUM') badgeClass = 'alert-warning';
                else if (risk === 'LOW') badgeClass = 'alert-info';
                else if (risk === 'INFO') badgeClass = 'alert-success';

                var desc = data[i][5] || '';
                var eventTypes = data[i][8] || '';
                var corrId = data[i][0];

                // Main row (clickable to expand)
                html += "<tr class='finding-row finding-" + riskLower + " corr-row' data-corr-id='" + corrId + "' onclick='toggleCorrelation(\"" + instanceId + "\",\"" + corrId + "\")'>";
                html += "<td><span class='badge " + badgeClass + "'>" + risk + "</span>";
                html += " <i class='glyphicon glyphicon-chevron-right finding-expand-icon' id='corr-icon-" + corrId + "'></i>";
                html += "</td>";
                html += "<td><div class='cell-clamp'>" + data[i][1] + "</div></td>";

                // Type column with clickable links to Data
                if (eventTypes) {
                    var types = eventTypes.split(',');
                    var typeLinks = [];
                    for (var t = 0; t < types.length; t++) {
                        var typ = types[t].trim();
                        if (typ) {
                            typeLinks.push("<a class='finding-type-link' onclick='event.stopPropagation(); dataEventData(\"" + instanceId + "\", \"" + typ.replace(/"/g, '&quot;') + "\", \"" + typ.replace(/"/g, '&quot;') + "\", \"full\");' title='View " + typ + " data'>" + typ + "</a>");
                        }
                    }
                    html += "<td><div class='cell-clamp'>" + typeLinks.join(", ") + "</div></td>";
                } else {
                    html += "<td></td>";
                }

                html += "<td><div class='cell-clamp'>" + data[i][7] + "</div></td>";
                html += "</tr>";

                // Expandable detail row (description + events sub-table)
                html += "<tr class='finding-detail-row finding-" + riskLower + " corr-detail-row' id='corrwell_tr_" + corrId + "'>";
                html += "<td colspan='4'><div class='finding-detail' id='corr-detail-content-" + corrId + "'>";
                if (desc) {
                    html += "<div class='corr-description-wrapper'>";
                    html += "<div class='finding-detail-section detail-description corr-description-wide'>";
                    html += "<div class='finding-detail-label'>Description</div>";
                    html += "<div class='finding-detail-text'>" + desc + "</div>";
                    html += "</div>";
                    html += "</div>";
                }
                html += "<div id='corrwell_td_" + corrId + "' class='corr-events-container'></div>";
                html += "</div></td></tr>";
            }

            html += "</tbody></table></div>";
            panel.html(html);

            initAiCorrelationButtons(instanceId);

            // Enable table sorting matching findings style
            $.tablesorter.addParser({
                id: 'correlationPanelCriticality',
                is: function(s) { return false; },
                format: function(s) {
                    return s.toLowerCase().replace(/critical/,0).replace(/high/,1).replace(/medium/,2).replace(/low/,3).replace(/info/,4);
                },
                type: 'numeric'
            });

            $("#correlations-panel-table").tablesorter({
                headers: { 0: { sorter: 'correlationPanelCriticality' } },
                cssChildRow: 'corr-detail-row',
                sortList: [[0, 0]]
            });
            sf.updateTooltips();
        }

        function renderCorrelationsPanelEmpty(instanceId) {
            var panel = $('#findings-correlations-content');
            var html = "<div class='findings-toolbar'>";
            html += "<div class='findings-toolbar-left'>";
            html += "<button id='btn-panel-rescan' class='btn btn-sm btn-cyan' onclick='runAiCorrelation(\"" + instanceId + "\", \"single\")'>";
            html += "<i class='glyphicon glyphicon-flash'></i>&nbsp;AI SCAN</button>&nbsp;";
            html += "<span class='findings-count'>0 CORRELATIONS</span>";
            html += "</div>";
            html += "<div class='findings-toolbar-right'>";
            html += "<span class='ai-correlation-compact-results' id='ai-correlation-results'></span>";
            html += "</div></div>";
            html += "<div class='alert alert-warning' style='margin: 0;'><h4>No correlations found.</h4>If the scan is still running please reload once it has completed. If the scan is complete, it may not have triggered any correlation rules.</div>";
            panel.html(html);
            initAiCorrelationButtons(instanceId);
        }

        // Scan status
        function scanSummaryView(instanceId) {
            grid = "<div id='scansummary-content'>";

            // === ROW 1: Overall Grade (left col-sm-7) + 5 stacked panels (right col-sm-5) ===
            grid += "<div class='row' id='grade-row' style='display:flex;flex-wrap:wrap;'>";

            // LEFT COLUMN: Overall Grade (wider)
            grid += "<div class='col-sm-7' id='grade-left-col'>";
            grid += "<div class='panel panel-default' id='grade-outer-panel' style='border: 1px solid var(--glass-border); background: var(--bg-secondary);'>";
            grid += "<div class='panel-heading' style='display:flex; justify-content:space-between; align-items:center;'>";
            grid += "<span><i class='glyphicon glyphicon-certificate'></i>&nbsp;&nbsp;OVERALL GRADE</span>";
            grid += "<button class='btn btn-xs btn-sync' id='grade-refresh-btn' onclick='refreshGrade(\"" + instanceId + "\")' title='Recalculate grade'><i class='glyphicon glyphicon-refresh'></i> SYNC</button>";
            grid += "</div>";
            grid += "<div id='grade-panel-body' style='padding: 0;'>";
            grid += "<div style='text-align: center; padding: 30px; color: var(--text-muted); font-family: var(--font-mono); text-transform: uppercase; letter-spacing: 1px;'><i class='glyphicon glyphicon-hourglass'></i> CALCULATING GRADE...</div>";
            grid += "</div></div></div>";

            // Helper to build a severity row with colored pills
            function _sevRow(prefix, defaultVal) {
                var d = defaultVal || '?';
                var r = '';
                r += "<div class='sev-row'>";
                r += "<span class='sev-pill sev-critical'><span class='sev-val' id='" + prefix + "-critical'>" + d + "</span><span class='sev-label'>CRIT</span></span>";
                r += "<span class='sev-pill sev-high'><span class='sev-val' id='" + prefix + "-high'>" + d + "</span><span class='sev-label'>HIGH</span></span>";
                r += "<span class='sev-pill sev-medium'><span class='sev-val' id='" + prefix + "-medium'>" + d + "</span><span class='sev-label'>MED</span></span>";
                r += "<span class='sev-pill sev-low'><span class='sev-val' id='" + prefix + "-low'>" + d + "</span><span class='sev-label'>LOW</span></span>";
                r += "<span class='sev-pill sev-info'><span class='sev-val' id='" + prefix + "-info'>" + d + "</span><span class='sev-label'>INFO</span></span>";
                r += "</div>";
                return r;
            }

            // RIGHT COLUMN: 5 separate panels stacked
            grid += "<div class='col-sm-5' id='right-panels-col' style='display:flex;flex-direction:column;gap:6px;'>";

            // Scan Status panel
            grid += "<div class='summary-right-panel srp-status'>";
            grid += "<div class='srp-header'><i class='glyphicon glyphicon-eye-open srp-icon'></i><span class='srp-title'>SCAN STATUS</span></div>";
            grid += "<div class='srp-body'>";
            grid += "<div class='stat-grid'>";
            grid += "<div class='stat-item'><span class='stat-value' id='tcounter'>?</span><span class='stat-label'>TOTAL</span></div>";
            grid += "<div class='stat-item'><span class='stat-value' id='ucounter'>?</span><span class='stat-label'>UNIQUE</span></div>";
            grid += "<div class='stat-item stat-item-text'><span class='stat-value stat-value-text' id='status'>?</span><span class='stat-label'>STATUS</span></div>";
            grid += "<div class='stat-item'><span class='stat-value' id='errors'>?</span><span class='stat-label'>ERRORS</span></div>";
            grid += "</div>";
            // Progress bar (shown only for active scans)
            grid += "<div id='summary-progress-container' style='display:none;padding:6px 0 0 0;'>";
            grid += "<div style='display:flex;align-items:center;gap:8px;'>";
            grid += "<div class='progress' style='flex:1;height:6px;margin-bottom:0;border-radius:3px;background:var(--bg-primary);'>";
            grid += "<div id='summary-progress-bar' class='progress-bar progress-bar-striped active' role='progressbar' style='width:0%;min-width:2em;text-align:center;line-height:6px;font-size:0;border-radius:3px;'>0%</div>";
            grid += "</div>";
            grid += "<small id='summary-progress-pct' style='white-space:nowrap;font-weight:600;min-width:30px;font-size:11px;color:var(--text-secondary);'></small>";
            grid += "</div>";
            grid += "<div id='summary-progress-details' style='margin-top:4px;font-size:10px;color:var(--text-muted);display:flex;gap:12px;flex-wrap:wrap;'></div>";
            grid += "</div>";
            grid += "</div></div>";

            // Findings panel
            grid += "<div class='summary-right-panel srp-findings'>";
            grid += "<div class='srp-header srp-header-link' onclick='viewFindings(\"${id}\"); window.scrollTo(0,0);'><i class='glyphicon glyphicon-list-alt srp-icon'></i><span class='srp-title'>FINDINGS</span><i class='glyphicon glyphicon-chevron-right srp-arrow'></i></div>";
            grid += "<div class='srp-body'>" + _sevRow('findings') + "</div></div>";

            // Correlations panel
            grid += "<div class='summary-right-panel srp-correlations'>";
            grid += "<div class='srp-header srp-header-link' onclick='viewFindings(\"${id}\"); setTimeout(function(){ switchFindingsTab(\"correlations\", \"${id}\"); }, 100); window.scrollTo(0,0);'><i class='glyphicon glyphicon-exclamation-sign srp-icon'></i><span class='srp-title'>CORRELATIONS</span><i class='glyphicon glyphicon-chevron-right srp-arrow'></i></div>";
            grid += "<div class='srp-body'>" + _sevRow('corr') + "</div></div>";

            // External Vulnerabilities panel
            grid += "<div class='summary-right-panel srp-extvuln'>";
            grid += "<div class='srp-header srp-header-link' onclick='viewVulnerabilities(\"${id}\"); window.scrollTo(0,0);'><i class='glyphicon glyphicon-search srp-icon'></i><span class='srp-title'>EXT. VULNERABILITIES</span><i class='glyphicon glyphicon-chevron-right srp-arrow'></i></div>";
            grid += "<div class='srp-body'>" + _sevRow('nessus', '-') + "</div></div>";

            // Web App Vulnerabilities panel
            grid += "<div class='summary-right-panel srp-webvuln'>";
            grid += "<div class='srp-header srp-header-link' onclick='viewVulnerabilities(\"${id}\"); setTimeout(function(){ switchVulnTab(\"burp\", \"${id}\"); }, 100); window.scrollTo(0,0);'><i class='glyphicon glyphicon-fire srp-icon'></i><span class='srp-title'>WEB APP VULNS</span><i class='glyphicon glyphicon-chevron-right srp-arrow'></i></div>";
            grid += "<div class='srp-body'>" + _sevRow('burp', '-') + "</div></div>";

            grid += "</div>"; // end right column
            grid += "</div>"; // end row 1

            // === ROW 2: Four intel panels across (equal width) ===
            grid += "<div class='row intel-row'>";
            grid += "<div class='col-sm-3'>";
            grid += "<div class='panel panel-default'>";
            grid += "<div class='panel-heading'><i class='glyphicon glyphicon-th-large'></i>&nbsp;&nbsp;ASSET OVERVIEW</div>";
            grid += "<div class='panel-body' style='padding: 0;'><div id='asset-overview-body'>";
            grid += "<div style='text-align:center;padding:20px;color:var(--text-muted);font-family:var(--font-mono);font-size:11px;text-transform:uppercase;letter-spacing:1px;text-shadow:0 0 8px rgba(255,255,255,0.3);'><i class='glyphicon glyphicon-hourglass'></i>&nbsp;LOADING...</div>";
            grid += "</div></div></div></div>";

            grid += "<div class='col-sm-3'>";
            grid += "<div class='panel panel-default'>";
            grid += "<div class='panel-heading'><i class='glyphicon glyphicon-cog'></i>&nbsp;&nbsp;TOP MODULES</div>";
            grid += "<div class='panel-body' style='padding: 0;'><div id='module-activity-body'>";
            grid += "<div style='text-align:center;padding:20px;color:var(--text-muted);font-family:var(--font-mono);font-size:11px;text-transform:uppercase;letter-spacing:1px;text-shadow:0 0 8px rgba(255,255,255,0.3);'><i class='glyphicon glyphicon-hourglass'></i>&nbsp;LOADING...</div>";
            grid += "</div></div></div></div>";

            grid += "<div class='col-sm-3'>";
            grid += "<div class='panel panel-default'>";
            grid += "<div class='panel-heading'><i class='glyphicon glyphicon-warning-sign'></i>&nbsp;&nbsp;ATTACK SURFACE</div>";
            grid += "<div class='panel-body' style='padding: 0;'><div id='attack-surface-body'>";
            grid += "<div style='text-align:center;padding:20px;color:var(--text-muted);font-family:var(--font-mono);font-size:11px;text-transform:uppercase;letter-spacing:1px;text-shadow:0 0 8px rgba(255,255,255,0.3);'><i class='glyphicon glyphicon-hourglass'></i>&nbsp;ANALYZING...</div>";
            grid += "</div></div></div></div>";

            grid += "<div class='col-sm-3'>";
            grid += "<div class='panel panel-default'>";
            grid += "<div class='panel-heading'><i class='glyphicon glyphicon-lock'></i>&nbsp;&nbsp;EXPOSURE INDICATORS</div>";
            grid += "<div class='panel-body' style='padding: 0;'><div id='exposure-indicators-body'>";
            grid += "<div style='text-align:center;padding:20px;color:var(--text-muted);font-family:var(--font-mono);font-size:11px;text-transform:uppercase;letter-spacing:1px;text-shadow:0 0 8px rgba(255,255,255,0.3);'><i class='glyphicon glyphicon-hourglass'></i>&nbsp;ANALYZING...</div>";
            grid += "</div></div></div></div>";
            grid += "</div>"; // end row 2

            // === ROW 3: Geo Intelligence Globe (full width) ===
            grid += "<div class='row'>";
            grid += "<div class='col-sm-12'>";
            grid += "<div class='panel panel-default'>";
            grid += "<div class='panel-heading' style='display:flex; justify-content:space-between; align-items:center;'>";
            grid += "<span><i class='glyphicon glyphicon-globe'></i>&nbsp;&nbsp;GEO INTEL</span>";
            grid += "<span id='globe-hotspot-count' style='font-family:var(--font-mono);font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;'></span>";
            grid += "</div>";
            grid += "<div class='panel-body' style='padding: 0; position: relative; overflow: hidden;'>";
            grid += "<canvas id='globe-canvas' style='width: 100%; display: block; background: var(--bg-primary);'></canvas>";
            grid += "<div id='globe-tooltip' style='display:none;position:absolute;background:rgba(12,12,12,0.95);border:1px solid rgba(255,255,255,0.2);border-radius:0;padding:8px 12px;font-family:var(--font-mono);font-size:11px;color:#fff;text-transform:uppercase;letter-spacing:0.5px;pointer-events:none;z-index:10;box-shadow:0 0 15px rgba(255,255,255,0.1);text-shadow:0 0 8px rgba(255,255,255,0.5);max-width:280px;'></div>";
            grid += "<div id='globe-loading' style='position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:var(--font-mono);font-size:12px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;text-shadow:0 0 10px rgba(255,255,255,0.3);'><i class='glyphicon glyphicon-refresh glyphicon-spin'></i>&nbsp;SCANNING COORDINATES...</div>";
            grid += "</div></div></div>";
            grid += "</div>"; // end row 3

            // === ROW 4: Data Types (full width) ===
            grid += "<div class='row'><div class='col-sm-12'>";
            grid += "<div class='panel panel-default'>";
            grid += "<div class='panel-heading'><i class='glyphicon glyphicon-stats'></i>&nbsp;&nbsp;DATA TYPES</div><div class='panel-body'>";
            grid += "<div id='vbarsummary'></div>";
            grid += "</div></div></div></div>";

            grid += "</div>"; // close scansummary-content

            // Cancel globe animation before removing content
            if (globeAnimationId) { cancelAnimationFrame(globeAnimationId); globeAnimationId = null; }
            $("#scansummary-content").remove();
            $("#ai-correlation-section").remove();
            $("#ai-correlation-table-single").remove();
            $("#ai-correlation-table-cross").remove();
            $("#scanlogs-content").remove();
            $("#stats-bar").remove();
            $("#dedup-bar").remove();
            $("#loader").show();
            $("#btn-export").hide();
            $("#btn-download-logs").hide();
            $("#btn-refresh").hide();
            $("#btn-search").hide();
            $("#scanreminder").show();
            navTo("btn-status");
            pushViewState('btn-status');

            $("#mainbody").append(grid);

            // Collect data and populate variables for use later
            dataloaders.push(
                function() {
                    sf.fetchData('${docroot}/scanstatus', {'id': instanceId}, function(data) {
                        scanName = data[0];
                        scanTarget = data[1];
                        scanStarted = data[2];
                        scanEnded = data[4];
                        scanStatus = data[5];
                        scanCorrelations = data[6];
                        var scanFindingsCounts = data[7] || {};

                        $("#corr-critical").html(scanCorrelations['CRITICAL']);
                        $("#corr-high").html(scanCorrelations['HIGH']);
                        $("#corr-medium").html(scanCorrelations['MEDIUM']);
                        $("#corr-low").html(scanCorrelations['LOW']);
                        $("#corr-info").html(scanCorrelations['INFO']);

                        $("#findings-critical").html(scanFindingsCounts['CRITICAL'] || 0);
                        $("#findings-high").html(scanFindingsCounts['HIGH'] || 0);
                        $("#findings-medium").html(scanFindingsCounts['MEDIUM'] || 0);
                        $("#findings-low").html(scanFindingsCounts['LOW'] || 0);
                        $("#findings-info").html(scanFindingsCounts['INFO'] || 0);
                    });
                }
            );

            dataloaders.push(
                function() {
                    sf.fetchData('${docroot}/scanerrors', {'id': instanceId}, function(data) {
                        $("#errors").html(data.length);
                    });
                }
            );

            // Progress bar inside Scan Status panel
            dataloaders.push(
                function() {
                    sf.fetchData('${docroot}/scanprogress', {'id': instanceId}, function(data) {
                        var container = $('#summary-progress-container');
                        var bar = $('#summary-progress-bar');
                        var status = data.status;

                        if (status == 'FINISHED' || status == 'ABORTED' || status == 'ERROR-FAILED') {
                            container.hide();
                            return;
                        }

                        if (status == 'CREATED' || status == 'INITIALIZING' || status == 'STARTING' || status == 'STARTED' || status == 'RUNNING') {
                            container.show();
                            var pct = data.progressPercent || 0;
                            bar.css('width', pct + '%').attr('aria-valuenow', pct).text(pct + '%');
                            $('#summary-progress-pct').text('~' + pct + '%');

                            var details = '';
                            details += '<span style="font-family:var(--font-mono);text-transform:uppercase;letter-spacing:0.5px;text-shadow:0 0 6px rgba(255,255,255,0.3);"><i class="glyphicon glyphicon-th-list"></i> ' + data.modulesWithResults + '/' + data.modulesTotal + ' MODULES</span>';
                            details += '<span style="font-family:var(--font-mono);text-transform:uppercase;letter-spacing:0.5px;text-shadow:0 0 6px rgba(255,255,255,0.3);"><i class="glyphicon glyphicon-play"></i> ' + data.modulesRunning + ' RUNNING</span>';
                            var ql = data.eventsQueued; if (ql > 999) ql = (ql/1000).toFixed(1) + 'k';
                            details += '<span style="font-family:var(--font-mono);text-transform:uppercase;letter-spacing:0.5px;text-shadow:0 0 6px rgba(255,255,255,0.3);"><i class="glyphicon glyphicon-inbox"></i> ' + ql + ' QUEUED</span>';
                            var tl = data.totalEvents; if (tl > 999) tl = (tl/1000).toFixed(1) + 'k';
                            details += '<span style="font-family:var(--font-mono);text-transform:uppercase;letter-spacing:0.5px;text-shadow:0 0 6px rgba(255,255,255,0.3);"><i class="glyphicon glyphicon-signal"></i> ' + tl + ' EVENTS</span>';
                            details += '<span style="font-family:var(--font-mono);text-transform:uppercase;letter-spacing:0.5px;text-shadow:0 0 6px rgba(255,255,255,0.3);"><i class="glyphicon glyphicon-dashboard"></i> ' + data.eventsPerSecond + '/SEC</span>';
                            $('#summary-progress-details').html(details);
                        } else {
                            container.hide();
                        }
                    });
                }
            );

            dataloaders.push(
                function() {
                    sf.fetchData('${docroot}/scansummary', {'id': instanceId, 'by': 'type'}, function(data) {
                        scanSummary = [];
                        totalCount = 0;
                        uniqueCount = 0;
                        for (i = 0; i < data.length; i++) {
                            scanSummary[i] = {};
                            scanSummary[i].scanId = instanceId;
                            scanSummary[i].id = data[i][0];
                            scanSummary[i].name = data[i][1];
                            scanSummary[i].total = data[i][3];
                            scanSummary[i].counter = data[i][4];
                            scanSummary[i].link = function(d) { return dataEventData(d.scanId, d.name, d.id, "full"); };
                            totalCount += data[i][3];
                            uniqueCount += data[i][4];
                            scanStatus = data[i][5];
                        }

                        for (x = 0; x < i; x++) {
                            scanSummary[x].pct = scanSummary[x].counter / uniqueCount;
                        }

                        $('#ucounter').html(uniqueCount);
                        $('#tcounter').html(totalCount);
                        $('#scanstatusbadge').html(scanStatus);

                        var statusy = "";
                        if (scanStatus == "FINISHED") {
                            statusy = "alert-success";
                        } else if (scanStatus.indexOf("ABORT") >= 0) {
                            statusy = "alert-warning";
                        } else if (scanStatus == "CREATED" || scanStatus == "RUNNING" || scanStatus == "STARTED" || scanStatus == "STARTING" || scanStatus == "INITIALIZING") {
                            statusy = "alert-info";
                        } else if (scanStatus.indexOf("FAILED") >= 0) {
                            statusy = "alert-danger";
                        } else {
                            statusy = "alert-info";
                        }
                        $('#scanstatusbadge').removeClass(["alert-info", "alert-warning", "alert-danger"]).addClass(statusy);
                        $('#status').html(scanStatus);
                        $("#vbarsummary").empty();
                        if (scanSummary.length == 0) {
                          $("#vbarsummary").append("<div id='scansummary-content' class='alert alert-warning' style='font-family:var(--font-mono);text-transform:uppercase;letter-spacing:0.5px;'><h4>NO DATA.</h4>IF THE SCAN IS STILL RUNNING THIS SECTION WILL UPDATE SHORTLY.</div>");
                        } else {
                          sf_viz_vbar("#vbarsummary", scanSummary);
                        }
                        $("#loader").fadeOut(500);
                    });
                }
            );

            // Overall Grade loader
            dataloaders.push(
                function() {
                    sf.fetchData('${docroot}/scangrade', {'id': instanceId}, function(data) {
                        renderGradePanel(data, instanceId);
                    });
                }
            );

            // Geo Intelligence Globe loader
            dataloaders.push(
                function() {
                    var geoPoints = [];
                    var countryHits = {};
                    var addressCount = 0;
                    var loaded = 0;
                    var total = 4;
                    function checkDone() {
                        loaded++;
                        if (loaded >= total) {
                            renderGlobe(geoPoints, countryHits, addressCount);
                        }
                    }
                    // Fetch PHYSICAL_COORDINATES
                    sf.fetchData('${docroot}/scaneventresults', {'id': instanceId, 'eventType': 'PHYSICAL_COORDINATES'}, function(data) {
                        for (var i = 0; i < data.length; i++) {
                            var raw = data[i][1];
                            var parts = raw.split(',');
                            if (parts.length >= 2) {
                                var lat = parseFloat(parts[0].trim());
                                var lon = parseFloat(parts[1].trim());
                                if (!isNaN(lat) && !isNaN(lon)) {
                                    geoPoints.push({lat: lat, lon: lon, label: raw.trim(), type: 'COORDINATES', source: data[i][2] || ''});
                                }
                            }
                        }
                        checkDone();
                    });
                    // Fetch GEOINFO (may contain lat/lon in text)
                    sf.fetchData('${docroot}/scaneventresults', {'id': instanceId, 'eventType': 'GEOINFO'}, function(data) {
                        for (var i = 0; i < data.length; i++) {
                            var raw = data[i][1];
                            var latMatch = raw.match(/(?:latitude|lat)[:\s]*(-?[\d.]+)/i);
                            var lonMatch = raw.match(/(?:longitude|lon|lng)[:\s]*(-?[\d.]+)/i);
                            if (latMatch && lonMatch) {
                                var lat = parseFloat(latMatch[1]);
                                var lon = parseFloat(lonMatch[1]);
                                if (!isNaN(lat) && !isNaN(lon)) {
                                    geoPoints.push({lat: lat, lon: lon, label: raw.substring(0, 80), type: 'GEOINFO', source: data[i][2] || ''});
                                }
                            }
                            var parts = raw.split(',');
                            if (!latMatch && parts.length >= 2) {
                                var lat2 = parseFloat(parts[0].trim());
                                var lon2 = parseFloat(parts[1].trim());
                                if (!isNaN(lat2) && !isNaN(lon2) && Math.abs(lat2) <= 90 && Math.abs(lon2) <= 180) {
                                    geoPoints.push({lat: lat2, lon: lon2, label: raw.substring(0, 80), type: 'GEOINFO', source: data[i][2] || ''});
                                }
                            }
                        }
                        checkDone();
                    });
                    // Fetch PHYSICAL_ADDRESS - count them for header
                    sf.fetchData('${docroot}/scaneventresults', {'id': instanceId, 'eventType': 'PHYSICAL_ADDRESS'}, function(data) {
                        addressCount = data.length;
                        checkDone();
                    });
                    // Fetch COUNTRY_NAME for country highlighting
                    sf.fetchData('${docroot}/scaneventresults', {'id': instanceId, 'eventType': 'COUNTRY_NAME'}, function(data) {
                        for (var i = 0; i < data.length; i++) {
                            var name = data[i][1].trim();
                            if (name) {
                                var key = name.toUpperCase();
                                countryHits[key] = (countryHits[key] || 0) + 1;
                            }
                        }
                        checkDone();
                    });
                }
            );

            // Asset Overview loader
            dataloaders.push(
                function() {
                    sf.fetchData('${docroot}/scansummary', {'id': instanceId, 'by': 'type'}, function(data) {
                        renderAssetOverview(data);
                    });
                }
            );

            // Module Activity loader
            dataloaders.push(
                function() {
                    sf.fetchData('${docroot}/scansummary', {'id': instanceId, 'by': 'module'}, function(data) {
                        renderModuleActivity(data);
                    });
                }
            );

            // Attack Surface loader
            dataloaders.push(
                function() {
                    sf.fetchData('${docroot}/scansummary', {'id': instanceId, 'by': 'type'}, function(data) {
                        renderAttackSurface(data);
                    });
                }
            );

            // Exposure Indicators loader
            dataloaders.push(
                function() {
                    sf.fetchData('${docroot}/scansummary', {'id': instanceId, 'by': 'type'}, function(data) {
                        renderExposureIndicators(data);
                    });
                }
            );

            // Nessus severity counts loader (from Vulnerabilities page API)
            dataloaders.push(
                function() {
                    sf.fetchData('${docroot}/scannessuscount', {'id': instanceId}, function(data) {
                        if (data.success && data.count > 0) {
                            sf.fetchData('${docroot}/scannessuslist', {'id': instanceId}, function(resp) {
                                if (resp.success && resp.results) {
                                    var c = {Critical:0, High:0, Medium:0, Low:0, None:0};
                                    for (var i = 0; i < resp.results.length; i++) {
                                        var sev = resp.results[i].severity || 'None';
                                        // Only count open (non-closed) items
                                        var tracking = resp.results[i].tracking || 0;
                                        if (tracking === 1) continue; // skip closed
                                        if (c.hasOwnProperty(sev)) c[sev]++;
                                        else c['None']++;
                                    }
                                    $('#nessus-critical').html(c.Critical);
                                    $('#nessus-high').html(c.High);
                                    $('#nessus-medium').html(c.Medium);
                                    $('#nessus-low').html(c.Low);
                                    $('#nessus-info').html(c.None);
                                }
                            });
                        } else {
                            $('#nessus-critical').html(0);
                            $('#nessus-high').html(0);
                            $('#nessus-medium').html(0);
                            $('#nessus-low').html(0);
                            $('#nessus-info').html(0);
                        }
                    }, function() {
                        $('#nessus-critical').html(0);$('#nessus-high').html(0);$('#nessus-medium').html(0);$('#nessus-low').html(0);$('#nessus-info').html(0);
                    });
                }
            );

            // Burp severity counts loader (from Vulnerabilities page API)
            dataloaders.push(
                function() {
                    sf.fetchData('${docroot}/scanburpcount', {'id': instanceId}, function(data) {
                        if (data.success && data.count > 0) {
                            sf.fetchData('${docroot}/scanburplist', {'id': instanceId}, function(resp) {
                                if (resp.success && resp.results) {
                                    var c = {High:0, Medium:0, Low:0, Information:0, None:0};
                                    for (var i = 0; i < resp.results.length; i++) {
                                        var sev = resp.results[i].severity || 'None';
                                        var tracking = resp.results[i].tracking || 0;
                                        if (tracking === 1) continue;
                                        if (c.hasOwnProperty(sev)) c[sev]++;
                                        else c['None']++;
                                    }
                                    $('#burp-critical').html(0);
                                    $('#burp-high').html(c.High);
                                    $('#burp-medium').html(c.Medium);
                                    $('#burp-low').html(c.Low);
                                    $('#burp-info').html(c.Information + c.None);
                                }
                            });
                        } else {
                            $('#burp-critical').html(0);$('#burp-high').html(0);$('#burp-medium').html(0);$('#burp-low').html(0);$('#burp-info').html(0);
                        }
                    }, function() {
                        $('#burp-critical').html(0);$('#burp-high').html(0);$('#burp-medium').html(0);$('#burp-low').html(0);$('#burp-info').html(0);
                    });
                }
            );

            loadersrunning = true;
            for (var i = 0; i < dataloaders.length; i++) {
                dataloaders[i]();
            }
            loadersrunning = false;
        }

        // Refresh grade (called from button click)
        function refreshGrade(iid) {
            var btn = $('#grade-refresh-btn');
            btn.prop('disabled', true).find('i').addClass('glyphicon-spin');
            $('#grade-panel-body').html("<div style='text-align: center; padding: 30px; color: var(--text-muted); font-family: var(--font-mono); text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 0 8px rgba(255,255,255,0.3);'><i class='glyphicon glyphicon-refresh glyphicon-spin'></i> RECALCULATING...</div>");
            sf.fetchData('${docroot}/scangrade', {'id': iid}, function(data) {
                renderGradePanel(data, iid);
                btn.prop('disabled', false).find('i').removeClass('glyphicon-spin');
            });
        }

        // Grade color map
        function gradeGlowColor(g) {
            var m = {
                'A': {grad: 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)', glow: 'rgba(34, 197, 94, 0.6)', text: '#22c55e'},
                'B': {grad: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', glow: 'rgba(59, 130, 246, 0.6)', text: '#3b82f6'},
                'C': {grad: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)', glow: 'rgba(245, 158, 11, 0.6)', text: '#f59e0b'},
                'D': {grad: 'linear-gradient(135deg, #f97316 0%, #ea580c 100%)', glow: 'rgba(249, 115, 22, 0.6)', text: '#f97316'},
                'F': {grad: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)', glow: 'rgba(239, 68, 68, 0.6)', text: '#ef4444'}
            };
            return m[g] || m['F'];
        }

        // Render the Overall Grade panel
        function renderGradePanel(gradeData, instanceId) {
            var panel = $('#grade-panel-body');

            if (!gradeData || !gradeData.enabled) {
                panel.html("<div style='text-align:center;padding:20px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase;letter-spacing:1px;text-shadow:0 0 8px rgba(255,255,255,0.3);'>GRADE CALCULATION IS DISABLED. ENABLE IT IN SETTINGS.</div>");
                return;
            }
            if (gradeData.error) {
                panel.html("<div style='text-align:center;padding:20px;color:var(--accent-orange);font-family:var(--font-mono);text-transform:uppercase;letter-spacing:0.5px;'>" + gradeData.error + "</div>");
                return;
            }

            var grade = gradeData.overall_grade || '-';
            var score = gradeData.overall_score || 0;
            var categories = gradeData.categories || {};
            var gc = gradeGlowColor(grade);

            var catOrder = [
                'Network Security', 'Web App Security', 'Information Leakage',
                'General Health', 'External Account Exposure', 'DNS Health',
                'IP Reputation', 'Information / Reference'
            ];

            var h = '';

            // === TOP: Large glowing grade badge centered ===
            h += "<div style='text-align:center;padding:28px 20px 18px 20px;'>";
            // Big glowing circle
            h += "<div style='display:inline-flex;flex-direction:column;align-items:center;justify-content:center;";
            h += "width:130px;height:130px;border-radius:50%;";
            h += "background:" + gc.grad + ";";
            h += "box-shadow:0 0 30px " + gc.glow + ", 0 0 60px " + gc.glow + ", 0 0 90px " + gc.glow + ";";
            h += "border:3px solid rgba(255,255,255,0.2);'>";
            h += "<span style='font-family:var(--font-mono);font-size:56px;font-weight:900;line-height:1;color:#fff;text-shadow:0 0 20px rgba(255,255,255,0.9),0 0 40px rgba(255,255,255,0.5);'>" + grade + "</span>";
            h += "<span style='font-family:var(--font-mono);font-size:16px;font-weight:600;color:rgba(255,255,255,0.9);text-shadow:0 0 10px rgba(255,255,255,0.7);'>" + score + "</span>";
            h += "</div>";
            // Subtitle
            h += "<div style='margin-top:12px;color:var(--text-secondary);font-size:13px;font-family:var(--font-mono);text-transform:uppercase;letter-spacing:1px;text-shadow:0 0 10px rgba(255,255,255,0.4);'>OVERALL SECURITY RATING</div>";
            h += "<div style='color:var(--text-muted);font-size:11px;margin-top:2px;font-family:var(--font-mono);text-transform:uppercase;letter-spacing:0.5px;'>ONLY UNVALIDATED ITEMS COUNT &mdash; VALIDATED &amp; FALSE POSITIVES ARE EXCLUDED</div>";
            if (scanStatus && scanStatus != 'FINISHED' && scanStatus != 'ABORTED' && scanStatus.indexOf('FAILED') < 0) {
                h += "<div style='display:inline-block;margin-top:8px;font-size:10px;color:var(--accent-yellow);background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.2);border-radius:4px;padding:3px 10px;'>";
                h += "<i class='glyphicon glyphicon-exclamation-sign'></i> SCAN IN PROGRESS &mdash; GRADE MAY CHANGE</div>";
            }
            h += "</div>";

            // === CATEGORY CARDS ===
            h += "<div style='padding:0 16px 16px 16px;'>";

            for (var ci = 0; ci < catOrder.length; ci++) {
                var catName = catOrder[ci];
                var cat = categories[catName];
                if (!cat) continue;
                var catId = 'gcat' + ci;
                var cc = gradeGlowColor(cat.grade);
                var hasDetails = cat.details && cat.details.length > 0;

                // Category card
                h += "<div style='background:var(--bg-tertiary);border:1px solid var(--glass-border);border-radius:var(--radius-md);margin-bottom:8px;overflow:hidden;'>";

                // Card header - clickable
                h += "<div onclick='toggleGradeDetail(\"" + catId + "\")' style='display:flex;align-items:center;justify-content:space-between;padding:10px 14px;cursor:pointer;transition:background 0.15s;' onmouseover='this.style.background=\"var(--bg-elevated)\"' onmouseout='this.style.background=\"transparent\"'>";

                // Left: color bar + name + mini badge
                h += "<div style='display:flex;align-items:center;gap:10px;flex:1;'>";
                h += "<div style='width:4px;height:28px;border-radius:2px;background:" + cat.color + ";flex-shrink:0;'></div>";
                h += "<span style='font-weight:600;font-size:13px;color:var(--text-primary);text-transform:uppercase;font-family:var(--font-mono);letter-spacing:0.5px;'>" + catName + "</span>";
                // Mini grade badge with glow
                h += "<span style='display:inline-block;width:26px;height:22px;line-height:22px;text-align:center;border-radius:4px;font-family:var(--font-mono);font-size:11px;font-weight:700;color:#fff;background:" + cc.grad + ";box-shadow:0 0 8px " + cc.glow + ";text-shadow:0 0 6px rgba(255,255,255,0.7);'>" + cat.grade + "</span>";
                h += "</div>";

                // Right: scores
                h += "<div style='display:flex;align-items:center;gap:16px;font-family:var(--font-mono);font-size:12px;'>";
                h += "<div style='text-align:right;'><div style='color:var(--text-muted);font-size:9px;text-transform:uppercase;letter-spacing:0.5px;'>Raw</div><div style='color:var(--text-secondary);'>" + cat.raw_score + "</div></div>";
                h += "<div style='text-align:right;'><div style='color:var(--text-muted);font-size:9px;text-transform:uppercase;letter-spacing:0.5px;'>Adj</div><div style='color:var(--text-secondary);'>" + cat.adj_score + "</div></div>";
                h += "<div style='text-align:right;min-width:36px;'><div style='color:var(--text-muted);font-size:9px;text-transform:uppercase;letter-spacing:0.5px;'>Score</div><div style='color:" + cc.text + ";font-weight:700;'>" + cat.score + "</div></div>";
                if (hasDetails) {
                    h += "<span class='grade-chevron' id='" + catId + "-icon' style='color:var(--text-muted);font-size:10px;transition:transform 0.2s;'>&#9654;</span>";
                }
                h += "</div>";

                h += "</div>"; // end header

                // Detail panel (hidden by default)
                if (hasDetails) {
                    h += "<div id='" + catId + "-detail' style='display:none;border-top:1px solid var(--glass-border);background:var(--bg-secondary);padding:8px 14px 8px 28px;'>";
                    for (var di = 0; di < cat.details.length; di++) {
                        var d = cat.details[di];
                        var ptColor = d.points < 0 ? 'var(--accent-red)' : 'var(--text-muted)';
                        var ptStr = d.points < 0 ? d.points : '0';
                        // Build clickable link to Data > Type for this event type
                        var typeLink = '';
                        var safeType = d.type.replace(/"/g, '&quot;');
                        if (d.type === 'EXTERNAL_VULNERABILITIES') {
                            typeLink = "<a class='finding-type-link' style='cursor:pointer;color:var(--text-secondary);text-decoration:none;border-bottom:1px dotted var(--text-muted);' onclick='viewVulnerabilities(\"" + instanceId + "\"); window.scrollTo(0,0);' title='View External Vulnerabilities'>" + d.type + "</a>";
                        } else if (d.type === 'WEBAPP_VULNERABILITIES') {
                            typeLink = "<a class='finding-type-link' style='cursor:pointer;color:var(--text-secondary);text-decoration:none;border-bottom:1px dotted var(--text-muted);' onclick='viewVulnerabilities(\"" + instanceId + "\"); switchVulnTab(\"burp\", \"" + instanceId + "\"); window.scrollTo(0,0);' title='View Web App Vulnerabilities'>" + d.type + "</a>";
                        } else {
                            typeLink = "<a class='finding-type-link' style='cursor:pointer;color:var(--text-secondary);text-decoration:none;border-bottom:1px dotted var(--text-muted);' onclick='dataEventData(\"" + instanceId + "\", \"" + safeType + "\", \"" + safeType + "\", \"full\"); window.scrollTo(0,0);' title='View " + safeType + " data'>" + d.type + "</a>";
                        }
                        var foundLabel = d.found ? 'FOUND' : 'NOT FOUND';
                        var foundColor = d.found ? 'var(--text-muted)' : 'var(--accent-orange)';
                        h += "<div style='display:flex;justify-content:space-between;align-items:center;padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.04);font-size:11px;'>";
                        h += "<span style='font-family:var(--font-mono);'>" + typeLink + " <span style='color:var(--text-muted);'>(" + d.count + " unval)</span> <span style='color:" + foundColor + ";font-size:9px;'>[" + foundLabel + "]</span></span>";
                        h += "<span style='font-family:var(--font-mono);font-weight:600;color:" + ptColor + ";'>" + ptStr + "</span>";
                        h += "</div>";
                    }
                    h += "</div>";
                }

                h += "</div>"; // end card
            }

            // Unmapped types warning
            if (gradeData.unmapped_types && gradeData.unmapped_types.length > 0) {
                h += "<div style='font-size:11px;color:var(--accent-yellow);background:rgba(245,158,11,0.06);border:1px solid rgba(245,158,11,0.12);border-radius:var(--radius-sm);padding:6px 12px;margin-top:4px;'>";
                h += "<i class='glyphicon glyphicon-info-sign'></i> ";
                h += gradeData.unmapped_types.length + " EVENT TYPE(S) AUTO-CATEGORIZED. ";
                h += "REVIEW IN <a href='${docroot}/opts' style='color:var(--accent-yellow);text-decoration:underline;font-family:var(--font-mono);'>SETTINGS</a>.";
                h += "</div>";
            }

            h += "</div>"; // end padding wrapper

            panel.html(h);

            // Sync right panel heights after grade panel renders (multiple passes for layout settling)
            setTimeout(syncRightPanelHeights, 100);
            setTimeout(syncRightPanelHeights, 400);
            setTimeout(syncRightPanelHeights, 800);
        }

        // Toggle grade category detail row
        function toggleGradeDetail(catId) {
            var detail = $('#' + catId + '-detail');
            var icon = $('#' + catId + '-icon');
            if (detail.is(':visible')) {
                detail.slideUp(150);
                icon.css('transform', 'rotate(0deg)');
            } else {
                detail.slideDown(150);
                icon.css('transform', 'rotate(90deg)');
            }
        }

        // === DYNAMIC PANEL SIZING ===
        // Force right column to exactly match grade panel height.
        // CSS flex:1 on each panel distributes space evenly.
        // Then scale severity values and stat values to fit the available body space.
        function syncRightPanelHeights() {
            var gradeOuter = document.getElementById('grade-outer-panel');
            var rightCol = document.getElementById('right-panels-col');
            if (!gradeOuter || !rightCol) return;

            // Step 1: Force right column to exact grade panel pixel height
            var gradeH = gradeOuter.offsetHeight;
            rightCol.style.height = gradeH + 'px';
            rightCol.style.maxHeight = gradeH + 'px';

            // Step 2: After layout settles, measure actual body heights and scale values
            requestAnimationFrame(function() {
                var bodies = rightCol.querySelectorAll('.srp-body');
                if (bodies.length === 0) return;

                // Get the actual rendered height of one body (they should all be equal via flex:1)
                var bodyH = bodies[0].offsetHeight;

                // Scale value font sizes proportional to body height
                var valFs = Math.max(12, Math.min(22, Math.round(bodyH / 3)));
                var labelFs = Math.max(7, Math.min(10, Math.round(bodyH / 8)));
                var gapPx = Math.max(3, Math.min(8, Math.round(bodyH / 10)));
                var padPx = Math.max(3, Math.min(8, Math.round(bodyH / 8)));

                var vals = rightCol.querySelectorAll('.sev-val, .stat-value:not(.stat-value-text)');
                for (var i = 0; i < vals.length; i++) {
                    vals[i].style.setProperty('font-size', valFs + 'px', 'important');
                }
                // Text values (like STATUS) use the same line-height as number values
                // but font-size adjusts to fit the word within the stat-item width
                var textVals = rightCol.querySelectorAll('.stat-value-text');
                var textFs = Math.max(10, Math.min(14, Math.round(valFs * 0.65)));
                for (var i = 0; i < textVals.length; i++) {
                    textVals[i].style.setProperty('font-size', textFs + 'px', 'important');
                    textVals[i].style.setProperty('line-height', valFs + 'px', 'important');
                }

                var labels = rightCol.querySelectorAll('.sev-label, .stat-label');
                for (var i = 0; i < labels.length; i++) {
                    labels[i].style.setProperty('font-size', labelFs + 'px', 'important');
                }

                var pills = rightCol.querySelectorAll('.sev-pill, .stat-item');
                for (var i = 0; i < pills.length; i++) {
                    pills[i].style.setProperty('padding', padPx + 'px 4px', 'important');
                }

                var rows = rightCol.querySelectorAll('.sev-row, .stat-grid');
                for (var i = 0; i < rows.length; i++) {
                    rows[i].style.setProperty('gap', gapPx + 'px', 'important');
                }
            });
        }

        // Run sync after grade loads and on resize
        $(window).on('resize', function() { setTimeout(syncRightPanelHeights, 50); });
        // Watch for grade content changes
        $(document).on('DOMNodeInserted', '#grade-panel-body', function() {
            setTimeout(syncRightPanelHeights, 200);
            setTimeout(syncRightPanelHeights, 600);
        });

        // === GEO INTELLIGENCE GLOBE ===
        var globeAnimationId = null;
        var globeRotation = 0;
        var globeDragging = false;
        var globeDragStart = {x: 0, y: 0};
        var globeRotX = 0.3; // tilt (slight downward angle to show upper hemisphere)
        var globeRotY = 0;
        var globeHotspots = [];

        // Country name to approximate centroid lat/lon lookup
        var countryCoords = {
            'AFGHANISTAN':[33,65],'ALBANIA':[41,20],'ALGERIA':[28,3],'ANDORRA':[42.5,1.5],'ANGOLA':[-12.5,18.5],
            'ANGUILLA':[18.2,-63],'ANTIGUA AND BARBUDA':[17.05,-61.8],'ARGENTINA':[-34,-64],'ARMENIA':[40,45],
            'ASCENSION ISLAND':[-8,-14.4],'AUSTRALIA':[-27,133],'AUSTRIA':[47.3,13.3],'AZERBAIJAN':[40.5,47.5],
            'BAHAMAS':[24.25,-76],'BAHRAIN':[26,50.5],'BANGLADESH':[24,90],'BARBADOS':[13.2,-59.5],
            'BELARUS':[53,28],'BELGIUM':[50.8,4],'BELIZE':[17.2,-88.7],'BENIN':[9.5,2.2],'BERMUDA':[32.3,-64.8],
            'BHUTAN':[27.5,90.5],'BOLIVIA':[-17,-65],'BOSNIA AND HERZEGOVINA':[44,18],'BOTSWANA':[-22,24],
            'BRAZIL':[-10,-55],'BRUNEI':[4.5,114.7],'BULGARIA':[43,25],'BURKINA FASO':[13,-2],
            'BURUNDI':[-3.5,30],'CAMBODIA':[13,105],'CAMEROON':[6,12],'CANADA':[60,-95],'CAPE VERDE':[16,-24],
            'CAYMAN ISLANDS':[19.5,-80.5],'CENTRAL AFRICAN REPUBLIC':[7,21],'CHAD':[15,19],'CHILE':[-30,-71],
            'CHINA':[35,105],'COLOMBIA':[4,-72],'COMOROS':[-12.2,44.2],'CONGO':[-1,15],
            'DEMOCRATIC REPUBLIC OF THE CONGO':[-4,22],'COSTA RICA':[10,-84],'CROATIA':[45.2,15.5],
            'CUBA':[21.5,-80],'CURACAO':[12.2,-69],'CYPRUS':[35,33],'CZECH REPUBLIC':[49.8,15.5],
            'CZECHIA':[49.8,15.5],'DENMARK':[56,10],'DJIBOUTI':[11.5,43],'DOMINICA':[15.4,-61.4],
            'DOMINICAN REPUBLIC':[19,-70.7],'EAST TIMOR':[-8.8,126],'ECUADOR':[-2,-77.5],
            'EGYPT':[27,30],'EL SALVADOR':[13.8,-88.9],'EQUATORIAL GUINEA':[2,10],'ERITREA':[15,39],
            'ESTONIA':[59,26],'ESWATINI':[-26.5,31.5],'ETHIOPIA':[8,38],'FIJI':[-18,175],
            'FINLAND':[64,26],'FRANCE':[46,2],'GABON':[-1,11.7],'GAMBIA':[13.5,-16.6],
            'GEORGIA':[42,43.5],'GERMANY':[51,9],'GHANA':[8,-2],'GIBRALTAR':[36.1,-5.4],
            'GREECE':[39,22],'GREENLAND':[72,-40],'GRENADA':[12.1,-61.7],'GUAM':[13.4,144.8],
            'GUATEMALA':[15.5,-90.2],'GUERNSEY':[49.5,-2.5],'GUINEA':[11,-10],'GUINEA-BISSAU':[12,-15],
            'GUYANA':[5,-59],'HAITI':[19,-72.4],'HONDURAS':[15,-86.5],'HONG KONG':[22.3,114.2],
            'HUNGARY':[47,20],'ICELAND':[65,-18],'INDIA':[20,77],'INDONESIA':[-5,120],
            'IRAN':[32,53],'IRAQ':[33,44],'IRELAND':[53,-8],'ISLE OF MAN':[54.2,-4.5],
            'ISRAEL':[31.5,34.8],'ITALY':[42.8,12.8],'IVORY COAST':[8,-5.5],'JAMAICA':[18.1,-77.3],
            'JAPAN':[36,138],'JERSEY':[49.2,-2.1],'JORDAN':[31,36],'KAZAKHSTAN':[48,68],
            'KENYA':[1,38],'KIRIBATI':[1.4,173],'KOSOVO':[42.6,21],'KUWAIT':[29.5,47.8],
            'KYRGYZSTAN':[41,75],'LAOS':[18,105],'LATVIA':[57,25],'LEBANON':[33.8,35.8],
            'LESOTHO':[-29.5,28.5],'LIBERIA':[6.5,-9.5],'LIBYA':[25,17],'LIECHTENSTEIN':[47.2,9.5],
            'LITHUANIA':[56,24],'LUXEMBOURG':[49.8,6.2],'MACAO':[22.2,113.5],'NORTH MACEDONIA':[41.5,22],
            'MADAGASCAR':[-20,47],'MALAWI':[-13.5,34],'MALAYSIA':[2.5,112.5],'MALDIVES':[3.2,73],
            'MALI':[17,-4],'MALTA':[35.9,14.4],'MARSHALL ISLANDS':[9,168],'MAURITANIA':[20,-12],
            'MAURITIUS':[-20.3,57.6],'MEXICO':[23,-102],'MICRONESIA':[6.9,158.2],'MOLDOVA':[47,29.5],
            'MONACO':[43.7,7.4],'MONGOLIA':[46,105],'MONTENEGRO':[42.5,19.3],'MOROCCO':[32,-5],
            'MOZAMBIQUE':[-18.2,35],'MYANMAR':[22,98],'NAMIBIA':[-22,17],'NAURU':[-0.5,166.9],
            'NEPAL':[28,84],'NETHERLANDS':[52.5,5.8],'NEW CALEDONIA':[-22.3,166.5],'NEW ZEALAND':[-41,174],
            'NICARAGUA':[13,-85],'NIGER':[16,8],'NIGERIA':[10,8],'NORTH KOREA':[40,127],
            'NORWAY':[62,10],'OMAN':[21,57],'PAKISTAN':[30,70],'PALAU':[7.5,134.5],
            'PALESTINE':[32,35.3],'PANAMA':[9,-80],'PAPUA NEW GUINEA':[-6,147],'PARAGUAY':[-23,-58],
            'PERU':[-10,-76],'PHILIPPINES':[13,122],'POLAND':[52,20],'PORTUGAL':[39.5,-8],
            'PUERTO RICO':[18.2,-66.5],'QATAR':[25.5,51.3],'REUNION':[-21.1,55.5],'ROMANIA':[46,25],
            'RUSSIA':[60,100],'RUSSIAN FEDERATION':[60,100],'RWANDA':[-2,29.9],'SAINT KITTS AND NEVIS':[17.3,-62.7],
            'SAINT LUCIA':[13.9,-61],'SAINT VINCENT AND THE GRENADINES':[13.2,-61.2],'SAMOA':[-13.8,-172],
            'SAN MARINO':[43.9,12.4],'SAO TOME AND PRINCIPE':[1,7],'SAUDI ARABIA':[25,45],
            'SENEGAL':[14,-14],'SERBIA':[44,21],'SEYCHELLES':[-4.7,55.5],'SIERRA LEONE':[8.5,-11.8],
            'SINGAPORE':[1.4,103.8],'SINT MAARTEN':[18,-63.1],'SLOVAKIA':[48.7,19.5],'SLOVENIA':[46.1,15],
            'SOLOMON ISLANDS':[-8,159],'SOMALIA':[5,46],'SOUTH AFRICA':[-29,24],'SOUTH KOREA':[37,127.5],
            'SOUTH SUDAN':[8,30],'SPAIN':[40,-4],'SRI LANKA':[7,81],'SUDAN':[15,30],
            'SURINAME':[4,-56],'SWEDEN':[62,15],'SWITZERLAND':[47,8.2],'SYRIA':[35,38],
            'TAIWAN':[23.5,121],'TAJIKISTAN':[39,71],'TANZANIA':[-6,35],'THAILAND':[15,100],
            'TOGO':[8,1.2],'TONGA':[-20,-175],'TRINIDAD AND TOBAGO':[10.4,-61.3],'TUNISIA':[34,9],
            'TURKEY':[39,35],'TURKMENISTAN':[40,60],'TURKS AND CAICOS ISLANDS':[21.8,-71.8],
            'TUVALU':[-8,178],'UGANDA':[1,32],'UKRAINE':[49,32],'UNITED ARAB EMIRATES':[24,54],
            'UNITED KINGDOM':[54,-2],'UNITED STATES':[38,-97],'UNITED STATES OF AMERICA':[38,-97],
            'USA':[38,-97],'UK':[54,-2],'URUGUAY':[-33,-56],'UZBEKISTAN':[41,64],
            'VANUATU':[-16,167],'VATICAN CITY':[41.9,12.5],'VENEZUELA':[8,-66],'VIETNAM':[16,108],
            'VIRGIN ISLANDS':[18.3,-64.8],'YEMEN':[15,48],'ZAMBIA':[-15,30],'ZIMBABWE':[-20,30],
            "COTE D'IVOIRE":[8,-5.5],'IVORY COAST':[8,-5.5]
        };

        // Simplified country boundary polygons for globe fill rendering
        var countryPolygons = {
            'UNITED STATES':[[49,-125],[49,-67],[45,-67],[41,-70],[35,-75],[30,-81],[25,-80],[25,-97],[32,-117],[37,-122],[48,-125]],
            'UNITED STATES OF AMERICA':[[49,-125],[49,-67],[45,-67],[41,-70],[35,-75],[30,-81],[25,-80],[25,-97],[32,-117],[37,-122],[48,-125]],
            'USA':[[49,-125],[49,-67],[45,-67],[41,-70],[35,-75],[30,-81],[25,-80],[25,-97],[32,-117],[37,-122],[48,-125]],
            'CANADA':[[49,-125],[49,-67],[47,-52],[53,-56],[60,-64],[58,-75],[60,-95],[70,-110],[72,-140],[60,-140],[55,-130],[49,-125]],
            'MEXICO':[[32,-117],[32,-106],[26,-97],[21,-97],[16,-94],[15,-92],[17,-90],[21,-87],[22,-98],[25,-110],[32,-117]],
            'BRAZIL':[[-5,-35],[-2,-44],[2,-50],[5,-52],[5,-60],[2,-67],[-4,-70],[-10,-74],[-17,-68],[-22,-58],[-33,-52],[-30,-50],[-23,-43],[-18,-40],[-12,-37],[-5,-35]],
            'RUSSIA':[[50,30],[55,40],[58,50],[60,60],[55,90],[52,113],[50,120],[50,130],[55,135],[60,130],[65,140],[68,170],[65,180],[70,180],[72,120],[70,50],[65,40],[60,30],[50,30]],
            'RUSSIAN FEDERATION':[[50,30],[55,40],[58,50],[60,60],[55,90],[52,113],[50,120],[50,130],[55,135],[60,130],[65,140],[68,170],[65,180],[70,180],[72,120],[70,50],[65,40],[60,30],[50,30]],
            'CHINA':[[22,98],[22,108],[25,120],[30,122],[35,119],[40,118],[42,130],[47,135],[50,130],[53,120],[48,88],[42,80],[35,75],[28,84],[22,98]],
            'INDIA':[[8,77],[10,77],[15,73],[20,73],[24,69],[28,70],[35,75],[35,80],[28,88],[22,88],[18,84],[13,80],[8,77]],
            'AUSTRALIA':[[-12,130],[-12,136],[-17,141],[-20,149],[-27,153],[-35,151],[-38,146],[-38,141],[-35,137],[-32,130],[-25,113],[-20,118],[-14,127],[-12,130]],
            'UNITED KINGDOM':[[50,-5],[50,1],[53,0],[55,-1],[58,-3],[58,-5],[57,-7],[55,-7],[52,-5],[50,-5]],
            'UK':[[50,-5],[50,1],[53,0],[55,-1],[58,-3],[58,-5],[57,-7],[55,-7],[52,-5],[50,-5]],
            'FRANCE':[[43,-1],[43,3],[44,8],[46,6],[48,8],[49,3],[51,2],[49,-1],[48,-5],[47,-1],[43,-1]],
            'GERMANY':[[47,6],[47,13],[49,13],[51,15],[54,14],[55,9],[54,9],[52,7],[50,6],[47,6]],
            'JAPAN':[[31,130],[33,130],[35,133],[36,137],[37,140],[40,140],[42,141],[44,145],[43,146],[41,140],[38,139],[35,140],[34,137],[34,132],[31,130]],
            'SOUTH KOREA':[[34,126],[35,126],[37,127],[38,128],[37,130],[35,129],[34,127],[34,126]],
            'NORTH KOREA':[[38,125],[39,125],[41,126],[43,130],[42,131],[40,129],[38,128],[38,125]],
            'ITALY':[[37,13],[38,16],[40,16],[41,14],[43,11],[44,12],[46,13],[47,12],[46,7],[44,7],[43,10],[42,12],[40,15],[38,13],[37,13]],
            'SPAIN':[[36,-5],[36,-2],[37,0],[39,0],[42,3],[43,0],[43,-2],[43,-8],[42,-9],[40,-8],[37,-7],[36,-5]],
            'PORTUGAL':[[37,-9],[37,-7],[40,-8],[42,-8],[42,-9],[40,-8],[38,-9],[37,-9]],
            'NETHERLANDS':[[51,4],[51,7],[53,7],[53,5],[52,4],[51,4]],
            'BELGIUM':[[49,3],[49,6],[51,6],[51,3],[50,3],[49,3]],
            'SWITZERLAND':[[46,6],[46,10],[48,10],[48,6],[46,6]],
            'AUSTRIA':[[47,10],[47,17],[49,17],[49,10],[47,10]],
            'POLAND':[[49,15],[49,24],[52,24],[55,18],[54,14],[51,15],[49,15]],
            'UKRAINE':[[45,22],[45,40],[49,40],[52,40],[52,24],[49,22],[45,22]],
            'TURKEY':[[36,26],[36,36],[37,44],[40,44],[42,43],[42,26],[40,26],[38,26],[36,26]],
            'IRAN':[[25,54],[27,60],[30,60],[35,52],[38,44],[38,48],[35,54],[30,62],[25,60],[25,54]],
            'IRAQ':[[30,38],[30,48],[37,46],[37,39],[33,39],[30,38]],
            'SAUDI ARABIA':[[16,42],[18,44],[22,55],[28,50],[30,38],[28,35],[24,38],[20,40],[16,42]],
            'EGYPT':[[22,25],[22,37],[31,34],[32,32],[31,25],[22,25]],
            'SOUTH AFRICA':[[-22,17],[-26,28],[-28,32],[-34,26],[-35,18],[-32,18],[-28,17],[-22,17]],
            'NIGERIA':[[4,3],[4,12],[7,12],[10,14],[14,14],[14,3],[10,3],[4,3]],
            'KENYA':[[-4,34],[-1,41],[4,41],[4,34],[1,34],[-4,34]],
            'ETHIOPIA':[[3,33],[3,48],[15,43],[15,33],[8,33],[3,33]],
            'ARGENTINA':[[-22,-65],[-27,-60],[-35,-57],[-42,-63],[-50,-68],[-55,-68],[-52,-70],[-42,-72],[-35,-70],[-27,-70],[-22,-65]],
            'COLOMBIA':[[-1,-69],[2,-77],[5,-76],[10,-75],[12,-72],[8,-67],[4,-67],[0,-70],[-1,-69]],
            'INDONESIA':[[-8,106],[-8,115],[-5,120],[-2,125],[0,128],[0,140],[-5,140],[-8,135],[-8,120],[-8,106]],
            'PAKISTAN':[[24,62],[24,70],[30,70],[36,71],[37,75],[35,78],[30,67],[25,62],[24,62]],
            'BANGLADESH':[[21,88],[21,92],[26,92],[26,88],[23,88],[21,88]],
            'THAILAND':[[6,100],[6,102],[12,102],[15,105],[18,100],[20,100],[20,105],[14,100],[10,99],[6,100]],
            'VIETNAM':[[8,104],[10,108],[15,108],[20,107],[22,103],[22,107],[16,108],[10,107],[8,104]],
            'PHILIPPINES':[[5,120],[7,122],[10,124],[15,121],[18,122],[17,120],[13,120],[10,118],[5,120]],
            'MALAYSIA':[[1,110],[1,104],[5,103],[7,117],[5,118],[2,111],[1,110]],
            'SINGAPORE':[[1.2,103.6],[1.2,104],[1.5,104],[1.5,103.6],[1.2,103.6]],
            'ISRAEL':[[29,34],[31,34],[33,35],[33,36],[31,35],[29,35],[29,34]],
            'UNITED ARAB EMIRATES':[[22,51],[22,56],[26,56],[26,51],[22,51]],
            'SWEDEN':[[55,12],[58,11],[62,12],[67,15],[69,18],[66,24],[63,19],[60,17],[56,16],[55,12]],
            'NORWAY':[[58,5],[59,5],[62,5],[66,13],[70,20],[71,26],[70,30],[66,16],[62,5],[58,5]],
            'FINLAND':[[60,20],[60,30],[64,26],[68,24],[70,27],[70,30],[68,30],[64,30],[60,28],[60,20]],
            'DENMARK':[[54,8],[55,8],[58,8],[58,13],[56,13],[55,10],[54,8]],
            'IRELAND':[[51,-10],[51,-6],[53,-6],[55,-6],[55,-10],[53,-10],[51,-10]],
            'CZECH REPUBLIC':[[49,12],[49,18],[51,18],[51,12],[49,12]],
            'CZECHIA':[[49,12],[49,18],[51,18],[51,12],[49,12]],
            'ROMANIA':[[44,22],[44,30],[48,27],[48,22],[46,22],[44,22]],
            'HUNGARY':[[46,16],[46,23],[48,23],[48,16],[46,16]],
            'GREECE':[[35,20],[35,27],[39,26],[41,24],[41,20],[39,20],[35,20]],
            'MOROCCO':[[28,-13],[28,0],[35,0],[36,-5],[34,-10],[28,-13]],
            'ALGERIA':[[19,0],[19,12],[28,9],[37,3],[37,-2],[35,-2],[28,-9],[19,0]],
            'TUNISIA':[[30,8],[30,11],[37,10],[37,8],[34,8],[30,8]],
            'LIBYA':[[20,10],[20,25],[33,25],[33,10],[25,10],[20,10]],
            'NEW ZEALAND':[[-34,172],[-37,174],[-41,175],[-47,167],[-45,167],[-41,172],[-37,174],[-34,172]],
            'TAIWAN':[[22,120],[22,121],[25,122],[25,121],[22,120]],
            'HONG KONG':[[22.15,113.85],[22.15,114.35],[22.55,114.35],[22.55,113.85],[22.15,113.85]]
        };

        var globeCountryData = []; // [{lat, lon, name, count, intensity}]

        function renderGlobe(geoPoints, countryHits, addressCount) {
            $('#globe-loading').hide();
            var canvas = document.getElementById('globe-canvas');
            if (!canvas) return;

            var container = canvas.parentElement;
            var w = container.offsetWidth;
            var h = Math.max(380, Math.min(480, w * 0.6));
            canvas.width = w * 2; // retina
            canvas.height = h * 2;
            canvas.style.height = h + 'px';
            var ctx = canvas.getContext('2d');
            ctx.scale(2, 2);

            // Globe zoom: show upper hemisphere only
            // The globe is drawn large and shifted down so only the top half is visible
            var globeZoomScale = 1.8; // make globe much bigger

            // Deduplicate coordinate points by rounding to 0.1 degree
            var seen = {};
            var uniquePoints = [];
            for (var i = 0; i < geoPoints.length; i++) {
                var key = Math.round(geoPoints[i].lat * 10) + ',' + Math.round(geoPoints[i].lon * 10);
                if (!seen[key]) {
                    seen[key] = true;
                    uniquePoints.push(geoPoints[i]);
                }
            }
            globeHotspots = uniquePoints;

            // Build country hotspot data from countryHits
            globeCountryData = [];
            var maxHits = 0;
            for (var name in countryHits) {
                if (countryHits[name] > maxHits) maxHits = countryHits[name];
            }
            for (var name in countryHits) {
                var coords = countryCoords[name];
                if (!coords) {
                    var altNames = [name, name.replace(/\s+/g, ' ')];
                    for (var a = 0; a < altNames.length; a++) {
                        if (countryCoords[altNames[a]]) { coords = countryCoords[altNames[a]]; break; }
                    }
                }
                if (coords) {
                    var intensity = maxHits > 0 ? countryHits[name] / maxHits : 0.3;
                    globeCountryData.push({lat: coords[0], lon: coords[1], name: name, count: countryHits[name], intensity: intensity});
                }
            }
            globeCountryData.sort(function(a, b) { return a.intensity - b.intensity; });

            // Store on hotspots for hover detection
            for (var i = 0; i < globeCountryData.length; i++) {
                globeHotspots.push({lat: globeCountryData[i].lat, lon: globeCountryData[i].lon, label: globeCountryData[i].name, type: 'COUNTRY', source: '', count: globeCountryData[i].count, intensity: globeCountryData[i].intensity});
            }

            var totalCountries = Object.keys(countryHits).length;
            var totalCoords = uniquePoints.length;
            var totalAddresses = addressCount || 0;
            var countParts = [];
            if (totalAddresses > 0) countParts.push(totalAddresses + ' ADDRESS' + (totalAddresses !== 1 ? 'ES' : ''));
            if (totalCoords > 0) countParts.push(totalCoords + ' COORDINATE' + (totalCoords !== 1 ? 'S' : ''));
            if (totalCountries > 0) countParts.push(totalCountries + ' COUNTR' + (totalCountries !== 1 ? 'IES' : 'Y'));
            var countText = countParts.length > 0 ? countParts.join(' &bull; ') : 'NO GEO DATA';
            $('#globe-hotspot-count').html(countText);

            var cx = w / 2;
            var cy = h * 0.85; // push center down so only upper hemisphere shows
            var radius = Math.min(w, h) * 0.38 * globeZoomScale; // scaled up globe

            // Globe interaction
            canvas.onmousedown = function(e) {
                globeDragging = true;
                globeDragStart = {x: e.clientX, y: e.clientY, rotY: globeRotY, rotX: globeRotX};
            };
            canvas.onmousemove = function(e) {
                if (globeDragging) {
                    globeRotY = globeDragStart.rotY + (e.clientX - globeDragStart.x) * 0.005;
                    globeRotX = Math.max(-Math.PI/2, Math.min(Math.PI/2, globeDragStart.rotX + (e.clientY - globeDragStart.y) * 0.005));
                } else {
                    checkGlobeHover(e, canvas, cx, cy, radius);
                }
            };
            canvas.onmouseup = function() { globeDragging = false; };
            canvas.onmouseleave = function() { globeDragging = false; $('#globe-tooltip').hide(); };

            function project(lat, lon) {
                var phi = lat * Math.PI / 180;
                var lam = lon * Math.PI / 180;
                var cosP = Math.cos(phi);
                var x3d = cosP * Math.sin(lam);
                var y3d = Math.sin(phi);
                var z3d = cosP * Math.cos(lam);
                var x2 = x3d * Math.cos(globeRotY) - z3d * Math.sin(globeRotY);
                var z2 = x3d * Math.sin(globeRotY) + z3d * Math.cos(globeRotY);
                var y2 = y3d * Math.cos(globeRotX) - z2 * Math.sin(globeRotX);
                var z3 = y3d * Math.sin(globeRotX) + z2 * Math.cos(globeRotX);
                return { x: cx + x2 * radius, y: cy - y2 * radius, z: z3, visible: z3 > 0 };
            }

            // Threat color based on intensity - white/green only
            function threatColor(intensity) {
                return {r:255,g:255,b:255};                        // white for all
            }

            function drawFrame() {
                var now = Date.now();
                ctx.clearRect(0, 0, w, h);

                // Background
                ctx.fillStyle = '#0c0c0c';
                ctx.fillRect(0, 0, w, h);

                // Globe outer glow - green tinted atmosphere
                var grd = ctx.createRadialGradient(cx, cy, radius * 0.9, cx, cy, radius * 1.4);
                grd.addColorStop(0, 'rgba(34, 197, 94, 0.04)');
                grd.addColorStop(0.5, 'rgba(34, 197, 94, 0.015)');
                grd.addColorStop(1, 'rgba(34, 197, 94, 0)');
                ctx.fillStyle = grd;
                ctx.fillRect(0, 0, w, h);

                // Globe sphere - darker with subtle blue tint
                ctx.beginPath();
                ctx.arc(cx, cy, radius, 0, Math.PI * 2);
                var sphereGrd = ctx.createRadialGradient(cx - radius * 0.3, cy - radius * 0.3, 0, cx, cy, radius);
                sphereGrd.addColorStop(0, 'rgba(20, 25, 35, 1)');
                sphereGrd.addColorStop(0.7, 'rgba(10, 12, 20, 1)');
                sphereGrd.addColorStop(1, 'rgba(5, 6, 12, 1)');
                ctx.fillStyle = sphereGrd;
                ctx.fill();

                // Globe border glow - green tinted
                ctx.beginPath();
                ctx.arc(cx, cy, radius, 0, Math.PI * 2);
                ctx.strokeStyle = 'rgba(34, 197, 94, 0.2)';
                ctx.lineWidth = 1.5;
                ctx.stroke();

                // Outer atmosphere rings
                for (var ring = 1; ring <= 3; ring++) {
                    ctx.beginPath();
                    ctx.arc(cx, cy, radius + ring * 3, 0, Math.PI * 2);
                    ctx.strokeStyle = 'rgba(34, 197, 94, ' + (0.06 / ring) + ')';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }

                // Grid lines - latitude (green tinted)
                ctx.strokeStyle = 'rgba(34, 197, 94, 0.06)';
                ctx.lineWidth = 0.5;
                for (var lat = -60; lat <= 60; lat += 30) {
                    ctx.beginPath();
                    var first = true;
                    for (var lon = -180; lon <= 180; lon += 3) {
                        var p = project(lat, lon);
                        if (p.visible) {
                            if (first) { ctx.moveTo(p.x, p.y); first = false; }
                            else ctx.lineTo(p.x, p.y);
                        } else { first = true; }
                    }
                    ctx.stroke();
                }

                // Grid lines - longitude
                for (var lon = -180; lon < 180; lon += 30) {
                    ctx.beginPath();
                    var first = true;
                    for (var lat = -90; lat <= 90; lat += 3) {
                        var p = project(lat, lon);
                        if (p.visible) {
                            if (first) { ctx.moveTo(p.x, p.y); first = false; }
                            else ctx.lineTo(p.x, p.y);
                        } else { first = true; }
                    }
                    ctx.stroke();
                }

                // Continent outlines + fills
                drawContinents(ctx, project);

                // === COUNTRY FILLS (threat-colored glow, intensity based) ===
                ctx.save();
                ctx.beginPath();
                ctx.arc(cx, cy, radius - 1, 0, Math.PI * 2);
                ctx.clip();

                for (var i = 0; i < globeCountryData.length; i++) {
                    var cd = globeCountryData[i];
                    var poly = countryPolygons[cd.name];
                    var centroid = project(cd.lat, cd.lon);
                    if (!centroid.visible) continue;

                    var pulse = 0.5 + 0.5 * Math.sin(now * 0.002 + i * 2.0);
                    var alpha = 0.15 + cd.intensity * 0.6;
                    var tc = threatColor(cd.intensity);
                    var tcStr = tc.r + ',' + tc.g + ',' + tc.b;

                    if (poly && poly.length >= 3) {
                        var projected = [];
                        var visCount = 0;
                        for (var j = 0; j < poly.length; j++) {
                            var pp = project(poly[j][0], poly[j][1]);
                            projected.push(pp);
                            if (pp.visible) visCount++;
                        }
                        if (visCount >= poly.length * 0.4) {
                            // Filled country polygon - threat colored
                            ctx.beginPath();
                            var started = false;
                            for (var j = 0; j < projected.length; j++) {
                                if (projected[j].visible) {
                                    if (!started) { ctx.moveTo(projected[j].x, projected[j].y); started = true; }
                                    else ctx.lineTo(projected[j].x, projected[j].y);
                                }
                            }
                            ctx.closePath();
                            ctx.fillStyle = 'rgba(' + tcStr + ',' + (alpha * (0.3 + pulse * 0.15)) + ')';
                            ctx.shadowColor = 'rgba(' + tcStr + ',' + (alpha * 0.9) + ')';
                            ctx.shadowBlur = 15 + cd.intensity * 20;
                            ctx.fill();
                            ctx.shadowBlur = 0;

                            // Bright stroke outline
                            ctx.beginPath();
                            started = false;
                            for (var j = 0; j < projected.length; j++) {
                                if (projected[j].visible) {
                                    if (!started) { ctx.moveTo(projected[j].x, projected[j].y); started = true; }
                                    else ctx.lineTo(projected[j].x, projected[j].y);
                                }
                            }
                            ctx.closePath();
                            ctx.strokeStyle = 'rgba(' + tcStr + ',' + (alpha * 0.8) + ')';
                            ctx.lineWidth = 1.2;
                            ctx.stroke();
                        }
                    } else {
                        // Fallback glow region - threat colored
                        var glowSize = 25 + cd.intensity * 25 + pulse * 8;
                        var cGrd = ctx.createRadialGradient(centroid.x, centroid.y, 0, centroid.x, centroid.y, glowSize);
                        cGrd.addColorStop(0, 'rgba(' + tcStr + ',' + (alpha * 0.6) + ')');
                        cGrd.addColorStop(0.3, 'rgba(' + tcStr + ',' + (alpha * 0.3) + ')');
                        cGrd.addColorStop(0.6, 'rgba(' + tcStr + ',' + (alpha * 0.1) + ')');
                        cGrd.addColorStop(1, 'rgba(' + tcStr + ',0)');
                        ctx.beginPath();
                        ctx.arc(centroid.x, centroid.y, glowSize, 0, Math.PI * 2);
                        ctx.fillStyle = cGrd;
                        ctx.fill();
                    }

                    // Country name labels - always show for countries with data
                    if (cd.intensity > 0.15) {
                        var labelSize = Math.max(7, Math.min(11, 7 + cd.intensity * 5));
                        ctx.font = '700 ' + labelSize + 'px JetBrains Mono,monospace';
                        ctx.fillStyle = 'rgba(' + tcStr + ',' + Math.min(1, alpha * 1.5) + ')';
                        ctx.shadowColor = 'rgba(' + tcStr + ',' + (alpha * 0.8) + ')';
                        ctx.shadowBlur = 12;
                        ctx.textAlign = 'center';
                        ctx.fillText(cd.name, centroid.x, centroid.y + 4);
                        // Hit count below name for high-intensity
                        if (cd.intensity > 0.3) {
                            ctx.font = '600 ' + (labelSize - 2) + 'px JetBrains Mono,monospace';
                            ctx.fillStyle = 'rgba(255,255,255,' + (alpha * 0.8) + ')';
                            ctx.fillText(cd.count + ' HITS', centroid.x, centroid.y + 4 + labelSize);
                        }
                        ctx.shadowBlur = 0;
                        ctx.textAlign = 'left';
                    }

                    // Animated expanding ring pulse for high-activity countries
                    if (cd.intensity > 0.4) {
                        var ringPhase = ((now * 0.001 + i * 1.3) % 3) / 3; // 0..1 over 3 seconds
                        var ringR = 8 + ringPhase * 35;
                        var ringAlpha = (1 - ringPhase) * 0.3 * cd.intensity;
                        ctx.beginPath();
                        ctx.arc(centroid.x, centroid.y, ringR, 0, Math.PI * 2);
                        ctx.strokeStyle = 'rgba(' + tcStr + ',' + ringAlpha + ')';
                        ctx.lineWidth = 1.5;
                        ctx.stroke();
                    }
                }
                ctx.restore(); // restore clipping

                // === CONNECTION ARCS between hotspot pairs (green curved lines) ===
                if (uniquePoints.length >= 2) {
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(cx, cy, radius - 1, 0, Math.PI * 2);
                    ctx.clip();

                    var maxArcs = Math.min(15, uniquePoints.length - 1);
                    for (var i = 0; i < maxArcs; i++) {
                        var p1 = project(uniquePoints[i].lat, uniquePoints[i].lon);
                        var j = (i + 1) % uniquePoints.length;
                        var p2 = project(uniquePoints[j].lat, uniquePoints[j].lon);
                        if (!p1.visible || !p2.visible) continue;

                        // Animated dash offset for data flow effect
                        var arcPulse = 0.15 + 0.15 * Math.sin(now * 0.002 + i * 0.8);

                        // Quadratic bezier arc - control point above the midpoint
                        var mx = (p1.x + p2.x) / 2;
                        var my = (p1.y + p2.y) / 2;
                        var dist = Math.sqrt((p2.x - p1.x) * (p2.x - p1.x) + (p2.y - p1.y) * (p2.y - p1.y));
                        var cpx = mx;
                        var cpy = my - dist * 0.3; // arc upward

                        ctx.beginPath();
                        ctx.moveTo(p1.x, p1.y);
                        ctx.quadraticCurveTo(cpx, cpy, p2.x, p2.y);
                        ctx.strokeStyle = 'rgba(34, 197, 94, ' + arcPulse + ')';
                        ctx.lineWidth = 0.8;
                        ctx.stroke();

                        // Animated travel dot along arc
                        var t = ((now * 0.0005 + i * 0.2) % 1);
                        var tt = 1 - t;
                        var dotX = tt * tt * p1.x + 2 * tt * t * cpx + t * t * p2.x;
                        var dotY = tt * tt * p1.y + 2 * tt * t * cpy + t * t * p2.y;
                        ctx.beginPath();
                        ctx.arc(dotX, dotY, 2, 0, Math.PI * 2);
                        ctx.fillStyle = 'rgba(34, 197, 94, 0.8)';
                        ctx.shadowColor = 'rgba(34, 197, 94, 0.9)';
                        ctx.shadowBlur = 8;
                        ctx.fill();
                        ctx.shadowBlur = 0;
                    }
                    ctx.restore();
                }

                // === COORDINATE/ADDRESS HOTSPOTS (bright green dots with rings) ===
                for (var i = 0; i < uniquePoints.length; i++) {
                    var pt = uniquePoints[i];
                    var p = project(pt.lat, pt.lon);
                    if (!p.visible) continue;

                    var pulse = 0.5 + 0.5 * Math.sin(now * 0.003 + i * 1.5);

                    // Outer green glow - bigger and brighter
                    var hotGrd = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, 18 + pulse * 10);
                    hotGrd.addColorStop(0, 'rgba(34, 197, 94, 0.8)');
                    hotGrd.addColorStop(0.2, 'rgba(34, 197, 94, 0.4)');
                    hotGrd.addColorStop(0.5, 'rgba(34, 197, 94, 0.12)');
                    hotGrd.addColorStop(1, 'rgba(34, 197, 94, 0)');
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 18 + pulse * 10, 0, Math.PI * 2);
                    ctx.fillStyle = hotGrd;
                    ctx.fill();

                    // Core bright dot
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
                    ctx.fillStyle = '#4ade80';
                    ctx.shadowColor = 'rgba(34, 197, 94, 1)';
                    ctx.shadowBlur = 20;
                    ctx.fill();
                    ctx.shadowBlur = 0;

                    // Animated expanding ring
                    var ringT = ((now * 0.001 + i * 0.7) % 2) / 2;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 4 + ringT * 18, 0, Math.PI * 2);
                    ctx.strokeStyle = 'rgba(34, 197, 94, ' + ((1 - ringT) * 0.5) + ')';
                    ctx.lineWidth = 1;
                    ctx.stroke();

                    // Crosshair
                    ctx.strokeStyle = 'rgba(34, 197, 94, ' + (0.25 + pulse * 0.2) + ')';
                    ctx.lineWidth = 0.5;
                    ctx.beginPath();
                    ctx.moveTo(p.x - 12, p.y); ctx.lineTo(p.x + 12, p.y);
                    ctx.moveTo(p.x, p.y - 12); ctx.lineTo(p.x, p.y + 12);
                    ctx.stroke();
                }

                // === SCANNING SWEEP ===
                var scanAngle = (now * 0.0008) % (Math.PI * 2);

                // Radar sweep cone
                ctx.save();
                ctx.beginPath();
                ctx.arc(cx, cy, radius - 1, 0, Math.PI * 2);
                ctx.clip();
                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.arc(cx, cy, radius, scanAngle - 0.4, scanAngle, false);
                ctx.closePath();
                var sweepGrd = ctx.createRadialGradient(cx, cy, 0, cx, cy, radius);
                sweepGrd.addColorStop(0, 'rgba(34, 197, 94, 0)');
                sweepGrd.addColorStop(0.5, 'rgba(34, 197, 94, 0.02)');
                sweepGrd.addColorStop(1, 'rgba(34, 197, 94, 0.06)');
                ctx.fillStyle = sweepGrd;
                ctx.fill();
                ctx.restore();

                // Sweep leading edge line
                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.lineTo(cx + Math.cos(scanAngle) * radius, cy + Math.sin(scanAngle) * radius);
                ctx.strokeStyle = 'rgba(34, 197, 94, 0.15)';
                ctx.lineWidth = 1;
                ctx.stroke();

                if (!globeDragging) {
                    globeRotY += 0.002;
                }

                globeAnimationId = requestAnimationFrame(drawFrame);
            }

            // Store project function for hover detection
            canvas._project = project;
            canvas._cx = cx;
            canvas._cy = cy;
            canvas._radius = radius;

            // Cancel previous animation if any
            if (globeAnimationId) cancelAnimationFrame(globeAnimationId);
            drawFrame();
        }

        function checkGlobeHover(e, canvas, cx, cy, radius) {
            var rect = canvas.getBoundingClientRect();
            var mx = e.clientX - rect.left;
            var my = e.clientY - rect.top;
            var tooltip = $('#globe-tooltip');
            var found = false;

            if (canvas._project) {
                for (var i = 0; i < globeHotspots.length; i++) {
                    var pt = globeHotspots[i];
                    var p = canvas._project(pt.lat, pt.lon);
                    if (!p.visible) continue;
                    var dx = mx - p.x;
                    var dy = my - p.y;
                    var hitRadius = pt.type === 'COUNTRY' ? 400 : 225;
                    if (dx * dx + dy * dy < hitRadius) {
                        var html = '';
                        if (pt.type === 'COUNTRY') {
                            html += '<div style="font-weight:700;margin-bottom:4px;color:#fff;text-shadow:0 0 10px rgba(255,255,255,0.8);">' + pt.label + '</div>';
                            html += '<div style="color:var(--text-secondary);">' + pt.count + ' HIT' + (pt.count !== 1 ? 'S' : '') + '</div>';
                            html += '<div style="color:var(--text-muted);margin-top:2px;font-size:10px;">COUNTRY</div>';
                        } else {
                            html += '<div style="font-weight:700;margin-bottom:4px;color:#22c55e;text-shadow:0 0 10px rgba(34,197,94,0.8);">' + pt.type + '</div>';
                            html += '<div style="color:var(--text-secondary);">' + pt.lat.toFixed(4) + ', ' + pt.lon.toFixed(4) + '</div>';
                            if (pt.source) html += '<div style="color:var(--text-muted);margin-top:2px;font-size:10px;">SRC: ' + $('<span>').text(pt.source).html().substring(0, 50) + '</div>';
                        }
                        tooltip.html(html).css({left: mx + 15, top: my - 10}).show();
                        found = true;
                        break;
                    }
                }
            }
            if (!found) tooltip.hide();
        }

        // Simplified continent outlines for the globe
        function drawContinents(ctx, project) {
            var continents = [
                // North America (simplified)
                [
                    [60,-140],[65,-168],[72,-168],[71,-155],[60,-140],[55,-130],[48,-125],
                    [37,-122],[32,-117],[25,-110],[20,-105],[18,-97],[20,-87],[25,-80],
                    [30,-81],[35,-75],[40,-74],[42,-70],[45,-67],[47,-64],[50,-57],
                    [52,-56],[55,-60],[60,-64],[58,-75],[60,-80],[55,-85],[50,-90],
                    [48,-88],[45,-83],[42,-82],[43,-79],[47,-84],[50,-85],[55,-90],
                    [58,-94],[60,-95],[65,-100],[70,-110],[72,-120],[70,-140],[65,-150]
                ],
                // South America
                [
                    [10,-75],[12,-72],[10,-67],[8,-63],[7,-60],[5,-52],[2,-50],
                    [-2,-44],[-5,-35],[-8,-35],[-12,-37],[-15,-39],[-18,-40],
                    [-22,-41],[-23,-43],[-25,-48],[-30,-50],[-33,-52],[-38,-57],
                    [-42,-63],[-46,-66],[-50,-68],[-53,-70],[-55,-68],[-54,-66],
                    [-52,-70],[-48,-75],[-42,-73],[-37,-73],[-33,-72],[-27,-71],
                    [-20,-70],[-15,-75],[-10,-77],[-5,-80],[0,-80],[2,-77],[5,-76]
                ],
                // Europe
                [
                    [36,-5],[37,0],[38,2],[40,0],[43,3],[43,5],[44,8],[44,12],
                    [41,12],[40,15],[38,16],[39,20],[38,24],[40,26],[41,29],
                    [43,28],[44,34],[46,30],[48,24],[50,20],[52,14],[54,10],
                    [55,8],[57,8],[58,6],[59,5],[62,5],[64,10],[68,16],[70,20],
                    [71,26],[70,28],[68,28],[65,25],[63,20],[60,18],[59,10],
                    [57,12],[55,13],[54,14],[53,8],[51,4],[51,1],[50,-5],
                    [48,-5],[47,-1],[44,-1],[43,-8],[40,-8],[37,-9]
                ],
                // Africa
                [
                    [37,10],[35,0],[33,-8],[28,-13],[22,-17],[18,-16],[15,-17],
                    [12,-16],[8,-8],[5,-4],[5,2],[2,10],[0,10],[-1,12],
                    [-5,12],[-10,14],[-12,14],[-15,12],[-18,12],[-20,14],
                    [-23,16],[-25,15],[-28,16],[-30,18],[-33,18],[-34,19],
                    [-34,24],[-34,26],[-33,28],[-30,30],[-25,33],[-20,35],
                    [-15,40],[-10,42],[-5,42],[0,42],[5,43],[10,45],[12,44],
                    [15,40],[20,38],[25,35],[30,32],[32,32],[35,10]
                ],
                // Asia (simplified)
                [
                    [42,30],[40,40],[38,45],[35,45],[30,48],[25,55],[22,60],
                    [25,65],[24,68],[20,73],[15,75],[10,77],[8,80],[5,80],
                    [2,103],[1,104],[5,105],[10,106],[15,108],[20,107],[22,114],
                    [30,122],[35,129],[38,130],[40,132],[43,132],[45,135],[42,140],
                    [45,142],[50,143],[55,135],[60,130],[65,140],[68,160],[66,170],
                    [64,178],[62,179],[60,165],[55,155],[50,140],[55,138],
                    [52,130],[50,120],[52,113],[55,90],[58,70],[60,60],[62,50],
                    [58,50],[55,40],[45,38],[42,30]
                ],
                // Australia
                [
                    [-12,130],[-12,136],[-15,136],[-15,140],[-17,141],[-18,146],
                    [-20,149],[-23,150],[-27,153],[-30,153],[-33,152],[-35,151],
                    [-37,150],[-38,146],[-38,141],[-35,137],[-35,135],[-32,133],
                    [-32,130],[-30,115],[-25,113],[-22,114],[-20,118],[-16,123],
                    [-14,127],[-12,130]
                ]
            ];

            // First pass: fill continents with low-opacity highlight
            for (var c = 0; c < continents.length; c++) {
                var pts = continents[c];
                var projected = [];
                var visCount = 0;
                for (var j = 0; j < pts.length; j++) {
                    var p = project(pts[j][0], pts[j][1]);
                    projected.push(p);
                    if (p.visible) visCount++;
                }
                // Only fill if enough points are visible
                if (visCount >= pts.length * 0.3) {
                    ctx.beginPath();
                    var started = false;
                    for (var j = 0; j < projected.length; j++) {
                        if (projected[j].visible) {
                            if (!started) { ctx.moveTo(projected[j].x, projected[j].y); started = true; }
                            else ctx.lineTo(projected[j].x, projected[j].y);
                        } else {
                            started = false;
                        }
                    }
                    ctx.closePath();
                    // Green-tinted continent fill - much more visible
                    ctx.fillStyle = 'rgba(34, 197, 94, 0.07)';
                    ctx.fill();
                    // Add a subtle inner glow edge
                    ctx.strokeStyle = 'rgba(34, 197, 94, 0.1)';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }

            // Second pass: draw continent outlines (brighter green-white stroke)
            ctx.strokeStyle = 'rgba(34, 197, 94, 0.25)';
            ctx.lineWidth = 1;

            for (var c = 0; c < continents.length; c++) {
                var pts = continents[c];
                ctx.beginPath();
                var started = false;
                for (var j = 0; j < pts.length; j++) {
                    var p = project(pts[j][0], pts[j][1]);
                    if (p.visible) {
                        if (!started) { ctx.moveTo(p.x, p.y); started = true; }
                        else ctx.lineTo(p.x, p.y);
                    } else {
                        started = false;
                    }
                }
                ctx.stroke();
            }
        }

        // === ASSET OVERVIEW PANEL ===
        function renderAssetOverview(data) {
            var panel = $('#asset-overview-body');
            if (!data || data.length === 0) {
                panel.html("<div style='text-align:center;padding:20px;color:var(--text-muted);font-family:var(--font-mono);font-size:11px;text-transform:uppercase;letter-spacing:1px;text-shadow:0 0 8px rgba(255,255,255,0.3);'>NO DATA AVAILABLE</div>");
                return;
            }

            // Categorize event types into asset groups
            var assets = {
                'DOMAINS': {icon: 'glyphicon-globe', count: 0, types: ['INTERNET_NAME', 'DOMAIN_NAME', 'AFFILIATE_INTERNET_NAME', 'CO_HOSTED_SITE', 'SIMILARDOMAIN']},
                'IP ADDRESSES': {icon: 'glyphicon-map-marker', count: 0, types: ['IP_ADDRESS', 'IPV6_ADDRESS', 'AFFILIATE_IPADDR']},
                'EMAILS': {icon: 'glyphicon-envelope', count: 0, types: ['EMAILADDR', 'AFFILIATE_EMAILADDR']},
                'HOSTS': {icon: 'glyphicon-hdd', count: 0, types: ['INTERNET_NAME', 'INTERNET_NAME_UNRESOLVED']},
                'PORTS': {icon: 'glyphicon-transfer', count: 0, types: ['TCP_PORT_OPEN', 'TCP_PORT_OPEN_BANNER', 'UDP_PORT_OPEN', 'UDP_PORT_OPEN_INFO']},
                'CREDENTIALS': {icon: 'glyphicon-lock', count: 0, types: ['ACCOUNT_EXTERNAL_OWNED', 'ACCOUNT_EXTERNAL_USER_SHARED', 'PASSWORD_COMPROMISED', 'EMAILADDR_COMPROMISED']},
                'NAMES': {icon: 'glyphicon-user', count: 0, types: ['HUMAN_NAME', 'USERNAME', 'SOCIAL_MEDIA']},
                'TECH': {icon: 'glyphicon-wrench', count: 0, types: ['WEBSERVER_TECHNOLOGY', 'SOFTWARE_USED', 'OPERATING_SYSTEM', 'WEBSERVER_BANNER']}
            };

            for (var i = 0; i < data.length; i++) {
                var evtType = data[i][0];
                var unique = data[i][4];
                for (var cat in assets) {
                    if (assets[cat].types.indexOf(evtType) >= 0) {
                        assets[cat].count += unique;
                    }
                }
            }

            var h = '';
            for (var cat in assets) {
                var a = assets[cat];
                var textColor = a.count > 0 ? 'var(--text-primary)' : 'var(--text-muted)';
                var countColor = a.count > 0 ? 'var(--text-primary)' : 'var(--text-muted)';
                h += "<div class='asset-overview-row' style='display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid var(--glass-border);'>";
                h += "<div style='display:flex;align-items:center;gap:10px;'>";
                h += "<i class='glyphicon " + a.icon + "' style='color:" + textColor + ";font-size:13px;'></i>";
                h += "<span style='font-family:var(--font-mono);font-size:11px;font-weight:700;color:" + textColor + ";text-transform:uppercase;letter-spacing:0.5px;'>" + cat + "</span>";
                h += "</div>";
                h += "<span style='font-family:var(--font-mono);font-size:14px;font-weight:700;color:" + countColor + ";'>" + a.count + "</span>";
                h += "</div>";
            }
            panel.html(h);
        }

        // === TOP MODULES PANEL ===
        var moduleColors = [
            {color: '#22c55e', glow: 'rgba(34, 197, 94, 0.5)'},   // green
            {color: '#3b82f6', glow: 'rgba(59, 130, 246, 0.5)'},  // blue
            {color: '#f59e0b', glow: 'rgba(245, 158, 11, 0.5)'},  // amber
            {color: '#ef4444', glow: 'rgba(239, 68, 68, 0.5)'},   // red
            {color: '#8b5cf6', glow: 'rgba(139, 92, 246, 0.5)'},  // purple
            {color: '#22d3ee', glow: 'rgba(34, 211, 238, 0.5)'},  // cyan
            {color: '#f97316', glow: 'rgba(249, 115, 22, 0.5)'},  // orange
            {color: '#ec4899', glow: 'rgba(236, 72, 153, 0.5)'},  // pink
            {color: '#14b8a6', glow: 'rgba(20, 184, 166, 0.5)'},  // teal
            {color: '#a3e635', glow: 'rgba(163, 230, 53, 0.5)'}   // lime
        ];

        function renderModuleActivity(data) {
            var panel = $('#module-activity-body');
            if (!data || data.length === 0) {
                panel.html("<div style='text-align:center;padding:20px;color:var(--text-muted);font-family:var(--font-mono);font-size:11px;text-transform:uppercase;letter-spacing:1px;text-shadow:0 0 8px rgba(255,255,255,0.3);'>NO MODULE DATA</div>");
                return;
            }

            // Filter out entries with no module name, sort by unique count descending, take top 8
            var filtered = data.filter(function(d) {
                var name = (d[1] || d[0] || '').toString().trim();
                return name.length > 0 && name !== 'ROOT';
            });
            var sorted = filtered.sort(function(a, b) { return b[4] - a[4]; });
            var top = sorted.slice(0, 8);
            var maxCount = top.length > 0 ? top[0][4] : 1;

            var h = '';
            for (var i = 0; i < top.length; i++) {
                var modName = (top[i][1] || top[i][0]).toString().toUpperCase();
                var count = top[i][4];
                var pct = Math.max(5, (count / maxCount) * 100);
                var mc = moduleColors[i % moduleColors.length];

                h += "<div style='padding:6px 12px;border-bottom:1px solid var(--glass-border);'>";
                h += "<div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;'>";
                h += "<span style='font-family:var(--font-mono);font-size:10px;font-weight:700;color:" + mc.color + ";text-transform:uppercase;letter-spacing:0.5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:70%;' title='" + modName + "'>" + modName + "</span>";
                h += "<span style='font-family:var(--font-mono);font-size:11px;font-weight:700;color:" + mc.color + ";'>" + count + "</span>";
                h += "</div>";
                h += "<div style='height:4px;background:var(--bg-tertiary);border-radius:0;overflow:hidden;'>";
                h += "<div style='height:100%;width:" + pct + "%;background:linear-gradient(90deg, " + mc.color + "66, " + mc.color + ");box-shadow:0 0 8px " + mc.glow + ";transition:width 0.5s ease;'></div>";
                h += "</div>";
                h += "</div>";
            }
            panel.html(h);
        }

        // === ATTACK SURFACE PANEL ===
        function renderAttackSurface(data) {
            var panel = $('#attack-surface-body');
            if (!data || data.length === 0) {
                panel.html("<div style='text-align:center;padding:20px;color:var(--text-muted);font-family:var(--font-mono);font-size:11px;text-transform:uppercase;letter-spacing:1px;'>NO DATA</div>");
                return;
            }

            var surface = {
                'OPEN PORTS': {icon: 'glyphicon-transfer', count: 0, severity: 'warning', types: ['TCP_PORT_OPEN', 'TCP_PORT_OPEN_BANNER', 'UDP_PORT_OPEN', 'UDP_PORT_OPEN_INFO']},
                'WEB SERVERS': {icon: 'glyphicon-cloud', count: 0, severity: 'info', types: ['WEBSERVER_BANNER', 'WEBSERVER_TECHNOLOGY']},
                'SSL/TLS ISSUES': {icon: 'glyphicon-lock', count: 0, severity: 'danger', types: ['SSL_CERTIFICATE_EXPIRED', 'SSL_CERTIFICATE_EXPIRING', 'SSL_CERTIFICATE_MISMATCH', 'SSL_CERTIFICATE_ISSUE']},
                'SUBDOMAINS': {icon: 'glyphicon-list', count: 0, severity: 'info', types: ['INTERNET_NAME', 'INTERNET_NAME_UNRESOLVED']},
                'DNS RECORDS': {icon: 'glyphicon-record', count: 0, severity: 'default', types: ['DNS_TEXT', 'DNS_SPF', 'DNS_SRV']},
                'LEAKED CREDS': {icon: 'glyphicon-alert', count: 0, severity: 'danger', types: ['PASSWORD_COMPROMISED', 'EMAILADDR_COMPROMISED', 'ACCOUNT_EXTERNAL_OWNED']},
                'DARK WEB': {icon: 'glyphicon-eye-close', count: 0, severity: 'danger', types: ['DARKNET_MENTION_URL', 'DARKNET_MENTION_CONTENT']},
                'SOCIAL MEDIA': {icon: 'glyphicon-comment', count: 0, severity: 'default', types: ['SOCIAL_MEDIA', 'USERNAME']}
            };

            var severityColors = {
                'danger': {color: 'var(--accent-red)', glow: 'var(--glow-red)'},
                'warning': {color: 'var(--accent-yellow)', glow: 'var(--glow-yellow)'},
                'info': {color: 'var(--accent-blue)', glow: 'var(--glow-blue)'},
                'default': {color: 'var(--text-secondary)', glow: 'none'}
            };

            for (var i = 0; i < data.length; i++) {
                var evtType = data[i][0];
                var unique = data[i][4];
                for (var cat in surface) {
                    if (surface[cat].types.indexOf(evtType) >= 0) {
                        surface[cat].count += unique;
                    }
                }
            }

            var h = '';
            for (var cat in surface) {
                var s = surface[cat];
                var sc = severityColors[s.severity] || severityColors['default'];
                var textColor = s.count > 0 ? sc.color : 'var(--text-muted)';
                var countColor = s.count > 0 ? sc.color : 'var(--text-muted)';
                h += "<div class='asset-overview-row' style='display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid var(--glass-border);'>";
                h += "<div style='display:flex;align-items:center;gap:10px;'>";
                h += "<i class='glyphicon " + s.icon + "' style='color:" + textColor + ";font-size:13px;'></i>";
                h += "<span style='font-family:var(--font-mono);font-size:11px;font-weight:700;color:" + textColor + ";text-transform:uppercase;letter-spacing:0.5px;'>" + cat + "</span>";
                h += "</div>";
                h += "<span style='font-family:var(--font-mono);font-size:14px;font-weight:700;color:" + countColor + ";'>" + s.count + "</span>";
                h += "</div>";
            }
            panel.html(h);
        }

        // === EXPOSURE INDICATORS PANEL ===
        function renderExposureIndicators(data) {
            var panel = $('#exposure-indicators-body');
            if (!data || data.length === 0) {
                panel.html("<div style='text-align:center;padding:20px;color:var(--text-muted);font-family:var(--font-mono);font-size:11px;text-transform:uppercase;letter-spacing:1px;'>NO DATA</div>");
                return;
            }

            var indicators = {
                'BREACHED EMAILS': {count: 0, severity: 'critical', types: ['EMAILADDR_COMPROMISED']},
                'LEAKED PASSWORDS': {count: 0, severity: 'critical', types: ['PASSWORD_COMPROMISED']},
                'EXPOSED ACCOUNTS': {count: 0, severity: 'high', types: ['ACCOUNT_EXTERNAL_OWNED', 'ACCOUNT_EXTERNAL_USER_SHARED']},
                'MALICIOUS AFFILIATES': {count: 0, severity: 'high', types: ['MALICIOUS_AFFILIATE_IPADDR', 'MALICIOUS_AFFILIATE_INTERNET_NAME']},
                'BLACKLISTED IPS': {count: 0, severity: 'high', types: ['BLACKLISTED_IPADDR', 'BLACKLISTED_AFFILIATE_IPADDR']},
                'DEFACED SITES': {count: 0, severity: 'medium', types: ['DEFACED_INTERNET_NAME', 'DEFACED_AFFILIATE_INTERNET_NAME']},
                'PHONE NUMBERS': {count: 0, severity: 'low', types: ['PHONE_NUMBER']},
                'PUBLIC CODE': {count: 0, severity: 'medium', types: ['PUBLIC_CODE_REPO']}
            };

            var severityIcons = {
                'critical': {icon: 'glyphicon-fire', color: '#dc2626'},
                'high': {icon: 'glyphicon-warning-sign', color: 'var(--accent-red)'},
                'medium': {icon: 'glyphicon-exclamation-sign', color: 'var(--accent-yellow)'},
                'low': {icon: 'glyphicon-info-sign', color: 'var(--accent-blue)'}
            };

            for (var i = 0; i < data.length; i++) {
                var evtType = data[i][0];
                var unique = data[i][4];
                for (var cat in indicators) {
                    if (indicators[cat].types.indexOf(evtType) >= 0) {
                        indicators[cat].count += unique;
                    }
                }
            }

            var h = '';
            for (var cat in indicators) {
                var ind = indicators[cat];
                var si = severityIcons[ind.severity] || severityIcons['low'];
                var textColor = ind.count > 0 ? si.color : 'var(--text-muted)';
                h += "<div class='asset-overview-row' style='display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid var(--glass-border);'>";
                h += "<div style='display:flex;align-items:center;gap:10px;'>";
                h += "<i class='glyphicon " + si.icon + "' style='color:" + textColor + ";font-size:13px;'></i>";
                h += "<span style='font-family:var(--font-mono);font-size:11px;font-weight:700;color:" + textColor + ";text-transform:uppercase;letter-spacing:0.5px;'>" + cat + "</span>";
                h += "</div>";
                h += "<span style='font-family:var(--font-mono);font-size:14px;font-weight:700;color:" + textColor + ";'>" + ind.count + "</span>";
                h += "</div>";
            }
            panel.html(h);
        }

        // Expand the correlation list to show the events associated
        function toggleCorrelation(instanceId, correlationId) {
            var row = $('tr[data-corr-id="' + correlationId + '"]');
            var detail = $('#corr-detail-content-' + correlationId);
            var eventsContainer = $('#corrwell_td_' + correlationId);

            if (row.hasClass('finding-expanded')) {
                row.removeClass('finding-expanded');
                detail.slideUp(150);
                return;
            }

            row.addClass('finding-expanded');
            detail.slideDown(150);

            // Only fetch events if not already loaded
            if (eventsContainer.children().length > 0) return;

            eventsContainer.html("<div style='padding: 10px; text-align: center;'><i class='glyphicon glyphicon-refresh spinning'></i> Loading events...</div>");

            sf.fetchData('${docroot}/scaneventresults', { 'id': instanceId, 'correlationId': correlationId }, function(data) {
                var table = "<table class='table corr-events-table small'>";
                table += "<thead><tr>";
                table += "<th>Type</th>";
                table += "<th>Data Element</th>";
                table += "<th>Source Data Element</th>";
                table += "<th>Source Module</th>";
                table += "<th>Identified</th>";
                table += "</tr></thead><tbody>";

                for (var i = 0; i < data.length; i++) {
                    var evtType = data[i][10] || '';
                    table += "<tr>";
                    // Type column with link to Data
                    if (evtType) {
                        table += "<td><a class='finding-type-link' onclick='dataEventData(\"" + instanceId + "\", \"" + evtType.replace(/"/g, '&quot;') + "\", \"" + evtType.replace(/"/g, '&quot;') + "\", \"full\");' title='View " + evtType + " data'>" + evtType + "</a></td>";
                    } else {
                        table += "<td></td>";
                    }
                    table += "<td><pre class='table-border-bg-inherit'>";
                    table += sf.replace_sfurltag(data[i][1]);
                    table += "</pre></td><td><pre class='table-border-bg-inherit'>";
                    table += sf.replace_sfurltag(data[i][2]);
                    table += "</pre></td><td><pre class='table-border-bg-inherit'>" + data[i][3];
                    table += "</pre></td><td><pre class='table-border-bg-inherit'>" + data[i][0];
                    table += "</pre></td>";
                    table += "</tr>";
                }
                table += "</tbody></table>";
                eventsContainer.html(table);
            });
        }

        // Legacy dataCorrelations - redirect to Findings page with Correlations tab
        function dataCorrelations(instanceId) {
            viewFindings(instanceId);
            // Switch to correlations tab after a short delay to let the DOM render
            setTimeout(function() {
                switchFindingsTab('correlations', instanceId);
            }, 100);
            return;
        }

        // Original correlation data fetching (kept for reference by AI correlation refresh)
        function dataCorrelationsLegacy(instanceId) {
            $("#scansummary-content").remove();
            $("#ai-correlation-section").remove();
            $("#ai-correlation-table-single").remove();
            $("#ai-correlation-table-cross").remove();
            $("#stats-bar").remove();
            $("#dedup-bar").remove();
            $("#loader").show();
            $("#btn-search").hide();
            $("#btn-export").hide();
            $("#scanreminder").hide();
            navTo("btn-findings");
            pushViewState('btn-findings', {findingsTab: 'correlations'});
            refresh = function() { dataCorrelations(instanceId); }
            
            console.log("Fetching correlation data for scan ID: " + instanceId);
            
            // First try the scanstatus endpoint which is known to work in the scanlist view
            sf.fetchData('${docroot}/scanstatus', {'id': instanceId}, 
                function(statusData) {
                    console.log("Got scan status data:", statusData);
                    
                    // Check if we have correlation data in the status response
                    if (statusData && statusData[6] && (
                        (statusData[6]['CRITICAL'] || 0) > 0 ||
                        statusData[6]['HIGH'] > 0 ||
                        statusData[6]['MEDIUM'] > 0 ||
                        statusData[6]['LOW'] > 0 ||
                        statusData[6]['INFO'] > 0
                    )) {
                        console.log("Correlation counts from status: ", statusData[6]);
                        
                        // Now fetch the detailed correlations
                        sf.fetchData('${docroot}/scancorrelations', {'id': instanceId}, 
                            function(data) {
                                console.log("Correlation details received:", data);
                                processCorrelationData(instanceId, data, statusData[6]);
                            },
                            function(xhr, textStatus, errorThrown) {
                                handleCorrelationError(instanceId, xhr, textStatus, errorThrown, statusData[6]);
                            }
                        );
                    } else {
                        console.log("No correlation counts found in status data");
                        noCorrelationsFound();
                    }
                },
                function(xhr, textStatus, errorThrown) {
                    console.error("Error fetching scan status data:", textStatus, errorThrown);
                    
                    // Fall back to the original correlation endpoint
                    sf.fetchData('${docroot}/scancorrelations', {'id': instanceId}, 
                        function(data) {
                            console.log("Correlation details received (fallback):", data);
                            processCorrelationData(instanceId, data);
                        },
                        function(xhr2, textStatus2, errorThrown2) {
                            handleCorrelationError(instanceId, xhr2, textStatus2, errorThrown2);
                        }
                    );
                }
            );
        }

        // Helper function to process correlation data
        function processCorrelationData(instanceId, data, counts) {
            if (!data || data.length == 0) {
                noCorrelationsFound();
                return;
            }
            
            // If we have counts but no details, show the counts
            if (data.length == 0 && counts) {
                var table = "<div id='scansummary-content' class='alert alert-info'>";
                table += "<h4>Correlation Summary</h4>";
                table += "<p>Found correlations but no details available:</p>";
                table += "<ul>";
                table += "<li>High: " + counts['HIGH'] + "</li>";
                table += "<li>Medium: " + counts['MEDIUM'] + "</li>";
                table += "<li>Low: " + counts['LOW'] + "</li>";
                table += "<li>Info: " + counts['INFO'] + "</li>";
                table += "</ul></div>";
                
                $("#loader").fadeOut(500);
                $("#mainbody").append(table);
                return;
            }
            
            var table = "<table id='scansummary-content' class='table table-bordered table-striped table-condensed tablesorter small'>";
            table += "<thead><tr><th>Correlation</th><th>Risk</th><th>Data Elements</th></tr></thead><tbody>";
            
            try {
                for (var i = 0; i < data.length; i++) {
                    table += "<tr>";
                    table += "<td><a style='cursor: pointer' onClick='toggleCorrelation(\"" + instanceId + "\",\"" + data[i][0] + "\")'>" + data[i][1] + "</a>&nbsp;&nbsp;";
                    table += "<i class='glyphicon glyphicon-question-sign' style='color: #ccc' rel='tooltip' data-title=\"" + data[i][5] + "\"></i>";
                    table += "</td>";
                    var statusy = "";
                    if (data[i][3] == "CRITICAL") {
                        statusy = "alert-critical";
                    } else if (data[i][3] == "HIGH") {
                        statusy = "alert-danger";
                    } else if (data[i][3] == "MEDIUM") {
                        statusy = "alert-warning";
                    } else if (data[i][3] == "LOW") {
                        statusy = "alert-info";
                    } else if (data[i][3] == "INFO") {
                        statusy = "alert-success";
                    }
                    table += "<td><span class='badge " + statusy + "'>" + data[i][3] + "</span></td>";
                    table += "<td>" + data[i][7] + "</td>";
                    table += "</tr><tr class='hidden tablesorter-childRow' id='corrwell_tr_" + data[i][0] + "'><td colspan=3 id='corrwell_td_" + data[i][0] + "'></td></tr>";
                }
            } catch (e) {
                console.error("Error processing correlation data:", e, data);
                table = "<div id='scansummary-content' class='alert alert-danger'><h4>Error displaying correlations</h4>An error occurred while processing correlation data: " + e.message + "</div>";
                $("#loader").fadeOut(500);
                $("#mainbody").append(table);
                return;
            }
            
            table += "</tbody></table>";
            $("#loader").fadeOut(500);
            // Add AI correlation section above regular correlations for visibility
            addAiCorrelationSection(instanceId);
            $("#mainbody").append(table);
            $.tablesorter.addParser({
                id: 'criticality',
                is: function(s) {
                    return false;
                },
                format: function(s) {
                    return s.toLowerCase().replace(/critical/,4).replace(/high/,3).replace(/medium/,2).replace(/low/,1).replace(/info/,0);
                },
                type: 'numeric'
            });
            $("#scansummary-content").tablesorter({
                headers: { 1: { sorter: 'criticality' } },
                cssChildRow: 'tablesorter-childRow',
                sortList: [[1, 1]]  // Sort by Risk column (1) in descending order (1) - HIGH first
            });
            sf.updateTooltips();
        }

        function handleCorrelationError(instanceId, xhr, textStatus, errorThrown, counts) {
            console.error("Error fetching correlation data:", textStatus, errorThrown);
            
            var errorMsg = "<div id='scansummary-content' class='alert alert-warning'>";
            
            // If we have counts but failed to get details, at least show the counts
            if (counts) {
                errorMsg += "<h4>Correlation Summary</h4>";
                errorMsg += "<p>Found correlations but couldn't retrieve details:</p>";
                errorMsg += "<ul>";
                errorMsg += "<li>High: " + counts['HIGH'] + "</li>";
                errorMsg += "<li>Medium: " + counts['MEDIUM'] + "</li>";
                errorMsg += "<li>Low: " + counts['LOW'] + "</li>";
                errorMsg += "<li>Info: " + counts['INFO'] + "</li>";
                errorMsg += "</ul>";
            } else {
                errorMsg += "<h4>Error retrieving correlation data</h4>";
                errorMsg += "<p>There was a problem retrieving the correlation data: " + textStatus + "</p>";
            }
            
            if (xhr.responseText) {
                errorMsg += "<p>Server response: " + xhr.responseText + "</p>";
            }
            
            errorMsg += "<button class='btn btn-primary' onclick='dataCorrelations(\"" + instanceId + "\")'>Retry</button>";
            errorMsg += "</div>";
            $("#loader").fadeOut(500);
            $("#mainbody").append(errorMsg);
        }

        function noCorrelationsFound() {
            var table = "<div id='scansummary-content' class='alert alert-warning'><h4>No correlations found.</h4>If the scan is still running please reload once it has completed. If the scan is complete, it may not have triggered any correlation rules.</div>";
            $("#loader").fadeOut(500);
            // Add AI correlation section first for visibility
            addAiCorrelationSection("${id}");
            $("#mainbody").append(table);
            sf.updateTooltips();
        }

        // Add AI correlation section with mode selection
        function addAiCorrelationSection(instanceId) {
            var aiSection = "<div id='ai-correlation-section' class='panel panel-default' style='margin-top: 20px;'>";
            aiSection += "<div class='panel-heading'><i class='glyphicon glyphicon-flash'></i>&nbsp;&nbsp;AI Correlation Analysis</div>";
            aiSection += "<div class='panel-body'>";
            aiSection += "<p>Run AI-powered analysis to identify significant and recurring indicators in scan data.</p>";

            // Mode selection buttons
            aiSection += "<div id='ai-correlation-mode-select' style='margin-bottom: 15px;'>";
            aiSection += "<button id='btn-run-single-correlation' class='btn btn-primary' style='margin-right: 10px;' onclick='runAiCorrelation(\"" + instanceId + "\", \"single\")'>";
            aiSection += "<i class='glyphicon glyphicon-search'></i>&nbsp;Single Scan Analysis</button>";
            aiSection += "<button id='btn-run-cross-correlation' class='btn btn-info' style='margin-right: 10px;' onclick='runAiCorrelation(\"" + instanceId + "\", \"cross\")'>";
            aiSection += "<i class='glyphicon glyphicon-transfer'></i>&nbsp;Cross-Scan Analysis</button>";
            aiSection += "</div>";

            aiSection += "<div id='ai-mode-descriptions'>";
            aiSection += "<p class='text-muted small' id='ai-single-desc'><strong>Single Scan:</strong> Analyze the current scan to find IOCs corroborated by multiple modules or event types.</p>";
            aiSection += "<p class='text-muted small' id='ai-cross-desc'><strong>Cross-Scan:</strong> Compare current scan results with imported historical scan data to find persistent IOCs.</p>";
            aiSection += "</div>";

            aiSection += "<div id='ai-correlation-results' style='margin-top: 15px;'></div>";
            aiSection += "</div></div>";
            $("#mainbody").append(aiSection);

            // Check which modes are available
            sf.fetchData('${docroot}/checkAiCorrelationModes', {'id': instanceId},
                function(data) {
                    if (data.success) {
                        if (!data.cross_scan_available) {
                            $("#btn-run-cross-correlation").prop('disabled', true).addClass('disabled')
                                .attr('title', 'No imported historical data detected. Import data from other scans to enable cross-scan analysis.');
                            $("#ai-cross-desc").html("<strong>Cross-Scan:</strong> <em>Unavailable</em> &mdash; No imported historical data detected. Import data from other scans first.");
                        }
                        if (!data.single_scan_available) {
                            $("#btn-run-single-correlation").prop('disabled', true).addClass('disabled');
                        }
                    }
                },
                function() {
                    // If check fails, leave both buttons enabled
                    console.error("Failed to check correlation modes");
                }
            );

        }

        // Run AI correlation analysis on current scan data
        // Uses $.ajax directly (not sf.fetchData) for proper error/timeout handling
        function runAiCorrelation(instanceId, mode) {
            var btnId = '#btn-panel-rescan';
            var resetBtn = function() {
                $(btnId).prop('disabled', false).html("<i class='glyphicon glyphicon-flash'></i>&nbsp;AI RESCAN");
            };

            $(btnId).prop('disabled', true).html("<i class='glyphicon glyphicon-refresh spinning'></i>&nbsp;Analyzing...");
            $("#ai-correlation-results").html("<span class='text-info'><i class='glyphicon glyphicon-hourglass'></i>&nbsp;Running analysis...</span>");

            $.ajax({
                type: "POST",
                url: '${docroot}/runAiCorrelation',
                data: {'id': instanceId, 'mode': mode},
                dataType: "json",
                timeout: 300000,
                success: function(data) {
                    resetBtn();
                    if (data.success) {
                        if (data.correlations_found > 0) {
                            $("#ai-correlation-results").html("<span class='text-success'><i class='glyphicon glyphicon-ok'></i>&nbsp;" + data.correlations_found + " new correlation(s) found.</span>");
                            setTimeout(function() { loadCorrelationsIntoPanel(instanceId); }, 1500);
                        } else {
                            $("#ai-correlation-results").html("<span class='text-muted'><i class='glyphicon glyphicon-info-sign'></i>&nbsp;No new correlations found.</span>");
                        }
                    } else {
                        $("#ai-correlation-results").html("<span class='text-danger'><i class='glyphicon glyphicon-exclamation-sign'></i>&nbsp;" + (data.error || 'Error') + "</span>");
                    }
                },
                error: function(xhr, textStatus, errorThrown) {
                    resetBtn();
                    var msg = textStatus === 'timeout' ? 'Request timed out' : textStatus;
                    $("#ai-correlation-results").html("<span class='text-danger'><i class='glyphicon glyphicon-exclamation-sign'></i>&nbsp;Failed: " + msg + "</span>");
                }
            });
        }

        // Run duplication check on scan results
        function runDeduplication(instanceId) {
            $("#btn-run-dedup").prop('disabled', true).html("<i class='glyphicon glyphicon-refresh spinning'></i>&nbsp;Checking...");
            $("#dedup-results").html("<span class='text-info'><i class='glyphicon glyphicon-hourglass'></i>&nbsp;Running duplication check...</span>");

            sf.fetchData('${docroot}/deduplicatescan', {'id': instanceId},
                function(data) {
                    $("#btn-run-dedup").prop('disabled', false).html("<i class='glyphicon glyphicon-duplicate'></i>&nbsp;Duplication Check");

                    if (data.success) {
                        if (data.removed > 0) {
                            var msg = "<span class='text-success'><i class='glyphicon glyphicon-ok'></i>&nbsp;Removed <strong>" + data.removed + "</strong> duplicate(s).";
                            if (data.fp_preserved > 0) {
                                msg += " FP status preserved on <strong>" + data.fp_preserved + "</strong> row(s).";
                            }
                            msg += "</span>";
                            $("#dedup-results").html(msg);
                            // Refresh the data view after a brief delay
                            setTimeout(function() { dataEventList(instanceId); }, 1500);
                        } else {
                            $("#dedup-results").html("<span class='text-success'><i class='glyphicon glyphicon-ok'></i>&nbsp;No duplicates found. Scan data is clean.</span>");
                        }
                    } else {
                        $("#dedup-results").html("<span class='text-danger'><i class='glyphicon glyphicon-exclamation-sign'></i>&nbsp;Error: " + (data.message || 'Unknown error') + "</span>");
                    }
                },
                function(xhr, textStatus, errorThrown) {
                    $("#btn-run-dedup").prop('disabled', false).html("<i class='glyphicon glyphicon-duplicate'></i>&nbsp;Duplication Check");
                    $("#dedup-results").html("<span class='text-danger'><i class='glyphicon glyphicon-exclamation-sign'></i>&nbsp;Failed: " + textStatus + "</span>");
                }
            );
        }

        // Logs for the scan
        function viewScanLog(instanceId) {
            $("#scansummary-content").remove();
            $("#ai-correlation-section").remove();
            $("#ai-correlation-table-single").remove();
            $("#ai-correlation-table-cross").remove();
            $("#scanlogs-content").remove();
            $("#stats-bar").remove();
            $("#dedup-bar").remove();
            $("#loader").show();
            $("#btn-search").hide();
            $("#btn-export").hide();
            $("#btn-download-logs").show();
            $("#scanreminder").hide();
            navTo("btn-log");
            pushViewState('btn-info');
            refresh = function() { viewScanLog(instanceId); }
            sf.fetchData('${docroot}/scanlog', {'id': instanceId}, function(data) {
                            var table = "<table id='scanlogs-content' class='table table-bordered table-striped table-condensed small tablesorter' style='table-layout: fixed'>";
                            table += "<thead><tr><th>Time</th><th>Component</th><th>Type</th><th>Event</th></tr></thead><tbody>";
                            for (var i = 0; i < data.length; i++) {
                                if (data[i][2] == "ERROR") {
                                  table += "<tr class='danger'>";
                                } else {
                                  table += "<tr>";
                                }
                                table += "<td>" + data[i][0] + "</a></td>";
                                table += "<td>" + data[i][1] + "</td>";
                                table += "<td>" + data[i][2] + "</td>";
                                table += "<td>" + data[i][3] + "</td>";
                                table += "</tr>";
                            }
                            table += "</tbody></table>";
                            $("#loader").fadeOut(500);
                            $("#mainbody").append(table);
                            $("#scanlogs-content").tablesorter({widgets: ["filter"], widgetOptions : { filter_searchDelay : 300, filter_hideFilters : false }});
            });
        }

        // Category display order (by weight descending, then alphabetical)
        var categoryOrder = [
            'Network Security',
            'Web App Security',
            'Information Leakage',
            'General Health',
            'External Account Exposure',
            'DNS Health',
            'IP Reputation',
            'Information / Reference'
        ];

        var _dataListRawData = []; // Store raw data for re-sorting
        var _dataListSort = 'group'; // Current sort mode
        var _dataListCategoryFilter = {}; // true = active (shown), false = hidden
        var _dataListFilterMode = 'all'; // 'all' = everything shown, 'selective' = user picked specific ones

        // Initialize all categories as active
        function dataListInitFilters() {
            _dataListFilterMode = 'all';
            for (var i = 0; i < categoryOrder.length; i++) {
                _dataListCategoryFilter[categoryOrder[i]] = true;
            }
        }
        dataListInitFilters();

        function updateAllTileVisuals() {
            for (var i = 0; i < categoryOrder.length; i++) {
                var cat = categoryOrder[i];
                var tile = document.getElementById('data-legend-' + cat.replace(/[\s\/]/g, '-'));
                if (!tile) continue;
                if (_dataListCategoryFilter[cat]) {
                    tile.classList.remove('data-legend-inactive');
                } else {
                    tile.classList.add('data-legend-inactive');
                }
            }
        }

        // Toggle a category filter on/off
        function toggleCategoryFilter(catName) {
            if (_dataListFilterMode === 'all') {
                // First click from "all shown": only show the clicked category
                _dataListFilterMode = 'selective';
                for (var i = 0; i < categoryOrder.length; i++) {
                    _dataListCategoryFilter[categoryOrder[i]] = false;
                }
                _dataListCategoryFilter[catName] = true;
            } else {
                // Already in selective mode
                if (_dataListCategoryFilter[catName]) {
                    // Turning off an active one - check if it's the last
                    var activeCount = 0;
                    for (var i = 0; i < categoryOrder.length; i++) {
                        if (_dataListCategoryFilter[categoryOrder[i]]) activeCount++;
                    }
                    if (activeCount <= 1) {
                        // Last active clicked off -> reset to all
                        _dataListFilterMode = 'all';
                        for (var i = 0; i < categoryOrder.length; i++) {
                            _dataListCategoryFilter[categoryOrder[i]] = true;
                        }
                    } else {
                        _dataListCategoryFilter[catName] = false;
                    }
                } else {
                    // Adding another category
                    _dataListCategoryFilter[catName] = true;
                }
            }
            updateAllTileVisuals();
            dataListApplySort(_dataListSort);
        }

        function dataListApplySort(sortMode) {
            _dataListSort = sortMode;
            // Update active button
            $('.data-sort-btn').removeClass('data-sort-active');
            $('#data-sort-' + sortMode).addClass('data-sort-active');

            // Filter by active categories
            var filtered = [];
            for (var i = 0; i < _dataListRawData.length; i++) {
                var cat = _dataListRawData[i][6] || 'Information / Reference';
                if (_dataListCategoryFilter[cat] !== false) {
                    filtered.push(_dataListRawData[i]);
                }
            }

            if (sortMode === 'alpha') {
                filtered.sort(function(a, b) { return a[1].localeCompare(b[1]); });
            } else if (sortMode === 'group') {
                filtered.sort(function(a, b) {
                    var ai = categoryOrder.indexOf(a[6]); if (ai < 0) ai = 99;
                    var bi = categoryOrder.indexOf(b[6]); if (bi < 0) bi = 99;
                    if (ai !== bi) return ai - bi;
                    return a[1].localeCompare(b[1]);
                });
            } else if (sortMode === 'severity') {
                filtered.sort(function(a, b) {
                    // rank ascending (1=most important), then weight desc, then alpha
                    if (a[8] !== b[8]) return a[8] - b[8];
                    if (a[9] !== b[9]) return b[9] - a[9];
                    return a[1].localeCompare(b[1]);
                });
            } else if (sortMode === 'count') {
                filtered.sort(function(a, b) {
                    // Total count descending
                    if (b[3] !== a[3]) return b[3] - a[3];
                    return a[1].localeCompare(b[1]);
                });
            }
            dataListRenderTable(filtered);
        }

        function dataListRenderTable(data) {
            var html = "";
            var lastCategory = null;

            for (var i = 0; i < data.length; i++) {
                var row = data[i];
                var category = row[6] || 'Information / Reference';
                var color = row[7] || '#6b7280';

                // Group header when sorting by group
                if (_dataListSort === 'group' && category !== lastCategory) {
                    lastCategory = category;
                    html += "<tr class='data-list-group-header'>";
                    html += "<td colspan='4' style='border-left: 4px solid " + color + "; padding: 8px 12px;'>";
                    html += "<span style='color: " + color + "; font-weight: 700; font-family: var(--font-mono); font-size: 12px; letter-spacing: 1px; text-transform: uppercase;'>" + category + "</span>";
                    html += "</td></tr>";
                }

                html += "<tr>";
                html += "<td>";
                html += "<a class='data-type-btn' style='border-left: 3px solid " + color + "; padding: 4px 10px; display: inline-block; background: " + color + "18; cursor: pointer;' ";
                html += "onClick='dataEventData(\"${id}\", \"" + escape(row[1]) + "\", \"" + row[0] + "\", \"full\");'>";
                html += row[1] + "</a></td>";
                html += "<td>" + row[4] + "</td>";
                html += "<td>" + row[3] + "</td>";
                html += "<td>" + row[2] + "</td>";
                html += "</tr>";
            }
            $('#data-list-tbody').html(html);
        }

        // Summary of event types and counts for a scan
        function dataEventList(instanceId) {
            currentType = "ALL";
            currentTypeName = "All";

            // Remove pre-existing tables if they exist
            $("#scansummary-content").remove();
            $("#ai-correlation-section").remove();
            $("#ai-correlation-table-single").remove();
            $("#ai-correlation-table-cross").remove();
            $("#scanlogs-content").remove();
            $("#stats-bar").remove();
            $("#dedup-bar").remove();
            $(".data-list-legend").remove();
            navTo("btn-data");
            pushViewState('btn-data', {dataType: 'ALL', dataTypeName: 'All'});
            $("#loader").show();
            $("#btn-export").show();
            $("#btn-download-logs").hide();
            $("#btn-refresh").show();
            $("#btn-search").show();
            $("#scanreminder").hide();
            refresh = function() { dataEventList(instanceId); }
            sf.fetchData('${docroot}/scansummary', {'id': instanceId, 'by': 'type'}, function(data) {
                            _dataListRawData = data;

                            // --- Toolbar bar: sort buttons (left) + dedup (right) ---
                            var toolbar = "<div id='dedup-bar' class='data-list-toolbar'>";

                            // Left: sort buttons
                            toolbar += "<div class='data-sort-group'>";
                            toolbar += "<span class='data-sort-label'>SORT</span>";
                            toolbar += "<button id='data-sort-group' class='data-sort-btn data-sort-active' onclick='dataListApplySort(\"group\")'><i class='glyphicon glyphicon-th-large'></i>&nbsp;Group</button>";
                            toolbar += "<button id='data-sort-alpha' class='data-sort-btn' onclick='dataListApplySort(\"alpha\")'><i class='glyphicon glyphicon-sort-by-alphabet'></i>&nbsp;A\u2013Z</button>";
                            toolbar += "<button id='data-sort-severity' class='data-sort-btn' onclick='dataListApplySort(\"severity\")'><i class='glyphicon glyphicon-warning-sign'></i>&nbsp;Severity</button>";
                            toolbar += "<button id='data-sort-count' class='data-sort-btn' onclick='dataListApplySort(\"count\")'><i class='glyphicon glyphicon-sort-by-order-alt'></i>&nbsp;Count</button>";
                            toolbar += "</div>";

                            // Right: dedup button + results
                            toolbar += "<div class='data-dedup-group'>";
                            toolbar += "<span id='dedup-results' style='display: inline;'></span>";
                            toolbar += "<button id='btn-run-dedup' class='btn btn-warning data-dedup-btn' onclick='runDeduplication(\"${id}\")'>";
                            toolbar += "<i class='glyphicon glyphicon-duplicate'></i>&nbsp;Duplication Check</button>";
                            toolbar += "</div>";
                            toolbar += "</div>";

                            // --- Category filter tiles ---
                            dataListInitFilters();
                            var legend = "<div class='data-list-legend'>";
                            for (var ci = 0; ci < categoryOrder.length; ci++) {
                                var catName = categoryOrder[ci];
                                var catColor = '#6b7280';
                                for (var di = 0; di < data.length; di++) {
                                    if (data[di][6] === catName) { catColor = data[di][7]; break; }
                                }
                                var catCount = 0;
                                for (var di = 0; di < data.length; di++) {
                                    if (data[di][6] === catName) catCount++;
                                }
                                if (catCount > 0) {
                                    var tileId = 'data-legend-' + catName.replace(/[\s\/]/g, '-');
                                    legend += "<button id='" + tileId + "' class='data-legend-tile' style='--tile-color: " + catColor + ";' onclick='toggleCategoryFilter(\"" + catName + "\")'>";
                                    legend += "<span class='data-legend-dot' style='background: " + catColor + ";'></span>";
                                    legend += "<span class='data-legend-tile-name'>" + catName + "</span>";
                                    legend += "<span class='data-legend-count'>" + catCount + "</span>";
                                    legend += "</button>";
                                }
                            }
                            legend += "</div>";

                            // --- Data table ---
                            var table = "<table id='scansummary-content' class='table table-bordered data-list-table'>";
                            table += "<thead><tr><th>Type</th><th>Unique Data Elements</th><th>Total Data Elements</th><th>Last Data Element</th></tr></thead>";
                            table += "<tbody id='data-list-tbody'></tbody></table>";

                            if (data.length < 1) {
                                table = "<div id='scansummary-content' class='alert alert-warning'><h4>No data.</h4>If the scan is still running please try again soon.</div>";
                            }

                            $("#loader").fadeOut(500);
                            $("#mainbody").append(toolbar + legend + table);

                            if (data.length > 0) {
                                // Apply default sort (group)
                                dataListApplySort(_dataListSort);
                            }
            });
        }

        // Detailed view of data for an event type for a scan
        function dataEventData(instanceId, eventTypeLabel, eventType, format, filterFP, filterValidated, filterImportedEntries) {
            if (filterFP === 'undefined' || filterFP === undefined) {
                filterFP = false;
            }
            if (filterValidated === 'undefined' || filterValidated === undefined) {
                filterValidated = false;
            }
            if (filterImportedEntries === 'undefined' || filterImportedEntries === undefined) {
                filterImportedEntries = false;  // Default: show imported entries
            }
            $("#scansummary-content").remove();
            $("#ai-correlation-section").remove();
            $("#ai-correlation-table-single").remove();
            $("#ai-correlation-table-cross").remove();
            $("#scanlogs-content").remove();
            $("#breadcrumbs").remove();
            $("#stats-bar").remove();
            $("#dedup-bar").remove();
            $("#loader").show();
            navTo("btn-data");
            $("#btn-export").show();
            $("#btn-download-logs").hide();
            $("#btn-refresh").show();
            $("#btn-search").show();
            $("#customtabview").show();
            $("#scanreminder").hide();
            currentType = eventType;
            currentTypeName = eventTypeLabel;
            updatePageTitle(currentTypeName);
            pushViewState('btn-data', {dataType: eventType, dataTypeName: eventTypeLabel, dataFormat: format});
            refresh = function() { dataEventData(instanceId, eventTypeLabel, eventType, format, filterFP, filterValidated, filterImportedEntries); }
            dataUpdate = function(newformat) { dataEventData(instanceId, eventTypeLabel, eventType, newformat, filterFP, filterValidated, filterImportedEntries); }
            currentDataFormat = format;

            if (format == 'full') {
                $("#btn-fullview").addClass("active");
                $("#btn-discoverypathview").removeClass("active");
                $("#btn-vizview").removeClass("active");
                $("#modifyactions").show();
                sf.fetchData('${docroot}/scaneventresults', {'id': instanceId, 'eventType': eventType }, function(data) {
                            // Count all categories
                            var stats = {
                                total: 0,
                                fp: 0,           // Current scan FPs
                                fpLegacy: 0,     // Target-level FPs from previous scans
                                validated: 0,     // Current scan validated
                                validatedLegacy: 0, // Target-level validated from previous scans
                                unvalidated: 0,
                                imported: 0,     // Entries imported from older scans
                                knownAsset: 0    // Entries matching known assets
                            };

                            for (var i = 0; i < data.length; i++) {
                                stats.total++;
                                // Count imported entries (data[13] is imported_from_scan)
                                if (data[i][13] != null) {
                                    stats.imported++;
                                }
                                // Count known asset matches (data[14])
                                if (data[i][14] && data[i][14] > 0) {
                                    stats.knownAsset++;
                                }
                                if (data[i][8] == "1") {
                                    stats.fp++;
                                } else if (data[i][11] == 1) {
                                    stats.fpLegacy++;
                                } else if (data[i][8] == "2") {
                                    stats.validated++;
                                } else if (data[i][12] == 1) {
                                    stats.validatedLegacy++;
                                } else {
                                    stats.unvalidated++;
                                }
                            }

                            var totalFP = stats.fp + stats.fpLegacy;
                            var totalValidated = stats.validated + stats.validatedLegacy;

                            // Full-width stats bar with integrated filter buttons
                            // Inline styles ensure sticky positioning works even if CSS doesn't load properly
                            var statsBar = "<div id='stats-bar' class='stats-bar-fullwidth' style='position: sticky; position: -webkit-sticky; top: 0; z-index: 101;'>";

                            // Left side: Stats
                            statsBar += "<div class='stats-bar-left'>";
                            statsBar += "<div class='stats-item'><span class='stats-value'>" + stats.total + "</span><span class='stats-label'>TOTAL</span></div>";
                            statsBar += "<div class='stats-item stats-fp'><span class='stats-value'>" + stats.fp + "</span><span class='stats-label'>FALSE POSITIVES</span></div>";
                            statsBar += "<div class='stats-item stats-validated'><span class='stats-value'>" + stats.validated + "</span><span class='stats-label'>VALIDATED</span></div>";
                            statsBar += "<div class='stats-item stats-unvalidated'><span class='stats-value'>" + stats.unvalidated + "</span><span class='stats-label'>UNVALIDATED</span></div>";
                            if (stats.imported > 0) {
                                statsBar += "<div class='stats-item stats-imported'><span class='stats-value'>" + stats.imported + "</span><span class='stats-label'>IMPORTED</span></div>";
                            }
                            if (stats.knownAsset > 0) {
                                statsBar += "<div class='stats-item stats-known-asset'><span class='stats-value'>" + stats.knownAsset + "</span><span class='stats-label'>KNOWN ASSETS</span></div>";
                            }
                            statsBar += "</div>";

                            // Right side: Filter buttons - use client-side filtering
                            statsBar += "<div class='stats-bar-right'>";

                            // Hide FP button - uses client-side toggle
                            if (totalFP > 0) {
                                var fpBtnClass = clientFilterState.fp ? 'filter-btn filter-btn-active filter-btn-fp' : 'filter-btn filter-btn-fp';
                                var fpBtnText = clientFilterState.fp ? 'HIDING ' + totalFP + ' FP' : 'HIDE ' + totalFP + ' FP';
                                statsBar += "<button class='" + fpBtnClass + "' data-show-text='HIDE " + totalFP + " FP' data-hiding-text='HIDING " + totalFP + " FP' onclick=\"toggleClientFilter('fp')\">";
                                statsBar += fpBtnText + "</button>";
                            }

                            // Hide Validated button - uses client-side toggle
                            if (totalValidated > 0) {
                                var valBtnClass = clientFilterState.validated ? 'filter-btn filter-btn-active filter-btn-validated' : 'filter-btn filter-btn-validated';
                                var valBtnText = clientFilterState.validated ? 'HIDING ' + totalValidated + ' VALIDATED' : 'HIDE ' + totalValidated + ' VALIDATED';
                                statsBar += "<button class='" + valBtnClass + "' data-show-text='HIDE " + totalValidated + " VALIDATED' data-hiding-text='HIDING " + totalValidated + " VALIDATED' onclick=\"toggleClientFilter('validated')\">";
                                statsBar += valBtnText + "</button>";
                            }

                            // Hide Imported button - uses client-side toggle
                            if (stats.imported > 0) {
                                var impBtnClass = clientFilterState.imported ? 'filter-btn filter-btn-active filter-btn-imported' : 'filter-btn filter-btn-imported';
                                var impBtnText = clientFilterState.imported ? 'HIDING ' + stats.imported + ' IMPORTED' : 'HIDE ' + stats.imported + ' IMPORTED';
                                statsBar += "<button class='" + impBtnClass + "' data-show-text='HIDE " + stats.imported + " IMPORTED' data-hiding-text='HIDING " + stats.imported + " IMPORTED' onclick=\"toggleClientFilter('imported')\">";
                                statsBar += impBtnText + "</button>";
                            }

                            // Select Known Assets button
                            if (stats.knownAsset > 0) {
                                statsBar += "<button class='filter-btn filter-btn-known-asset' onclick='selectKnownAssets()'>";
                                statsBar += "SELECT " + stats.knownAsset + " KNOWN</button>";
                            }

                            statsBar += "</div>";
                            statsBar += "</div>";

                            var table = "<table id='scansummary-content' class='table table-bordered table-striped small tablesorter'>";
                            var thStyle = "";
                            table += "<thead><tr>";
                            table += "<th class='text-center' " + thStyle + "><input id='checkall' type='checkbox' onClick='switchSelectAll()'></th>";
                            table += "<th class='text-center validation-status' " + thStyle + ">Status</th>";
                            table += "<th " + thStyle + ">Data Element</th>";
                            table += "<th " + thStyle + ">Source Data Element</th>";
                            table += "<th " + thStyle + ">Source Module</th>";
                            table += "<th " + thStyle + ">Identified</th>";
                            table += "</tr></thead><tbody>";

                            for (var i = 0; i < data.length; i++) {
                                // All rows are rendered - filtering is done client-side
                                // Check if this entry is imported
                                var isImported = data[i][13] != null;
                                // Check if this matches a known asset (index 14)
                                var isKnownAsset = data[i][14] && data[i][14] > 0;

                                var rowClasses = [];
                                if (isImported) rowClasses.push("imported-row");
                                if (isKnownAsset) rowClasses.push("known-asset-row");
                                table += "<tr" + (rowClasses.length > 0 ? " class='" + rowClasses.join(" ") + "'" : "") + ">";
                                // Checkbox column (simple checkbox only, no persistence indicators)
                                table += "<td class='text-center'><input type='checkbox' id='cb_" + data[i][7] + "'></td>";

                                // Status column with text badges
                                // Imported entries get a purple glow behind the status badge
                                table += "<td class='text-center validation-status'>";
                                // Determine status: FP=1 or target-level FP = False Positive (ORANGE)
                                // FP=2 or target-level validated = Validated (BLUE)
                                // Otherwise = Unvalidated (GREY)
                                var importedClass = isImported ? " status-imported-glow" : "";
                                if (data[i][8] == "1" || data[i][11] == 1) {
                                    // Current scan marked as FP or target-level FP
                                    table += "<span class='status-fp" + importedClass + "' title='False Positive - confirmed does not belong to organization'>FALSE POSITIVE</span>";
                                } else if (data[i][8] == "2" || data[i][12] == 1) {
                                    // Current scan marked as validated or target-level validated
                                    table += "<span class='status-validated" + importedClass + "' title='Validated - confirmed belongs to organization'>VALIDATED</span>";
                                } else {
                                    table += "<span class='status-unvalidated" + importedClass + "' title='Not yet reviewed'>UNVALIDATED</span>";
                                }
                                // Known asset badge
                                if (isKnownAsset) {
                                    table += "<br><span class='status-known-asset' title='Matches a known asset'>KNOWN ASSET</span>";
                                }
                                table += "</td>";

                                table += "<td><pre class='table-border-bg-inherit'>";
                                //table += "<a href='${docroot}/entityinfo?id=" + data[i][7] + "'>" + data[i][1] + "</a>";
                                table += sf.replace_sfurltag(data[i][1]);
                                table += "</pre></td><td><pre class='table-border-bg-inherit'>";
                                table += sf.replace_sfurltag(data[i][2]);
                                table += "</pre></td><td><pre class='table-border-bg-inherit'>" + data[i][3];
                                table += "</pre></td><td><pre class='table-border-bg-inherit'>" + data[i][0];
                                table += "</pre></td>";
                                table += "</tr>";
                            }
                            table += "</tbody></table>"
                            $("#loader").fadeOut(500);
                            $("#mainbody").append(statsBar + table);

                            // Set sticky headers below stats bar
                            var dataStatsBar = document.getElementById('stats-bar');
                            if (dataStatsBar) {
                                var barHeight = dataStatsBar.offsetHeight;
                                $('#scansummary-content thead th').each(function() {
                                    this.style.setProperty('position', 'sticky', 'important');
                                    this.style.setProperty('top', barHeight + 'px', 'important');
                                    this.style.setProperty('z-index', '100', 'important');
                                    $(this).addClass('data-sticky-th');
                                });
                            }

                            $("#scansummary-content").tablesorter({ headers: { 0: { sorter: false }, 1: { sorter: false } } });

                            // Apply any active client-side filters after table render
                            if (clientFilterState.fp || clientFilterState.validated || clientFilterState.imported) {
                                applyClientSideFilters();
                            }
                            lastChecked = null;
                            var chkboxes = $('input[id*=cb_]');
                            chkboxes.click(function(e) {
                                if(!lastChecked) {
                                    lastChecked = this;
                                    return;
                                }

                                if(e.shiftKey) {
                                    var start = chkboxes.index(this);
                                    var end = chkboxes.index(lastChecked);

                                    chkboxes.slice(Math.min(start,end), Math.max(start,end)+ 1).prop('checked', lastChecked.checked);

                                }

                                lastChecked = this;
                            });

                            // Make clicking anywhere in first cell toggle checkbox
                            $("#scansummary-content td:first-child").click(function(e) {
                                // Only toggle if not clicking directly on checkbox
                                if (e.target.type !== 'checkbox') {
                                    var cb = $(this).find("input[type='checkbox']");
                                    cb.prop('checked', !cb.prop('checked'));
                                    updateSelectionToolbar();
                                }
                            });

                            // Update toolbar when any checkbox changes
                            $("input[id*=cb_]").change(function() {
                                updateSelectionToolbar();
                            });

                            // Update toolbar when "select all" checkbox changes
                            $("#checkall").change(function() {
                                updateSelectionToolbar();
                            });

                });
            }

            if (format == 'discovery-path') {
                $("#btn-discoverypathview").addClass("active");
                $("#btn-fullview").removeClass("active");
                $("#btn-vizview").removeClass("active");
                $("#modifyactions").show();

                // Fetch both datasets: full view data (for ordering + FP status) and discovery tree (for paths)
                var fullViewData = null;
                var discoveryData = null;
                var loaded = 0;

                function onBothLoaded() {
                    var treeData = discoveryData['tree'];
                    var dataMap = discoveryData['data'];

                    // Build a lookup from leaf hash to its path (array of node objects from root to leaf)
                    var leafPaths = {};

                    function walkTree(node, pathSoFar) {
                        var nodeName = node.name;
                        var nodeInfo = dataMap[nodeName];
                        var currentPath = pathSoFar.slice();
                        if (nodeInfo) {
                            currentPath.push({
                                data: sf.remove_sfurltag(String(nodeInfo[1])),
                                type: nodeInfo[10] || nodeInfo[4],
                                module: nodeInfo[3] || '',
                                hash: nodeInfo[8],
                                isRoot: nodeInfo[4] === 'ROOT'
                            });
                        }

                        if (!node.children || node.children.length === 0) {
                            // Leaf node - store the path keyed by hash
                            if (nodeInfo && nodeInfo[4] !== 'ROOT') {
                                leafPaths[nodeInfo[8]] = currentPath;
                            }
                        } else {
                            for (var c = 0; c < node.children.length; c++) {
                                walkTree(node.children[c], currentPath);
                            }
                        }
                    }

                    if (treeData) {
                        walkTree(treeData, []);
                    }

                    // Find the maximum path depth across all leaves
                    var maxDepth = 0;
                    for (var h in leafPaths) {
                        if (leafPaths[h].length > maxDepth) maxDepth = leafPaths[h].length;
                    }

                    // Count stats from fullViewData (same logic as full view)
                    var stats = { total: 0, fp: 0, fpLegacy: 0, validated: 0, validatedLegacy: 0, unvalidated: 0, imported: 0 };
                    for (var i = 0; i < fullViewData.length; i++) {
                        stats.total++;
                        if (fullViewData[i][13] != null) stats.imported++;
                        if (fullViewData[i][8] == "1") stats.fp++;
                        else if (fullViewData[i][11] == 1) stats.fpLegacy++;
                        else if (fullViewData[i][8] == "2") stats.validated++;
                        else if (fullViewData[i][12] == 1) stats.validatedLegacy++;
                        else stats.unvalidated++;
                    }
                    var totalFP = stats.fp + stats.fpLegacy;
                    var totalValidated = stats.validated + stats.validatedLegacy;

                    // Build stats bar (same style as full view)
                    var statsBar = "<div id='stats-bar' class='stats-bar-fullwidth' style='position: sticky; position: -webkit-sticky; top: 0; z-index: 101;'>";
                    statsBar += "<div class='stats-bar-left'>";
                    statsBar += "<div class='stats-item'><span class='stats-value'>" + stats.total + "</span><span class='stats-label'>TOTAL</span></div>";
                    statsBar += "<div class='stats-item stats-fp'><span class='stats-value'>" + stats.fp + "</span><span class='stats-label'>FALSE POSITIVES</span></div>";
                    statsBar += "<div class='stats-item stats-validated'><span class='stats-value'>" + stats.validated + "</span><span class='stats-label'>VALIDATED</span></div>";
                    statsBar += "<div class='stats-item stats-unvalidated'><span class='stats-value'>" + stats.unvalidated + "</span><span class='stats-label'>UNVALIDATED</span></div>";
                    if (stats.imported > 0) {
                        statsBar += "<div class='stats-item stats-imported'><span class='stats-value'>" + stats.imported + "</span><span class='stats-label'>IMPORTED</span></div>";
                    }
                    statsBar += "</div>";

                    // Filter buttons
                    statsBar += "<div class='stats-bar-right'>";
                    if (totalFP > 0) {
                        var fpBtnClass = clientFilterState.fp ? 'filter-btn filter-btn-active filter-btn-fp' : 'filter-btn filter-btn-fp';
                        var fpBtnText = clientFilterState.fp ? 'HIDING ' + totalFP + ' FP' : 'HIDE ' + totalFP + ' FP';
                        statsBar += "<button class='" + fpBtnClass + "' data-show-text='HIDE " + totalFP + " FP' data-hiding-text='HIDING " + totalFP + " FP' onclick=\"toggleClientFilter('fp')\">" + fpBtnText + "</button>";
                    }
                    if (totalValidated > 0) {
                        var valBtnClass = clientFilterState.validated ? 'filter-btn filter-btn-active filter-btn-validated' : 'filter-btn filter-btn-validated';
                        var valBtnText = clientFilterState.validated ? 'HIDING ' + totalValidated + ' VALIDATED' : 'HIDE ' + totalValidated + ' VALIDATED';
                        statsBar += "<button class='" + valBtnClass + "' data-show-text='HIDE " + totalValidated + " VALIDATED' data-hiding-text='HIDING " + totalValidated + " VALIDATED' onclick=\"toggleClientFilter('validated')\">" + valBtnText + "</button>";
                    }
                    if (stats.imported > 0) {
                        var impBtnClass = clientFilterState.imported ? 'filter-btn filter-btn-active filter-btn-imported' : 'filter-btn filter-btn-imported';
                        var impBtnText = clientFilterState.imported ? 'HIDING ' + stats.imported + ' IMPORTED' : 'HIDE ' + stats.imported + ' IMPORTED';
                        statsBar += "<button class='" + impBtnClass + "' data-show-text='HIDE " + stats.imported + " IMPORTED' data-hiding-text='HIDING " + stats.imported + " IMPORTED' onclick=\"toggleClientFilter('imported')\">" + impBtnText + "</button>";
                    }
                    statsBar += "</div></div>";

                    // Build table header with dynamic node columns
                    var thStyle = "class='data-sticky-th' style='position: sticky; position: -webkit-sticky; top: 50px; z-index: 100;'";

                    var table = "<table id='scansummary-content' class='table table-bordered table-striped small tablesorter'>";
                    table += "<thead><tr>";
                    table += "<th class='text-center' " + thStyle + "><input id='checkall' type='checkbox' onClick='switchSelectAll()'></th>";
                    table += "<th class='text-center validation-status' " + thStyle + ">Status</th>";
                    // Dynamic node columns: Root on left, Leaf on right
                    for (var d = 0; d < maxDepth; d++) {
                        var colLabel;
                        if (d === 0) colLabel = "Root";
                        else if (d === maxDepth - 1) colLabel = "Leaf";
                        else if (maxDepth <= 3) colLabel = "Branch";
                        else colLabel = "Branch " + d;
                        table += "<th " + thStyle + ">" + colLabel + "</th>";
                    }
                    table += "</tr></thead><tbody>";

                    // Iterate fullViewData in order (same as full view)  each entry is a leaf
                    for (var i = 0; i < fullViewData.length; i++) {
                        var d = fullViewData[i];
                        var leafHash = d[7]; // hash
                        var path = leafPaths[leafHash];
                        var isImported = d[13] != null;
                        var isKnownAsset = d[14] && d[14] > 0;

                        // Row classes
                        var rowClasses = [];
                        if (isImported) rowClasses.push("imported-row");
                        if (isKnownAsset) rowClasses.push("known-asset-row");
                        var rowClassAttr = rowClasses.length > 0 ? " class='" + rowClasses.join(" ") + "'" : "";

                        table += "<tr" + rowClassAttr + ">";

                        // Checkbox
                        table += "<td class='text-center'><input type='checkbox' id='cb_" + d[7] + "'></td>";

                        // Status column (same as full view)
                        table += "<td class='text-center validation-status'>";
                        var importedClass = isImported ? " status-imported-glow" : "";
                        if (d[8] == "1" || d[11] == 1) {
                            table += "<span class='status-fp" + importedClass + "' title='False Positive'>FALSE POSITIVE</span>";
                        } else if (d[8] == "2" || d[12] == 1) {
                            table += "<span class='status-validated" + importedClass + "' title='Validated'>VALIDATED</span>";
                        } else {
                            table += "<span class='status-unvalidated" + importedClass + "' title='Not yet reviewed'>UNVALIDATED</span>";
                        }
                        if (isKnownAsset) {
                            table += "<br><span class='status-known-asset' title='Matches a known asset'>KNOWN ASSET</span>";
                        }
                        table += "</td>";

                        // Node columns (Root -> ... -> Leaf)
                        function buildCell(type, module, data) {
                            var html = "<td class='discovery-path-cell dp-collapsed'>";
                            html += "<div class='dp-cell-wrap'>";
                            html += "<div class='dp-type'><strong>TYPE:</strong> <span class='dp-value'>" + type + "</span></div>";
                            html += "<div class='dp-module'><strong>SOURCE MODULE:</strong> <span class='dp-value'>" + module + "</span></div>";
                            html += "<div class='dp-data'><strong>DATA:</strong> <span class='dp-value dp-data-value'>" + data + "</span></div>";
                            html += "<div class='dp-expand-toggle'></div>";
                            html += "</div>";
                            html += "</td>";
                            return html;
                        }

                        if (path && path.length > 0) {
                            for (var n = 0; n < maxDepth; n++) {
                                if (n < path.length) {
                                    table += buildCell(path[n].type, path[n].module, path[n].data);
                                } else {
                                    table += "<td></td>";
                                }
                            }
                        } else {
                            for (var n = 0; n < maxDepth - 1; n++) {
                                table += "<td></td>";
                            }
                            table += buildCell(d[10], d[3], sf.remove_sfurltag(d[1]));
                        }

                        table += "</tr>";
                    }
                    table += "</tbody></table>";

                    $("#loader").fadeOut(500);
                    $("#mainbody").append(statsBar + table);
                    $("#scansummary-content").tablesorter({ headers: { 0: { sorter: false }, 1: { sorter: false } } });

                    // Show expand toggle only on cells that are actually truncated
                    $("#scansummary-content .discovery-path-cell").each(function() {
                        var cell = $(this);
                        var hasOverflow = false;
                        cell.find('.dp-type, .dp-module, .dp-data').each(function() {
                            if (this.scrollWidth > this.clientWidth) {
                                hasOverflow = true;
                            }
                        });
                        if (!hasOverflow) {
                            cell.find('.dp-expand-toggle').remove();
                            cell.removeClass('dp-collapsed');
                        }
                    });

                    // Click handler for expand/collapse toggle
                    $("#scansummary-content").on('click', '.dp-expand-toggle', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        var cell = $(this).closest('.discovery-path-cell');
                        if (cell.hasClass('dp-collapsed')) {
                            cell.removeClass('dp-collapsed').addClass('dp-expanded');
                        } else {
                            cell.removeClass('dp-expanded').addClass('dp-collapsed');
                        }
                    });

                    // Apply any active client-side filters
                    if (clientFilterState.fp || clientFilterState.validated || clientFilterState.imported) {
                        applyClientSideFilters();
                    }

                    // Checkbox shift-click support
                    lastChecked = null;
                    var chkboxes = $('input[id*=cb_]');
                    chkboxes.click(function(e) {
                        if (!lastChecked) { lastChecked = this; return; }
                        if (e.shiftKey) {
                            var start = chkboxes.index(this);
                            var end = chkboxes.index(lastChecked);
                            chkboxes.slice(Math.min(start, end), Math.max(start, end) + 1).prop('checked', lastChecked.checked);
                        }
                        lastChecked = this;
                    });

                    // Click anywhere in first cell to toggle checkbox
                    $("#scansummary-content td:first-child").click(function(e) {
                        if (e.target.type !== 'checkbox') {
                            var cb = $(this).find("input[type='checkbox']");
                            cb.prop('checked', !cb.prop('checked'));
                            updateSelectionToolbar();
                        }
                    });

                    $("input[id*=cb_]").change(function() { updateSelectionToolbar(); });
                    $("#checkall").change(function() { updateSelectionToolbar(); });
                }

                // Fetch full view data (for ordering and FP status)
                sf.fetchData('${docroot}/scaneventresults', {'id': instanceId, 'eventType': eventType }, function(data) {
                    fullViewData = data;
                    loaded++;
                    if (loaded === 2) onBothLoaded();
                });

                // Fetch discovery path tree
                sf.fetchData('${docroot}/scanelementtypediscovery', {
                    'id': instanceId,
                    'eventType': eventType,
                    'filterFp': '0'
                }, function(data) {
                    discoveryData = data;
                    loaded++;
                    if (loaded === 2) onBothLoaded();
                });
            }

            if (format.indexOf('viz') == 0) {
                $("#btn-vizview").addClass("active");
                $("#btn-fullview").removeClass("active");
                $("#btn-discoverypathview").removeClass("active");

                if (format.indexOf("viz-bubble") == 0) {
                    sf.fetchData('${docroot}/scaneventresults', {'id': instanceId, 'eventType': eventType }, function(data) {
                        itemList = []
                        for (var i = 0; i < data.length; i++) {
                            if (format == "viz-bubble-source") {
                                itemList.push(sf.remove_sfurltag(data[i][2]));
                            }
                            if (format == "viz-bubble-data") {
                                itemList.push(sf.remove_sfurltag(data[i][1]));
                            }
                        }
                        $("#loader").fadeOut(500);
                        $("#mainbody").append("<div id='scansummary-content' class='text-center'></div>");
                        sf_viz_bubble("#scansummary-content", itemList)
                    });
                }

                if (format == "viz-dendro") {
                    sf.fetchData("${docroot}/scanelementtypediscovery", {'id': instanceId, 'eventType': eventType }, function(data) {
                        $("#loader").fadeOut(500);
                        $("#mainbody").append("<div id='scansummary-content' class='text-center'></div>");
                        sf_viz_dendrogram("#scansummary-content", data);
                    });
                }
            }
        }

        function downloadLogs(instanceId) {
            $("#loader").show();
            sf.log("Loading logs for scan: " + instanceId);
            var efr = document.getElementById('exportframe');
            var urlBase = '${docroot}/scanexportlogs?id=';
            efr.src = urlBase + instanceId;
            $("#loader").fadeOut(500);
        }

        // Download the data currently being viewed
        function exportEventData(instanceId, eventType, fileType, exportMode, legacy) {
            exportMode = exportMode || "full";
            var legacyParam = legacy ? '&legacy=1' : '';
            $("#loader").show();
            var efr = document.getElementById('exportframe');
            if (currentSection == "btn-search") {
                if (lastSearchType == null || lastSearchType == "ALL") {
                    type = "";
                } else {
                    type = lastSearchType;
                }
                if (fileType == "excel") {
                    var urlBase = '${docroot}/scansearchresultexport?filetype=excel&export_mode=' + exportMode + legacyParam + '&id=';
                } else {
                    var urlBase = '${docroot}/scansearchresultexport?export_mode=' + exportMode + legacyParam + '&id=';
                }
                efr.src = urlBase + instanceId + '&eventType=' + type + "&value=" + lastSearchQuery;
            }

            if (currentSection == "btn-data") {
                if (currentDataFormat == "discovery-path") {
                    if (fileType == "excel") {
                        var urlBase = '${docroot}/scandiscoverypathexport?filetype=excel&id=';
                    } else {
                        var urlBase = '${docroot}/scandiscoverypathexport?id=';
                    }
                    efr.src = urlBase + instanceId + '&eventType=' + eventType;
                } else {
                    if (fileType == "excel") {
                        var urlBase = '${docroot}/scaneventresultexport?filetype=excel&export_mode=' + exportMode + legacyParam + '&id=';
                    } else {
                        var urlBase = '${docroot}/scaneventresultexport?export_mode=' + exportMode + legacyParam + '&id=';
                    }
                    efr.src = urlBase + instanceId + '&type=' + eventType;
                }
            }

            if (currentSection == "btn-graph") {
                if (fileType == "excel") {
                    efr.src = '${docroot}/scanvulnsexport?filetype=xlsx&id=' + instanceId;
                } else {
                    efr.src = '${docroot}/scanvulnsexport?filetype=csv&id=' + instanceId;
                }
            }

            if (currentSection == "btn-findings") {
                if (fileType == "excel") {
                    efr.src = '${docroot}/scanfindingsexport?filetype=xlsx&id=' + instanceId;
                } else {
                    efr.src = '${docroot}/scanfindingsexport?filetype=csv&id=' + instanceId;
                }
            }

            $("#loader").fadeOut(500);
        }

        // View the configuration that was used for this scan
        function viewScanConfig(instanceId) {
            $("#scansummary-content").remove();
            $("#ai-correlation-section").remove();
            $("#ai-correlation-table-single").remove();
            $("#ai-correlation-table-cross").remove();
            $("#scanlogs-content").remove();
            $("#stats-bar").remove();
            $("#dedup-bar").remove();
            $("#loader").show();
            $("#btn-export").hide();
            $("#btn-download-logs").hide();
            $("#btn-refresh").show();
            $("#btn-search").hide();
            $("#scanreminder").hide();
            navTo("btn-info");
            pushViewState('btn-info');
            scanLogLoaded = false;
            refresh = function() { viewScanConfig(instanceId); }
            sf.fetchData('${docroot}/scanopts', {'id': instanceId}, function(data) {
                var table = "<div id='scansummary-content'>";

                // Meta Information - collapsible, collapsed by default
                table += "<div class='manage-section'>";
                table += "<div class='manage-section-header collapsed' onclick='toggleManageSection(this)'>";
                table += "<i class='glyphicon glyphicon-chevron-right section-chevron'></i>";
                table += "<h4>Meta Information</h4>";
                table += "</div>";
                table += "<div class='manage-section-body' style='display:none'>";
                table += "<table class='table table-bordered table-striped'>";
                table += "<tr><td>Name:</td><td>" + data['meta'][0] + "</td></tr>";
                table += "<tr><td>Internal ID:</td><td>${id}</td></tr>";
                table += "<tr><td>Target:</td><td>" + data['meta'][1] + "</td></tr>";
                table += "<tr><td>Started:</td><td>" + data['meta'][3] + "</td></tr>";
                table += "<tr><td>Completed:</td><td>" + data['meta'][4] + "</td></tr>";
                table += "<tr><td>Status:</td><td>" + data['meta'][5] + "</td></tr>";
                table += "</table>";
                table += "</div></div>";

                // Global Settings - collapsible, collapsed by default
                table += "<div class='manage-section'>";
                table += "<div class='manage-section-header collapsed' onclick='toggleManageSection(this)'>";
                table += "<i class='glyphicon glyphicon-chevron-right section-chevron'></i>";
                table += "<h4>Global Settings</h4>";
                table += "</div>";
                table += "<div class='manage-section-body' style='display:none'>";
                table += "<table class='table table-bordered table-striped' style='table-layout: fixed'>";
                table += "<thead><tr><th>Option</th><th>Value</th></tr></thead><tbody>";
                for (var key in data['config']) {
                    if (key.indexOf(":") > 0) {
                        continue;
                    }
                    table += "<tr><td width=100%>" + data['configdesc'][key] + "</td><td>" + data['config'][key] + "</td></tr>";
                }
                table += "</tbody></table>";
                table += "</div></div>";

                // Module Settings - collapsible, collapsed by default
                table += "<div class='manage-section'>";
                table += "<div class='manage-section-header collapsed' onclick='toggleManageSection(this)'>";
                table += "<i class='glyphicon glyphicon-chevron-right section-chevron'></i>";
                table += "<h4>Module Settings</h4>";
                table += "</div>";
                table += "<div class='manage-section-body' style='display:none'>";
                table += "<div class='table-responsive'><table class='table table-bordered table-striped' style='table-layout: fixed'>";
                table += "<thead><tr><th>Module</th> <th>Option</th> <th>Value</th></tr></thead><tbody>";
                var keys = [];
                for (var key in data['config']) {
                    keys.push(key);
                }
                var keys_s = keys.sort();
                for (var i = 0; i < keys_s.length; i++) {
                    var key = keys_s[i];
                    if (key.indexOf(":") > 0) {
                        var bits = key.split(":");
                        table += "<tr><td>" + bits[0] + "</td><td>" + data['configdesc'][key] + "</td><td>" + data['config'][key] + "</td></tr>";
                    }
                }
                table += "</tbody></table></div>";
                table += "</div></div>";

                // Scan Log - collapsible button at the bottom
                table += "<div class='manage-section'>";
                table += "<div class='manage-section-header collapsed' id='scan-log-header' onclick='toggleScanLog(this, \"" + instanceId + "\")'>";
                table += "<i class='glyphicon glyphicon-chevron-right section-chevron'></i>";
                table += "<h4><i class='glyphicon glyphicon-book'></i>&nbsp;Scan Log</h4>";
                table += "</div>";
                table += "<div class='manage-section-body' id='scan-log-body' style='display:none'>";
                table += "<div id='scan-log-loader' style='text-align:center; padding: 20px; display:none'><img src=\"${docroot}/static/img/loader.gif\"></div>";
                table += "<div id='scan-log-content'></div>";
                table += "</div></div>";

                table += "</div>";

                $("#loader").fadeOut(500);
                $("#mainbody").append(table);
            });
        }

        // Toggle collapsible manage sections
        function toggleManageSection(header) {
            var $header = $(header);
            var $body = $header.next('.manage-section-body');
            var $chevron = $header.find('.section-chevron');

            if ($header.hasClass('collapsed')) {
                $header.removeClass('collapsed');
                $chevron.removeClass('glyphicon-chevron-right').addClass('glyphicon-chevron-down');
                $body.slideDown(200);
            } else {
                $header.addClass('collapsed');
                $chevron.removeClass('glyphicon-chevron-down').addClass('glyphicon-chevron-right');
                $body.slideUp(200);
            }
        }

        // Toggle scan log section - fetches logs on first expand
        var scanLogLoaded = false;
        function toggleScanLog(header, instanceId) {
            var $header = $(header);
            var $body = $('#scan-log-body');
            var $chevron = $header.find('.section-chevron');

            if ($header.hasClass('collapsed')) {
                $header.removeClass('collapsed');
                $chevron.removeClass('glyphicon-chevron-right').addClass('glyphicon-chevron-down');
                $body.slideDown(200);

                // Fetch logs on first expand
                if (!scanLogLoaded) {
                    scanLogLoaded = true;
                    $('#scan-log-loader').show();
                    sf.fetchData('${docroot}/scanlog', {'id': instanceId}, function(data) {
                        var logTable = "<table class='table table-bordered table-striped table-condensed small tablesorter' style='table-layout: fixed'>";
                        logTable += "<thead><tr><th>Time</th><th>Component</th><th>Type</th><th>Event</th></tr></thead><tbody>";
                        for (var i = 0; i < data.length; i++) {
                            if (data[i][2] == "ERROR") {
                                logTable += "<tr class='danger'>";
                            } else {
                                logTable += "<tr>";
                            }
                            logTable += "<td>" + data[i][0] + "</td>";
                            logTable += "<td>" + data[i][1] + "</td>";
                            logTable += "<td>" + data[i][2] + "</td>";
                            logTable += "<td>" + data[i][3] + "</td>";
                            logTable += "</tr>";
                        }
                        logTable += "</tbody></table>";
                        $('#scan-log-loader').hide();
                        $('#scan-log-content').html(logTable);
                        $('#scan-log-content .tablesorter').tablesorter({widgets: ["filter"], widgetOptions : { filter_searchDelay : 300, filter_hideFilters : false }});
                    });
                }
            } else {
                $header.addClass('collapsed');
                $chevron.removeClass('glyphicon-chevron-down').addClass('glyphicon-chevron-right');
                $body.slideUp(200);
            }
        }

        // Always default to Summary view
        // Use replaceState for initial load (don't push a new history entry)
        _skipHistoryPush = true;
        scanSummaryView("${id}");
        _skipHistoryPush = false;
        history.replaceState(buildHistoryState(), '', window.location.href);

        var refreshSummaryInterval;

        refreshSummary = function() {
            var status = document.getElementById("scanstatusbadge").innerHTML;

            if (status == "ERROR-FAILED" || status == "FINISHED" || status == "ABORTED") {
                sf.log("Scan is " + status);
                clearInterval(refreshSummaryInterval);
                return;
            }

            sf.log("Scan is " + status + ". Refreshing scan summary ...");

            for (var i = 0; i < dataloaders.length; i++) {
                if (!loadersrunning) {
                    loadersrunning = true;
                    dataloaders[i]();
                    loadersrunning = false;
                }
            }
        }

        refreshSummaryInterval = setInterval(refreshSummary, 5000);

        // Scan progress bar
        var progressInterval;

        function updateScanProgress() {
            sf.fetchData('${docroot}/scanprogress', {'id': '${id}'}, function(data) {
                var container = $('#scan-progress-container');
                var bar = $('#scan-progress-bar');
                var status = data.status;

                if (status == 'FINISHED' || status == 'ABORTED' || status == 'ERROR-FAILED') {
                    bar.css('width', '100%').attr('aria-valuenow', 100).text('100%');
                    bar.removeClass('active progress-bar-striped');
                    if (status == 'FINISHED') {
                        bar.addClass('progress-bar-success');
                    } else if (status == 'ABORTED') {
                        bar.addClass('progress-bar-warning');
                    } else {
                        bar.addClass('progress-bar-danger');
                    }
                    $('#scan-progress-pct').text('Done');
                    $('#scan-progress-details').html('<span>' + status + '</span>');
                    clearInterval(progressInterval);
                    setTimeout(function() { container.fadeOut(1000); }, 3000);
                    return;
                }

                if (status == 'CREATED' || status == 'INITIALIZING' || status == 'STARTING' || status == 'STARTED' || status == 'RUNNING') {
                    container.show();
                    var pct = data.progressPercent || 0;
                    bar.css('width', pct + '%').attr('aria-valuenow', pct).text(pct + '%');
                    $('#scan-progress-pct').text('~' + pct + '%');

                    // Detail metrics
                    $('#sp-modules').html('<i class="glyphicon glyphicon-th-list"></i> ' +
                        data.modulesWithResults + '/' + data.modulesTotal + ' modules reported');
                    $('#sp-running').html('<i class="glyphicon glyphicon-play"></i> ' +
                        data.modulesRunning + ' running');
                    var queuedLabel = data.eventsQueued;
                    if (queuedLabel > 999) queuedLabel = (queuedLabel / 1000).toFixed(1) + 'k';
                    $('#sp-queued').html('<i class="glyphicon glyphicon-inbox"></i> ' +
                        queuedLabel + ' queued');
                    var totalLabel = data.totalEvents;
                    if (totalLabel > 999) totalLabel = (totalLabel / 1000).toFixed(1) + 'k';
                    $('#sp-events').html('<i class="glyphicon glyphicon-signal"></i> ' +
                        totalLabel + ' events');
                    $('#sp-rate').html('<i class="glyphicon glyphicon-dashboard"></i> ' +
                        data.eventsPerSecond + '/sec');
                } else {
                    container.hide();
                }
            });
        }

        // Start progress polling if scan is active
        if ("${status}" == "CREATED" || "${status}" == "RUNNING" || "${status}" == "STARTING" || "${status}" == "STARTED" || "${status}" == "INITIALIZING") {
            updateScanProgress();
            progressInterval = setInterval(updateScanProgress, 3000);
        }

        // Check if this scan is the latest for its target and handle auto-import
        var scanLatestInfo = null;
        var filterImported = false;  // Default: show imported entries

        function checkScanLatest() {
            sf.fetchData('${docroot}/scanislatest', {'id': '${id}'}, function(data) {
                scanLatestInfo = data;

                // Show LATEST badge if this is the latest scan
                if (data.isLatest) {
                    $('#latestbadge').show();

                    // Show SYNC/RESYNC badge only for latest scans with multiple scans for target
                    if (data.scanCount > 1) {
                        if (data.importedCount > 0) {
                            // Already synced - show RESYNC
                            $('#syncbadge').text('RESYNC').attr('title', 'Click to delete and re-import entries from previous scans').show();
                        } else {
                            // Not yet synced - show SYNC
                            $('#syncbadge').text('SYNC').attr('title', 'Click to import entries from previous scans').show();
                        }
                    }
                }

                // Show imported count badge if there are imported entries
                if (data.importedCount > 0) {
                    $('#importedbadge').text('+' + data.importedCount + ' IMPORTED').show();
                }

                // Log import status
                if (data.importStatus && data.importStatus.indexOf('Imported') === 0) {
                    alertify.success(data.importStatus);
                }
            });
        }

        // Resync scan entries - delete imported and re-import fresh
        function resyncScanEntries() {
            var currentText = $('#syncbadge').text();
            var actionText = currentText === 'RESYNC' ? 'delete existing imports and re-import' : 'import';

            alertify.confirm("Are you sure you want to " + actionText + " entries from previous scans?",
            function() {
                // User confirmed
                $('#syncbadge').text('SYNCING...').css('background-color', '#f59e0b');
                $('#loader').show();

                sf.fetchData('${docroot}/resyncscanentries', {'id': '${id}'}, function(data) {
                    $('#loader').hide();

                    if (data.success) {
                        alertify.success(data.message);

                        // Update badges
                        if (data.imported > 0) {
                            $('#syncbadge').text('RESYNC').css('background-color', '#10b981');
                            $('#importedbadge').text('+' + data.imported + ' IMPORTED').show();
                        } else {
                            $('#syncbadge').text('SYNC').css('background-color', '#10b981');
                            $('#importedbadge').hide();
                        }

                        // Refresh the current view to show updated data
                        if (typeof refresh === 'function') {
                            refresh();
                        }
                    } else {
                        alertify.error('Sync failed: ' + data.message);
                        $('#syncbadge').text(currentText).css('background-color', '#10b981');
                    }
                });
            },
            function() {
                // User cancelled
            }).set({title: currentText === 'RESYNC' ? "Re-sync entries?" : "Sync entries?"});
        }

        // Check on page load
        checkScanLatest();

    </script>
<iframe class="hidden" id='exportframe'></iframe>
<%include file="FOOTER.tmpl"/>
