## -*- coding: utf-8 -*-
<%include file="HEADER.tmpl"/>
<%
  if status == "FINISHED":
    statusy = "alert-success"
  elif status.startswith("ABORT"):
    statusy = "alert-warning"
  elif status == "CREATED" or status == "RUNNING" or status == "STARTED" or status == "STARTING" or status == "INITIALIZING":
    statusy = "alert-info"
  elif status == "ERROR-FAILED":
    statusy = "alert-danger"
  else:
    statusy = "alert-info"
  end
%>
<h2>${name}&nbsp;<span id='scanstatusbadge' class='badge ${statusy}'>${status}</span><span id='latestbadge' class='badge' style='display: none; background-color: #3b82f6; color: white; margin-left: 5px;'>LATEST</span><span id='syncbadge' class='badge' style='display: none; background-color: #10b981; color: white; margin-left: 5px; cursor: pointer;' onclick='resyncScanEntries()' title='Click to sync entries from previous scans'>SYNC</span><span id='importedbadge' class='badge' style='display: none; background-color: #8b5cf6; color: white; margin-left: 5px;'></span>&nbsp;<img id="loader" src="${docroot}/static/img/loader.gif"></h2>
  <div id="scan-progress-container" style="display: none; margin-bottom: 10px;">
    <div style="display: flex; align-items: center; gap: 10px;">
      <div class="progress" style="flex: 1; height: 18px; margin-bottom: 0;">
        <div id="scan-progress-bar" class="progress-bar progress-bar-striped active" role="progressbar"
             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%; min-width: 2em; text-align: center; line-height: 18px; font-size: 11px;">
          0%
        </div>
      </div>
      <small id="scan-progress-pct" style="white-space: nowrap; font-weight: bold; min-width: 30px;"></small>
    </div>
    <div id="scan-progress-details" style="margin-top: 4px; font-size: 11px; color: #888; display: flex; gap: 15px; flex-wrap: wrap;">
      <span id="sp-modules" title="Modules that have reported results / total modules"></span>
      <span id="sp-running" title="Modules actively processing events"></span>
      <span id="sp-queued" title="Events waiting to be processed by modules"></span>
      <span id="sp-events" title="Total events produced so far"></span>
      <span id="sp-rate" title="Events produced per second (recent)"></span>
    </div>
  </div>
  <div class="btn-toolbar" role="toolbar" style='padding-bottom: 10px'>
   <div class="btn-group">
      <a id='btn-status' class="btn btn-default" onClick='scanSummaryView("${id}")'><i class='glyphicon glyphicon-eye-open'></i>&nbsp;Summary</a>
      <a id='btn-findings' class="btn btn-default" onClick='viewFindings("${id}")'><i class='glyphicon glyphicon-exclamation-sign'></i>&nbsp;Findings</a>
      <a id='btn-browse' class="btn btn-default" onClick='browseEventList("${id}")'><i class='glyphicon glyphicon-th-list'></i>&nbsp;Browse</a>
      <a id='btn-graph' class="btn btn-default" onClick='viewVulnerabilities("${id}")'><i class='glyphicon glyphicon-asterisk'></i>&nbsp;Vulnerabilities</a>
      <a id='btn-info' class="btn btn-default" onClick='viewScanConfig("${id}")'><i class='glyphicon glyphicon-cog'></i>&nbsp;Manage</a>
    </div>
        <div id='modifyactions' role="group" class="btn-group">
            <a id='btn-setfp' rel="tooltip" data-title="Set validation status" class="btn-warning btn btn-default dropdown-toggle" data-toggle="dropdown"><i class='glyphicon glyphicon-ok-circle glyphicon glyphicon-white'></i></a>
            <ul class="dropdown-menu">
                <li class="dropdown-header">Validation Status</li>
                <li><a href='#' class='link' onClick='setFp(2); return false;'><i class='glyphicon glyphicon-ok-circle' style='color: #3b82f6;'></i> Mark as Validated</a></li>
                <li><a href='#' class='link' onClick='setFp(1); return false;'><i class='glyphicon glyphicon-ban-circle' style='color: #ea580c;'></i> Mark as False Positive</a></li>
                <li><a href='#' class='link' onClick='setFp(0); return false;'><i class='glyphicon glyphicon-minus' style='color: #6b7280;'></i> Mark as Unvalidated</a></li>
                <li class="divider"></li>
                <li><a href='#' class='link' onClick='setFp(0, 1); return false;'>Force Unset (ignore parent)</a></li>
                <li class="divider"></li>
                <li class="dropdown-header">Bulk Actions</li>
                <li><a href='#' class='link' onClick='selectMatchingFps(); return false;'>Select All Matching Saved FPs</a></li>
                <li><a href='#' class='link' onClick='markAllMatchingFps(); return false;'>Mark All Matching as FP</a></li>
                <li><a href='#' class='link' onClick='selectAllVisible(); return false;'>Select All Visible</a></li>
            </ul>
        </div>
        <div id='customtabview' role="group" class="btn-group">
         <a id='btn-fullview' rel="tooltip" data-title="Full Data View" class="btn btn-default active" onClick='browseUpdate("full")'><i class='glyphicon glyphicon-th glyphicon glyphicon-white'></i></a>
         <a id='btn-discoverypathview' rel="tooltip" data-title="Discovery Path View" class="btn btn-default" onClick='browseUpdate("discovery-path")'><i class='glyphicon glyphicon-random glyphicon glyphicon-white'></i></a>
         <a id='btn-vizview' rel="tooltip" data-title="Visualize" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><i class='glyphicon glyphicon-picture glyphicon glyphicon-white'></i></a>
         <ul class="dropdown-menu">
            <li><a class='link' onClick='browseUpdate("viz-bubble-data")'>Bubble (Data Element)</a></li>
            <li><a class='link' onClick='browseUpdate("viz-bubble-source")'>Bubble (Source Data Element)</a></li>
            <li><a class='link' onClick='browseUpdate("viz-dendro")'>Discovery Path (Visual)</a></li>
         </ul>
        </div>
        <div id='customvizview' class="btn-group">
         <a id='btn-random' rel="tooltip" data-title="Random Layout" class="btn btn-default active" onClick='vizUpdate("random")'><b>R</b></a>
         <a id='btn-forceatlas' rel="tooltip" data-title="Force Layout" class="btn btn-default" onClick='vizUpdate("force")'><b>F</b></a>
         <a id='btn-saveimage' rel="tooltip" data-title="Save Image" class="btn btn-default dropdown-toggle" onClick='vizUpdate("download")'><i class='glyphicon glyphicon-picture glyphicon glyphicon-white'></i></a>
        </div>
        <div class="btn-group" role="group">
            <button id='btn-refresh' rel="tooltip" title="Refresh" class="btn btn-success btn-default" onClick='refresh()'><i class='glyphicon glyphicon-refresh glyphicon glyphicon-white'></i></button>
            <a id='btn-export' rel="tooltip" data-title="Export Data" class="btn btn-default dropdown-toggle download-button" data-toggle="dropdown"><i class='glyphicon glyphicon-download-alt glyphicon glyphicon-white'></i></a>
            <ul class="dropdown-menu">
              <li class="dropdown-header">Full Data (All Results)</li>
              <li><a class='link' onClick='exportEventData("${id}", currentType, "csv", "full")'>CSV</a></li>
              <li><a class='link' onClick='exportEventData("${id}", currentType, "excel", "full")'>Excel</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Analysis (No False Positives)</li>
              <li><a class='link' onClick='exportEventData("${id}", currentType, "csv", "analysis")'>CSV</a></li>
              <li><a class='link' onClick='exportEventData("${id}", currentType, "excel", "analysis")'>Excel</a></li>
              <li><a class='link' onClick='exportEventData("${id}", currentType, "excel", "analysis_correlations")'>Excel + Findings & Correlations</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Legacy Export (v4.0 Types)</li>
              <li><a class='link' onClick='exportEventData("${id}", currentType, "csv", "full", true)'>CSV</a></li>
              <li><a class='link' onClick='exportEventData("${id}", currentType, "excel", "full", true)'>Excel</a></li>
              <li><a class='link' onClick='exportEventData("${id}", currentType, "csv", "analysis", true)'>CSV Analysis</a></li>
              <li><a class='link' onClick='exportEventData("${id}", currentType, "excel", "analysis", true)'>Excel Analysis</a></li>
              <li><a class='link' onClick='exportEventData("${id}", currentType, "excel", "analysis_correlations", true)'>Excel Analysis + Findings & Correlations</a></li>
            </ul>
        </div>
    <div class='btn-group search-group'>
        <div id='btn-search' class='input-group'>
          <input class='form-control' id='searchvalue' type='text' placeholder='Search...' data-toggle='popover' data-html='true' data-animation='true' data-title='Usage' data-content="Supply a regular expression encapsulated in '/', e.g. <i>/searchregex/</i> or a simple wildcard search, e.g. <i>*string*</i> or an exact value, e.g. <i>string</i>.<br /><br /><b>Note</b> that the current scope is what's searched.">
            <div class='input-group-btn' style='width: 0px'> <!-- Chrome fix -->
              <button class='btn btn-primary' id='searchbutton' type='button' onClick="$('#btn-search').popover('toggle');searchDirector('${id}')">
                <i class='glyphicon glyphicon-search glyphicon glyphicon-white'></i>
              </button>
            </div>
        </div>
    </div>
  </div>

  <!-- Page Title -->
  <div id="page-title" class="page-title">BROWSE</div>

  <!-- Floating Selection Toolbar - Modern horizontal design -->
  <div id="selection-toolbar" class="toolbar-bottom toolbar-hidden">
    <!-- Left snap button (horizontal mode only) -->
    <div class="toolbar-snap-btn toolbar-snap-left" onclick="snapToolbar('left')" title="Snap to left">
      <i class="glyphicon glyphicon-chevron-left"></i>
    </div>

    <div class="toolbar-content">
      <!-- Header row with count and close button -->
      <div class="toolbar-header">
        <div class="selection-count-display">
          <span class="count-number" id="selection-count">0</span>
          <span>SELECTED</span>
        </div>
        <button type="button" class="close-btn" onclick="clearSelection()">&times;</button>
      </div>

      <!-- Match buttons section -->
      <div class="match-section">
        <label>Select matching:</label>
        <div class="match-buttons">
          <div id="match-data-element" class="match-btn-wrapper" style="display: none;">
            <button class="btn btn-data-match" onclick="selectAllMatchingDataElements()">
              <i class="glyphicon glyphicon-plus"></i>
              Data Element
              <span id="data-match-count" class="match-count-badge">0</span>
            </button>
          </div>
          <div id="match-source-element" class="match-btn-wrapper" style="display: none;">
            <button class="btn btn-source-match" onclick="selectAllMatchingSourceElements()">
              <i class="glyphicon glyphicon-plus"></i>
              Source Element
              <span id="source-match-count" class="match-count-badge">0</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Action buttons -->
      <div class="toolbar-actions">
        <button class="btn btn-validated-action" onclick="setFp(2)" title="Mark as Validated (confirmed belongs to organization)">
          <i class="glyphicon glyphicon-ok-circle"></i>
          Validated
        </button>
        <button class="btn btn-fp-action" onclick="setFp(1)" title="Mark as False Positive (confirmed doesn't belong)">
          <i class="glyphicon glyphicon-ban-circle"></i>
          False Positive
        </button>
        <button class="btn btn-unvalidated-action" onclick="setFp(0)" title="Mark as Unvalidated (reset status)">
          <i class="glyphicon glyphicon-minus"></i>
          Unvalidated
        </button>
        <button class="btn btn-clear" onclick="clearSelection()">
          Clear
        </button>
      </div>

      <!-- Undo snap button (vertical mode only) -->
      <div class="toolbar-undo-snap" onclick="snapToolbar('bottom')" title="Return to bottom">
        <i class="glyphicon glyphicon-chevron-down"></i>
      </div>
    </div>

    <!-- Right snap button (horizontal mode only) -->
    <div class="toolbar-snap-btn toolbar-snap-right" onclick="snapToolbar('right')" title="Snap to right">
      <i class="glyphicon glyphicon-chevron-right"></i>
    </div>
  </div>
    <script src="${docroot}/static/node_modules/sigma/build/sigma.min.js"></script>
    <script src="${docroot}/static/node_modules/sigma/build/plugins/sigma.parsers.json.min.js"></script>
    <script src="${docroot}/static/node_modules/sigma/build/plugins/sigma.plugins.dragNodes.min.js"></script>
    <script src="${docroot}/static/node_modules/sigma/build/plugins/sigma.layout.forceAtlas2.min.js"></script>
    <script src="${docroot}/static/node_modules/sigma/build/plugins/sigma.renderers.snapshot.min.js"></script>
    <script type='text/javascript'>
        var currentType = "ALL";
        var currentTypeName = "All";
        var currentSection = "btn-browse";
        var currentBrowseFormat = "full";
        var lastSearchType = "ALL";
        var lastSearchQuery = "";
        var dataloaders = [];
        var sharedSigma = "";
        var loadersrunning = false;
        var refresh = function() { browseEventList("${id}"); }
        $('#searchvalue').popover({ 'trigger': 'focus', 'placement': 'bottom'});
        $('#searchvalue').keyup(function(event) {
            if (event.keyCode == 13) {
                $('#searchbutton').click();
            }
        });

        function switchSelectAll() {
            if (!$("#checkall")[0].checked) {
                $("input[id*=cb_]").prop('checked', false);
            } else {
                $("input[id*=cb_]").prop('checked', true);
            }
        }

        // Store data for bulk FP operations
        var currentViewData = [];

        // Client-side filter state - persists while on the page
        var clientFilterState = {
            fp: false,
            validated: false,
            imported: false
        };

        // Toggle client-side filter
        function toggleClientFilter(type) {
            clientFilterState[type] = !clientFilterState[type];
            applyClientSideFilters();
            updateFilterButtonStates();
        }

        // Apply client-side filters by showing/hiding rows
        function applyClientSideFilters() {
            var visibleCount = 0;
            var hiddenCount = 0;

            $("#scansummary-content tbody tr").each(function() {
                var row = $(this);
                var statusSpan = row.find(".validation-status span");
                var isImported = row.hasClass("imported-row");

                var shouldHide = false;

                // Check FP filter
                if (clientFilterState.fp && statusSpan.hasClass('status-fp')) {
                    shouldHide = true;
                }

                // Check Validated filter
                if (clientFilterState.validated && statusSpan.hasClass('status-validated')) {
                    shouldHide = true;
                }

                // Check Imported filter
                if (clientFilterState.imported && isImported) {
                    shouldHide = true;
                }

                if (shouldHide) {
                    row.hide();
                    hiddenCount++;
                } else {
                    row.show();
                    visibleCount++;
                }
            });

            // Update visible count in stats
            $(".stats-bar-left .stats-item:first-child .stats-value").text(visibleCount);

            return visibleCount;
        }

        // Update filter button visual states
        function updateFilterButtonStates() {
            // Update FP button
            var fpBtn = $(".filter-btn-fp");
            if (clientFilterState.fp) {
                fpBtn.addClass('filter-btn-active');
                fpBtn.text(fpBtn.data('hiding-text') || 'HIDING FP');
            } else {
                fpBtn.removeClass('filter-btn-active');
                fpBtn.text(fpBtn.data('show-text') || 'HIDE FP');
            }

            // Update Validated button
            var valBtn = $(".filter-btn-validated");
            if (clientFilterState.validated) {
                valBtn.addClass('filter-btn-active');
                valBtn.text(valBtn.data('hiding-text') || 'HIDING VALIDATED');
            } else {
                valBtn.removeClass('filter-btn-active');
                valBtn.text(valBtn.data('show-text') || 'HIDE VALIDATED');
            }

            // Update Imported button
            var impBtn = $(".filter-btn-imported");
            if (clientFilterState.imported) {
                impBtn.addClass('filter-btn-active');
                impBtn.text(impBtn.data('hiding-text') || 'HIDING IMPORTED');
            } else {
                impBtn.removeClass('filter-btn-active');
                impBtn.text(impBtn.data('show-text') || 'HIDE IMPORTED');
            }
        }

        // Select all visible checkboxes
        function selectAllVisible() {
            $("input[id*=cb_]").prop('checked', true);
            $("#checkall").prop('checked', true);
            var count = $("input[id*=cb_]:checked").length;
            alertify.success("Selected " + count + " items");
        }

        // Select only items that match saved target-level FPs
        function selectMatchingFps() {
            $("input[id*=cb_]").prop('checked', false);
            $("#checkall").prop('checked', false);
            var count = 0;
            // Find rows with the warning icon (matching saved FPs)
            $("tr").each(function() {
                var row = $(this);
                if (row.find(".glyphicon-repeat.text-warning").length > 0) {
                    row.find("input[id*=cb_]").prop('checked', true);
                    count++;
                }
            });
            if (count > 0) {
                alertify.success("Selected " + count + " items matching saved FPs");
            } else {
                alertify.warning("No items match saved FPs in current view");
            }
        }

        // One-click: select all matching FPs and mark them
        function markAllMatchingFps() {
            selectMatchingFps();
            var sel = getSelected();
            if (sel.length == 0) {
                alertify.warning("No items match saved FPs to mark");
                return;
            }
            // Confirm before bulk marking
            alertify.confirm("Mark " + sel.length + " items as False Positive?<br/><small>These will be saved for all future scans of this target.</small>",
                function() {
                    setFp(1);
                },
                function() {
                    alertify.warning("Cancelled");
                }
            ).setHeader("Confirm Bulk FP");
        }

        // Variables for selection toolbar - now storing arrays for multiple selection support
        var selectedDataElements = [];
        var selectedSourceElements = [];

        // Clear all selections
        function clearSelection() {
            $("input[id*=cb_]").prop('checked', false);
            $("#checkall").prop('checked', false);
            updateSelectionToolbar();
        }

        // Update the selection toolbar based on current selections
        function updateSelectionToolbar() {
            // Only operate if we're on a page with FP checkboxes
            var hasCheckboxes = $("input[id*=cb_]").length > 0;
            if (!hasCheckboxes) {
                hideSelectionToolbar();
                return;
            }

            var selectedCount = $("input[id*=cb_]:checked").length;
            $("#selection-count").text(selectedCount);

            if (selectedCount > 0) {
                // Show toolbar - use class toggle for consistent behavior
                showSelectionToolbar();

                // Highlight table headers to match toolbar buttons
                highlightTableHeaders(true);

                // Collect ALL unique Data Elements and Source Elements from ALL selected rows
                selectedDataElements = [];
                selectedSourceElements = [];
                var dataElementSet = {};
                var sourceElementSet = {};

                $("input[id*=cb_]:checked").each(function() {
                    var row = $(this).closest("tr");
                    var cells = row.find("td");

                    if (cells.length >= 4) {
                        var dataEl = cells.eq(2).text().trim();
                        var sourceEl = cells.eq(3).text().trim();

                        // Add to unique sets
                        if (dataEl && !dataElementSet[dataEl]) {
                            dataElementSet[dataEl] = true;
                            selectedDataElements.push(dataEl);
                        }
                        if (sourceEl && !sourceElementSet[sourceEl]) {
                            sourceElementSet[sourceEl] = true;
                            selectedSourceElements.push(sourceEl);
                        }
                    }
                });

                // Show data element match option with count
                if (selectedDataElements.length > 0) {
                    var preview = "";
                    if (selectedDataElements.length === 1) {
                        preview = '"' + selectedDataElements[0].substring(0, 40) + '"';
                        if (selectedDataElements[0].length > 40) preview = preview.slice(0, -1) + '..."';
                    } else {
                        preview = selectedDataElements.length + " unique values";
                    }
                    $("#match-source-preview").text(preview);
                    $("#source-match-count").text(selectedDataElements.length);
                    $("#match-source-element").show();
                } else {
                    $("#match-source-element").hide();
                }

                // Show source element match option with count
                if (selectedSourceElements.length > 0) {
                    var preview = "";
                    if (selectedSourceElements.length === 1) {
                        preview = '"' + selectedSourceElements[0].substring(0, 40) + '"';
                        if (selectedSourceElements[0].length > 40) preview = preview.slice(0, -1) + '..."';
                    } else {
                        preview = selectedSourceElements.length + " unique values";
                    }
                    $("#match-data-preview").text(preview);
                    $("#data-match-count").text(selectedSourceElements.length);
                    $("#match-data-element").show();
                } else {
                    $("#match-data-element").hide();
                }
            } else {
                hideSelectionToolbar();
                // Remove table header highlights
                highlightTableHeaders(false);
            }
        }

        // Helper functions for consistent toolbar show/hide
        function showSelectionToolbar() {
            var toolbar = document.getElementById('selection-toolbar');
            if (toolbar) {
                toolbar.classList.remove('toolbar-hidden');
                toolbar.style.display = 'flex';
            }
        }

        function hideSelectionToolbar() {
            var toolbar = document.getElementById('selection-toolbar');
            if (toolbar) {
                toolbar.classList.add('toolbar-hidden');
                toolbar.style.display = 'none';
            }
        }

        // Highlight or unhighlight table headers when toolbar is shown/hidden
        function highlightTableHeaders(highlight) {
            var isDarkMode = localStorage.getItem("theme") === "dark-theme";
            var defaultBg = isDarkMode ? "rgba(0, 0, 0, 0.85)" : "rgba(255, 255, 255, 0.85)";
            var defaultColor = isDarkMode ? "#ffffff" : "#1f2937";
            var defaultBorder = isDarkMode ? "1px solid rgba(255, 255, 255, 0.2)" : "1px solid rgba(0, 0, 0, 0.2)";

            // Find headers by text content
            $("#scansummary-content thead th").each(function() {
                var headerText = $(this).text().trim();
                if (headerText === "Data Element") {
                    if (highlight) {
                        $(this).addClass('th-data-highlight');
                        // Override inline styles with green button style
                        $(this).css({
                            'background': 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)',
                            'background-color': '#22c55e',
                            'color': '#ffffff',
                            'border': '1px solid #16a34a',
                            'text-shadow': '0 1px 2px rgba(0, 0, 0, 0.3)'
                        });
                    } else {
                        $(this).removeClass('th-data-highlight');
                        // Restore default styles
                        $(this).css({
                            'background': defaultBg,
                            'background-color': '',
                            'color': defaultColor,
                            'border': defaultBorder,
                            'text-shadow': ''
                        });
                    }
                } else if (headerText === "Source Data Element") {
                    if (highlight) {
                        $(this).addClass('th-source-highlight');
                        // Override inline styles with purple button style
                        $(this).css({
                            'background': 'linear-gradient(135deg, #a855f7 0%, #7c3aed 100%)',
                            'background-color': '#a855f7',
                            'color': '#ffffff',
                            'border': '1px solid #7c3aed',
                            'text-shadow': '0 1px 2px rgba(0, 0, 0, 0.3)'
                        });
                    } else {
                        $(this).removeClass('th-source-highlight');
                        // Restore default styles
                        $(this).css({
                            'background': defaultBg,
                            'background-color': '',
                            'color': defaultColor,
                            'border': defaultBorder,
                            'text-shadow': ''
                        });
                    }
                }
            });
        }

        // Select all rows matching ANY of the selected Data Elements
        function selectAllMatchingDataElements() {
            if (selectedDataElements.length === 0) return;

            // Create a lookup set for fast matching
            var matchSet = {};
            for (var i = 0; i < selectedDataElements.length; i++) {
                matchSet[selectedDataElements[i]] = true;
            }

            var newSelections = 0;
            $("#scansummary-content tbody tr").each(function() {
                var cells = $(this).find("td");
                if (cells.length >= 3) {
                    var dataElement = cells.eq(2).text().trim();
                    if (matchSet[dataElement]) {
                        var cb = $(this).find("input[id*=cb_]");
                        if (!cb.prop('checked')) {
                            cb.prop('checked', true);
                            newSelections++;
                        }
                    }
                }
            });

            if (newSelections > 0) {
                alertify.success("Selected " + newSelections + " additional rows matching " + selectedDataElements.length + " Data Element(s)");
            } else {
                alertify.info("All matching rows are already selected");
            }
            updateSelectionToolbar();
        }

        // Select all rows matching ANY of the selected Source Data Elements
        function selectAllMatchingSourceElements() {
            if (selectedSourceElements.length === 0) return;

            // Create a lookup set for fast matching
            var matchSet = {};
            for (var i = 0; i < selectedSourceElements.length; i++) {
                matchSet[selectedSourceElements[i]] = true;
            }

            var newSelections = 0;
            $("#scansummary-content tbody tr").each(function() {
                var cells = $(this).find("td");
                if (cells.length >= 4) {
                    var sourceElement = cells.eq(3).text().trim();
                    if (matchSet[sourceElement]) {
                        var cb = $(this).find("input[id*=cb_]");
                        if (!cb.prop('checked')) {
                            cb.prop('checked', true);
                            newSelections++;
                        }
                    }
                }
            });

            if (newSelections > 0) {
                alertify.success("Selected " + newSelections + " additional rows matching " + selectedSourceElements.length + " Source Element(s)");
            } else {
                alertify.info("All matching rows are already selected");
            }
            updateSelectionToolbar();
        }

        // ============================================
        // Snap-to Toolbar Functionality
        // ============================================
        var toolbarPosition = 'bottom'; // 'bottom', 'left', or 'right'

        function snapToolbar(position) {
            var toolbar = document.getElementById('selection-toolbar');

            // Remove all position classes
            toolbar.classList.remove('toolbar-bottom', 'toolbar-left', 'toolbar-right');

            // Add new position class
            toolbar.classList.add('toolbar-' + position);
            toolbarPosition = position;

            // Store preference in localStorage
            try {
                localStorage.setItem('toolbarPosition', position);
            } catch(e) {}

            // Update toolbar display
            updateToolbarStyle();
        }

        function updateToolbarStyle() {
            var selectedCount = $("input[id*=cb_]:checked").length;

            if (selectedCount > 0) {
                showSelectionToolbar();
            }
        }

        function loadToolbarPosition() {
            try {
                var saved = localStorage.getItem('toolbarPosition');
                if (saved && ['bottom', 'left', 'right'].indexOf(saved) !== -1) {
                    toolbarPosition = saved;
                    var toolbar = document.getElementById('selection-toolbar');
                    toolbar.classList.remove('toolbar-bottom', 'toolbar-left', 'toolbar-right');
                    toolbar.classList.add('toolbar-' + saved);
                }
            } catch(e) {}
        }

        // Initialize on page load
        $(document).ready(function() {
            loadToolbarPosition();
            sf.updateTooltips();
        });

        function getSelected() {
            ids = [];
            $("input[id*=cb_]").each(function(i, obj) {
                if (obj.checked) {
                    ids[ids.length] = obj.id.replace("cb_", "");
                }
            });

            return ids;
        }

        function setFp(flag, force) {
            sel = getSelected();
            if (sel.length == 0) {
                alertify.error("You need to select at least one record.");
                return false;
            }
            data = JSON.stringify(sel);
            $("#loader").show();
            // Always use persist endpoint - all status changes are saved for future scans
            var endpoint = '${docroot}/resultsetfppersist';
            var params = {'id': '${id}', 'fp': flag, 'resultids': data, 'persist': 1 };
            if (force) {
                params['force'] = force;
            }
            sf.fetchData(endpoint, params, function(ret) {
                $("#loader").hide();
                if (ret[0] == "SUCCESS") {
                    if (flag == 1) {
                        alertify.success("Marked as False Positive successfully.");
                    } else if (flag == 2) {
                        alertify.success("Marked as Validated successfully.");
                    } else {
                        alertify.success("Status cleared successfully.");
                    }
                    // Update rows in-place instead of full refresh
                    updateRowsStatus(sel, flag);
                    // Clear selection and update toolbar
                    clearSelection();
                    // Update stats bar counts
                    updateStatsBarCounts();
                    return;
                }
                if (ret[0] == "WARNING") {
                    alertify.error(ret[1]);
                    return;
                }
                if (ret[0] == "ERROR") {
                    alertify.error("There was an error updating status because: " + ret[1] + "<br/>If you believe this to be an error, please log out and log back in, and if the problem repeats, report this as a bug.");
                }
            });
        }

        // Update rows in place without full refresh
        function updateRowsStatus(ids, flag) {
            ids.forEach(function(id) {
                var checkbox = $("input#cb_" + id);
                var row = checkbox.closest("tr");
                var statusCell = row.find("td.validation-status");

                var isImported = row.hasClass("imported-row");
                var importedClass = isImported ? " status-imported-glow" : "";
                var statusHtml = "";

                if (flag == 1) {
                    statusHtml = "<span class='status-fp" + importedClass + "' title='False Positive - confirmed does not belong to organization'>FALSE POSITIVE</span>";
                    row.attr('data-status', 'fp');
                } else if (flag == 2) {
                    statusHtml = "<span class='status-validated" + importedClass + "' title='Validated - confirmed belongs to organization'>VALIDATED</span>";
                    row.attr('data-status', 'validated');
                } else {
                    statusHtml = "<span class='status-unvalidated" + importedClass + "' title='Not yet reviewed'>UNVALIDATED</span>";
                    row.attr('data-status', 'unvalidated');
                }

                statusCell.html(statusHtml);
            });
        }

        // Update stats bar counts without full refresh
        function updateStatsBarCounts() {
            var stats = {
                total: 0,
                fp: 0,
                validated: 0,
                unvalidated: 0,
                imported: 0
            };

            $("#scansummary-content tbody tr:visible").each(function() {
                var row = $(this);
                stats.total++;

                if (row.hasClass('imported-row')) {
                    stats.imported++;
                }

                var statusSpan = row.find(".validation-status span");
                if (statusSpan.hasClass('status-fp')) {
                    stats.fp++;
                } else if (statusSpan.hasClass('status-validated')) {
                    stats.validated++;
                } else {
                    stats.unvalidated++;
                }
            });

            // Update stats bar display
            $(".stats-bar-left .stats-fp .stats-value").text(stats.fp);
            $(".stats-bar-left .stats-validated .stats-value").text(stats.validated);
            $(".stats-bar-left .stats-unvalidated .stats-value").text(stats.unvalidated);
        }

        // Page title mappings
        var pageTitles = {
            "btn-status": "SUMMARY",
            "btn-findings": "FINDINGS",
            "btn-browse": "BROWSE",
            "btn-graph": "VULNERABILITIES",
            "btn-info": "MANAGE",
            "btn-search": "SEARCH RESULTS"
        };

        // Update page title with optional subdirectory
        function updatePageTitle(subDirectory) {
            var baseTitle = pageTitles[currentSection] || currentSection.replace("btn-", "").toUpperCase();
            if (subDirectory && subDirectory !== "All" && subDirectory !== "ALL") {
                // Decode URL-encoded characters (e.g., %20 -> space)
                var decodedSubDir = decodeURIComponent(subDirectory);
                $("#page-title").text(baseTitle + " / " + decodedSubDir.toUpperCase());
            } else {
                $("#page-title").text(baseTitle);
            }
        }

        function navTo(target) {
            var targets = [ "btn-browse", "btn-info",
                "btn-export", "btn-download-logs", "btn-viz",
                "btn-status", "btn-graph", "btn-findings" ]
            for (var i = 0; i < targets.length; i++) {
                if (targets[i] == target) {
                    $("#" + targets[i]).addClass("active");
                } else {
                    $("#" + targets[i]).removeClass("active");
                }
            }

            currentSection = target;
            updatePageTitle();

            $("#breadcrumbs").remove();
            $("#stats-bar").remove();
            $("#dedup-bar").remove();
            $("#customtabview").hide();
            $("#customvizview").hide();
            $("#modifyactions").hide();
            // Hide selection toolbar and remove header highlights when navigating away
            hideSelectionToolbar();
            highlightTableHeaders(false);
            dataloaders = []
        }

        function searchDirector(instanceId) {
            qry = $("#searchvalue").val();
            if (currentType == "ALL") {
                searchResults(instanceId, qry);
            } else {
                searchResults(instanceId, qry, currentType);
            }
        }

        function searchResults(instanceId, query, typeName) {
            // Remove pre-existing tables if they exist
            $("#scansummary-content").remove();
            $("#ai-correlation-section").remove();
            $("#ai-correlation-table-single").remove();
            $("#ai-correlation-table-cross").remove();
            $("#scanlogs-content").remove();
            $("#stats-bar").remove();
            $("#dedup-bar").remove();
            navTo("btn-search");
            $("#modifyactions").hide();
            $("#loader").show();
            $("#btn-export").show();
            $("#btn-download-logs").hide();
            $("#btn-refresh").show();
            $("#btn-search").show();
            $("#scanreminder").hide();
            refresh = function() { searchResults(instanceId, query, typeName); }
            sf.search(instanceId, query, typeName, function(data) {
                            lastSearchType = typeName;
                            lastSearchQuery = query;

                            if (data.length == 0) {
                                var table = "<div id='scansummary-content'>&nbsp;&nbsp;No results found. Try broadening your search criteria.</div>";
                            } else {
                                // Search results info bar
                                var infoBar = "<div class='search-results-info'>Search results: " + data.length + " records</div>";

                                var table = "<table id='scansummary-content' class='table table-bordered table-striped small tablesorter'><thead><tr>";
                                if (typeName == null) {
                                    table += "<th class='sorter-false'>Data Element Type</th>";
                                }
                                table += "<th>Data Element</th><th>Source Data Element</th><th>Source Module</th><th>Identified</th></tr></thead><tbody>";
                                for (var i = 0; i < data.length; i++) {
                                    table += "<tr>";
                                    if (typeName == null) {
                                        table += "<td><pre class='table-border-bg-inherit'>" + data[i][8] + "</pre></td>";
                                    }
                                    table += "<td><pre class='table-border-bg-inherit'>";
                                    table += sf.replace_sfurltag(data[i][1]);
                                    // for debug
                                    table += "</pre></td><td><pre class='table-border-bg-inherit'>";
                                    table += sf.replace_sfurltag(data[i][2]);
                                    table += "</pre></td><td><pre class='table-border-bg-inherit'>" + data[i][3];
                                    table += "</pre></td><td><pre class='table-border-bg-inherit'>" + data[i][0];
                                    table += "</pre></td>";
                                    table += "</tr>";
                                }
                                table += "</tbody></table>"
                                table = infoBar + table;
                            }
                            $("#loader").fadeOut(500);
                            $("#mainbody").append(table);
                            $("#scansummary-content").tablesorter();
            });
        }

        // Vulnerabilities page - placeholder for NESSUS and BURP imports
        function viewVulnerabilities(instanceId) {
            $("#scansummary-content").remove();
            $("#ai-correlation-section").remove();
            $("#ai-correlation-table-single").remove();
            $("#ai-correlation-table-cross").remove();
            $("#scanlogs-content").remove();
            $("#stats-bar").remove();
            $("#dedup-bar").remove();
            $("#btn-export").hide();
            $("#btn-download-logs").hide();
            $("#btn-refresh").show();
            $("#btn-search").hide();
            $("#scanreminder").hide();
            navTo("btn-graph");
            refresh = function() { viewVulnerabilities(instanceId); }

            var activeTab = 'nessus';

            var grid = "<div id='scansummary-content'>";
            grid += "<div class='vuln-container'>";
            grid += "<div class='vuln-tab-bar'>";
            grid += "<button id='vuln-btn-nessus' class='vuln-tab-btn active' onclick='switchVulnTab(\"nessus\")'>";
            grid += "<span class='vuln-btn-icon'><i class='glyphicon glyphicon-shield'></i></span>";
            grid += "<span class='vuln-btn-label'>NESSUS</span>";
            grid += "<span class='vuln-btn-sub'>Tenable Pro Scanner</span>";
            grid += "</button>";
            grid += "<button id='vuln-btn-burp' class='vuln-tab-btn' onclick='switchVulnTab(\"burp\")'>";
            grid += "<span class='vuln-btn-icon'><i class='glyphicon glyphicon-globe'></i></span>";
            grid += "<span class='vuln-btn-label'>BURP</span>";
            grid += "<span class='vuln-btn-sub'>PortSwigger Pro Scanner</span>";
            grid += "</button>";
            grid += "</div>";
            grid += "<div class='vuln-content'>";
            grid += "<div id='vuln-nessus-content' class='vuln-panel'>";
            grid += "<div class='vuln-placeholder'>";
            grid += "<i class='glyphicon glyphicon-import' style='font-size: 32px; opacity: 0.4;'></i>";
            grid += "<p>Import Nessus Pro scan results (.nessus)</p>";
            grid += "<p class='text-muted' style='font-size: 12px;'>No vulnerability scans imported yet</p>";
            grid += "</div></div>";
            grid += "<div id='vuln-burp-content' class='vuln-panel' style='display:none'>";
            grid += "<div class='vuln-placeholder'>";
            grid += "<i class='glyphicon glyphicon-import' style='font-size: 32px; opacity: 0.4;'></i>";
            grid += "<p>Import Burp Pro scan results (.xml)</p>";
            grid += "<p class='text-muted' style='font-size: 12px;'>No vulnerability scans imported yet</p>";
            grid += "</div></div>";
            grid += "</div></div></div>";

            $("#mainbody").append(grid);
            $("#loader").hide();
        }

        // Switch between NESSUS and BURP vulnerability tabs
        function switchVulnTab(tab) {
            $('.vuln-tab-btn').removeClass('active');
            $('#vuln-btn-' + tab).addClass('active');
            $('.vuln-panel').hide();
            $('#vuln-' + tab + '-content').show();
        }

        // Legacy graphEvents - redirects to vulnerabilities
        function graphEvents(instanceId) {
            viewVulnerabilities(instanceId);
        }

        // ============================================================
        // FINDINGS PAGE - Two tabs: FINDINGS (Excel import) + CORRELATIONS
        // ============================================================
        var findingsActiveTab = 'findings';

        function viewFindings(instanceId) {
            $("#scansummary-content").remove();
            $("#ai-correlation-section").remove();
            $("#ai-correlation-table-single").remove();
            $("#ai-correlation-table-cross").remove();
            $("#scanlogs-content").remove();
            $("#stats-bar").remove();
            $("#dedup-bar").remove();
            $("#btn-export").hide();
            $("#btn-download-logs").hide();
            $("#btn-refresh").show();
            $("#btn-search").hide();
            $("#scanreminder").hide();
            navTo("btn-findings");
            refresh = function() { viewFindings(instanceId); }

            var grid = "<div id='scansummary-content'>";
            grid += "<div class='vuln-container'>";
            grid += "<div class='vuln-tab-bar'>";
            grid += "<button id='findings-btn-findings' class='vuln-tab-btn active' onclick='switchFindingsTab(\"findings\", \"" + instanceId + "\")'>";
            grid += "<span class='vuln-btn-icon'><i class='glyphicon glyphicon-list-alt'></i></span>";
            grid += "<span class='vuln-btn-label'>FINDINGS</span>";
            grid += "<span class='vuln-btn-sub'>All Finding Analysis</span>";
            grid += "</button>";
            grid += "<button id='findings-btn-correlations' class='vuln-tab-btn' onclick='switchFindingsTab(\"correlations\", \"" + instanceId + "\")'>";
            grid += "<span class='vuln-btn-icon'><i class='glyphicon glyphicon-exclamation-sign'></i></span>";
            grid += "<span class='vuln-btn-label'>CORRELATIONS</span>";
            grid += "<span class='vuln-btn-sub'>Rule-Based Analysis</span>";
            grid += "</button>";
            grid += "</div>";
            grid += "<div class='vuln-content'>";
            grid += "<div id='findings-findings-content' class='vuln-panel'></div>";
            grid += "<div id='findings-correlations-content' class='vuln-panel' style='display:none'></div>";
            grid += "</div></div></div>";

            $("#mainbody").append(grid);
            $("#loader").hide();

            // Load findings data into the findings tab
            loadFindingsData(instanceId);
        }

        function switchFindingsTab(tab, instanceId) {
            // Update tab buttons
            $('#findings-btn-findings').removeClass('active');
            $('#findings-btn-correlations').removeClass('active');
            $('#findings-btn-' + tab).addClass('active');

            // Show/hide panels
            $('#findings-findings-content').hide();
            $('#findings-correlations-content').hide();
            $('#findings-' + tab + '-content').show();

            findingsActiveTab = tab;

            // Load correlations data on first switch
            if (tab === 'correlations' && $('#findings-correlations-content').html() === '') {
                loadCorrelationsIntoPanel(instanceId);
            }
        }

        function loadFindingsData(instanceId) {
            var panel = $('#findings-findings-content');

            // First check if findings already exist
            sf.fetchData('${docroot}/scanfindingscount', {'id': instanceId},
                function(data) {
                    if (data.success && data.count > 0) {
                        // Findings exist - load and display them
                        loadFindingsTable(instanceId);
                    } else {
                        // No findings - show upload placeholder
                        showFindingsUploadPlaceholder(instanceId);
                    }
                },
                function() {
                    showFindingsUploadPlaceholder(instanceId);
                }
            );
        }

        function showFindingsUploadPlaceholder(instanceId) {
            var panel = $('#findings-findings-content');
            var html = "<div class='vuln-placeholder'>";
            html += "<i class='glyphicon glyphicon-import' style='font-size: 32px; opacity: 0.4;'></i>";
            html += "<p>Import Finding Analysis results (.xlsx)</p>";
            html += "<p class='text-muted' style='font-size: 12px;'>Upload an Excel file with Priority, Category, Tab, Item, Description, Recommendation columns</p>";
            html += "<div style='margin-top: 20px;'>";
            html += "<button class='btn btn-danger' onclick='triggerFindingsUpload(\"" + instanceId + "\")'>";
            html += "<i class='glyphicon glyphicon-upload'></i>&nbsp;&nbsp;UPLOAD FINDINGS ANALYSIS";
            html += "</button>";
            html += "<input type='file' id='findings-file-input' accept='.xlsx,.xls' style='display:none' onchange='handleFindingsUpload(\"" + instanceId + "\", this)'>";
            html += "</div></div>";
            panel.html(html);
        }

        function triggerFindingsUpload(instanceId) {
            $('#findings-file-input').click();
        }

        function handleFindingsUpload(instanceId, input) {
            if (!input.files || !input.files[0]) return;

            var file = input.files[0];
            var fname = file.name.toLowerCase();
            if (!fname.endsWith('.xlsx') && !fname.endsWith('.xls')) {
                alert('Please select an Excel file (.xlsx)');
                return;
            }

            var formData = new FormData();
            formData.append('importfile', file);
            formData.append('id', instanceId);

            var panel = $('#findings-findings-content');
            panel.html("<div class='vuln-placeholder'><i class='glyphicon glyphicon-refresh spinning' style='font-size: 32px;'></i><p>Importing findings...</p></div>");

            $.ajax({
                url: '${docroot}/importfindings',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                dataType: 'json',
                success: function(data) {
                    if (data.success) {
                        loadFindingsTable(instanceId);
                    } else {
                        panel.html("<div class='alert alert-danger' style='margin: 20px;'><i class='glyphicon glyphicon-exclamation-sign'></i>&nbsp;" + data.message + "</div>");
                        setTimeout(function() { showFindingsUploadPlaceholder(instanceId); }, 3000);
                    }
                },
                error: function(xhr, status, error) {
                    panel.html("<div class='alert alert-danger' style='margin: 20px;'><i class='glyphicon glyphicon-exclamation-sign'></i>&nbsp;Upload failed: " + status + "</div>");
                    setTimeout(function() { showFindingsUploadPlaceholder(instanceId); }, 3000);
                }
            });
        }

        function loadFindingsTable(instanceId) {
            var panel = $('#findings-findings-content');
            panel.html("<div class='vuln-placeholder'><i class='glyphicon glyphicon-refresh spinning' style='font-size: 24px;'></i><p>Loading findings...</p></div>");

            sf.fetchData('${docroot}/scanfindings', {'id': instanceId},
                function(data) {
                    if (!data || data.length === 0) {
                        showFindingsUploadPlaceholder(instanceId);
                        return;
                    }

                    // Toolbar
                    var html = "<div class='findings-toolbar'>";
                    html += "<div class='findings-toolbar-left'>";
                    html += "<span class='findings-count'><i class='glyphicon glyphicon-list-alt'></i>&nbsp;" + data.length + " FINDINGS</span>";
                    html += "</div>";
                    html += "<div class='findings-toolbar-right'>";
                    html += "<button class='btn btn-sm btn-default' onclick='reimportFindings(\"" + instanceId + "\")'>";
                    html += "<i class='glyphicon glyphicon-upload'></i>&nbsp;REIMPORT</button>&nbsp;";
                    html += "<a class='btn btn-sm btn-default' href='${docroot}/scanfindingsexport?id=" + instanceId + "&filetype=xlsx'>";
                    html += "<i class='glyphicon glyphicon-download-alt'></i>&nbsp;EXPORT</a>";
                    html += "</div></div>";

                    // Compact 4-column table with expandable detail rows
                    html += "<div class='findings-table-wrapper'>";
                    html += "<table id='findings-table' class='table findings-table tablesorter small'>";
                    html += "<colgroup>";
                    html += "<col class='col-priority'>";
                    html += "<col class='col-category'>";
                    html += "<col class='col-type'>";
                    html += "<col class='col-item'>";
                    html += "</colgroup>";
                    html += "<thead><tr>";
                    html += "<th>Priority</th>";
                    html += "<th>Category</th>";
                    html += "<th>Type</th>";
                    html += "<th>Item</th>";
                    html += "</tr></thead><tbody>";

                    for (var i = 0; i < data.length; i++) {
                        var priority = data[i][1];
                        var prioLower = priority.toLowerCase();
                        var badgeClass = '';
                        if (priority === 'CRITICAL') badgeClass = 'alert-critical';
                        else if (priority === 'HIGH') badgeClass = 'alert-danger';
                        else if (priority === 'MEDIUM') badgeClass = 'alert-warning';
                        else if (priority === 'LOW') badgeClass = 'alert-info';
                        else if (priority === 'INFO') badgeClass = 'alert-success';

                        var typeVal = data[i][3] || '';
                        var desc = data[i][5] || '';
                        var rec = data[i][6] || '';
                        var hasDetail = desc || rec;

                        // Main row (clickable to expand)
                        html += "<tr class='finding-row finding-" + prioLower + "' data-finding-id='" + i + "'" + (hasDetail ? " onclick='toggleFinding(" + i + ")'" : "") + ">";
                        html += "<td><span class='badge " + badgeClass + "'>" + priority + "</span>";
                        if (hasDetail) html += " <i class='glyphicon glyphicon-chevron-right finding-expand-icon' id='finding-icon-" + i + "'></i>";
                        html += "</td>";
                        html += "<td>" + (data[i][2] || '') + "</td>";
                        // Type column as clickable link to Browse page
                        if (typeVal) {
                            html += "<td><a class='finding-type-link' onclick='event.stopPropagation(); browseEventData(\"" + instanceId + "\", \"" + typeVal.replace(/"/g, '&quot;') + "\", \"" + typeVal.replace(/"/g, '&quot;') + "\", \"full\");' title='Browse " + typeVal + " data'>" + typeVal + "</a></td>";
                        } else {
                            html += "<td></td>";
                        }
                        html += "<td>" + (data[i][4] || '') + "</td>";
                        html += "</tr>";

                        // Expandable detail row
                        if (hasDetail) {
                            html += "<tr class='finding-detail-row finding-" + prioLower + "' id='finding-detail-" + i + "'>";
                            html += "<td colspan='4'><div class='finding-detail' id='finding-detail-content-" + i + "'>";
                            html += "<div class='finding-detail-grid'>";
                            if (desc) {
                                html += "<div class='finding-detail-section detail-description'>";
                                html += "<div class='finding-detail-label'>Description</div>";
                                html += "<div class='finding-detail-text'>" + desc + "</div>";
                                html += "</div>";
                            }
                            if (rec) {
                                html += "<div class='finding-detail-section detail-recommendation'>";
                                html += "<div class='finding-detail-label'>Recommendation</div>";
                                html += "<div class='finding-detail-text'>" + rec + "</div>";
                                html += "</div>";
                            }
                            html += "</div></div></td></tr>";
                        }
                    }

                    html += "</tbody></table></div>";
                    html += "<input type='file' id='findings-file-input' accept='.xlsx,.xls' style='display:none' onchange='handleFindingsUpload(\"" + instanceId + "\", this)'>";

                    panel.html(html);

                    // Enable table sorting (skip detail rows)
                    $.tablesorter.addParser({
                        id: 'findingsPriority',
                        is: function(s) { return false; },
                        format: function(s) {
                            return s.toLowerCase().replace(/critical/,0).replace(/high/,1).replace(/medium/,2).replace(/low/,3).replace(/info/,4);
                        },
                        type: 'numeric'
                    });

                    $("#findings-table").tablesorter({
                        headers: { 0: { sorter: 'findingsPriority' } },
                        cssChildRow: 'finding-detail-row',
                        sortList: [[0, 0]]
                    });
                },
                function() {
                    showFindingsUploadPlaceholder(instanceId);
                }
            );
        }

        function toggleFinding(idx) {
            var row = $('tr[data-finding-id="' + idx + '"]');
            var detail = $('#finding-detail-content-' + idx);
            if (row.hasClass('finding-expanded')) {
                row.removeClass('finding-expanded');
                detail.slideUp(150);
            } else {
                row.addClass('finding-expanded');
                detail.slideDown(150);
            }
        }

        function reimportFindings(instanceId) {
            if (confirm('FINDINGS ANALYSIS HAS ALREADY BEEN PERFORMED - WOULD YOU LIKE TO REPLACE THE CURRENT FINDINGS?')) {
                $('#findings-file-input').click();
            }
        }

        // Load correlations data into the correlations tab panel
        function loadCorrelationsIntoPanel(instanceId) {
            var panel = $('#findings-correlations-content');
            panel.html("<div class='vuln-placeholder'><i class='glyphicon glyphicon-refresh spinning' style='font-size: 24px;'></i><p>Loading correlations...</p></div>");

            sf.fetchData('${docroot}/scanstatus', {'id': instanceId},
                function(statusData) {
                    if (statusData && statusData[6] && (
                        (statusData[6]['CRITICAL'] || 0) > 0 ||
                        statusData[6]['HIGH'] > 0 ||
                        statusData[6]['MEDIUM'] > 0 ||
                        statusData[6]['LOW'] > 0 ||
                        statusData[6]['INFO'] > 0
                    )) {
                        sf.fetchData('${docroot}/scancorrelations', {'id': instanceId},
                            function(data) {
                                renderCorrelationsPanel(instanceId, data, statusData[6]);
                            },
                            function() {
                                renderCorrelationsPanelEmpty(instanceId);
                            }
                        );
                    } else {
                        renderCorrelationsPanelEmpty(instanceId);
                    }
                },
                function() {
                    sf.fetchData('${docroot}/scancorrelations', {'id': instanceId},
                        function(data) {
                            renderCorrelationsPanel(instanceId, data);
                        },
                        function() {
                            renderCorrelationsPanelEmpty(instanceId);
                        }
                    );
                }
            );
        }

        function buildAiCorrelationBar(instanceId) {
            // No longer rendered as a separate bar - AI rescan is now in the toolbar
            return "";
        }

        function initAiCorrelationButtons(instanceId) {
            sf.fetchData('${docroot}/checkAiCorrelationModes', {'id': instanceId},
                function(data) {
                    if (data.success) {
                        if (!data.single_scan_available) {
                            $("#btn-panel-rescan").prop('disabled', true).addClass('disabled')
                                .attr('title', 'No scan data available for AI analysis.');
                        }
                    }
                },
                function() { }
            );
        }

        function renderCorrelationsPanel(instanceId, data, counts) {
            var panel = $('#findings-correlations-content');

            if (!data || data.length == 0) {
                renderCorrelationsPanelEmpty(instanceId);
                return;
            }

            // Toolbar matching findings style
            var html = "<div class='findings-toolbar'>";
            html += "<div class='findings-toolbar-left'>";
            html += "<span class='findings-count'>" + data.length + " CORRELATIONS</span>";
            html += "</div>";
            html += "<div class='findings-toolbar-right'>";
            html += "<span class='ai-correlation-compact-results' id='ai-correlation-results'></span>";
            html += "<button id='btn-panel-rescan' class='btn btn-sm btn-default' onclick='runAiCorrelation(\"" + instanceId + "\", \"single\")'>";
            html += "<i class='glyphicon glyphicon-flash'></i>&nbsp;AI RESCAN</button>";
            html += "<a class='btn btn-sm btn-default' href='${docroot}/scancorrelationsexport?id=" + instanceId + "&filetype=xlsx' target='_blank'>";
            html += "<i class='glyphicon glyphicon-download-alt'></i>&nbsp;EXPORT</a>";
            html += "</div></div>";

            // Table matching findings style: Risk | Correlation | Type | Data Elements
            html += "<div class='findings-table-wrapper'>";
            html += "<table id='correlations-panel-table' class='table findings-table tablesorter small'>";
            html += "<colgroup>";
            html += "<col class='col-priority'>";
            html += "<col class='col-corr-name'>";
            html += "<col class='col-corr-type'>";
            html += "<col class='col-corr-elements'>";
            html += "</colgroup>";
            html += "<thead><tr>";
            html += "<th>Risk</th>";
            html += "<th>Correlation</th>";
            html += "<th>Type</th>";
            html += "<th>Data Elements</th>";
            html += "</tr></thead><tbody>";

            for (var i = 0; i < data.length; i++) {
                var risk = data[i][3];
                var riskLower = risk.toLowerCase();
                var badgeClass = '';
                if (risk === 'CRITICAL') badgeClass = 'alert-critical';
                else if (risk === 'HIGH') badgeClass = 'alert-danger';
                else if (risk === 'MEDIUM') badgeClass = 'alert-warning';
                else if (risk === 'LOW') badgeClass = 'alert-info';
                else if (risk === 'INFO') badgeClass = 'alert-success';

                var desc = data[i][5] || '';
                var eventTypes = data[i][8] || '';
                var corrId = data[i][0];

                // Main row (clickable to expand)
                html += "<tr class='finding-row finding-" + riskLower + " corr-row' data-corr-id='" + corrId + "' onclick='toggleCorrelation(\"" + instanceId + "\",\"" + corrId + "\")'>";
                html += "<td><span class='badge " + badgeClass + "'>" + risk + "</span>";
                html += " <i class='glyphicon glyphicon-chevron-right finding-expand-icon' id='corr-icon-" + corrId + "'></i>";
                html += "</td>";
                html += "<td>" + data[i][1] + "</td>";

                // Type column with clickable links to Browse
                if (eventTypes) {
                    var types = eventTypes.split(',');
                    var typeLinks = [];
                    for (var t = 0; t < types.length; t++) {
                        var typ = types[t].trim();
                        if (typ) {
                            typeLinks.push("<a class='finding-type-link' onclick='event.stopPropagation(); browseEventData(\"" + instanceId + "\", \"" + typ.replace(/"/g, '&quot;') + "\", \"" + typ.replace(/"/g, '&quot;') + "\", \"full\");' title='Browse " + typ + " data'>" + typ + "</a>");
                        }
                    }
                    html += "<td>" + typeLinks.join(", ") + "</td>";
                } else {
                    html += "<td></td>";
                }

                html += "<td>" + data[i][7] + "</td>";
                html += "</tr>";

                // Expandable detail row (description + events sub-table)
                html += "<tr class='finding-detail-row finding-" + riskLower + " corr-detail-row' id='corrwell_tr_" + corrId + "'>";
                html += "<td colspan='4'><div class='finding-detail' id='corr-detail-content-" + corrId + "'>";
                if (desc) {
                    html += "<div class='corr-description-wrapper'>";
                    html += "<div class='finding-detail-section detail-description corr-description-wide'>";
                    html += "<div class='finding-detail-label'>Description</div>";
                    html += "<div class='finding-detail-text'>" + desc + "</div>";
                    html += "</div>";
                    html += "</div>";
                }
                html += "<div id='corrwell_td_" + corrId + "' class='corr-events-container'></div>";
                html += "</div></td></tr>";
            }

            html += "</tbody></table></div>";
            panel.html(html);

            initAiCorrelationButtons(instanceId);

            // Enable table sorting matching findings style
            $.tablesorter.addParser({
                id: 'correlationPanelCriticality',
                is: function(s) { return false; },
                format: function(s) {
                    return s.toLowerCase().replace(/critical/,0).replace(/high/,1).replace(/medium/,2).replace(/low/,3).replace(/info/,4);
                },
                type: 'numeric'
            });

            $("#correlations-panel-table").tablesorter({
                headers: { 0: { sorter: 'correlationPanelCriticality' } },
                cssChildRow: 'corr-detail-row',
                sortList: [[0, 0]]
            });
            sf.updateTooltips();
        }

        function renderCorrelationsPanelEmpty(instanceId) {
            var panel = $('#findings-correlations-content');
            var html = "<div class='findings-toolbar'>";
            html += "<div class='findings-toolbar-left'>";
            html += "<span class='findings-count'>0 CORRELATIONS</span>";
            html += "</div>";
            html += "<div class='findings-toolbar-right'>";
            html += "<span class='ai-correlation-compact-results' id='ai-correlation-results'></span>";
            html += "<button id='btn-panel-rescan' class='btn btn-sm btn-default' onclick='runAiCorrelation(\"" + instanceId + "\", \"single\")'>";
            html += "<i class='glyphicon glyphicon-flash'></i>&nbsp;AI RESCAN</button>";
            html += "</div></div>";
            html += "<div class='alert alert-warning' style='margin: 0;'><h4>No correlations found.</h4>If the scan is still running please reload once it has completed. If the scan is complete, it may not have triggered any correlation rules.</div>";
            panel.html(html);
            initAiCorrelationButtons(instanceId);
        }

        // Scan status
        function scanSummaryView(instanceId) {
            grid = "<div id='scansummary-content'>";
            grid += "<div class='row'>";
            grid += "<div class='col-sm-7'>";
            grid += "<div class='panel panel-default'>";
            grid += "<div class='panel-heading'><i class='glyphicon glyphicon-eye-open'></i>&nbsp;&nbsp;Scan Status</div><div class='panel-body' style='padding: 5px'>";
            grid += "<div class='btn-toolbar text-center'>";
            grid += "<div class='btn-group' style='float: unset; padding: 5px'><button class='btn disabled btn-md btn-secondary' style='cursor: default;'>Total</span></button>";
            grid += "<button class='btn disabled btn-md btn-default' id='tcounter' style='cursor: default;'>?</button></div>";
            grid += "<div class='btn-group' style='float: unset; padding: 5px'><button class='btn disabled btn-md btn-secondary' style='cursor: default;'>Unique</button>";
            grid += "<button class='btn disabled btn-md btn-default' id='ucounter' style='cursor: default;'>?</button></div>";
            grid += "<div class='btn-group' style='float: unset; padding: 5px'><button class='btn disabled btn-md btn-secondary' style='cursor: default;'>Status</button>";
            grid += "<button class='btn disabled btn-md btn-default' id='status' style='cursor: default;'>?</button></div>";
            grid += "<div class='btn-group' style='float: unset; padding: 5px'><button class='btn disabled btn-md btn-secondary' style='cursor: default;'>Errors</button>";
            grid += "<button class='btn disabled btn-md btn-default' id='errors' style='cursor: default;'>?</button></div>";
            grid += "</div>";
            // Progress bar inside Scan Status panel (shown only for active scans)
            grid += "<div id='summary-progress-container' style='display: none; padding: 8px 10px 4px 10px;'>";
            grid += "<div style='display: flex; align-items: center; gap: 8px;'>";
            grid += "<div class='progress' style='flex: 1; height: 14px; margin-bottom: 0;'>";
            grid += "<div id='summary-progress-bar' class='progress-bar progress-bar-striped active' role='progressbar' style='width: 0%; min-width: 2em; text-align: center; line-height: 14px; font-size: 10px;'>0%</div>";
            grid += "</div>";
            grid += "<small id='summary-progress-pct' style='white-space: nowrap; font-weight: bold; min-width: 30px;'></small>";
            grid += "</div>";
            grid += "<div id='summary-progress-details' style='margin-top: 3px; font-size: 10px; color: #888; display: flex; gap: 12px; flex-wrap: wrap;'></div>";
            grid += "</div>";
            grid += "</div></div></div>";
            grid += "<div class='col-sm-5'>";
            grid += "<div class='panel panel-default'>";
            grid += "<div class='panel-heading'><i class='glyphicon glyphicon-exclamation-sign'></i>&nbsp;&nbsp;Correlations</div><div class='panel-body' style='padding: 5px'>";
            grid += "<div class='btn-toolbar text-center'>";
            grid += "<div class='btn-group' style='float: unset; padding: 5px'><button class='btn disabled btn-md btn-critical' style='cursor: default;'>Critical</span></button>";
            grid += "<button class='btn disabled btn-md btn-default' id='corr-critical' style='cursor: default;'>?</button></div>";
            grid += "<div class='btn-group' style='float: unset; padding: 5px'><button class='btn disabled btn-md btn-danger' style='cursor: default;'>High</span></button>";
            grid += "<button class='btn disabled btn-md btn-default' id='corr-high' style='cursor: default;'>?</button></div>";
            grid += "<div class='btn-group' style='float: unset; padding: 5px'><button class='btn disabled btn-md btn-warning' style='cursor: default;'>Medium</button>";
            grid += "<button class='btn disabled btn-md btn-default' id='corr-medium' style='cursor: default;'>?</button></div>";
            grid += "<div class='btn-group' style='float: unset; padding: 5px'><button class='btn disabled btn-md btn-info' style='cursor: default;'>Low</button>";
            grid += "<button class='btn disabled btn-md btn-default' id='corr-low' style='cursor: default;'>?</button></div>";
            grid += "<div class='btn-group' style='float: unset; padding: 5px'><button class='btn disabled btn-md btn-success' style='cursor: default;'>Info</button>";
            grid += "<button class='btn disabled btn-md btn-default' id='corr-info' style='cursor: default;'>?</button></div>";
            grid += "</div></div></div></div></div>";
            grid += "<div class='row'><div class='col-sm-12'>";
            grid += "<div class='panel panel-default'>";
            grid += "<div class='panel-heading'><i class='glyphicon glyphicon-stats'></i>&nbsp;&nbsp;Data Types</div><div class='panel-body'>";
            grid += "<div id='vbarsummary'></div>";
            grid += "</div></div></div></div>";

            $("#scansummary-content").remove();
            $("#ai-correlation-section").remove();
            $("#ai-correlation-table-single").remove();
            $("#ai-correlation-table-cross").remove();
            $("#scanlogs-content").remove();
            $("#stats-bar").remove();
            $("#dedup-bar").remove();
            $("#loader").show();
            $("#btn-export").hide();
            $("#btn-download-logs").hide();
            $("#btn-refresh").hide();
            $("#btn-search").hide();
            $("#scanreminder").show();
            navTo("btn-status");

            $("#mainbody").append(grid);

            // Collect data and populate variables for use later
            dataloaders.push(
                function() {
                    sf.fetchData('${docroot}/scanstatus', {'id': instanceId}, function(data) {
                        scanName = data[0];
                        scanTarget = data[1];
                        scanStarted = data[2];
                        scanEnded = data[4];
                        scanStatus = data[5];
                        scanCorrelations = data[6];

                        $("#corr-critical").html(scanCorrelations['CRITICAL']);
                        $("#corr-high").html(scanCorrelations['HIGH']);
                        $("#corr-medium").html(scanCorrelations['MEDIUM']);
                        $("#corr-low").html(scanCorrelations['LOW']);
                        $("#corr-info").html(scanCorrelations['INFO']);
                    });
                }
            );

            dataloaders.push(
                function() {
                    sf.fetchData('${docroot}/scanerrors', {'id': instanceId}, function(data) {
                        $("#errors").html(data.length);
                    });
                }
            );

            // Progress bar inside Scan Status panel
            dataloaders.push(
                function() {
                    sf.fetchData('${docroot}/scanprogress', {'id': instanceId}, function(data) {
                        var container = $('#summary-progress-container');
                        var bar = $('#summary-progress-bar');
                        var status = data.status;

                        if (status == 'FINISHED' || status == 'ABORTED' || status == 'ERROR-FAILED') {
                            container.hide();
                            return;
                        }

                        if (status == 'CREATED' || status == 'INITIALIZING' || status == 'STARTING' || status == 'STARTED' || status == 'RUNNING') {
                            container.show();
                            var pct = data.progressPercent || 0;
                            bar.css('width', pct + '%').attr('aria-valuenow', pct).text(pct + '%');
                            $('#summary-progress-pct').text('~' + pct + '%');

                            var details = '';
                            details += '<span><i class="glyphicon glyphicon-th-list"></i> ' + data.modulesWithResults + '/' + data.modulesTotal + ' modules</span>';
                            details += '<span><i class="glyphicon glyphicon-play"></i> ' + data.modulesRunning + ' running</span>';
                            var ql = data.eventsQueued; if (ql > 999) ql = (ql/1000).toFixed(1) + 'k';
                            details += '<span><i class="glyphicon glyphicon-inbox"></i> ' + ql + ' queued</span>';
                            var tl = data.totalEvents; if (tl > 999) tl = (tl/1000).toFixed(1) + 'k';
                            details += '<span><i class="glyphicon glyphicon-signal"></i> ' + tl + ' events</span>';
                            details += '<span><i class="glyphicon glyphicon-dashboard"></i> ' + data.eventsPerSecond + '/sec</span>';
                            $('#summary-progress-details').html(details);
                        } else {
                            container.hide();
                        }
                    });
                }
            );

            dataloaders.push(
                function() {
                    sf.fetchData('${docroot}/scansummary', {'id': instanceId, 'by': 'type'}, function(data) {
                        scanSummary = [];
                        totalCount = 0;
                        uniqueCount = 0;
                        for (i = 0; i < data.length; i++) {
                            scanSummary[i] = {};
                            scanSummary[i].scanId = instanceId;
                            scanSummary[i].id = data[i][0];
                            scanSummary[i].name = data[i][1];
                            scanSummary[i].total = data[i][3];
                            scanSummary[i].counter = data[i][4];
                            scanSummary[i].link = function(d) { return browseEventData(d.scanId, d.name, d.id, "full"); };
                            totalCount += data[i][3];
                            uniqueCount += data[i][4];
                            scanStatus = data[i][5];
                        }

                        for (x = 0; x < i; x++) {
                            scanSummary[x].pct = scanSummary[x].counter / uniqueCount;
                        }

                        $('#ucounter').html(uniqueCount);
                        $('#tcounter').html(totalCount);
                        $('#scanstatusbadge').html(scanStatus);

                        var statusy = "";
                        if (scanStatus == "FINISHED") {
                            statusy = "alert-success";
                        } else if (scanStatus.indexOf("ABORT") >= 0) {
                            statusy = "alert-warning";
                        } else if (scanStatus == "CREATED" || scanStatus == "RUNNING" || scanStatus == "STARTED" || scanStatus == "STARTING" || scanStatus == "INITIALIZING") {
                            statusy = "alert-info";
                        } else if (scanStatus.indexOf("FAILED") >= 0) {
                            statusy = "alert-danger";
                        } else {
                            statusy = "alert-info";
                        }
                        $('#scanstatusbadge').removeClass(["alert-info", "alert-warning", "alert-danger"]).addClass(statusy);
                        $('#status').html(scanStatus);
                        $("#vbarsummary").empty();
                        if (scanSummary.length == 0) {
                          $("#vbarsummary").append("<div id='scansummary-content' class='alert alert-warning'><h4>No data.</h4>If the scan is still running this section will update shortly.</div>");
                        } else {
                          sf_viz_vbar("#vbarsummary", scanSummary);
                        }
                        $("#loader").fadeOut(500);
                    });
                }
            );

            loadersrunning = true;
            for (var i = 0; i < dataloaders.length; i++) {
                dataloaders[i]();
            }
            loadersrunning = false;
        }

        // Expand the correlation list to show the events associated
        function toggleCorrelation(instanceId, correlationId) {
            var row = $('tr[data-corr-id="' + correlationId + '"]');
            var detail = $('#corr-detail-content-' + correlationId);
            var eventsContainer = $('#corrwell_td_' + correlationId);

            if (row.hasClass('finding-expanded')) {
                row.removeClass('finding-expanded');
                detail.slideUp(150);
                return;
            }

            row.addClass('finding-expanded');
            detail.slideDown(150);

            // Only fetch events if not already loaded
            if (eventsContainer.children().length > 0) return;

            eventsContainer.html("<div style='padding: 10px; text-align: center;'><i class='glyphicon glyphicon-refresh spinning'></i> Loading events...</div>");

            sf.fetchData('${docroot}/scaneventresults', { 'id': instanceId, 'correlationId': correlationId }, function(data) {
                var table = "<table class='table corr-events-table small'>";
                table += "<thead><tr>";
                table += "<th>Type</th>";
                table += "<th>Data Element</th>";
                table += "<th>Source Data Element</th>";
                table += "<th>Source Module</th>";
                table += "<th>Identified</th>";
                table += "</tr></thead><tbody>";

                for (var i = 0; i < data.length; i++) {
                    var evtType = data[i][10] || '';
                    table += "<tr>";
                    // Type column with link to Browse
                    if (evtType) {
                        table += "<td><a class='finding-type-link' onclick='browseEventData(\"" + instanceId + "\", \"" + evtType.replace(/"/g, '&quot;') + "\", \"" + evtType.replace(/"/g, '&quot;') + "\", \"full\");' title='Browse " + evtType + " data'>" + evtType + "</a></td>";
                    } else {
                        table += "<td></td>";
                    }
                    table += "<td><pre class='table-border-bg-inherit'>";
                    table += sf.replace_sfurltag(data[i][1]);
                    table += "</pre></td><td><pre class='table-border-bg-inherit'>";
                    table += sf.replace_sfurltag(data[i][2]);
                    table += "</pre></td><td><pre class='table-border-bg-inherit'>" + data[i][3];
                    table += "</pre></td><td><pre class='table-border-bg-inherit'>" + data[i][0];
                    table += "</pre></td>";
                    table += "</tr>";
                }
                table += "</tbody></table>";
                eventsContainer.html(table);
            });
        }

        // Legacy browseCorrelations - redirect to Findings page with Correlations tab
        function browseCorrelations(instanceId) {
            viewFindings(instanceId);
            // Switch to correlations tab after a short delay to let the DOM render
            setTimeout(function() {
                switchFindingsTab('correlations', instanceId);
            }, 100);
            return;
        }

        // Original correlation data fetching (kept for reference by AI correlation refresh)
        function browseCorrelationsLegacy(instanceId) {
            $("#scansummary-content").remove();
            $("#ai-correlation-section").remove();
            $("#ai-correlation-table-single").remove();
            $("#ai-correlation-table-cross").remove();
            $("#stats-bar").remove();
            $("#dedup-bar").remove();
            $("#loader").show();
            $("#btn-search").hide();
            $("#btn-export").hide();
            $("#scanreminder").hide();
            navTo("btn-findings");
            refresh = function() { browseCorrelations(instanceId); }
            
            console.log("Fetching correlation data for scan ID: " + instanceId);
            
            // First try the scanstatus endpoint which is known to work in the scanlist view
            sf.fetchData('${docroot}/scanstatus', {'id': instanceId}, 
                function(statusData) {
                    console.log("Got scan status data:", statusData);
                    
                    // Check if we have correlation data in the status response
                    if (statusData && statusData[6] && (
                        (statusData[6]['CRITICAL'] || 0) > 0 ||
                        statusData[6]['HIGH'] > 0 ||
                        statusData[6]['MEDIUM'] > 0 ||
                        statusData[6]['LOW'] > 0 ||
                        statusData[6]['INFO'] > 0
                    )) {
                        console.log("Correlation counts from status: ", statusData[6]);
                        
                        // Now fetch the detailed correlations
                        sf.fetchData('${docroot}/scancorrelations', {'id': instanceId}, 
                            function(data) {
                                console.log("Correlation details received:", data);
                                processCorrelationData(instanceId, data, statusData[6]);
                            },
                            function(xhr, textStatus, errorThrown) {
                                handleCorrelationError(instanceId, xhr, textStatus, errorThrown, statusData[6]);
                            }
                        );
                    } else {
                        console.log("No correlation counts found in status data");
                        noCorrelationsFound();
                    }
                },
                function(xhr, textStatus, errorThrown) {
                    console.error("Error fetching scan status data:", textStatus, errorThrown);
                    
                    // Fall back to the original correlation endpoint
                    sf.fetchData('${docroot}/scancorrelations', {'id': instanceId}, 
                        function(data) {
                            console.log("Correlation details received (fallback):", data);
                            processCorrelationData(instanceId, data);
                        },
                        function(xhr2, textStatus2, errorThrown2) {
                            handleCorrelationError(instanceId, xhr2, textStatus2, errorThrown2);
                        }
                    );
                }
            );
        }

        // Helper function to process correlation data
        function processCorrelationData(instanceId, data, counts) {
            if (!data || data.length == 0) {
                noCorrelationsFound();
                return;
            }
            
            // If we have counts but no details, show the counts
            if (data.length == 0 && counts) {
                var table = "<div id='scansummary-content' class='alert alert-info'>";
                table += "<h4>Correlation Summary</h4>";
                table += "<p>Found correlations but no details available:</p>";
                table += "<ul>";
                table += "<li>High: " + counts['HIGH'] + "</li>";
                table += "<li>Medium: " + counts['MEDIUM'] + "</li>";
                table += "<li>Low: " + counts['LOW'] + "</li>";
                table += "<li>Info: " + counts['INFO'] + "</li>";
                table += "</ul></div>";
                
                $("#loader").fadeOut(500);
                $("#mainbody").append(table);
                return;
            }
            
            var table = "<table id='scansummary-content' class='table table-bordered table-striped table-condensed tablesorter small'>";
            table += "<thead><tr><th>Correlation</th><th>Risk</th><th>Data Elements</th></tr></thead><tbody>";
            
            try {
                for (var i = 0; i < data.length; i++) {
                    table += "<tr>";
                    table += "<td><a style='cursor: pointer' onClick='toggleCorrelation(\"" + instanceId + "\",\"" + data[i][0] + "\")'>" + data[i][1] + "</a>&nbsp;&nbsp;";
                    table += "<i class='glyphicon glyphicon-question-sign' style='color: #ccc' rel='tooltip' data-title=\"" + data[i][5] + "\"></i>";
                    table += "</td>";
                    var statusy = "";
                    if (data[i][3] == "CRITICAL") {
                        statusy = "alert-critical";
                    } else if (data[i][3] == "HIGH") {
                        statusy = "alert-danger";
                    } else if (data[i][3] == "MEDIUM") {
                        statusy = "alert-warning";
                    } else if (data[i][3] == "LOW") {
                        statusy = "alert-info";
                    } else if (data[i][3] == "INFO") {
                        statusy = "alert-success";
                    }
                    table += "<td><span class='badge " + statusy + "'>" + data[i][3] + "</span></td>";
                    table += "<td>" + data[i][7] + "</td>";
                    table += "</tr><tr class='hidden tablesorter-childRow' id='corrwell_tr_" + data[i][0] + "'><td colspan=3 id='corrwell_td_" + data[i][0] + "'></td></tr>";
                }
            } catch (e) {
                console.error("Error processing correlation data:", e, data);
                table = "<div id='scansummary-content' class='alert alert-danger'><h4>Error displaying correlations</h4>An error occurred while processing correlation data: " + e.message + "</div>";
                $("#loader").fadeOut(500);
                $("#mainbody").append(table);
                return;
            }
            
            table += "</tbody></table>";
            $("#loader").fadeOut(500);
            // Add AI correlation section above regular correlations for visibility
            addAiCorrelationSection(instanceId);
            $("#mainbody").append(table);
            $.tablesorter.addParser({
                id: 'criticality',
                is: function(s) {
                    return false;
                },
                format: function(s) {
                    return s.toLowerCase().replace(/critical/,4).replace(/high/,3).replace(/medium/,2).replace(/low/,1).replace(/info/,0);
                },
                type: 'numeric'
            });
            $("#scansummary-content").tablesorter({
                headers: { 1: { sorter: 'criticality' } },
                cssChildRow: 'tablesorter-childRow',
                sortList: [[1, 1]]  // Sort by Risk column (1) in descending order (1) - HIGH first
            });
            sf.updateTooltips();
        }

        function handleCorrelationError(instanceId, xhr, textStatus, errorThrown, counts) {
            console.error("Error fetching correlation data:", textStatus, errorThrown);
            
            var errorMsg = "<div id='scansummary-content' class='alert alert-warning'>";
            
            // If we have counts but failed to get details, at least show the counts
            if (counts) {
                errorMsg += "<h4>Correlation Summary</h4>";
                errorMsg += "<p>Found correlations but couldn't retrieve details:</p>";
                errorMsg += "<ul>";
                errorMsg += "<li>High: " + counts['HIGH'] + "</li>";
                errorMsg += "<li>Medium: " + counts['MEDIUM'] + "</li>";
                errorMsg += "<li>Low: " + counts['LOW'] + "</li>";
                errorMsg += "<li>Info: " + counts['INFO'] + "</li>";
                errorMsg += "</ul>";
            } else {
                errorMsg += "<h4>Error retrieving correlation data</h4>";
                errorMsg += "<p>There was a problem retrieving the correlation data: " + textStatus + "</p>";
            }
            
            if (xhr.responseText) {
                errorMsg += "<p>Server response: " + xhr.responseText + "</p>";
            }
            
            errorMsg += "<button class='btn btn-primary' onclick='browseCorrelations(\"" + instanceId + "\")'>Retry</button>";
            errorMsg += "</div>";
            $("#loader").fadeOut(500);
            $("#mainbody").append(errorMsg);
        }

        function noCorrelationsFound() {
            var table = "<div id='scansummary-content' class='alert alert-warning'><h4>No correlations found.</h4>If the scan is still running please reload once it has completed. If the scan is complete, it may not have triggered any correlation rules.</div>";
            $("#loader").fadeOut(500);
            // Add AI correlation section first for visibility
            addAiCorrelationSection("${id}");
            $("#mainbody").append(table);
            sf.updateTooltips();
        }

        // Add AI correlation section with mode selection
        function addAiCorrelationSection(instanceId) {
            var aiSection = "<div id='ai-correlation-section' class='panel panel-default' style='margin-top: 20px;'>";
            aiSection += "<div class='panel-heading'><i class='glyphicon glyphicon-flash'></i>&nbsp;&nbsp;AI Correlation Analysis</div>";
            aiSection += "<div class='panel-body'>";
            aiSection += "<p>Run AI-powered analysis to identify significant and recurring indicators in scan data.</p>";

            // Mode selection buttons
            aiSection += "<div id='ai-correlation-mode-select' style='margin-bottom: 15px;'>";
            aiSection += "<button id='btn-run-single-correlation' class='btn btn-primary' style='margin-right: 10px;' onclick='runAiCorrelation(\"" + instanceId + "\", \"single\")'>";
            aiSection += "<i class='glyphicon glyphicon-search'></i>&nbsp;Single Scan Analysis</button>";
            aiSection += "<button id='btn-run-cross-correlation' class='btn btn-info' style='margin-right: 10px;' onclick='runAiCorrelation(\"" + instanceId + "\", \"cross\")'>";
            aiSection += "<i class='glyphicon glyphicon-transfer'></i>&nbsp;Cross-Scan Analysis</button>";
            aiSection += "</div>";

            aiSection += "<div id='ai-mode-descriptions'>";
            aiSection += "<p class='text-muted small' id='ai-single-desc'><strong>Single Scan:</strong> Analyze the current scan to find IOCs corroborated by multiple modules or event types.</p>";
            aiSection += "<p class='text-muted small' id='ai-cross-desc'><strong>Cross-Scan:</strong> Compare current scan results with imported historical scan data to find persistent IOCs.</p>";
            aiSection += "</div>";

            aiSection += "<div id='ai-correlation-results' style='margin-top: 15px;'></div>";
            aiSection += "</div></div>";
            $("#mainbody").append(aiSection);

            // Check which modes are available
            sf.fetchData('${docroot}/checkAiCorrelationModes', {'id': instanceId},
                function(data) {
                    if (data.success) {
                        if (!data.cross_scan_available) {
                            $("#btn-run-cross-correlation").prop('disabled', true).addClass('disabled')
                                .attr('title', 'No imported historical data detected. Import data from other scans to enable cross-scan analysis.');
                            $("#ai-cross-desc").html("<strong>Cross-Scan:</strong> <em>Unavailable</em> &mdash; No imported historical data detected. Import data from other scans first.");
                        }
                        if (!data.single_scan_available) {
                            $("#btn-run-single-correlation").prop('disabled', true).addClass('disabled');
                        }
                    }
                },
                function() {
                    // If check fails, leave both buttons enabled
                    console.error("Failed to check correlation modes");
                }
            );

        }

        // Run AI correlation analysis on current scan data
        // Uses $.ajax directly (not sf.fetchData) for proper error/timeout handling
        function runAiCorrelation(instanceId, mode) {
            var btnId = '#btn-panel-rescan';
            var resetBtn = function() {
                $(btnId).prop('disabled', false).html("<i class='glyphicon glyphicon-flash'></i>&nbsp;AI RESCAN");
            };

            $(btnId).prop('disabled', true).html("<i class='glyphicon glyphicon-refresh spinning'></i>&nbsp;Analyzing...");
            $("#ai-correlation-results").html("<span class='text-info'><i class='glyphicon glyphicon-hourglass'></i>&nbsp;Running analysis...</span>");

            $.ajax({
                type: "POST",
                url: '${docroot}/runAiCorrelation',
                data: {'id': instanceId, 'mode': mode},
                dataType: "json",
                timeout: 300000,
                success: function(data) {
                    resetBtn();
                    if (data.success) {
                        if (data.correlations_found > 0) {
                            $("#ai-correlation-results").html("<span class='text-success'><i class='glyphicon glyphicon-ok'></i>&nbsp;" + data.correlations_found + " new correlation(s) found.</span>");
                            setTimeout(function() { loadCorrelationsIntoPanel(instanceId); }, 1500);
                        } else {
                            $("#ai-correlation-results").html("<span class='text-muted'><i class='glyphicon glyphicon-info-sign'></i>&nbsp;No new correlations found.</span>");
                        }
                    } else {
                        $("#ai-correlation-results").html("<span class='text-danger'><i class='glyphicon glyphicon-exclamation-sign'></i>&nbsp;" + (data.error || 'Error') + "</span>");
                    }
                },
                error: function(xhr, textStatus, errorThrown) {
                    resetBtn();
                    var msg = textStatus === 'timeout' ? 'Request timed out' : textStatus;
                    $("#ai-correlation-results").html("<span class='text-danger'><i class='glyphicon glyphicon-exclamation-sign'></i>&nbsp;Failed: " + msg + "</span>");
                }
            });
        }

        // Run duplication check on scan results
        function runDeduplication(instanceId) {
            $("#btn-run-dedup").prop('disabled', true).html("<i class='glyphicon glyphicon-refresh spinning'></i>&nbsp;Checking...");
            $("#dedup-results").html("<span class='text-info'><i class='glyphicon glyphicon-hourglass'></i>&nbsp;Running duplication check...</span>");

            sf.fetchData('${docroot}/deduplicatescan', {'id': instanceId},
                function(data) {
                    $("#btn-run-dedup").prop('disabled', false).html("<i class='glyphicon glyphicon-duplicate'></i>&nbsp;Duplication Check");

                    if (data.success) {
                        if (data.removed > 0) {
                            var msg = "<span class='text-success'><i class='glyphicon glyphicon-ok'></i>&nbsp;Removed <strong>" + data.removed + "</strong> duplicate(s).";
                            if (data.fp_preserved > 0) {
                                msg += " FP status preserved on <strong>" + data.fp_preserved + "</strong> row(s).";
                            }
                            msg += "</span>";
                            $("#dedup-results").html(msg);
                            // Refresh the browse view after a brief delay
                            setTimeout(function() { browseEventList(instanceId); }, 1500);
                        } else {
                            $("#dedup-results").html("<span class='text-success'><i class='glyphicon glyphicon-ok'></i>&nbsp;No duplicates found. Scan data is clean.</span>");
                        }
                    } else {
                        $("#dedup-results").html("<span class='text-danger'><i class='glyphicon glyphicon-exclamation-sign'></i>&nbsp;Error: " + (data.message || 'Unknown error') + "</span>");
                    }
                },
                function(xhr, textStatus, errorThrown) {
                    $("#btn-run-dedup").prop('disabled', false).html("<i class='glyphicon glyphicon-duplicate'></i>&nbsp;Duplication Check");
                    $("#dedup-results").html("<span class='text-danger'><i class='glyphicon glyphicon-exclamation-sign'></i>&nbsp;Failed: " + textStatus + "</span>");
                }
            );
        }

        // Logs for the scan
        function viewScanLog(instanceId) {
            $("#scansummary-content").remove();
            $("#ai-correlation-section").remove();
            $("#ai-correlation-table-single").remove();
            $("#ai-correlation-table-cross").remove();
            $("#scanlogs-content").remove();
            $("#stats-bar").remove();
            $("#dedup-bar").remove();
            $("#loader").show();
            $("#btn-search").hide();
            $("#btn-export").hide();
            $("#btn-download-logs").show();
            $("#scanreminder").hide();
            navTo("btn-log");
            refresh = function() { viewScanLog(instanceId); }
            sf.fetchData('${docroot}/scanlog', {'id': instanceId}, function(data) {
                            var table = "<table id='scanlogs-content' class='table table-bordered table-striped table-condensed small tablesorter' style='table-layout: fixed'>";
                            table += "<thead><tr><th>Time</th><th>Component</th><th>Type</th><th>Event</th></tr></thead><tbody>";
                            for (var i = 0; i < data.length; i++) {
                                if (data[i][2] == "ERROR") {
                                  table += "<tr class='danger'>";
                                } else {
                                  table += "<tr>";
                                }
                                table += "<td>" + data[i][0] + "</a></td>";
                                table += "<td>" + data[i][1] + "</td>";
                                table += "<td>" + data[i][2] + "</td>";
                                table += "<td>" + data[i][3] + "</td>";
                                table += "</tr>";
                            }
                            table += "</tbody></table>";
                            $("#loader").fadeOut(500);
                            $("#mainbody").append(table);
                            $("#scanlogs-content").tablesorter({widgets: ["filter"], widgetOptions : { filter_searchDelay : 300, filter_hideFilters : false }});
            });
        }

        // Summary of event types and counts for a scan
        function browseEventList(instanceId) {
            currentType = "ALL";
            currentTypeName = "All";

            // Remove pre-existing tables if they exist
            $("#scansummary-content").remove();
            $("#ai-correlation-section").remove();
            $("#ai-correlation-table-single").remove();
            $("#ai-correlation-table-cross").remove();
            $("#scanlogs-content").remove();
            $("#stats-bar").remove();
            $("#dedup-bar").remove();
            navTo("btn-browse");
            $("#loader").show();
            $("#btn-export").show();
            $("#btn-download-logs").hide();
            $("#btn-refresh").show();
            $("#btn-search").show();
            $("#scanreminder").hide();
            refresh = function() { browseEventList(instanceId); }
            sf.fetchData('${docroot}/scansummary', {'id': instanceId, 'by': 'type'}, function(data) {
                            var dedupBar = "<div id='dedup-bar' style='margin-bottom: 15px; display: flex; align-items: center; gap: 15px;'>";
                            dedupBar += "<button id='btn-run-dedup' class='btn btn-warning' onclick='runDeduplication(\"${id}\")'>";
                            dedupBar += "<i class='glyphicon glyphicon-duplicate'></i>&nbsp;Duplication Check</button>";
                            dedupBar += "<span id='dedup-results' style='display: inline;'></span>";
                            dedupBar += "</div>";

                            var table = "<table id='scansummary-content' class='table table-bordered table-striped tablesorter'>";
                            table += "<thead><tr> <th>Type</th><th>Unique Data Elements</th> <th>Total Data Elements</th><th>Last Data Element</th></tr></thead><tbody>";
                            for (var i = 0; i < data.length; i++) {
                                table += "<tr><td><a class='link' onClick='";
                                table += "browseEventData(\"${id}\", \"" + escape(data[i][1]) + "\", \"" + data[i][0] + "\", \"full\");'>";
                                table += data[i][1] + "</a></td>";
                                table += "<td>" + data[i][4] + "</td>";
                                table += "<td>" + data[i][3] + "</td>";
                                table += "<td>" + data[i][2] + "</td>";
                            }
                            table += "</tbody></table>"

                            if (data.length < 1) {
                                table = "<div id='scansummary-content' class='alert alert-warning'><h4>No data.</h4>If the scan is still running please try again soon.</div>";
                            }

                            $("#loader").fadeOut(500);
                            $("#mainbody").append(dedupBar + table);
                            $("#scansummary-content").tablesorter();
            });
        }

        // Detailed view of data for an event type for a scan
        function browseEventData(instanceId, eventTypeLabel, eventType, format, filterFP, filterValidated, filterImportedEntries) {
            if (filterFP === 'undefined' || filterFP === undefined) {
                filterFP = false;
            }
            if (filterValidated === 'undefined' || filterValidated === undefined) {
                filterValidated = false;
            }
            if (filterImportedEntries === 'undefined' || filterImportedEntries === undefined) {
                filterImportedEntries = false;  // Default: show imported entries
            }
            $("#scansummary-content").remove();
            $("#ai-correlation-section").remove();
            $("#ai-correlation-table-single").remove();
            $("#ai-correlation-table-cross").remove();
            $("#scanlogs-content").remove();
            $("#breadcrumbs").remove();
            $("#stats-bar").remove();
            $("#dedup-bar").remove();
            $("#loader").show();
            navTo("btn-browse");
            $("#btn-export").show();
            $("#btn-download-logs").hide();
            $("#btn-refresh").show();
            $("#btn-search").show();
            $("#customtabview").show();
            $("#scanreminder").hide();
            currentType = eventType;
            currentTypeName = eventTypeLabel;
            updatePageTitle(currentTypeName);
            refresh = function() { browseEventData(instanceId, eventTypeLabel, eventType, format, filterFP, filterValidated, filterImportedEntries); }
            browseUpdate = function(newformat) { browseEventData(instanceId, eventTypeLabel, eventType, newformat, filterFP, filterValidated, filterImportedEntries); }
            currentBrowseFormat = format;

            if (format == 'full') {
                $("#btn-fullview").addClass("active");
                $("#btn-discoverypathview").removeClass("active");
                $("#btn-vizview").removeClass("active");
                $("#modifyactions").show();
                sf.fetchData('${docroot}/scaneventresults', {'id': instanceId, 'eventType': eventType }, function(data) {
                            // Count all categories
                            var stats = {
                                total: 0,
                                fp: 0,           // Current scan FPs
                                fpLegacy: 0,     // Target-level FPs from previous scans
                                validated: 0,     // Current scan validated
                                validatedLegacy: 0, // Target-level validated from previous scans
                                unvalidated: 0,
                                imported: 0      // Entries imported from older scans
                            };

                            for (var i = 0; i < data.length; i++) {
                                stats.total++;
                                // Count imported entries (data[13] is imported_from_scan)
                                if (data[i][13] != null) {
                                    stats.imported++;
                                }
                                if (data[i][8] == "1") {
                                    stats.fp++;
                                } else if (data[i][11] == 1) {
                                    stats.fpLegacy++;
                                } else if (data[i][8] == "2") {
                                    stats.validated++;
                                } else if (data[i][12] == 1) {
                                    stats.validatedLegacy++;
                                } else {
                                    stats.unvalidated++;
                                }
                            }

                            var totalFP = stats.fp + stats.fpLegacy;
                            var totalValidated = stats.validated + stats.validatedLegacy;

                            // Full-width stats bar with integrated filter buttons
                            // Inline styles ensure sticky positioning works even if CSS doesn't load properly
                            var statsBar = "<div id='stats-bar' class='stats-bar-fullwidth' style='position: sticky; position: -webkit-sticky; top: 0; z-index: 101;'>";

                            // Left side: Stats
                            statsBar += "<div class='stats-bar-left'>";
                            statsBar += "<div class='stats-item'><span class='stats-value'>" + stats.total + "</span><span class='stats-label'>TOTAL</span></div>";
                            statsBar += "<div class='stats-item stats-fp'><span class='stats-value'>" + stats.fp + "</span><span class='stats-label'>FALSE POSITIVES</span></div>";
                            statsBar += "<div class='stats-item stats-validated'><span class='stats-value'>" + stats.validated + "</span><span class='stats-label'>VALIDATED</span></div>";
                            statsBar += "<div class='stats-item stats-unvalidated'><span class='stats-value'>" + stats.unvalidated + "</span><span class='stats-label'>UNVALIDATED</span></div>";
                            if (stats.imported > 0) {
                                statsBar += "<div class='stats-item stats-imported'><span class='stats-value'>" + stats.imported + "</span><span class='stats-label'>IMPORTED</span></div>";
                            }
                            statsBar += "</div>";

                            // Right side: Filter buttons - use client-side filtering
                            statsBar += "<div class='stats-bar-right'>";

                            // Hide FP button - uses client-side toggle
                            if (totalFP > 0) {
                                var fpBtnClass = clientFilterState.fp ? 'filter-btn filter-btn-active filter-btn-fp' : 'filter-btn filter-btn-fp';
                                var fpBtnText = clientFilterState.fp ? 'HIDING ' + totalFP + ' FP' : 'HIDE ' + totalFP + ' FP';
                                statsBar += "<button class='" + fpBtnClass + "' data-show-text='HIDE " + totalFP + " FP' data-hiding-text='HIDING " + totalFP + " FP' onclick=\"toggleClientFilter('fp')\">";
                                statsBar += fpBtnText + "</button>";
                            }

                            // Hide Validated button - uses client-side toggle
                            if (totalValidated > 0) {
                                var valBtnClass = clientFilterState.validated ? 'filter-btn filter-btn-active filter-btn-validated' : 'filter-btn filter-btn-validated';
                                var valBtnText = clientFilterState.validated ? 'HIDING ' + totalValidated + ' VALIDATED' : 'HIDE ' + totalValidated + ' VALIDATED';
                                statsBar += "<button class='" + valBtnClass + "' data-show-text='HIDE " + totalValidated + " VALIDATED' data-hiding-text='HIDING " + totalValidated + " VALIDATED' onclick=\"toggleClientFilter('validated')\">";
                                statsBar += valBtnText + "</button>";
                            }

                            // Hide Imported button - uses client-side toggle
                            if (stats.imported > 0) {
                                var impBtnClass = clientFilterState.imported ? 'filter-btn filter-btn-active filter-btn-imported' : 'filter-btn filter-btn-imported';
                                var impBtnText = clientFilterState.imported ? 'HIDING ' + stats.imported + ' IMPORTED' : 'HIDE ' + stats.imported + ' IMPORTED';
                                statsBar += "<button class='" + impBtnClass + "' data-show-text='HIDE " + stats.imported + " IMPORTED' data-hiding-text='HIDING " + stats.imported + " IMPORTED' onclick=\"toggleClientFilter('imported')\">";
                                statsBar += impBtnText + "</button>";
                            }

                            statsBar += "</div>";
                            statsBar += "</div>";

                            var table = "<table id='scansummary-content' class='table table-bordered table-striped small tablesorter'>";
                            // Inline sticky styles on th elements ensure headers stick below stats bar
                            // Theme-aware glass blur effect - backdrop-filter applied via CSS
                            var isDarkMode = localStorage.getItem("theme") === "dark-theme";
                            var thBg = isDarkMode ? "rgba(0, 0, 0, 0.85)" : "rgba(255, 255, 255, 0.85)";
                            var thColor = isDarkMode ? "#ffffff" : "#1f2937";
                            var thStyle = "style='position: sticky; position: -webkit-sticky; top: 50px; z-index: 100; background: " + thBg + "; color: " + thColor + ";'";
                            table += "<thead><tr>";
                            table += "<th class='text-center' " + thStyle + "><input id='checkall' type='checkbox' onClick='switchSelectAll()'></th>";
                            table += "<th class='text-center validation-status' " + thStyle + ">Status</th>";
                            table += "<th " + thStyle + ">Data Element</th>";
                            table += "<th " + thStyle + ">Source Data Element</th>";
                            table += "<th " + thStyle + ">Source Module</th>";
                            table += "<th " + thStyle + ">Identified</th>";
                            table += "</tr></thead><tbody>";

                            for (var i = 0; i < data.length; i++) {
                                // All rows are rendered - filtering is done client-side
                                // Check if this entry is imported
                                var isImported = data[i][13] != null;

                                table += "<tr" + (isImported ? " class='imported-row'" : "") + ">";
                                // Checkbox column (simple checkbox only, no persistence indicators)
                                table += "<td class='text-center'><input type='checkbox' id='cb_" + data[i][7] + "'></td>";

                                // Status column with text badges
                                // Imported entries get a purple glow behind the status badge
                                table += "<td class='text-center validation-status'>";
                                // Determine status: FP=1 or target-level FP = False Positive (ORANGE)
                                // FP=2 or target-level validated = Validated (BLUE)
                                // Otherwise = Unvalidated (GREY)
                                var importedClass = isImported ? " status-imported-glow" : "";
                                if (data[i][8] == "1" || data[i][11] == 1) {
                                    // Current scan marked as FP or target-level FP
                                    table += "<span class='status-fp" + importedClass + "' title='False Positive - confirmed does not belong to organization'>FALSE POSITIVE</span>";
                                } else if (data[i][8] == "2" || data[i][12] == 1) {
                                    // Current scan marked as validated or target-level validated
                                    table += "<span class='status-validated" + importedClass + "' title='Validated - confirmed belongs to organization'>VALIDATED</span>";
                                } else {
                                    table += "<span class='status-unvalidated" + importedClass + "' title='Not yet reviewed'>UNVALIDATED</span>";
                                }
                                table += "</td>";

                                table += "<td><pre class='table-border-bg-inherit'>";
                                //table += "<a href='${docroot}/entityinfo?id=" + data[i][7] + "'>" + data[i][1] + "</a>";
                                table += sf.replace_sfurltag(data[i][1]);
                                table += "</pre></td><td><pre class='table-border-bg-inherit'>";
                                table += sf.replace_sfurltag(data[i][2]);
                                table += "</pre></td><td><pre class='table-border-bg-inherit'>" + data[i][3];
                                table += "</pre></td><td><pre class='table-border-bg-inherit'>" + data[i][0];
                                table += "</pre></td>";
                                table += "</tr>";
                            }
                            table += "</tbody></table>"
                            $("#loader").fadeOut(500);
                            $("#mainbody").append(statsBar + table);
                            $("#scansummary-content").tablesorter({ headers: { 0: { sorter: false }, 1: { sorter: false } } });

                            // Apply any active client-side filters after table render
                            if (clientFilterState.fp || clientFilterState.validated || clientFilterState.imported) {
                                applyClientSideFilters();
                            }
                            lastChecked = null;
                            var chkboxes = $('input[id*=cb_]');
                            chkboxes.click(function(e) {
                                if(!lastChecked) {
                                    lastChecked = this;
                                    return;
                                }

                                if(e.shiftKey) {
                                    var start = chkboxes.index(this);
                                    var end = chkboxes.index(lastChecked);

                                    chkboxes.slice(Math.min(start,end), Math.max(start,end)+ 1).prop('checked', lastChecked.checked);

                                }

                                lastChecked = this;
                            });

                            // Make clicking anywhere in first cell toggle checkbox
                            $("#scansummary-content td:first-child").click(function(e) {
                                // Only toggle if not clicking directly on checkbox
                                if (e.target.type !== 'checkbox') {
                                    var cb = $(this).find("input[type='checkbox']");
                                    cb.prop('checked', !cb.prop('checked'));
                                    updateSelectionToolbar();
                                }
                            });

                            // Update toolbar when any checkbox changes
                            $("input[id*=cb_]").change(function() {
                                updateSelectionToolbar();
                            });

                            // Update toolbar when "select all" checkbox changes
                            $("#checkall").change(function() {
                                updateSelectionToolbar();
                            });

                });
            }

            if (format == 'discovery-path') {
                $("#btn-discoverypathview").addClass("active");
                $("#btn-fullview").removeClass("active");
                $("#btn-vizview").removeClass("active");
                $("#modifyactions").show();

                // Fetch both datasets: full view data (for ordering + FP status) and discovery tree (for paths)
                var fullViewData = null;
                var discoveryData = null;
                var loaded = 0;

                function onBothLoaded() {
                    var treeData = discoveryData['tree'];
                    var dataMap = discoveryData['data'];

                    // Build a lookup from leaf hash to its path (array of node objects from root to leaf)
                    var leafPaths = {};

                    function walkTree(node, pathSoFar) {
                        var nodeName = node.name;
                        var nodeInfo = dataMap[nodeName];
                        var currentPath = pathSoFar.slice();
                        if (nodeInfo) {
                            currentPath.push({
                                data: sf.remove_sfurltag(String(nodeInfo[1])),
                                type: nodeInfo[10] || nodeInfo[4],
                                module: nodeInfo[3] || '',
                                hash: nodeInfo[8],
                                isRoot: nodeInfo[4] === 'ROOT'
                            });
                        }

                        if (!node.children || node.children.length === 0) {
                            // Leaf node - store the path keyed by hash
                            if (nodeInfo && nodeInfo[4] !== 'ROOT') {
                                leafPaths[nodeInfo[8]] = currentPath;
                            }
                        } else {
                            for (var c = 0; c < node.children.length; c++) {
                                walkTree(node.children[c], currentPath);
                            }
                        }
                    }

                    if (treeData) {
                        walkTree(treeData, []);
                    }

                    // Find the maximum path depth across all leaves
                    var maxDepth = 0;
                    for (var h in leafPaths) {
                        if (leafPaths[h].length > maxDepth) maxDepth = leafPaths[h].length;
                    }

                    // Count stats from fullViewData (same logic as full view)
                    var stats = { total: 0, fp: 0, fpLegacy: 0, validated: 0, validatedLegacy: 0, unvalidated: 0, imported: 0 };
                    for (var i = 0; i < fullViewData.length; i++) {
                        stats.total++;
                        if (fullViewData[i][13] != null) stats.imported++;
                        if (fullViewData[i][8] == "1") stats.fp++;
                        else if (fullViewData[i][11] == 1) stats.fpLegacy++;
                        else if (fullViewData[i][8] == "2") stats.validated++;
                        else if (fullViewData[i][12] == 1) stats.validatedLegacy++;
                        else stats.unvalidated++;
                    }
                    var totalFP = stats.fp + stats.fpLegacy;
                    var totalValidated = stats.validated + stats.validatedLegacy;

                    // Build stats bar (same style as full view)
                    var statsBar = "<div id='stats-bar' class='stats-bar-fullwidth' style='position: sticky; position: -webkit-sticky; top: 0; z-index: 101;'>";
                    statsBar += "<div class='stats-bar-left'>";
                    statsBar += "<div class='stats-item'><span class='stats-value'>" + stats.total + "</span><span class='stats-label'>TOTAL</span></div>";
                    statsBar += "<div class='stats-item stats-fp'><span class='stats-value'>" + stats.fp + "</span><span class='stats-label'>FALSE POSITIVES</span></div>";
                    statsBar += "<div class='stats-item stats-validated'><span class='stats-value'>" + stats.validated + "</span><span class='stats-label'>VALIDATED</span></div>";
                    statsBar += "<div class='stats-item stats-unvalidated'><span class='stats-value'>" + stats.unvalidated + "</span><span class='stats-label'>UNVALIDATED</span></div>";
                    if (stats.imported > 0) {
                        statsBar += "<div class='stats-item stats-imported'><span class='stats-value'>" + stats.imported + "</span><span class='stats-label'>IMPORTED</span></div>";
                    }
                    statsBar += "</div>";

                    // Filter buttons
                    statsBar += "<div class='stats-bar-right'>";
                    if (totalFP > 0) {
                        var fpBtnClass = clientFilterState.fp ? 'filter-btn filter-btn-active filter-btn-fp' : 'filter-btn filter-btn-fp';
                        var fpBtnText = clientFilterState.fp ? 'HIDING ' + totalFP + ' FP' : 'HIDE ' + totalFP + ' FP';
                        statsBar += "<button class='" + fpBtnClass + "' data-show-text='HIDE " + totalFP + " FP' data-hiding-text='HIDING " + totalFP + " FP' onclick=\"toggleClientFilter('fp')\">" + fpBtnText + "</button>";
                    }
                    if (totalValidated > 0) {
                        var valBtnClass = clientFilterState.validated ? 'filter-btn filter-btn-active filter-btn-validated' : 'filter-btn filter-btn-validated';
                        var valBtnText = clientFilterState.validated ? 'HIDING ' + totalValidated + ' VALIDATED' : 'HIDE ' + totalValidated + ' VALIDATED';
                        statsBar += "<button class='" + valBtnClass + "' data-show-text='HIDE " + totalValidated + " VALIDATED' data-hiding-text='HIDING " + totalValidated + " VALIDATED' onclick=\"toggleClientFilter('validated')\">" + valBtnText + "</button>";
                    }
                    if (stats.imported > 0) {
                        var impBtnClass = clientFilterState.imported ? 'filter-btn filter-btn-active filter-btn-imported' : 'filter-btn filter-btn-imported';
                        var impBtnText = clientFilterState.imported ? 'HIDING ' + stats.imported + ' IMPORTED' : 'HIDE ' + stats.imported + ' IMPORTED';
                        statsBar += "<button class='" + impBtnClass + "' data-show-text='HIDE " + stats.imported + " IMPORTED' data-hiding-text='HIDING " + stats.imported + " IMPORTED' onclick=\"toggleClientFilter('imported')\">" + impBtnText + "</button>";
                    }
                    statsBar += "</div></div>";

                    // Build table header with dynamic node columns
                    var isDarkMode = localStorage.getItem("theme") === "dark-theme";
                    var thBg = isDarkMode ? "rgba(0, 0, 0, 0.85)" : "rgba(255, 255, 255, 0.85)";
                    var thColor = isDarkMode ? "#ffffff" : "#1f2937";
                    var thStyle = "style='position: sticky; position: -webkit-sticky; top: 50px; z-index: 100; background: " + thBg + "; color: " + thColor + ";'";

                    var table = "<table id='scansummary-content' class='table table-bordered table-striped small tablesorter'>";
                    table += "<thead><tr>";
                    table += "<th class='text-center' " + thStyle + "><input id='checkall' type='checkbox' onClick='switchSelectAll()'></th>";
                    table += "<th class='text-center validation-status' " + thStyle + ">Status</th>";
                    // Dynamic node columns: Root on left, Leaf on right
                    for (var d = 0; d < maxDepth; d++) {
                        var colLabel;
                        if (d === 0) colLabel = "Root";
                        else if (d === maxDepth - 1) colLabel = "Leaf";
                        else if (maxDepth <= 3) colLabel = "Branch";
                        else colLabel = "Branch " + d;
                        table += "<th " + thStyle + ">" + colLabel + "</th>";
                    }
                    table += "</tr></thead><tbody>";

                    // Iterate fullViewData in order (same as full view)  each entry is a leaf
                    for (var i = 0; i < fullViewData.length; i++) {
                        var d = fullViewData[i];
                        var leafHash = d[7]; // hash
                        var path = leafPaths[leafHash];
                        var isImported = d[13] != null;

                        // Row classes
                        var rowClasses = [];
                        if (isImported) rowClasses.push("imported-row");
                        var rowClassAttr = rowClasses.length > 0 ? " class='" + rowClasses.join(" ") + "'" : "";

                        table += "<tr" + rowClassAttr + ">";

                        // Checkbox
                        table += "<td class='text-center'><input type='checkbox' id='cb_" + d[7] + "'></td>";

                        // Status column (same as full view)
                        table += "<td class='text-center validation-status'>";
                        var importedClass = isImported ? " status-imported-glow" : "";
                        if (d[8] == "1" || d[11] == 1) {
                            table += "<span class='status-fp" + importedClass + "' title='False Positive'>FALSE POSITIVE</span>";
                        } else if (d[8] == "2" || d[12] == 1) {
                            table += "<span class='status-validated" + importedClass + "' title='Validated'>VALIDATED</span>";
                        } else {
                            table += "<span class='status-unvalidated" + importedClass + "' title='Not yet reviewed'>UNVALIDATED</span>";
                        }
                        table += "</td>";

                        // Node columns (Root -> ... -> Leaf)
                        function buildCell(type, module, data) {
                            var html = "<td class='discovery-path-cell dp-collapsed'>";
                            html += "<div class='dp-cell-wrap'>";
                            html += "<div class='dp-type'><strong>TYPE:</strong> <span class='dp-value'>" + type + "</span></div>";
                            html += "<div class='dp-module'><strong>SOURCE MODULE:</strong> <span class='dp-value'>" + module + "</span></div>";
                            html += "<div class='dp-data'><strong>DATA:</strong> <span class='dp-value dp-data-value'>" + data + "</span></div>";
                            html += "<div class='dp-expand-toggle'></div>";
                            html += "</div>";
                            html += "</td>";
                            return html;
                        }

                        if (path && path.length > 0) {
                            for (var n = 0; n < maxDepth; n++) {
                                if (n < path.length) {
                                    table += buildCell(path[n].type, path[n].module, path[n].data);
                                } else {
                                    table += "<td></td>";
                                }
                            }
                        } else {
                            for (var n = 0; n < maxDepth - 1; n++) {
                                table += "<td></td>";
                            }
                            table += buildCell(d[10], d[3], sf.remove_sfurltag(d[1]));
                        }

                        table += "</tr>";
                    }
                    table += "</tbody></table>";

                    $("#loader").fadeOut(500);
                    $("#mainbody").append(statsBar + table);
                    $("#scansummary-content").tablesorter({ headers: { 0: { sorter: false }, 1: { sorter: false } } });

                    // Show expand toggle only on cells that are actually truncated
                    $("#scansummary-content .discovery-path-cell").each(function() {
                        var cell = $(this);
                        var hasOverflow = false;
                        cell.find('.dp-type, .dp-module, .dp-data').each(function() {
                            if (this.scrollWidth > this.clientWidth) {
                                hasOverflow = true;
                            }
                        });
                        if (!hasOverflow) {
                            cell.find('.dp-expand-toggle').remove();
                            cell.removeClass('dp-collapsed');
                        }
                    });

                    // Click handler for expand/collapse toggle
                    $("#scansummary-content").on('click', '.dp-expand-toggle', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        var cell = $(this).closest('.discovery-path-cell');
                        if (cell.hasClass('dp-collapsed')) {
                            cell.removeClass('dp-collapsed').addClass('dp-expanded');
                        } else {
                            cell.removeClass('dp-expanded').addClass('dp-collapsed');
                        }
                    });

                    // Apply any active client-side filters
                    if (clientFilterState.fp || clientFilterState.validated || clientFilterState.imported) {
                        applyClientSideFilters();
                    }

                    // Checkbox shift-click support
                    lastChecked = null;
                    var chkboxes = $('input[id*=cb_]');
                    chkboxes.click(function(e) {
                        if (!lastChecked) { lastChecked = this; return; }
                        if (e.shiftKey) {
                            var start = chkboxes.index(this);
                            var end = chkboxes.index(lastChecked);
                            chkboxes.slice(Math.min(start, end), Math.max(start, end) + 1).prop('checked', lastChecked.checked);
                        }
                        lastChecked = this;
                    });

                    // Click anywhere in first cell to toggle checkbox
                    $("#scansummary-content td:first-child").click(function(e) {
                        if (e.target.type !== 'checkbox') {
                            var cb = $(this).find("input[type='checkbox']");
                            cb.prop('checked', !cb.prop('checked'));
                            updateSelectionToolbar();
                        }
                    });

                    $("input[id*=cb_]").change(function() { updateSelectionToolbar(); });
                    $("#checkall").change(function() { updateSelectionToolbar(); });
                }

                // Fetch full view data (for ordering and FP status)
                sf.fetchData('${docroot}/scaneventresults', {'id': instanceId, 'eventType': eventType }, function(data) {
                    fullViewData = data;
                    loaded++;
                    if (loaded === 2) onBothLoaded();
                });

                // Fetch discovery path tree
                sf.fetchData('${docroot}/scanelementtypediscovery', {
                    'id': instanceId,
                    'eventType': eventType,
                    'filterFp': '0'
                }, function(data) {
                    discoveryData = data;
                    loaded++;
                    if (loaded === 2) onBothLoaded();
                });
            }

            if (format.indexOf('viz') == 0) {
                $("#btn-vizview").addClass("active");
                $("#btn-fullview").removeClass("active");
                $("#btn-discoverypathview").removeClass("active");

                if (format.indexOf("viz-bubble") == 0) {
                    sf.fetchData('${docroot}/scaneventresults', {'id': instanceId, 'eventType': eventType }, function(data) {
                        itemList = []
                        for (var i = 0; i < data.length; i++) {
                            if (format == "viz-bubble-source") {
                                itemList.push(sf.remove_sfurltag(data[i][2]));
                            }
                            if (format == "viz-bubble-data") {
                                itemList.push(sf.remove_sfurltag(data[i][1]));
                            }
                        }
                        $("#loader").fadeOut(500);
                        $("#mainbody").append("<div id='scansummary-content' class='text-center'></div>");
                        sf_viz_bubble("#scansummary-content", itemList)
                    });
                }

                if (format == "viz-dendro") {
                    sf.fetchData("${docroot}/scanelementtypediscovery", {'id': instanceId, 'eventType': eventType }, function(data) {
                        $("#loader").fadeOut(500);
                        $("#mainbody").append("<div id='scansummary-content' class='text-center'></div>");
                        sf_viz_dendrogram("#scansummary-content", data);
                    });
                }
            }
        }

        function downloadLogs(instanceId) {
            $("#loader").show();
            sf.log("Loading logs for scan: " + instanceId);
            var efr = document.getElementById('exportframe');
            var urlBase = '${docroot}/scanexportlogs?id=';
            efr.src = urlBase + instanceId;
            $("#loader").fadeOut(500);
        }

        // Download the data currently being viewed
        function exportEventData(instanceId, eventType, fileType, exportMode, legacy) {
            exportMode = exportMode || "full";
            var legacyParam = legacy ? '&legacy=1' : '';
            $("#loader").show();
            var efr = document.getElementById('exportframe');
            if (currentSection == "btn-search") {
                if (lastSearchType == null || lastSearchType == "ALL") {
                    type = "";
                } else {
                    type = lastSearchType;
                }
                if (fileType == "excel") {
                    var urlBase = '${docroot}/scansearchresultexport?filetype=excel&export_mode=' + exportMode + legacyParam + '&id=';
                } else {
                    var urlBase = '${docroot}/scansearchresultexport?export_mode=' + exportMode + legacyParam + '&id=';
                }
                efr.src = urlBase + instanceId + '&eventType=' + type + "&value=" + lastSearchQuery;
            }

            if (currentSection == "btn-browse") {
                if (currentBrowseFormat == "discovery-path") {
                    if (fileType == "excel") {
                        var urlBase = '${docroot}/scandiscoverypathexport?filetype=excel&id=';
                    } else {
                        var urlBase = '${docroot}/scandiscoverypathexport?id=';
                    }
                    efr.src = urlBase + instanceId + '&eventType=' + eventType;
                } else {
                    if (fileType == "excel") {
                        var urlBase = '${docroot}/scaneventresultexport?filetype=excel&export_mode=' + exportMode + legacyParam + '&id=';
                    } else {
                        var urlBase = '${docroot}/scaneventresultexport?export_mode=' + exportMode + legacyParam + '&id=';
                    }
                    efr.src = urlBase + instanceId + '&type=' + eventType;
                }
            }

            $("#loader").fadeOut(500);
        }

        // View the configuration that was used for this scan
        function viewScanConfig(instanceId) {
            $("#scansummary-content").remove();
            $("#ai-correlation-section").remove();
            $("#ai-correlation-table-single").remove();
            $("#ai-correlation-table-cross").remove();
            $("#scanlogs-content").remove();
            $("#stats-bar").remove();
            $("#dedup-bar").remove();
            $("#loader").show();
            $("#btn-export").hide();
            $("#btn-download-logs").hide();
            $("#btn-refresh").show();
            $("#btn-search").hide();
            $("#scanreminder").hide();
            navTo("btn-info");
            scanLogLoaded = false;
            refresh = function() { viewScanConfig(instanceId); }
            sf.fetchData('${docroot}/scanopts', {'id': instanceId}, function(data) {
                var table = "<div id='scansummary-content'>";

                // Meta Information - collapsible, collapsed by default
                table += "<div class='manage-section'>";
                table += "<div class='manage-section-header collapsed' onclick='toggleManageSection(this)'>";
                table += "<i class='glyphicon glyphicon-chevron-right section-chevron'></i>";
                table += "<h4>Meta Information</h4>";
                table += "</div>";
                table += "<div class='manage-section-body' style='display:none'>";
                table += "<table class='table table-bordered table-striped'>";
                table += "<tr><td>Name:</td><td>" + data['meta'][0] + "</td></tr>";
                table += "<tr><td>Internal ID:</td><td>${id}</td></tr>";
                table += "<tr><td>Target:</td><td>" + data['meta'][1] + "</td></tr>";
                table += "<tr><td>Started:</td><td>" + data['meta'][3] + "</td></tr>";
                table += "<tr><td>Completed:</td><td>" + data['meta'][4] + "</td></tr>";
                table += "<tr><td>Status:</td><td>" + data['meta'][5] + "</td></tr>";
                table += "</table>";
                table += "</div></div>";

                // Global Settings - collapsible, collapsed by default
                table += "<div class='manage-section'>";
                table += "<div class='manage-section-header collapsed' onclick='toggleManageSection(this)'>";
                table += "<i class='glyphicon glyphicon-chevron-right section-chevron'></i>";
                table += "<h4>Global Settings</h4>";
                table += "</div>";
                table += "<div class='manage-section-body' style='display:none'>";
                table += "<table class='table table-bordered table-striped' style='table-layout: fixed'>";
                table += "<thead><tr><th>Option</th><th>Value</th></tr></thead><tbody>";
                for (var key in data['config']) {
                    if (key.indexOf(":") > 0) {
                        continue;
                    }
                    table += "<tr><td width=100%>" + data['configdesc'][key] + "</td><td>" + data['config'][key] + "</td></tr>";
                }
                table += "</tbody></table>";
                table += "</div></div>";

                // Module Settings - collapsible, collapsed by default
                table += "<div class='manage-section'>";
                table += "<div class='manage-section-header collapsed' onclick='toggleManageSection(this)'>";
                table += "<i class='glyphicon glyphicon-chevron-right section-chevron'></i>";
                table += "<h4>Module Settings</h4>";
                table += "</div>";
                table += "<div class='manage-section-body' style='display:none'>";
                table += "<div class='table-responsive'><table class='table table-bordered table-striped' style='table-layout: fixed'>";
                table += "<thead><tr><th>Module</th> <th>Option</th> <th>Value</th></tr></thead><tbody>";
                var keys = [];
                for (var key in data['config']) {
                    keys.push(key);
                }
                var keys_s = keys.sort();
                for (var i = 0; i < keys_s.length; i++) {
                    var key = keys_s[i];
                    if (key.indexOf(":") > 0) {
                        var bits = key.split(":");
                        table += "<tr><td>" + bits[0] + "</td><td>" + data['configdesc'][key] + "</td><td>" + data['config'][key] + "</td></tr>";
                    }
                }
                table += "</tbody></table></div>";
                table += "</div></div>";

                // Scan Log - collapsible button at the bottom
                table += "<div class='manage-section'>";
                table += "<div class='manage-section-header collapsed' id='scan-log-header' onclick='toggleScanLog(this, \"" + instanceId + "\")'>";
                table += "<i class='glyphicon glyphicon-chevron-right section-chevron'></i>";
                table += "<h4><i class='glyphicon glyphicon-book'></i>&nbsp;Scan Log</h4>";
                table += "</div>";
                table += "<div class='manage-section-body' id='scan-log-body' style='display:none'>";
                table += "<div id='scan-log-loader' style='text-align:center; padding: 20px; display:none'><img src=\"${docroot}/static/img/loader.gif\"></div>";
                table += "<div id='scan-log-content'></div>";
                table += "</div></div>";

                table += "</div>";

                $("#loader").fadeOut(500);
                $("#mainbody").append(table);
            });
        }

        // Toggle collapsible manage sections
        function toggleManageSection(header) {
            var $header = $(header);
            var $body = $header.next('.manage-section-body');
            var $chevron = $header.find('.section-chevron');

            if ($header.hasClass('collapsed')) {
                $header.removeClass('collapsed');
                $chevron.removeClass('glyphicon-chevron-right').addClass('glyphicon-chevron-down');
                $body.slideDown(200);
            } else {
                $header.addClass('collapsed');
                $chevron.removeClass('glyphicon-chevron-down').addClass('glyphicon-chevron-right');
                $body.slideUp(200);
            }
        }

        // Toggle scan log section - fetches logs on first expand
        var scanLogLoaded = false;
        function toggleScanLog(header, instanceId) {
            var $header = $(header);
            var $body = $('#scan-log-body');
            var $chevron = $header.find('.section-chevron');

            if ($header.hasClass('collapsed')) {
                $header.removeClass('collapsed');
                $chevron.removeClass('glyphicon-chevron-right').addClass('glyphicon-chevron-down');
                $body.slideDown(200);

                // Fetch logs on first expand
                if (!scanLogLoaded) {
                    scanLogLoaded = true;
                    $('#scan-log-loader').show();
                    sf.fetchData('${docroot}/scanlog', {'id': instanceId}, function(data) {
                        var logTable = "<table class='table table-bordered table-striped table-condensed small tablesorter' style='table-layout: fixed'>";
                        logTable += "<thead><tr><th>Time</th><th>Component</th><th>Type</th><th>Event</th></tr></thead><tbody>";
                        for (var i = 0; i < data.length; i++) {
                            if (data[i][2] == "ERROR") {
                                logTable += "<tr class='danger'>";
                            } else {
                                logTable += "<tr>";
                            }
                            logTable += "<td>" + data[i][0] + "</td>";
                            logTable += "<td>" + data[i][1] + "</td>";
                            logTable += "<td>" + data[i][2] + "</td>";
                            logTable += "<td>" + data[i][3] + "</td>";
                            logTable += "</tr>";
                        }
                        logTable += "</tbody></table>";
                        $('#scan-log-loader').hide();
                        $('#scan-log-content').html(logTable);
                        $('#scan-log-content .tablesorter').tablesorter({widgets: ["filter"], widgetOptions : { filter_searchDelay : 300, filter_hideFilters : false }});
                    });
                }
            } else {
                $header.addClass('collapsed');
                $chevron.removeClass('glyphicon-chevron-down').addClass('glyphicon-chevron-right');
                $body.slideUp(200);
            }
        }

        if ("${status}" == "CREATED" || "${status}" == "RUNNING" || "${status}" == "STARTING" || "${status}" == "STARTED" || "${status}" == "UNKNOWN" || "${status}" == "INITIALIZING") {
            scanSummaryView("${id}");
        } else {
            browseEventList("${id}");
        }

        var refreshSummaryInterval;

        refreshSummary = function() {
            var status = document.getElementById("scanstatusbadge").innerHTML;

            if (status == "ERROR-FAILED" || status == "FINISHED" || status == "ABORTED") {
                sf.log("Scan is " + status);
                clearInterval(refreshSummaryInterval);
                return;
            }

            sf.log("Scan is " + status + ". Refreshing scan summary ...");

            for (var i = 0; i < dataloaders.length; i++) {
                if (!loadersrunning) {
                    loadersrunning = true;
                    dataloaders[i]();
                    loadersrunning = false;
                }
            }
        }

        refreshSummaryInterval = setInterval(refreshSummary, 5000);

        // Scan progress bar
        var progressInterval;

        function updateScanProgress() {
            sf.fetchData('${docroot}/scanprogress', {'id': '${id}'}, function(data) {
                var container = $('#scan-progress-container');
                var bar = $('#scan-progress-bar');
                var status = data.status;

                if (status == 'FINISHED' || status == 'ABORTED' || status == 'ERROR-FAILED') {
                    bar.css('width', '100%').attr('aria-valuenow', 100).text('100%');
                    bar.removeClass('active progress-bar-striped');
                    if (status == 'FINISHED') {
                        bar.addClass('progress-bar-success');
                    } else if (status == 'ABORTED') {
                        bar.addClass('progress-bar-warning');
                    } else {
                        bar.addClass('progress-bar-danger');
                    }
                    $('#scan-progress-pct').text('Done');
                    $('#scan-progress-details').html('<span>' + status + '</span>');
                    clearInterval(progressInterval);
                    setTimeout(function() { container.fadeOut(1000); }, 3000);
                    return;
                }

                if (status == 'CREATED' || status == 'INITIALIZING' || status == 'STARTING' || status == 'STARTED' || status == 'RUNNING') {
                    container.show();
                    var pct = data.progressPercent || 0;
                    bar.css('width', pct + '%').attr('aria-valuenow', pct).text(pct + '%');
                    $('#scan-progress-pct').text('~' + pct + '%');

                    // Detail metrics
                    $('#sp-modules').html('<i class="glyphicon glyphicon-th-list"></i> ' +
                        data.modulesWithResults + '/' + data.modulesTotal + ' modules reported');
                    $('#sp-running').html('<i class="glyphicon glyphicon-play"></i> ' +
                        data.modulesRunning + ' running');
                    var queuedLabel = data.eventsQueued;
                    if (queuedLabel > 999) queuedLabel = (queuedLabel / 1000).toFixed(1) + 'k';
                    $('#sp-queued').html('<i class="glyphicon glyphicon-inbox"></i> ' +
                        queuedLabel + ' queued');
                    var totalLabel = data.totalEvents;
                    if (totalLabel > 999) totalLabel = (totalLabel / 1000).toFixed(1) + 'k';
                    $('#sp-events').html('<i class="glyphicon glyphicon-signal"></i> ' +
                        totalLabel + ' events');
                    $('#sp-rate').html('<i class="glyphicon glyphicon-dashboard"></i> ' +
                        data.eventsPerSecond + '/sec');
                } else {
                    container.hide();
                }
            });
        }

        // Start progress polling if scan is active
        if ("${status}" == "CREATED" || "${status}" == "RUNNING" || "${status}" == "STARTING" || "${status}" == "STARTED" || "${status}" == "INITIALIZING") {
            updateScanProgress();
            progressInterval = setInterval(updateScanProgress, 3000);
        }

        // Check if this scan is the latest for its target and handle auto-import
        var scanLatestInfo = null;
        var filterImported = false;  // Default: show imported entries

        function checkScanLatest() {
            sf.fetchData('${docroot}/scanislatest', {'id': '${id}'}, function(data) {
                scanLatestInfo = data;

                // Show LATEST badge if this is the latest scan
                if (data.isLatest) {
                    $('#latestbadge').show();

                    // Show SYNC/RESYNC badge only for latest scans with multiple scans for target
                    if (data.scanCount > 1) {
                        if (data.importedCount > 0) {
                            // Already synced - show RESYNC
                            $('#syncbadge').text('RESYNC').attr('title', 'Click to delete and re-import entries from previous scans').show();
                        } else {
                            // Not yet synced - show SYNC
                            $('#syncbadge').text('SYNC').attr('title', 'Click to import entries from previous scans').show();
                        }
                    }
                }

                // Show imported count badge if there are imported entries
                if (data.importedCount > 0) {
                    $('#importedbadge').text('+' + data.importedCount + ' IMPORTED').show();
                }

                // Log import status
                if (data.importStatus && data.importStatus.indexOf('Imported') === 0) {
                    alertify.success(data.importStatus);
                }
            });
        }

        // Resync scan entries - delete imported and re-import fresh
        function resyncScanEntries() {
            var currentText = $('#syncbadge').text();
            var actionText = currentText === 'RESYNC' ? 'delete existing imports and re-import' : 'import';

            alertify.confirm("Are you sure you want to " + actionText + " entries from previous scans?",
            function() {
                // User confirmed
                $('#syncbadge').text('SYNCING...').css('background-color', '#f59e0b');
                $('#loader').show();

                sf.fetchData('${docroot}/resyncscanentries', {'id': '${id}'}, function(data) {
                    $('#loader').hide();

                    if (data.success) {
                        alertify.success(data.message);

                        // Update badges
                        if (data.imported > 0) {
                            $('#syncbadge').text('RESYNC').css('background-color', '#10b981');
                            $('#importedbadge').text('+' + data.imported + ' IMPORTED').show();
                        } else {
                            $('#syncbadge').text('SYNC').css('background-color', '#10b981');
                            $('#importedbadge').hide();
                        }

                        // Refresh the current view to show updated data
                        if (typeof refresh === 'function') {
                            refresh();
                        }
                    } else {
                        alertify.error('Sync failed: ' + data.message);
                        $('#syncbadge').text(currentText).css('background-color', '#10b981');
                    }
                });
            },
            function() {
                // User cancelled
            }).set({title: currentText === 'RESYNC' ? "Re-sync entries?" : "Sync entries?"});
        }

        // Check on page load
        checkScanLatest();

    </script>
<iframe class="hidden" id='exportframe'></iframe>
<%include file="FOOTER.tmpl"/>
